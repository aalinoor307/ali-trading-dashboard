<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ali's Trading System ¬∑ Secure Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #020617;
      --bg-elevated: #020617;
      --accent: #4f46e5;
      --danger: #ef4444;
      --success: #22c55e;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --border: #1f2937;
      --card-radius: 18px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 45%, #000 100%);
      color: var(--text);
    }

    .app-shell {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 12px 16px 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      position: sticky;
      top: 0;
      z-index: 20;
      backdrop-filter: blur(14px);
      background: linear-gradient(to bottom, rgba(10,12,27,0.96), rgba(10,12,27,0.5), transparent);
      border-bottom: 1px solid rgba(148,163,184,0.08);
    }

    header h1 {
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 0;
      letter-spacing: 0.03em;
    }

    header .logo-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, #a5b4fc, #4f46e5);
      box-shadow: 0 0 16px rgba(129,140,248,0.9);
    }

    header .subtitle {
      font-size: 0.78rem;
      color: var(--muted);
      margin-top: 2px;
    }

    header .badge {
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 0.7rem;
      border: 1px solid rgba(148,163,184,0.25);
      background: radial-gradient(circle at top, rgba(37,99,235,0.3), rgba(15,23,42,0.95));
      text-align: right;
    }

    @media (max-width: 640px) {
      header {
        flex-direction: column;
        align-items: flex-start;
      }
      header .badge {
        align-self: stretch;
        text-align: left;
      }
    }

    main {
      padding: 10px 10px 22px;
      max-width: 1320px;
      margin: 0 auto;
      width: 100%;
      display: grid;
      grid-template-columns: minmax(0, 3fr) minmax(0, 2.4fr);
      gap: 14px;
    }

    @media (max-width: 960px) {
      main {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: radial-gradient(circle at top, #111827, #020617);
      border-radius: var(--card-radius);
      border: 1px solid rgba(148,163,184,0.18);
      padding: 14px 14px 12px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 18px 40px rgba(0,0,0,0.55);
    }

    .card::before {
      content: "";
      position: absolute;
      inset: -40%;
      background: radial-gradient(circle at top left, rgba(79,70,229,0.22), transparent 55%);
      opacity: 0.6;
      pointer-events: none;
      mix-blend-mode: screen;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 10px;
      margin-bottom: 8px;
      position: relative;
      z-index: 1;
    }

    .card-title {
      font-size: 0.95rem;
      font-weight: 600;
    }

    .card-caption {
      font-size: 0.75rem;
      color: var(--muted);
    }

    .pill {
      font-size: 0.7rem;
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.3);
      white-space: nowrap;
      color: var(--muted);
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 8px;
      position: relative;
      z-index: 1;
    }

    .form-grid-3 {
      display: grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 8px;
    }
    .form-grid-2 {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 8px;
    }

    @media (max-width: 768px) {
      .form-grid-3, .form-grid-2 {
        grid-template-columns: minmax(0,1fr);
      }
    }

    label {
      font-size: 0.74rem;
      color: var(--muted);
      display: block;
      margin-bottom: 2px;
    }

    input, select, textarea {
      width: 100%;
      padding: 8px 9px;
      border-radius: 10px;
      border: 1px solid rgba(55,65,81,0.9);
      background-color: rgba(15,23,42,0.95);
      color: var(--text);
      font-family: inherit;
      font-size: 0.8rem;
      outline: none;
      transition: border 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    @media (max-width: 600px) {
      input, select, textarea {
        font-size: 0.9rem;
      }
    }

    input:focus, select:focus, textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(79,70,229,0.4);
      background-color: #020617;
    }

    textarea { resize: vertical; min-height: 60px; }

    .criteria-grid {
      display: grid;
      grid-template-columns: minmax(0,1fr);
      gap: 5px;
      margin-top: 3px;
      font-size: 0.74rem;
    }

    .criteria-item {
      display: flex;
      align-items: flex-start;
      gap: 6px;
      padding: 6px 7px;
      border-radius: 10px;
      background-color: rgba(15,23,42,0.96);
      border: 1px dashed rgba(55,65,81,0.9);
    }

    .criteria-item input[type="checkbox"] {
      width: 14px;
      height: 14px;
      margin-top: 3px;
      cursor: pointer;
    }

    .criteria-label-main {
      font-size: 0.72rem;
      color: var(--text);
    }
    .criteria-weight {
      font-size: 0.7rem;
      color: var(--muted);
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 8px 14px;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: radial-gradient(circle at top left, #a855f7, #4f46e5);
      color: white;
      box-shadow: 0 15px 35px rgba(79,70,229,0.7);
      margin-top: 4px;
    }

    .btn span.icon { font-size: 0.9rem; }

    .btn-secondary {
      background: radial-gradient(circle at top left, rgba(15,23,42,0.96), rgba(30,64,175,0.95));
      border: 1px solid rgba(129,140,248,0.7);
      box-shadow: 0 8px 20px rgba(15,23,42,0.8);
      color: #e5e7eb;
    }

    .btn-ghost {
      background: transparent;
      border: 1px dashed rgba(148,163,184,0.7);
      box-shadow: none;
      color: var(--muted);
    }

    .trades-table-wrapper {
      margin-top: 10px;
      max-height: 340px;
      overflow: auto;
      border-radius: 12px;
      border: 1px solid rgba(31,41,55,0.95);
      background: radial-gradient(circle at top left, rgba(15,23,42,0.9), #020617);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.7rem;
    }

    thead {
      position: sticky;
      top: 0;
      background: #020617;
      z-index: 2;
    }

    th, td {
      padding: 5px 6px;
      border-bottom: 1px solid rgba(31,41,55,0.95);
      white-space: nowrap;
    }

    th {
      color: var(--muted);
      font-weight: 500;
      font-size: 0.68rem;
    }

    tbody tr { transition: background 0.12s ease; }

    tbody tr.win { background: rgba(34,197,94,0.08); }
    tbody tr.loss { background: rgba(239,68,68,0.08); }
    tbody tr.breakeven { background: rgba(234,179,8,0.08); }

    tbody tr:hover { background: rgba(148,163,184,0.08); }

    .tag {
      border-radius: 999px;
      padding: 2px 7px;
      font-size: 0.68rem;
      border: 1px solid rgba(148,163,184,0.5);
    }
    .tag.high { border-color: rgba(34,197,94,0.8); color: #bbf7d0; }
    .tag.low { border-color: rgba(248,113,113,0.8); color: #fecaca; }
    .tag.session { border-color: rgba(96,165,250,0.9); color: #bfdbfe; }
    .tag.emotion { border-color: rgba(244,114,182,0.9); color: #f9a8d4; }

    .link-btn {
      color: #93c5fd;
      text-decoration: none;
      font-size: 0.7rem;
    }

    .charts-grid {
      display: grid;
      grid-template-columns: minmax(0,1.1fr) minmax(0,1.3fr);
      gap: 10px;
      margin-top: 4px;
      position: relative;
      z-index: 1;
    }

    @media (max-width: 768px) {
      .charts-grid {
        grid-template-columns: minmax(0,1fr);
      }
    }

    .chart-card {
      background: radial-gradient(circle at top left, rgba(15,23,42,0.95), #020617);
      border-radius: 14px;
      border: 1px solid rgba(31,41,55,1);
      padding: 9px;
      box-shadow: 0 12px 32px rgba(15,23,42,0.9);
    }

    .chart-title {
      font-size: 0.78rem;
      color: var(--muted);
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }

    .chart-legend {
      font-size: 0.7rem;
      color: var(--muted);
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      display: inline-block;
    }
    .dot.green { background: #22c55e; }
    .dot.red { background: #ef4444; }
    .dot.blue { background: #3b82f6; }

    .kpi-row {
      display: grid;
      grid-template-columns: repeat(3,minmax(0,1fr));
      gap: 8px;
      margin-top: 4px;
      position: relative;
      z-index: 1;
    }

    @media (max-width: 600px) {
      .kpi-row {
        grid-template-columns: repeat(2,minmax(0,1fr));
      }
    }

    .kpi {
      background: radial-gradient(circle at top left, rgba(15,118,110,0.35), rgba(15,23,42,0.96));
      border-radius: 14px;
      padding: 7px 8px;
      border: 1px solid rgba(45,212,191,0.35);
    }
    .kpi:nth-child(2) {
      background: radial-gradient(circle at top left, rgba(37,99,235,0.32), rgba(15,23,42,0.96));
      border-color: rgba(96,165,250,0.45);
    }
    .kpi:nth-child(3) {
      background: radial-gradient(circle at top left, rgba(185,28,28,0.34), rgba(15,23,42,0.96));
      border-color: rgba(248,113,113,0.45);
    }

    .kpi-label {
      font-size: 0.7rem;
      color: var(--muted);
    }

    .kpi-value {
      font-size: 1.05rem;
      font-weight: 600;
      margin-top: 2px;
    }

    .kpi-sub {
      font-size: 0.7rem;
      color: var(--muted);
      margin-top: 1px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2,minmax(0,1fr));
      gap: 8px;
      margin-top: 8px;
    }

    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: minmax(0,1fr);
      }
    }

    .mini-card {
      background: radial-gradient(circle at top left, rgba(15,23,42,0.95), #020617);
      border-radius: 14px;
      border: 1px solid rgba(31,41,55,1);
      padding: 8px;
      font-size: 0.74rem;
      box-shadow: 0 10px 24px rgba(15,23,42,0.9);
    }

    .mini-card h4 {
      margin: 0 0 4px;
      font-size: 0.78rem;
    }

    .mini-card table {
      font-size: 0.7rem;
    }

    .mini-card th, .mini-card td {
      border-bottom: none;
      padding: 2px 3px;
    }

    .toolbar {
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      align-items:center;
      margin-top:8px;
      font-size:0.72rem;
      position:relative;
      z-index:1;
    }

    .toolbar input[type="file"] { display:none; }

    .toolbar-label { color:var(--muted); }

    .footer-note {
      padding: 6px 14px 14px;
      text-align: center;
      font-size: 0.7rem;
      color: var(--muted);
    }

    /* LOCK OVERLAY */
    #lock-overlay {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, rgba(15,23,42,0.98), rgba(15,23,42,0.98));
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    #lock-card {
      background: radial-gradient(circle at top left, rgba(79,70,229,0.3), #020617);
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.3);
      padding: 20px 18px 16px;
      max-width: 360px;
      width: 92%;
      box-shadow: 0 22px 60px rgba(0,0,0,0.8);
    }

    #lock-card h2 {
      margin: 0 0 6px;
      font-size: 1rem;
    }

    #lock-card p {
      margin: 0 0 10px;
      font-size: 0.8rem;
      color: var(--muted);
    }

    #lock-pin {
      letter-spacing: 0.3em;
      text-align: center;
      font-size: 1.1rem;
    }

    .lock-actions {
      display:flex;
      gap:8px;
      margin-top:10px;
      flex-wrap:wrap;
    }

    .lock-note {
      margin-top:8px;
      font-size:0.7rem;
      color:var(--muted);
    }
  </style>
</head>
<body>
<div class="app-shell">
  <!-- LOCK SCREEN -->
  <div id="lock-overlay">
    <div id="lock-card">
      <h2>Protect your journal</h2>
      <p id="lock-message">
        Create a 4‚Äì6 digit PIN for this browser. It‚Äôs not bank security, but it keeps casual eyes out.
      </p>
      <label for="lock-pin">PIN</label>
      <input type="password" id="lock-pin" maxlength="6" inputmode="numeric" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      <div class="lock-actions">
        <button id="lock-set" class="btn btn-secondary" type="button"><span class="icon">üîí</span> Set PIN</button>
        <button id="lock-unlock" class="btn btn-secondary" type="button" style="display:none;"><span class="icon">‚úÖ</span> Unlock</button>
        <button id="lock-reset" class="btn btn-ghost" type="button"><span class="icon">‚ôªÔ∏è</span> Reset PIN</button>
      </div>
      <div class="lock-note">
        PIN is stored locally on this device only. Still protect your Windows / phone login for real security.
      </div>
    </div>
  </div>

  <header>
    <div>
      <h1><span class="logo-dot"></span> Ali‚Äôs Trading System <span style="font-size:0.8rem;color:#9ca3af;">¬∑ Probabilities ¬∑ Discipline ¬∑ R</span></h1>
      <div class="subtitle">Log trades, score execution, and watch your edge play out like a web app.</div>
    </div>
    <div class="badge">
      Client-side only ¬∑ Auto-backup ¬∑ PIN lock<br/>
      For ‚Äúcloud sync‚Äù, keep this HTML + JSON in a cloud folder.
    </div>
  </header>

  <main>
    <!-- LEFT: FORM + TABLE -->
    <section class="card">
      <div class="card-header">
        <div>
          <div class="card-title">New Trade</div>
          <div class="card-caption">Fill the checklist ‚Äì probability & discipline are automatic.</div>
        </div>
        <div class="pill">Live scoring ¬∑ Local auto-backup</div>
      </div>

      <form id="trade-form">
        <div class="form-grid-3">
          <div>
            <label for="date">Date</label>
            <input type="date" id="date" required />
          </div>
          <div>
            <label for="pair">Pair</label>
            <input type="text" id="pair" placeholder="e.g. XAUUSD" required />
          </div>
          <div>
            <label for="timeframe">Timeframe</label>
            <input type="text" id="timeframe" placeholder="e.g. 15m / 4H" required />
          </div>
        </div>

        <div class="form-grid-3">
          <div>
            <label for="direction">Direction</label>
            <select id="direction" required>
              <option value="">Select</option>
              <option value="Buy">Buy</option>
              <option value="Sell">Sell</option>
            </select>
          </div>
          <div>
            <label for="setup">Setup</label>
            <select id="setup" required>
              <option value="">Select</option>
              <option value="Breakout with momentum">Breakout with momentum</option>
              <option value="Candle close above/below level">Candle close above/below level</option>
            </select>
          </div>
          <div>
            <label for="session">Session</label>
            <select id="session" required>
              <option value="">Select</option>
              <option value="Asia">Asia</option>
              <option value="London">London</option>
              <option value="New York">New York</option>
              <option value="Overlap">Overlap</option>
            </select>
          </div>
        </div>

        <div class="form-grid-2">
          <div>
            <label>Breakout / Candle criteria <span style="color:#6b7280;">(tick if met)</span></label>
            <div class="criteria-grid">
              <label class="criteria-item">
                <input type="checkbox" data-weight="2" class="crit">
                <div>
                  <div class="criteria-label-main">Clean close at level</div>
                  <div class="criteria-weight">No big wicks both sides ¬∑ weight 2</div>
                </div>
              </label>
              <label class="criteria-item">
                <input type="checkbox" data-weight="2" class="crit">
                <div>
                  <div class="criteria-label-main">No long wick against direction</div>
                  <div class="criteria-weight">Favourable wick profile ¬∑ weight 2</div>
                </div>
              </label>
              <label class="criteria-item">
                <input type="checkbox" data-weight="1" class="crit">
                <div>
                  <div class="criteria-label-main">Candle structure matches plan</div>
                  <div class="criteria-weight">Momentum/story + HTF match ¬∑ weight 1</div>
                </div>
              </label>
              <label class="criteria-item">
                <input type="checkbox" data-weight="1" class="crit">
                <div>
                  <div class="criteria-label-main">Not after huge candle</div>
                  <div class="criteria-weight">Avoid chasing exhaustion ¬∑ weight 1</div>
                </div>
              </label>
              <label class="criteria-item">
                <input type="checkbox" data-weight="2" class="crit">
                <div>
                  <div class="criteria-label-main">No flat / no-wick close</div>
                  <div class="criteria-weight">Wick first then flip ¬∑ weight 2</div>
                </div>
              </label>
              <label class="criteria-item">
                <input type="checkbox" data-weight="2" class="crit">
                <div>
                  <div class="criteria-label-main">Wick first, then flip entry</div>
                  <div class="criteria-weight">Classic flip entry ¬∑ weight 2</div>
                </div>
              </label>
            </div>
          </div>

          <div>
            <label>Risk / Reward</label>
            <div class="form-grid-3">
              <div>
                <label for="entry">Entry</label>
                <input type="number" step="0.0001" id="entry" placeholder="2350.50" />
              </div>
              <div>
                <label for="sl">Stop loss</label>
                <input type="number" step="0.0001" id="sl" placeholder="2346.50" />
              </div>
              <div>
                <label for="tp">Take profit</label>
                <input type="number" step="0.0001" id="tp" placeholder="2360.50" />
              </div>
            </div>
            <div class="form-grid-3" style="margin-top:6px;">
              <div>
                <label for="plannedR">R:R planned</label>
                <input type="number" step="0.01" id="plannedR" placeholder="auto if TP/SL" />
              </div>
              <div>
                <label for="exit">Exit price</label>
                <input type="number" step="0.0001" id="exit" placeholder="actual exit" />
              </div>
              <div>
                <label for="realizedR">R:R realized</label>
                <input type="number" step="0.01" id="realizedR" placeholder="auto if exit set" />
              </div>
            </div>
            <div class="form-grid-2" style="margin-top:6px;">
              <div>
                <label for="emotion">Emotion tag</label>
                <select id="emotion" required>
                  <option value="">Select</option>
                  <option value="Calm">Calm</option>
                  <option value="Disciplined">Disciplined</option>
                  <option value="Confident">Confident</option>
                  <option value="Neutral">Neutral</option>
                  <option value="FOMO">FOMO</option>
                  <option value="Fearful">Fearful</option>
                  <option value="Revenge">Revenge</option>
                  <option value="Tired">Tired</option>
                </select>
              </div>
              <div>
                <label for="mistake">Mistake tag</label>
                <select id="mistake">
                  <option value="None">None</option>
                  <option value="Late entry">Late entry</option>
                  <option value="Early exit">Early exit</option>
                  <option value="No TP">No TP</option>
                  <option value="No SL">No SL</option>
                  <option value="Oversized risk">Oversized risk</option>
                  <option value="FOMO entry">FOMO entry</option>
                  <option value="Revenge trade">Revenge trade</option>
                  <option value="Traded news">Traded news</option>
                  <option value="Overtrading">Overtrading</option>
                  <option value="Ignored rule">Ignored rule</option>
                </select>
              </div>
            </div>
            <div style="margin-top:6px;">
              <label for="screenshot">Screenshot link (optional)</label>
              <input type="url" id="screenshot" placeholder="Paste TradingView / chart URL" />
            </div>
          </div>
        </div>

        <div class="form-grid-2">
          <div>
            <label for="notes">Journal notes</label>
            <textarea id="notes" placeholder="What did you do well? What can you improve?"></textarea>
          </div>
          <div style="display:flex;flex-direction:column;justify-content:flex-end;align-items:flex-start;">
            <button type="submit" class="btn">
              <span class="icon">‚ûï</span>
              Add trade to log
            </button>
            <div style="font-size:0.7rem;color:var(--muted);margin-top:4px;">
              Auto-backup: trades are stored in this browser. Use Export for extra safety or when changing devices.
            </div>
          </div>
        </div>
      </form>

      <div class="toolbar">
        <span class="toolbar-label">Save / load across devices:</span>
        <button id="export-json" class="btn btn-secondary" type="button">
          <span class="icon">‚¨áÔ∏è</span> Export JSON
        </button>
        <button id="export-csv" class="btn btn-secondary" type="button">
          <span class="icon">üìÑ</span> Export CSV
        </button>
        <label for="import-json-input" class="btn btn-ghost">
          <span class="icon">‚¨ÜÔ∏è</span> Import JSON
        </label>
        <input type="file" id="import-json-input" accept=".json,application/json" />
      </div>
      <div style="font-size:0.7rem;color:var(--muted);margin-top:4px;">
        Put this HTML + JSON in a cloud folder (Drive / Dropbox / OneDrive) for simple ‚Äúcloud sync‚Äù.
      </div>

      <div class="trades-table-wrapper">
        <table id="trades-table">
          <thead>
          <tr>
            <th>#</th>
            <th>Date</th>
            <th>Pair</th>
            <th>Dir</th>
            <th>Setup</th>
            <th>Score %</th>
            <th>Prob</th>
            <th>R planned</th>
            <th>R realized</th>
            <th>Run R</th>
            <th>Session</th>
            <th>Emotion</th>
            <th>Disc.</th>
            <th>Mistake</th>
            <th>Chart</th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- RIGHT: DASHBOARD -->
    <section class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Performance Dashboard</div>
          <div class="card-caption">Live equity curve, probability mix, and behaviour stats.</div>
        </div>
        <div class="pill">Auto-updated from the left panel</div>
      </div>

      <div class="kpi-row">
        <div class="kpi">
          <div class="kpi-label">Total trades</div>
          <div class="kpi-value" id="kpi-total">0</div>
          <div class="kpi-sub" id="kpi-month">‚Äì</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">Win rate</div>
          <div class="kpi-value" id="kpi-winrate">0%</div>
          <div class="kpi-sub" id="kpi-wins">0W / 0L / 0BE</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">Avg R (realized)</div>
          <div class="kpi-value" id="kpi-avgr">0.0R</div>
          <div class="kpi-sub" id="kpi-equity">Equity: 0R</div>
        </div>
      </div>

      <div class="charts-grid">
        <div class="chart-card">
          <div class="chart-title">
            <span>Probability quality</span>
            <span class="chart-legend">
              <span><span class="dot green"></span> High</span>
              <span><span class="dot red"></span> Low</span>
            </span>
          </div>
          <canvas id="probabilityChart" height="140"></canvas>
        </div>

        <div class="chart-card">
          <div class="chart-title">
            <span>Equity curve (R)</span>
            <span class="chart-legend">
              <span><span class="dot blue"></span> Running R</span>
            </span>
          </div>
          <canvas id="equityChart" height="140"></canvas>
        </div>
      </div>

      <div class="stats-grid">
        <div class="mini-card">
          <h4>Setup performance</h4>
          <table id="setup-stats">
            <thead>
            <tr><th>Setup</th><th>Trades</th><th>Win%</th><th>Avg R</th></tr>
            </thead>
            <tbody>
            <tr><td>Breakout</td><td>0</td><td>0%</td><td>0.0</td></tr>
            <tr><td>Candle close</td><td>0</td><td>0%</td><td>0.0</td></tr>
            </tbody>
          </table>
        </div>
        <div class="mini-card">
          <h4>Most common mistakes</h4>
          <table id="mistake-stats">
            <thead>
            <tr><th>Mistake</th><th>Count</th></tr>
            </thead>
            <tbody>
            <tr><td>None</td><td>0</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <div class="footer-note">
    Auto-backup uses this browser‚Äôs storage. For true ‚Äúcloud‚Äù, just keep this HTML + your JSON backups in a synced folder and open it on any device.
  </div>
</div>

<script>
  const STORAGE_KEY = 'ali_trades_v1';
  const PIN_KEY = 'ali_trades_pin_v1';

  let trades = [];
  let probabilityChart, equityChart;

  // Simple obfuscation (not real encryption)
  function hashPin(pin) {
    return btoa(pin);
  }

  function showLockOverlay() {
    document.getElementById('lock-overlay').style.display = 'flex';
    document.getElementById('lock-pin').value = '';
    document.getElementById('lock-pin').focus();
  }

  function hideLockOverlay() {
    document.getElementById('lock-overlay').style.display = 'none';
  }

  function initLock() {
    const savedPin = localStorage.getItem(PIN_KEY);
    const msg = document.getElementById('lock-message');
    const setBtn = document.getElementById('lock-set');
    const unlockBtn = document.getElementById('lock-unlock');

    if (savedPin) {
      msg.textContent = 'Enter your 4‚Äì6 digit PIN to unlock this dashboard.';
      setBtn.style.display = 'none';
      unlockBtn.style.display = 'inline-flex';
    } else {
      msg.textContent = 'Create a 4‚Äì6 digit PIN for this browser. It keeps casual eyes out.';
      setBtn.style.display = 'inline-flex';
      unlockBtn.style.display = 'none';
    }
  }

  document.getElementById('lock-set').addEventListener('click', () => {
    const pinInput = document.getElementById('lock-pin');
    const pin = pinInput.value.trim();
    if (pin.length < 4 || pin.length > 6 || !/^[0-9]+$/.test(pin)) {
      alert('PIN must be 4‚Äì6 digits.');
      return;
    }
    localStorage.setItem(PIN_KEY, hashPin(pin));
    alert('PIN set for this browser. Remember it!');
    hideLockOverlay();
  });

  document.getElementById('lock-unlock').addEventListener('click', () => {
    const pinInput = document.getElementById('lock-pin');
    const pin = pinInput.value.trim();
    const saved = localStorage.getItem(PIN_KEY);
    if (hashPin(pin) === saved) {
      hideLockOverlay();
    } else {
      alert('Incorrect PIN.');
    }
  });

  document.getElementById('lock-reset').addEventListener('click', () => {
    if (confirm('Reset PIN? This does NOT delete your trades, only the lock.')) {
      localStorage.removeItem(PIN_KEY);
      initLock();
    }
  });

  // ====== CORE CALCULATIONS ======
  function computeCriteriaScore() {
    const checks = Array.from(document.querySelectorAll('.crit'));
    let totalWeight = 0;
    let metWeight = 0;
    checks.forEach(ch => {
      const w = parseFloat(ch.dataset.weight || '0');
      totalWeight += w;
      if (ch.checked) metWeight += w;
    });
    const score = totalWeight === 0 ? 0 : metWeight / totalWeight;
    return { totalWeight, metWeight, score };
  }

  function computePlannedR(entry, sl, tp, direction) {
    entry = parseFloat(entry);
    sl = parseFloat(sl);
    tp = parseFloat(tp);
    if (Number.isNaN(entry) || Number.isNaN(sl) || Number.isNaN(tp) || !direction) return null;
    const risk = direction === 'Buy' ? entry - sl : sl - entry;
    const reward = direction === 'Buy' ? tp - entry : entry - tp;
    if (risk === 0) return null;
    return reward / risk;
  }

  function computeRealizedR(entry, sl, exit, direction) {
    entry = parseFloat(entry);
    sl = parseFloat(sl);
    exit = parseFloat(exit);
    if (Number.isNaN(entry) || Number.isNaN(sl) || Number.isNaN(exit) || !direction) return null;
    const risk = direction === 'Buy' ? entry - sl : sl - entry;
    if (risk === 0) return null;
    const pnl = direction === 'Buy' ? exit - entry : entry - exit;
    return pnl / risk;
  }

  function computeDiscipline(score, emotion, session, realizedR) {
    let d = score * 70; // 0‚Äì70

    const emoMap = {
      'Calm': 15,
      'Disciplined': 15,
      'Confident': 10,
      'Neutral': 5,
      'FOMO': -10,
      'Fearful': -5,
      'Revenge': -20,
      'Tired': -5
    };
    d += emoMap[emotion] || 0;

    const sessMap = {
      'London': 5,
      'New York': 5,
      'Asia': -5,
      'Overlap': 0
    };
    d += sessMap[session] || 0;

    if (realizedR > 0) d += 10;
    else if (realizedR < 0) d -= 10;

    return Math.round(d);
  }

  // ====== RENDERING & KPIs ======
  function updateKpis() {
    const total = trades.length;
    document.getElementById('kpi-total').textContent = total.toString();

    if (total === 0) {
      document.getElementById('kpi-winrate').textContent = '0%';
      document.getElementById('kpi-wins').textContent = '0W / 0L / 0BE';
      document.getElementById('kpi-avgr').textContent = '0.0R';
      document.getElementById('kpi-equity').textContent = 'Equity: 0R';
      document.getElementById('kpi-month').textContent = '‚Äì';
      return;
    }

    const wins = trades.filter(t => t.realizedR > 0).length;
    const losses = trades.filter(t => t.realizedR < 0).length;
    const be = trades.filter(t => t.realizedR === 0).length;
    const winrate = wins / total * 100;
    document.getElementById('kpi-winrate').textContent = winrate.toFixed(1) + '%';
    document.getElementById('kpi-wins').textContent = `${wins}W / ${losses}L / ${be}BE`;

    const avgR = trades.reduce((s, t) => s + t.realizedR, 0) / total;
    document.getElementById('kpi-avgr').textContent = avgR.toFixed(2) + 'R';

    const equity = trades[trades.length - 1].runningR;
    document.getElementById('kpi-equity').textContent = 'Equity: ' + equity.toFixed(2) + 'R';

    const firstDate = trades[0].date;
    document.getElementById('kpi-month').textContent = firstDate ? ('Since ' + firstDate) : '‚Äì';
  }

  function updateTable() {
    const tbody = document.querySelector('#trades-table tbody');
    tbody.innerHTML = '';
    trades.forEach((t, idx) => {
      const tr = document.createElement('tr');
      if (t.realizedR > 0) tr.classList.add('win');
      else if (t.realizedR < 0) tr.classList.add('loss');
      else tr.classList.add('breakeven');

      tr.innerHTML = `
        <td>${idx + 1}</td>
        <td>${t.date || ''}</td>
        <td>${t.pair}</td>
        <td>${t.direction}</td>
        <td>${t.setupShort}</td>
        <td>${(t.score * 100).toFixed(0)}%</td>
        <td><span class="tag ${t.probability === 'High' ? 'high' : 'low'}">${t.probability}</span></td>
        <td>${t.plannedR.toFixed(2)}</td>
        <td>${t.realizedR.toFixed(2)}</td>
        <td>${t.runningR.toFixed(2)}</td>
        <td><span class="tag session">${t.session}</span></td>
        <td><span class="tag emotion">${t.emotion}</span></td>
        <td>${t.discipline}</td>
        <td>${t.mistake}</td>
        <td>${t.screenshot ? '<a href="' + t.screenshot + '" target="_blank" class="link-btn">Chart</a>' : ''}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function updateCharts() {
    const high = trades.filter(t => t.probability === 'High').length;
    const low = trades.filter(t => t.probability === 'Low').length;

    const ctxProb = document.getElementById('probabilityChart').getContext('2d');
    if (!probabilityChart) {
      probabilityChart = new Chart(ctxProb, {
        type: 'doughnut',
        data: {
          labels: ['High', 'Low'],
          datasets: [{
            data: [high, low],
            backgroundColor: ['#22c55e', '#ef4444'],
            borderColor: ['#052e16', '#450a0a'],
            borderWidth: 1.5
          }]
        },
        options: {
          plugins: {
            legend: {
              display: true,
              position: 'bottom',
              labels: { color: '#9ca3af', font: { size: 11 } }
            }
          },
          cutout: '60%',
        }
      });
    } else {
      probabilityChart.data.datasets[0].data = [high, low];
      probabilityChart.update();
    }

    const ctxEq = document.getElementById('equityChart').getContext('2d');
    const labels = trades.map((_, idx) => idx + 1);
    const dataEq = trades.map(t => t.runningR);

    if (!equityChart) {
      equityChart = new Chart(ctxEq, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Running R',
            data: dataEq,
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59,130,246,0.15)',
            borderWidth: 2,
            tension: 0.25,
            pointRadius: 2.2,
            pointHoverRadius: 3
          }]
        },
        options: {
          plugins: { legend: { display: false } },
          scales: {
            x: {
              ticks: { color: '#6b7280', font: { size: 9 } },
              grid: { color: 'rgba(31,41,55,0.7)' }
            },
            y: {
              ticks: { color: '#6b7280', font: { size: 9 } },
              grid: { color: 'rgba(31,41,55,0.7)' }
            }
          }
        }
      });
    } else {
      equityChart.data.labels = labels;
      equityChart.data.datasets[0].data = dataEq;
      equityChart.update();
    }
  }

  function updateSetupStats() {
    const rows = {
      breakout: { count: 0, wins: 0, rSum: 0 },
      candle: { count: 0, wins: 0, rSum: 0 }
    };
    trades.forEach(t => {
      const key = t.setup === 'Breakout with momentum' ? 'breakout' : 'candle';
      rows[key].count += 1;
      if (t.realizedR > 0) rows[key].wins += 1;
      rows[key].rSum += t.realizedR;
    });

    const tbody = document.querySelector('#setup-stats tbody');
    tbody.innerHTML = '';
    const cfg = [
      { key: 'breakout', label: 'Breakout' },
      { key: 'candle', label: 'Candle close' }
    ];
    cfg.forEach(c => {
      const r = rows[c.key];
      const tr = document.createElement('tr');
      const winrate = r.count ? (r.wins / r.count * 100).toFixed(0) : '0';
      const avgR = r.count ? (r.rSum / r.count).toFixed(2) : '0.00';
      tr.innerHTML = `<td>${c.label}</td><td>${r.count}</td><td>${winrate}%</td><td>${avgR}</td>`;
      tbody.appendChild(tr);
    });
  }

  function updateMistakeStats() {
    const counts = {};
    trades.forEach(t => {
      const m = t.mistake || 'None';
      counts[m] = (counts[m] || 0) + 1;
    });
    const entries = Object.entries(counts).sort((a,b) => b[1] - a[1]);

    const tbody = document.querySelector('#mistake-stats tbody');
    tbody.innerHTML = '';
    if (!entries.length) {
      const tr = document.createElement('tr');
      tr.innerHTML = '<td>None</td><td>0</td>';
      tbody.appendChild(tr);
      return;
    }
    entries.slice(0,5).forEach(([mist, count]) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${mist}</td><td>${count}</td>`;
      tbody.appendChild(tr);
    });
  }

  // ====== STORAGE (AUTO-BACKUP) ======
  function saveToLocal() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(trades));
      localStorage.setItem(STORAGE_KEY + '_time', new Date().toISOString());
    } catch (e) {
      console.warn('Could not save to localStorage', e);
    }
  }

  function loadFromLocal() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      const parsed = JSON.parse(raw);
      if (!Array.isArray(parsed)) return;
      trades = [];
      let runningR = 0;
      parsed.forEach(rawT => {
        const t = {
          date: rawT.date || '',
          pair: rawT.pair || '',
          timeframe: rawT.timeframe || '',
          direction: rawT.direction || '',
          setup: rawT.setup || '',
          setupShort:
            rawT.setup === 'Breakout with momentum' ? 'Breakout' :
            rawT.setup === 'Candle close above/below level' ? 'Candle' :
            (rawT.setupShort || rawT.setup || ''),
          session: rawT.session || '',
          emotion: rawT.emotion || '',
          mistake: rawT.mistake || 'None',
          screenshot: rawT.screenshot || '',
          notes: rawT.notes || '',
          score: Number(rawT.score) || 0,
          probability: rawT.probability === 'High' ? 'High' : 'Low',
          plannedR: Number(rawT.plannedR) || 0,
          realizedR: Number(rawT.realizedR) || 0,
          runningR: 0,
          discipline: Number(rawT.discipline) || 0
        };
        runningR += t.realizedR;
        t.runningR = runningR;
        trades.push(t);
      });
    } catch (e) {
      console.warn('Could not load from localStorage', e);
    }
  }

  function refreshAll() {
    updateKpis();
    updateTable();
    updateCharts();
    updateSetupStats();
    updateMistakeStats();
    saveToLocal();
  }

  // ====== EXPORT / IMPORT ======
  function downloadFile(filename, content, mime) {
    const blob = new Blob([content], { type: mime });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function exportJSON() {
    const dataStr = JSON.stringify(trades, null, 2);
    const date = new Date().toISOString().slice(0,10);
    downloadFile(`ali_trades_${date}.json`, dataStr, 'application/json');
  }

  function exportCSV() {
    if (!trades.length) {
      const date = new Date().toISOString().slice(0,10);
      downloadFile(`ali_trades_${date}.csv`, 'no trades yet', 'text/csv');
      return;
    }
    const header = [
      'date','pair','timeframe','direction','setup','session','emotion','mistake',
      'score','probability','plannedR','realizedR','runningR','discipline','screenshot','notes'
    ];
    const rows = trades.map(t => [
      t.date,
      t.pair,
      t.timeframe,
      t.direction,
      t.setup,
      t.session,
      t.emotion,
      t.mistake,
      t.score,
      t.probability,
      t.plannedR,
      t.realizedR,
      t.runningR,
      t.discipline,
      t.screenshot,
      (t.notes || '').replace(/[\r\n]+/g,' ')
    ]);
    const lines = [header.join(','), ...rows.map(r => r.map(v => {
      if (v === null || v === undefined) return '';
      const s = String(v);
      if (/[",\n]/.test(s)) {
        return '"' + s.replace(/"/g,'""') + '"';
      }
      return s;
    }).join(','))];
    const csv = lines.join('\n');
    const date = new Date().toISOString().slice(0,10);
    downloadFile(`ali_trades_${date}.csv`, csv, 'text/csv');
  }

  function importJSON(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const parsed = JSON.parse(e.target.result);
        if (!Array.isArray(parsed)) {
          alert('JSON must be an array of trades.');
          return;
        }
        trades = [];
        let runningR = 0;
        parsed.forEach(raw => {
          const t = {
            date: raw.date || '',
            pair: raw.pair || '',
            timeframe: raw.timeframe || '',
            direction: raw.direction || '',
            setup: raw.setup || '',
            setupShort:
              raw.setup === 'Breakout with momentum' ? 'Breakout' :
              raw.setup === 'Candle close above/below level' ? 'Candle' :
              (raw.setupShort || raw.setup || ''),
            session: raw.session || '',
            emotion: raw.emotion || '',
            mistake: raw.mistake || 'None',
            screenshot: raw.screenshot || '',
            notes: raw.notes || '',
            score: Number(raw.score) || 0,
            probability: raw.probability === 'High' ? 'High' : 'Low',
            plannedR: Number(raw.plannedR) || 0,
            realizedR: Number(raw.realizedR) || 0,
            runningR: 0,
            discipline: Number(raw.discipline) || 0
          };
          runningR += t.realizedR;
          t.runningR = runningR;
          trades.push(t);
        });
        refreshAll();
        alert('Session imported successfully ‚úÖ');
      } catch (err) {
        console.error(err);
        alert('Could not read JSON file.');
      }
    };
    reader.readAsText(file);
  }

  // ====== EVENT HOOKS ======
  document.getElementById('trade-form').addEventListener('submit', (e) => {
    e.preventDefault();
    const date = document.getElementById('date').value;
    const pair = document.getElementById('pair').value.trim();
    const timeframe = document.getElementById('timeframe').value.trim();
    const direction = document.getElementById('direction').value;
    const setup = document.getElementById('setup').value;
    const session = document.getElementById('session').value;
    const emotion = document.getElementById('emotion').value;
    const mistake = document.getElementById('mistake').value || 'None';
    const screenshot = document.getElementById('screenshot').value.trim();
    const notes = document.getElementById('notes').value.trim();

    const entry = document.getElementById('entry').value;
    const sl = document.getElementById('sl').value;
    const tp = document.getElementById('tp').value;
    let plannedR = parseFloat(document.getElementById('plannedR').value);
    const exit = document.getElementById('exit').value;
    let realizedR = parseFloat(document.getElementById('realizedR').value);

    const { score } = computeCriteriaScore();
    const probability = score >= 0.8 ? 'High' : 'Low';

    if (isNaN(plannedR)) {
      const calc = computePlannedR(entry, sl, tp, direction);
      plannedR = calc !== null ? calc : 0;
    }

    if (isNaN(realizedR)) {
      const calcR = computeRealizedR(entry, sl, exit, direction);
      realizedR = calcR !== null ? calcR : 0;
    }

    const discipline = computeDiscipline(score, emotion, session, realizedR);

    let runningR = trades.length ? trades[trades.length - 1].runningR : 0;
    runningR += realizedR;

    const trade = {
      date,
      pair,
      timeframe,
      direction,
      setup,
      setupShort: setup === 'Breakout with momentum' ? 'Breakout' :
                  setup === 'Candle close above/below level' ? 'Candle' :
                  setup,
      session,
      emotion,
      mistake,
      screenshot,
      notes,
      score,
      probability,
      plannedR,
      realizedR,
      runningR,
      discipline
    };

    trades.push(trade);
    refreshAll();

    // reset only some fields
    document.getElementById('entry').value = '';
    document.getElementById('sl').value = '';
    document.getElementById('tp').value = '';
    document.getElementById('plannedR').value = '';
    document.getElementById('exit').value = '';
    document.getElementById('realizedR').value = '';
    document.getElementById('screenshot').value = '';
    document.getElementById('notes').value = '';
    document.querySelectorAll('.crit').forEach(c => { c.checked = false; });
  });

  document.getElementById('export-json').addEventListener('click', exportJSON);
  document.getElementById('export-csv').addEventListener('click', exportCSV);
  document.getElementById('import-json-input').addEventListener('change', (e) => {
    if (e.target.files && e.target.files[0]) {
      importJSON(e.target.files[0]);
      e.target.value = '';
    }
  });

  // ====== INIT ======
  window.addEventListener('DOMContentLoaded', () => {
    initLock();            // set up PIN behaviour
    loadFromLocal();       // auto-backup restore
    refreshAll();          // render if anything exists
    showLockOverlay();     // ask for PIN or create one
  });
</script>
</body>
</html>
