<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>TredLog – Probability-driven trading journal – Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- ============ SIMPLE PASSWORD GATE (CLIENT-SIDE ONLY) ============ -->
    <script>
      // EDIT ONLY THIS VALUE IF YOU WANT TO CHANGE YOUR PASSWORD
      const DASHBOARD_PASSWORD = "Alihandroz2099";

      (function () {
        if (!DASHBOARD_PASSWORD) return; // leave blank to disable

        try {
          const KEY = "tredlog_auth_v1";
          if (sessionStorage.getItem(KEY) === "yes") return;

          let ok = false;
          for (let i = 0; i < 5; i++) {
            const pw = prompt("Enter your TredLog dashboard password:");
            if (pw === null) break; // user cancelled
            if (pw === DASHBOARD_PASSWORD) {
              ok = true;
              break;
            }
            alert("Incorrect password, try again.");
          }
          if (!ok) {
            alert("Access denied.");
            document.documentElement.innerHTML = "";
          } else {
            sessionStorage.setItem(KEY, "yes");
          }
        } catch (e) {
          console.warn("Password gate error:", e);
        }
      })();
    </script>

    <style>
      :root {
        --bg: #050816;
        --panel: #0b1020;
        --panel-soft: #101524;
        --border-soft: rgba(148, 163, 184, 0.35);
        --accent: #ffc24b;
        --accent-soft: rgba(255, 194, 75, 0.14);
        --accent-strong: #f97316;
        --text: #f9fafb;
        --muted: #9ca3af;
        --danger: #f87171;
        --success: #4ade80;
        --card-radius: 16px;
        --pill-radius: 999px;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
          sans-serif;
        background: radial-gradient(circle at top, #101933 0, #050816 50%);
        color: var(--text);
        display: flex;
        justify-content: center;
      }

      .shell {
        width: 100%;
        max-width: 1300px;
        padding: 24px 16px 40px;
      }

      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 18px;
      }

      .logo-row {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .logo-icon {
        width: 30px;
        height: 30px;
        border-radius: 999px;
        background: radial-gradient(
          circle at 30% 20%,
          #ffe29f,
          #ff9f4a 45%,
          #ff3c3c 100%
        );
        box-shadow: 0 0 0 4px rgba(255, 194, 75, 0.15);
      }

      .logo-text-main {
        font-weight: 600;
        letter-spacing: 0.03em;
      }

      .logo-text-sub {
        font-size: 11px;
        color: var(--muted);
      }

      .header-pills {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        justify-content: flex-end;
      }

      .pill {
        padding: 5px 10px;
        border-radius: var(--pill-radius);
        border: 1px solid rgba(148, 163, 184, 0.35);
        font-size: 11px;
        color: var(--muted);
        background: rgba(15, 23, 42, 0.8);
        display: inline-flex;
        align-items: center;
        gap: 4px;
      }

      .pill.good {
        border-color: rgba(22, 163, 74, 0.7);
        color: #bbf7d0;
        background: rgba(22, 163, 74, 0.1);
      }

      .pill.danger {
        border-color: rgba(239, 68, 68, 0.7);
        color: #fecaca;
        background: rgba(127, 29, 29, 0.2);
        cursor: pointer;
      }

      .pill button {
        background: transparent;
        border: none;
        color: inherit;
        font: inherit;
        cursor: pointer;
        padding: 0;
      }

      main {
        display: grid;
        grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr);
        gap: 18px;
      }

      .card {
        background: radial-gradient(circle at top left, #151932 0, #050816 70%);
        border-radius: var(--card-radius);
        border: 1px solid rgba(148, 163, 184, 0.35);
        box-shadow: 0 18px 40px rgba(15, 23, 42, 0.8);
      }

      .card-inner {
        padding: 14px 18px 14px;
      }

      .card-title-row {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        margin-bottom: 8px;
      }

      .card-title {
        font-size: 13px;
        font-weight: 600;
      }

      .card-subtitle {
        font-size: 11px;
        color: var(--muted);
      }

      .row {
        display: flex;
        gap: 10px;
      }

      .col-2 {
        flex: 1 1 0;
      }

      label {
        display: block;
        font-size: 11px;
        color: var(--muted);
        margin-bottom: 3px;
      }

      input,
      select,
      textarea {
        width: 100%;
        background: rgba(15, 23, 42, 0.95);
        border-radius: 9px;
        border: 1px solid rgba(55, 65, 81, 0.9);
        color: var(--text);
        font-size: 12px;
        padding: 7px 9px;
        outline: none;
      }

      textarea {
        resize: vertical;
        min-height: 70px;
      }

      input::placeholder,
      textarea::placeholder {
        color: rgba(148, 163, 184, 0.7);
      }

      .btn {
        border-radius: 999px;
        border: none;
        cursor: pointer;
        font-size: 12px;
        padding: 7px 14px;
        font-weight: 500;
      }

      .btn-primary {
        background: linear-gradient(90deg, #ffc24b, #f97316);
        color: #111827;
        box-shadow: 0 16px 32px rgba(248, 196, 113, 0.5);
      }

      .btn-ghost {
        background: transparent;
        border: 1px solid rgba(148, 163, 184, 0.6);
        color: var(--muted);
      }

      .btn-small {
        padding: 4px 8px;
        font-size: 11px;
      }

      .btn-primary:hover {
        filter: brightness(1.05);
      }

      .section-heading {
        font-size: 12px;
        font-weight: 600;
        margin-top: 8px;
        margin-bottom: 6px;
      }

      .checklist-grid {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 10px;
      }

      .checklist-card {
        background: rgba(15, 23, 42, 0.9);
        border-radius: 12px;
        border: 1px solid rgba(31, 41, 55, 0.9);
        padding: 7px 9px 8px;
        font-size: 11px;
      }

      .checklist-title {
        font-weight: 600;
        margin-bottom: 4px;
      }

      .checklist-item {
        display: flex;
        align-items: flex-start;
        gap: 5px;
        margin-bottom: 3px;
      }

      .checklist-item input {
        width: auto;
        margin-top: 2px;
      }

      .small-text {
        font-size: 10px;
        color: var(--muted);
      }

      .footer-row {
        display: flex;
        justify-content: space-between;
        margin-top: 6px;
        font-size: 10px;
        color: var(--muted);
      }

      .footer-row strong {
        color: var(--accent);
      }

      /* Right-side cards */

      .overview-grid {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 8px;
        margin-bottom: 8px;
      }

      .overview-box {
        background: rgba(15, 23, 42, 0.98);
        border-radius: 12px;
        border: 1px solid rgba(31, 41, 55, 0.9);
        padding: 8px 9px;
        font-size: 11px;
      }

      .overview-label {
        color: var(--muted);
        font-size: 10px;
        margin-bottom: 3px;
      }

      .overview-value {
        font-size: 13px;
        font-weight: 600;
      }

      .overview-note {
        font-size: 10px;
        color: var(--muted);
        margin-top: 2px;
      }

      canvas {
        width: 100%;
        height: 180px;
        background: rgba(15, 23, 42, 0.9);
        border-radius: 12px;
        border: 1px solid rgba(31, 41, 55, 0.9);
      }

      .chart-row {
        display: grid;
        grid-template-columns: 2.1fr 1.1fr;
        gap: 8px;
        margin-bottom: 8px;
      }

      .chart-box {
        background: rgba(15, 23, 42, 0.98);
        border-radius: 12px;
        border: 1px solid rgba(31, 41, 55, 0.9);
        padding: 6px 9px 9px;
        font-size: 11px;
      }

      .chart-title-row {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        margin-bottom: 4px;
      }

      .chart-title {
        font-size: 11px;
        font-weight: 600;
      }

      .chart-caption {
        font-size: 10px;
        color: var(--muted);
      }

      .three-grid {
        display: grid;
        grid-template-columns: 1.4fr 1.4fr 1.2fr;
        gap: 8px;
        margin-top: 6px;
      }

      .table {
        width: 100%;
        border-collapse: collapse;
        font-size: 11px;
      }

      .table th,
      .table td {
        padding: 4px 6px;
        border-bottom: 1px solid rgba(31, 41, 55, 0.9);
        text-align: left;
      }

      .table th {
        font-weight: 500;
        color: var(--muted);
      }

      .table tbody tr:last-child td {
        border-bottom: none;
      }

      .table a {
        color: var(--accent);
        text-decoration: none;
      }

      .table a:hover {
        text-decoration: underline;
      }

      .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 4px;
      }

      .calendar-title {
        font-size: 11px;
        font-weight: 600;
      }

      .calendar-nav {
        display: flex;
        gap: 4px;
      }

      .calendar-nav button {
        border-radius: 999px;
        border: 1px solid rgba(55, 65, 81, 0.9);
        background: rgba(15, 23, 42, 0.9);
        color: var(--muted);
        cursor: pointer;
        font-size: 10px;
        padding: 2px 6px;
      }

      .calendar-grid {
        width: 100%;
        border-collapse: collapse;
        font-size: 10px;
      }

      .calendar-grid th,
      .calendar-grid td {
        text-align: center;
        padding: 3px 0;
      }

      .calendar-grid th {
        color: var(--muted);
        font-weight: 500;
      }

      .calendar-day {
        border-radius: 6px;
        padding: 3px 0;
        margin: 1px;
      }

      .calendar-day.has-trades {
        background: rgba(34, 197, 94, 0.12);
        border: 1px solid rgba(34, 197, 94, 0.6);
      }

      .calendar-day.negative {
        background: rgba(248, 113, 113, 0.12);
        border-color: rgba(248, 113, 113, 0.6);
      }

      .calendar-pnl {
        display: block;
        font-size: 9px;
      }

      .eval-list {
        list-style: none;
        padding: 0;
        margin: 4px 0 0;
        font-size: 10px;
        color: var(--muted);
      }

      .eval-list li {
        display: flex;
        justify-content: space-between;
        padding: 2px 0;
      }

      .eval-label {
        opacity: 0.9;
      }

      .eval-value {
        color: var(--text);
        font-weight: 500;
        padding-left: 10px;
      }

      footer {
        margin-top: 12px;
        font-size: 10px;
        color: var(--muted);
        display: flex;
        justify-content: space-between;
        gap: 6px;
        flex-wrap: wrap;
      }

      footer a {
        color: var(--accent);
        text-decoration: none;
      }

      footer a:hover {
        text-decoration: underline;
      }

      @media (max-width: 1100px) {
        main {
          grid-template-columns: minmax(0, 1fr);
        }

        .three-grid {
          grid-template-columns: minmax(0, 1fr);
        }
      }

      @media (max-width: 720px) {
        header {
          flex-direction: column;
          align-items: flex-start;
          gap: 8px;
        }

        .row {
          flex-direction: column;
        }

        .overview-grid {
          grid-template-columns: minmax(0, 1fr);
        }

        .chart-row {
          grid-template-columns: minmax(0, 1fr);
        }
      }
    </style>
  </head>
  <body>
    <div class="shell">
      <header>
        <div class="logo-row">
          <div class="logo-icon"></div>
          <div>
            <div class="logo-text-main">TredLog</div>
            <div class="logo-text-sub">
              Probability-driven trading journal – Dashboard
            </div>
          </div>
        </div>
        <div class="header-pills">
          <div id="storageModePill" class="pill">
            Local autosave • Browser only
          </div>
          <div class="pill good">Built for serious traders</div>
          <button id="exportBtn" class="pill btn-small">Export backup</button>
          <button id="importBtn" class="pill btn-small">Import backup</button>
          <div id="driveStatusPill" class="pill">
            Drive: not connected
          </div>
          <button id="googleSignInBtn" class="pill btn-small">
            Sign in with Google
          </button>
          <button
            id="googleSignOutBtn"
            class="pill btn-small"
            style="display: none"
          >
            Sign out
          </button>
          <div id="clearBtn" class="pill danger">Clear local data</div>
        </div>
      </header>

      <main>
        <!-- LEFT: account & new trade -->
        <section class="card">
          <div class="card-inner">
            <div class="card-title-row">
              <div class="card-title">Account & new trade</div>
              <div class="card-subtitle">
                <span id="tradeCountLabel">0 trades logged</span>
              </div>
            </div>

            <!-- Account -->
            <div class="row">
              <div class="col-2">
                <label for="startingBalance">Starting balance (USD)</label>
                <input
                  id="startingBalance"
                  type="number"
                  min="0"
                  step="0.01"
                  placeholder="e.g. 10,000"
                />
              </div>
              <div class="col-2">
                <label for="riskPerTrade">Risk per trade (USD)</label>
                <input
                  id="riskPerTrade"
                  type="number"
                  step="0.01"
                  min="0"
                  placeholder="e.g. 1,000"
                />
              </div>
            </div>

            <!-- Trade core -->
            <div class="row" style="margin-top: 6px">
              <div class="col-2">
                <label for="tradeDate">Date</label>
                <input id="tradeDate" type="date" />
              </div>
              <div class="col-2">
                <label for="pair">Pair / symbol</label>
                <input id="pair" type="text" placeholder="e.g. GBPUSD" />
              </div>
            </div>

            <div class="row" style="margin-top: 6px">
              <div class="col-2">
                <label for="direction">Direction</label>
                <select id="direction">
                  <option value="">Select</option>
                  <option value="Buy">Buy</option>
                  <option value="Sell">Sell</option>
                  <option value="Long">Long</option>
                  <option value="Short">Short</option>
                </select>
              </div>
              <div class="col-2">
                <label for="session">Session</label>
                <input id="session" type="text" placeholder="London, NY, Asia…" />
              </div>
            </div>

            <div class="row" style="margin-top: 6px">
              <div class="col-2">
                <label for="riskR">Risk (R)</label>
                <input
                  id="riskR"
                  type="number"
                  step="0.01"
                  placeholder="1"
                  value="1"
                />
              </div>
              <div class="col-2">
                <label for="resultR">Result (R)</label>
                <input
                  id="resultR"
                  type="number"
                  step="0.01"
                  placeholder="e.g. -1, 0.5, 2"
                />
              </div>
            </div>

            <div class="row" style="margin-top: 6px">
              <div class="col-2">
                <label for="setup">Setup</label>
                <input
                  id="setup"
                  type="text"
                  placeholder="Momentum, pullback, range break…"
                />
              </div>
              <div class="col-2">
                <label for="screenshot">Screenshot / chart link</label>
                <input
                  id="screenshot"
                  type="text"
                  placeholder="Paste TradingView or chart URL"
                />
              </div>
            </div>

            <div style="margin-top: 6px">
              <label for="notes">Journal notes</label>
              <textarea
                id="notes"
                placeholder="What did you see? Which rules were met? Where could you improve?"
              ></textarea>
            </div>

            <!-- Weighted checklist -->
            <div class="section-heading">Weighted checklist</div>
            <div class="small-text" style="margin-bottom: 4px">
              Tick only what actually happened on this trade. Custom setup rules
              are for you only – discipline % is based on the core rules.
            </div>

            <div class="checklist-grid">
              <!-- Custom setup -->
              <div class="checklist-card">
                <div class="checklist-title">Custom setup checklist</div>
                <div class="small-text" style="margin-bottom: 4px">
                  Add your own rules (e.g. "Clean close at level", "No double
                  wick"). These are just for you – they don’t change discipline
                  %.
                </div>
                <div
                  id="customRulesList"
                  class="small-text"
                  style="min-height: 36px"
                >
                  <em>No custom rules yet. Add your checklist items above.</em>
                </div>
                <div style="margin-top: 4px; display: flex; gap: 4px">
                  <input
                    id="newCustomRule"
                    type="text"
                    placeholder="e.g. Clean close at level"
                  />
                  <button id="addCustomRuleBtn" class="btn btn-ghost btn-small">
                    Add
                  </button>
                </div>
              </div>

              <!-- Risk & discipline -->
              <div class="checklist-card">
                <div class="checklist-title">Risk & discipline</div>
                <label class="checklist-item">
                  <input id="chkPlannedRespected" type="checkbox" />
                  <span>Planned R respected.</span>
                </label>
                <label class="checklist-item">
                  <input id="chkNoRevenge" type="checkbox" />
                  <span>No revenge trades.</span>
                </label>
                <label class="checklist-item">
                  <input id="chkNoAddRisk" type="checkbox" />
                  <span>No adding risk mid-trade.</span>
                </label>
              </div>

              <!-- Screenshots / behaviour -->
              <div class="checklist-card">
                <div class="checklist-title">Screenshots / behaviour</div>
                <label class="checklist-item">
                  <input id="chkScreenshotsSaved" type="checkbox" />
                  <span>Screenshots saved for review.</span>
                </label>
                <label class="checklist-item">
                  <input id="chkAnnotated" type="checkbox" />
                  <span>Annotated before &amp; after.</span>
                </label>
                <label class="checklist-item">
                  <input id="chkClearHeadspace" type="checkbox" />
                  <span>Clear headspace / no FOMO late session.</span>
                </label>
              </div>
            </div>

            <div class="footer-row">
              <div>
                <button id="saveDraftBtn" class="btn btn-ghost btn-small">
                  Save draft
                </button>
              </div>
              <div>
                <span id="disciplineLabel"
                  >0 / 6 rules followed (0% discipline).</span
                >
                <span class="small-text">
                  Higher score → higher discipline per trade.
                </span>
              </div>
              <div>
                <button id="addTradeBtn" class="btn btn-primary">
                  Add trade to log
                </button>
              </div>
            </div>
          </div>
        </section>

        <!-- RIGHT: stats, charts, calendar, evaluation, recent trades -->
        <section class="card">
          <div class="card-inner">
            <div class="card-title-row">
              <div class="card-title">Equity & discipline overview</div>
              <div class="card-subtitle">
                <span id="toplineTotals"
                  >Total PnL: $0.00 • Balance: $0.00 • Starting: $0.00</span
                >
              </div>
            </div>

            <!-- Top three metrics -->
            <div class="overview-grid">
              <div class="overview-box">
                <div class="overview-label">WIN RATE</div>
                <div id="winRateValue" class="overview-value">0%</div>
                <div id="winRateNote" class="overview-note">
                  Based on trades with R ≠ 0.
                </div>
              </div>
              <div class="overview-box">
                <div class="overview-label">AVG R (REALIZED)</div>
                <div id="avgRValue" class="overview-value">0.0R</div>
                <div class="overview-note">From all logged trades.</div>
              </div>
              <div class="overview-box">
                <div class="overview-label">DISCIPLINE SCORE</div>
                <div id="disciplineScoreValue" class="overview-value">
                  0 / 100
                </div>
                <div class="overview-note">
                  Based on risk & behaviour checklist per trade.
                </div>
              </div>
            </div>

            <!-- Charts -->
            <div class="chart-row">
              <div class="chart-box">
                <div class="chart-title-row">
                  <div class="chart-title">Equity curve (cumulative R)</div>
                  <div id="equityCaption" class="chart-caption">
                    No trades yet. Log your first setup to start drawing your
                    curve.
                  </div>
                </div>
                <canvas id="equityChart" height="180"></canvas>
              </div>
              <div class="chart-box">
                <div class="chart-title-row">
                  <div class="chart-title">
                    Probability view (wins vs losses)
                  </div>
                  <div id="probCaption" class="chart-caption"></div>
                </div>
                <canvas id="probChart" height="180"></canvas>
              </div>
            </div>

            <!-- Three lower cards: weekly/monthly, calendar, evaluation -->
            <div class="three-grid">
              <!-- Weekly & monthly stats -->
              <div class="chart-box">
                <div class="chart-title">Weekly & monthly stats</div>
                <div class="small-text">
                  Quick glance at last 7 and 30 days.
                </div>
                <ul class="eval-list" style="margin-top: 6px">
                  <li>
                    <span class="eval-label">Last 7 days:</span>
                    <span id="last7PnL" class="eval-value"></span>
                  </li>
                  <li>
                    <span class="eval-label">Last 30 days:</span>
                    <span id="last30PnL" class="eval-value"></span>
                  </li>
                  <li>
                    <span class="eval-label">Total trades:</span>
                    <span id="totalTradesEval" class="eval-value"></span>
                  </li>
                  <li>
                    <span class="eval-label">Best day (USD):</span>
                    <span id="bestDayEval" class="eval-value"></span>
                  </li>
                  <li>
                    <span class="eval-label">Worst day (USD):</span>
                    <span id="worstDayEval" class="eval-value"></span>
                  </li>
                </ul>
              </div>

              <!-- Calendar -->
              <div class="chart-box">
                <div class="calendar-header">
                  <div class="calendar-title" id="calendarTitle">
                    Calendar – this month
                  </div>
                  <div class="calendar-nav">
                    <button id="calPrevBtn">‹</button>
                    <button id="calNextBtn">›</button>
                  </div>
                </div>
                <table class="calendar-grid">
                  <thead>
                    <tr>
                      <th>Sun</th>
                      <th>Mon</th>
                      <th>Tue</th>
                      <th>Wed</th>
                      <th>Thu</th>
                      <th>Fri</th>
                      <th>Sat</th>
                    </tr>
                  </thead>
                  <tbody id="calendarBody"></tbody>
                </table>
              </div>

              <!-- Evaluation panel -->
              <div class="chart-box">
                <div class="chart-title">Evaluation</div>
                <ul class="eval-list">
                  <li>
                    <span class="eval-label">Total number of trades</span>
                    <span id="evalTotalTrades" class="eval-value"></span>
                  </li>
                  <li>
                    <span class="eval-label">Avg. profit per trading day</span>
                    <span id="evalAvgDay" class="eval-value"></span>
                  </li>
                  <li>
                    <span class="eval-label">Biggest winner</span>
                    <span id="evalBiggestWinner" class="eval-value"></span>
                  </li>
                  <li>
                    <span class="eval-label">Biggest loser</span>
                    <span id="evalBiggestLoser" class="eval-value"></span>
                  </li>
                  <li>
                    <span class="eval-label">Total fees</span>
                    <span id="evalFees" class="eval-value">$0.00</span>
                  </li>
                  <li>
                    <span class="eval-label">Winrate w/o BE</span>
                    <span id="evalWinNoBE" class="eval-value"></span>
                  </li>
                  <li>
                    <span class="eval-label">ROI</span>
                    <span id="evalROI" class="eval-value"></span>
                  </li>
                  <li>
                    <span class="eval-label">Max drawdown</span>
                    <span id="evalDrawdown" class="eval-value"></span>
                  </li>
                  <li>
                    <span class="eval-label">Winning / Losing days</span>
                    <span id="evalWinLoseDays" class="eval-value"></span>
                  </li>
                  <li>
                    <span class="eval-label">Trades per day / week</span>
                    <span id="evalTradesPer" class="eval-value"></span>
                  </li>
                  <li>
                    <span class="eval-label">Current streak</span>
                    <span id="evalStreak" class="eval-value"></span>
                  </li>
                </ul>
              </div>
            </div>

            <!-- Recent trades table -->
            <div class="chart-box" style="margin-top: 8px">
              <div class="chart-title-row">
                <div class="chart-title">Recent trades</div>
                <div class="chart-caption" id="recentCaption"></div>
              </div>
              <div style="max-height: 180px; overflow: auto">
                <table class="table">
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>Date</th>
                      <th>Pair</th>
                      <th>Dir</th>
                      <th>R</th>
                      <th>PnL ($)</th>
                      <th>Disc%</th>
                      <th>Screenshot</th>
                      <th>Notes</th>
                    </tr>
                  </thead>
                  <tbody id="recentBody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </section>
      </main>

      <footer>
        <div>© 2025 TredLog. All rights reserved.</div>
        <div>
          Contact:
          <a href="mailto:support@tredlog.com">support@tredlog.com</a>
        </div>
      </footer>
    </div>

    <script>
      // ========= Google Drive config (fill these with your real values) =========
      const GOOGLE_CLIENT_ID = "41189729388-rksho3qtsot9qv7h2g4c0s8q81ghub6u.apps.googleusercontent.com";
      const GOOGLE_API_KEY = "AIzaSyD3SRe0koUE0MdEE0JWllD5V8L1koP7iGs";
      const GOOGLE_DISCOVERY_DOCS = [
        "https://www.googleapis.com/discovery/v1/apis/drive/v3/rest",
      ];
      const GOOGLE_SCOPES = "https://www.googleapis.com/auth/drive.file";

      // ========= Storage / state =========
      const STORAGE_KEY = "tredlog_dashboard_v3";

      let state = {
        startingBalance: 0,
        riskPerTrade: 0,
        trades: [],
        customRules: [],
      };

      // Month offset for calendar & recent trades filtering
      let calendarMonthOffset = 0; // 0 = current month

      // Google Drive runtime state
      let gapiInitialized = false;
      let googleAuthInstance = null;
      let isSignedIn = false;
      let driveFileId = null;
      let driveSaveTimeout = null;

      // ========= Helpers =========
      const $ = (id) => document.getElementById(id);

      function fmtUSD(v) {
        if (!isFinite(v)) return "$0.00";
        return (
          "$" +
          Number(v).toLocaleString("en-US", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          })
        );
      }

      function fmtR(v) {
        if (!isFinite(v)) return "0.0R";
        return (
          Number(v).toLocaleString("en-US", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          }) + "R"
        );
      }

      function fmtPct(v) {
        if (!isFinite(v)) return "0%";
        return (
          Number(v).toLocaleString("en-US", {
            minimumFractionDigits: 1,
            maximumFractionDigits: 1,
          }) + "%"
        );
      }

      function parseNumber(input) {
        const v = Number(input);
        return isFinite(v) ? v : 0;
      }

      function saveState(shouldSyncDrive = true) {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        } catch (e) {
          console.warn("Failed to save state", e);
        }
        if (shouldSyncDrive) scheduleDriveSave();
      }

      function loadState() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return;
          const data = JSON.parse(raw);
          if (!data || typeof data !== "object") return;
          state.startingBalance = Number(data.startingBalance) || 0;
          state.riskPerTrade = Number(data.riskPerTrade) || 0;
          state.customRules = Array.isArray(data.customRules)
            ? data.customRules
            : [];
          state.trades = Array.isArray(data.trades) ? data.trades : [];
        } catch (e) {
          console.warn("Failed to load state", e);
        }
      }

      function resetInputs() {
        $("tradeDate").value = "";
        $("pair").value = "";
        $("direction").value = "";
        $("session").value = "";
        $("riskR").value = "1";
        $("resultR").value = "";
        $("setup").value = "";
        $("screenshot").value = "";
        $("notes").value = "";
        [
          "chkPlannedRespected",
          "chkNoRevenge",
          "chkNoAddRisk",
          "chkScreenshotsSaved",
          "chkAnnotated",
          "chkClearHeadspace",
        ].forEach((id) => {
          $(id).checked = false;
        });
        updateDisciplinePreview();
      }

      // ========= Checklist discipline % =========
      function updateDisciplinePreview() {
        const coreChecks = [
          "chkPlannedRespected",
          "chkNoRevenge",
          "chkNoAddRisk",
          "chkScreenshotsSaved",
          "chkAnnotated",
          "chkClearHeadspace",
        ];
        const total = coreChecks.length;
        let hit = 0;
        coreChecks.forEach((id) => {
          if ($(id).checked) hit++;
        });
        const pct = total ? Math.round((hit / total) * 100) : 0;
        $("disciplineLabel").textContent = `${hit} / ${total} rules followed (${pct}% discipline).`;
      }

      // ========= Calendar helpers =========
      function getCalendarMonthRange(offset) {
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth() + offset; // can be negative / >11
        const first = new Date(year, month, 1);
        const last = new Date(year, month + 1, 0);
        return { first, last };
      }

      function sameYMD(a, b) {
        return (
          a.getFullYear() === b.getFullYear() &&
          a.getMonth() === b.getMonth() &&
          a.getDate() === b.getDate()
        );
      }

      // ========= Google Drive helpers =========
      function setDriveStatus(text, isOffOrError) {
        const pill = $("driveStatusPill");
        if (!pill) return;
        pill.textContent = text;
        if (isOffOrError) {
          pill.style.borderColor = "rgba(239,68,68,0.7)";
          pill.style.color = "#fecaca";
          pill.style.background = "rgba(127,29,29,0.2)";
        } else {
          pill.style.borderColor = "rgba(22,163,74,0.7)";
          pill.style.color = "#bbf7d0";
          pill.style.background = "rgba(22,163,74,0.15)";
        }
      }

      function scheduleDriveSave() {
        if (!gapiInitialized || !isSignedIn) return;
        if (driveSaveTimeout) clearTimeout(driveSaveTimeout);
        driveSaveTimeout = setTimeout(() => {
          saveBackupToDrive().catch((err) =>
            console.error("Drive autosync failed", err)
          );
        }, 1500); // debounce autosync ~1.5s
      }

      // Called by Google API script tag
      function gapiLoaded() {
        if (!GOOGLE_CLIENT_ID || !GOOGLE_API_KEY) {
          console.warn(
            "Google Client ID / API key missing. Drive sync disabled until you fill them."
          );
          return;
        }
        window.gapi.load("client:auth2", initGapiClient);
      }

      async function initGapiClient() {
        try {
          await gapi.client.init({
            apiKey: GOOGLE_API_KEY,
            clientId: GOOGLE_CLIENT_ID,
            discoveryDocs: GOOGLE_DISCOVERY_DOCS,
            scope: GOOGLE_SCOPES,
          });
          googleAuthInstance = gapi.auth2.getAuthInstance();
          googleAuthInstance.isSignedIn.listen(updateSigninStatus);
          updateSigninStatus(googleAuthInstance.isSignedIn.get());
          gapiInitialized = true;
        } catch (err) {
          console.error("Error initializing Google API client", err);
          setDriveStatus("Drive: init error", true);
        }
      }

      function updateSigninStatus(signedIn) {
        isSignedIn = signedIn;
        const signInBtn = $("googleSignInBtn");
        const signOutBtn = $("googleSignOutBtn");
        const storagePill = $("storageModePill");

        if (signedIn) {
          signInBtn.style.display = "none";
          signOutBtn.style.display = "inline-flex";
          storagePill.textContent = "Local autosave + Drive autosync";
          setDriveStatus("Drive: connected (autosync on)", false);
          // Once signed in, load backup if it exists
          loadBackupFromDrive().catch((err) =>
            console.error("Failed to load Drive backup", err)
          );
        } else {
          signInBtn.style.display = "inline-flex";
          signOutBtn.style.display = "none";
          storagePill.textContent = "Local autosave • Browser only";
          setDriveStatus("Drive: not connected", true);
        }
      }

      function handleSignInClick() {
        if (!googleAuthInstance) {
          alert(
            "Google client not ready yet. If this keeps happening, check your API key / Client ID."
          );
          return;
        }
        googleAuthInstance.signIn();
      }

      function handleSignOutClick() {
        if (!googleAuthInstance) return;
        googleAuthInstance.signOut();
      }

      async function loadBackupFromDrive() {
        if (!gapiInitialized || !isSignedIn) return;

        setDriveStatus("Drive: checking backup…", false);

        // Look for existing backup file
        const listResp = await gapi.client.drive.files.list({
          q: "name = 'tredlog-dashboard-backup.json' and trashed = false",
          spaces: "drive",
          fields: "files(id, name, modifiedTime)",
          pageSize: 1,
        });

        const files = listResp.result.files || [];
        if (!files.length) {
          setDriveStatus("Drive: no backup yet (will create)", false);
          return;
        }

        const file = files[0];
        driveFileId = file.id;

        const getResp = await gapi.client.drive.files.get({
          fileId: driveFileId,
          alt: "media",
        });

        const cloudState = getResp.result || null;
        if (!cloudState || typeof cloudState !== "object") {
          setDriveStatus("Drive: backup found but invalid", true);
          return;
        }

        const hasLocalTrades = state.trades && state.trades.length > 0;

        if (!hasLocalTrades) {
          // If local is empty, just adopt cloud state
          state = {
            startingBalance: Number(cloudState.startingBalance) || 0,
            riskPerTrade: Number(cloudState.riskPerTrade) || 0,
            trades: Array.isArray(cloudState.trades) ? cloudState.trades : [],
            customRules: Array.isArray(cloudState.customRules)
              ? cloudState.customRules
              : [],
          };
          saveState(false);
          renderCustomRules();
          recalcDashboard();
          setDriveStatus("Drive: backup loaded", false);
        } else {
          const useCloud = confirm(
            "A TredLog backup was found on Google Drive.\n\n" +
              "Click OK to replace your current local data with the Drive backup.\n" +
              "Click Cancel to keep your local data and overwrite Drive next save."
          );
          if (useCloud) {
            state = {
              startingBalance: Number(cloudState.startingBalance) || 0,
              riskPerTrade: Number(cloudState.riskPerTrade) || 0,
              trades: Array.isArray(cloudState.trades)
                ? cloudState.trades
                : [],
              customRules: Array.isArray(cloudState.customRules)
                ? cloudState.customRules
                : [],
            };
            saveState(false);
            renderCustomRules();
            recalcDashboard();
            setDriveStatus("Drive: backup loaded", false);
          } else {
            setDriveStatus("Drive: will overwrite backup on next sync", false);
          }
        }
      }

      async function saveBackupToDrive() {
        if (!gapiInitialized || !isSignedIn) return;

        try {
          setDriveStatus("Drive: syncing…", false);
          const fileContent = JSON.stringify(state, null, 2);
          const metadata = {
            name: "tredlog-dashboard-backup.json",
          };

          const accessToken = gapi.auth.getToken().access_token;

          const form = new FormData();
          form.append(
            "metadata",
            new Blob([JSON.stringify(metadata)], { type: "application/json" })
          );
          form.append("file", new Blob([fileContent], { type: "application/json" }));

          let method = "POST";
          let url =
            "https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart";

          if (driveFileId) {
            method = "PATCH";
            url =
              "https://www.googleapis.com/upload/drive/v3/files/" +
              encodeURIComponent(driveFileId) +
              "?uploadType=multipart";
          }

          const res = await fetch(url, {
            method,
            headers: new Headers({ Authorization: "Bearer " + accessToken }),
            body: form,
          });

          if (!res.ok) {
            throw new Error("Drive upload failed: " + res.status);
          }

          const data = await res.json();
          driveFileId = data.id;
          setDriveStatus("Drive: synced just now", false);
        } catch (err) {
          console.error("Error saving backup to Drive", err);
          setDriveStatus("Drive: sync error", true);
        }
      }

      // ========= Recalc dashboard =========
      function recalcDashboard() {
        const trades = [...state.trades].sort(
          (a, b) => new Date(a.date) - new Date(b.date)
        );
        const riskPerTrade = Number(state.riskPerTrade) || 0;
        const starting = Number(state.startingBalance) || 0;

        $("startingBalance").value = starting || "";
        $("riskPerTrade").value = riskPerTrade || "";

        $("tradeCountLabel").textContent =
          trades.length === 1
            ? "1 trade logged"
            : `${trades.length} trades logged`;

        // Compute PnL in R & USD per trade
        trades.forEach((t) => {
          t.resultR = Number(t.resultR) || 0;
          t.riskR = Number(t.riskR) || 1;
          t.pnlR = t.resultR;
          t.pnlUSD = t.pnlR * riskPerTrade;
        });

        // Totals
        const totalR = trades.reduce((s, t) => s + t.pnlR, 0);
        const totalUsd = trades.reduce((s, t) => s + t.pnlUSD, 0);
        const balance = starting + totalUsd;

        $("toplineTotals").textContent = `Total PnL: ${fmtUSD(
          totalUsd
        )} • Balance: ${fmtUSD(balance)} • Starting: ${fmtUSD(starting)}`;

        // Win rate, avg R
        const nonBe = trades.filter((t) => t.pnlR !== 0);
        const wins = trades.filter((t) => t.pnlR > 0);
        const losses = trades.filter((t) => t.pnlR < 0);
        const winRate = nonBe.length ? (wins.length / nonBe.length) * 100 : 0;
        const avgR = trades.length ? totalR / trades.length : 0;

        $("winRateValue").textContent = fmtPct(winRate);
        $("winRateNote").textContent = nonBe.length
          ? `Based on ${nonBe.length} trade(s) with R ≠ 0.`
          : "No non-breakeven trades yet.";
        $("avgRValue").textContent = fmtR(avgR);

        // Discipline score = average discipline % of trades
        let disciplineAvg = 0;
        if (trades.length) {
          disciplineAvg =
            trades.reduce((s, t) => s + (Number(t.disciplinePct) || 0), 0) /
            trades.length;
        }
        $("disciplineScoreValue").textContent = `${Math.round(
          disciplineAvg
        )} / 100`;

        // Equity curve data (cumulative R)
        const equityR = [];
        let runningR = 0;
        trades.forEach((t) => {
          runningR += t.pnlR;
          equityR.push({ x: new Date(t.date), y: runningR });
        });

        const eqCaption =
          trades.length === 0
            ? "No trades yet. Log your first setup to start drawing your curve."
            : `Total R: ${fmtR(totalR)} • PnL: ${fmtUSD(
                totalUsd
              )} • Starting balance: ${fmtUSD(
                starting
              )} • Current balance: ${fmtUSD(balance)}.`;
        $("equityCaption").textContent = eqCaption;

        drawEquityChart(equityR);

        // Probability view bar
        drawProbabilityChart(wins.length, losses.length);

        // Weekly / monthly stats, daily PnL map
        const today = new Date();
        const dayMs = 24 * 60 * 60 * 1000;
        const last7Start = new Date(today.getTime() - 6 * dayMs);
        const last30Start = new Date(today.getTime() - 29 * dayMs);

        let pnl7 = 0,
          pnl30 = 0;
        const dayMap = new Map(); // key: yyyy-mm-dd, value: total pnlUSD
        trades.forEach((t) => {
          const d = new Date(t.date);
          const key = t.date;
          if (!dayMap.has(key)) dayMap.set(key, 0);
          dayMap.set(key, dayMap.get(key) + t.pnlUSD);
          if (d >= last7Start && d <= today) pnl7 += t.pnlUSD;
          if (d >= last30Start && d <= today) pnl30 += t.pnlUSD;
        });

        $("last7PnL").textContent = `${fmtR(
          pnl7 / (riskPerTrade || 1 || 1)
        )} • ${fmtUSD(pnl7)}`;
        $("last30PnL").textContent = `${fmtR(
          pnl30 / (riskPerTrade || 1 || 1)
        )} • ${fmtUSD(pnl30)}`;
        $("totalTradesEval").textContent = trades.length
          ? `${trades.length} trade${trades.length === 1 ? "" : "s"}`
          : "No trades yet.";

        let bestDay = 0,
          worstDay = 0;
        dayMap.forEach((v) => {
          if (v > bestDay) bestDay = v;
          if (v < worstDay) worstDay = v;
        });
        $("bestDayEval").textContent = fmtUSD(bestDay);
        $("worstDayEval").textContent = fmtUSD(worstDay);

        // Calendar and month-filtered recent trades
        renderCalendarAndRecent(trades);

        // Evaluation metrics
        renderEvaluation(trades, {
          totalUsd,
          starting,
          balance,
          winRate,
          pnlByDay: dayMap,
          equityR,
          wins,
          losses,
        });
      }

      function renderCalendarAndRecent(trades) {
        const { first, last } = getCalendarMonthRange(calendarMonthOffset);
        const year = first.getFullYear();
        const month = first.getMonth();

        // Title
        const monthName = first.toLocaleString("en-US", { month: "long" });
        $("calendarTitle").textContent = `Calendar – ${monthName} ${year}`;

        // Build day → pnl map for that month
        const daysInMonth = last.getDate();
        const perDay = Array.from({ length: daysInMonth }, () => 0);
        trades.forEach((t) => {
          const d = new Date(t.date);
          if (d.getFullYear() === year && d.getMonth() === month) {
            const day = d.getDate();
            perDay[day - 1] += t.pnlUSD;
          }
        });

        // Render calendar grid
        const tbody = $("calendarBody");
        tbody.innerHTML = "";
        const firstWeekday = new Date(year, month, 1).getDay(); // 0=Sun

        let row = document.createElement("tr");
        // leading blanks
        for (let i = 0; i < firstWeekday; i++) {
          row.appendChild(document.createElement("td"));
        }

        for (let day = 1; day <= daysInMonth; day++) {
          if (row.children.length === 7) {
            tbody.appendChild(row);
            row = document.createElement("tr");
          }
          const cell = document.createElement("td");
          const pnl = perDay[day - 1];
          const div = document.createElement("div");
          div.className = "calendar-day";
          if (pnl !== 0) {
            div.classList.add("has-trades");
            if (pnl < 0) div.classList.add("negative");
          }
          div.textContent = day;
          if (pnl !== 0) {
            const span = document.createElement("span");
            span.className = "calendar-pnl";
            span.textContent = fmtUSD(pnl);
            div.appendChild(span);
          }
          cell.appendChild(div);
          row.appendChild(cell);
        }
        if (row.children.length > 0) {
          while (row.children.length < 7) {
            row.appendChild(document.createElement("td"));
          }
          tbody.appendChild(row);
        }

        // Recent trades filtered by that month
        const monthTrades = trades.filter((t) => {
          const d = new Date(t.date);
          return d.getFullYear() === year && d.getMonth() === month;
        });

        const recentBody = $("recentBody");
        recentBody.innerHTML = "";
        monthTrades
          .slice()
          .sort((a, b) => new Date(b.date) - new Date(a.date))
          .forEach((t, idx) => {
            const tr = document.createElement("tr");
            const discPct = isFinite(t.disciplinePct)
              ? Math.round(t.disciplinePct)
              : 0;
            const cells = [
              idx + 1,
              t.date,
              t.pair || "",
              t.direction || "",
              fmtR(t.pnlR),
              fmtUSD(t.pnlUSD),
              `${discPct}%`,
              t.screenshot
                ? `<a href="${t.screenshot}" target="_blank">Open</a>`
                : "",
              t.notes || "",
            ];
            cells.forEach((val) => {
              const td = document.createElement("td");
              td.innerHTML = val;
              tr.appendChild(td);
            });
            recentBody.appendChild(tr);
          });

        $("recentCaption").textContent = monthTrades.length
          ? `${monthTrades.length} trade${
              monthTrades.length === 1 ? "" : "s"
            } in ${monthName} ${year}.`
          : `No trades logged in ${monthName} ${year}.`;
      }

      function renderEvaluation(
        trades,
        { totalUsd, starting, balance, winRate, pnlByDay, equityR, wins, losses }
      ) {
        $("evalTotalTrades").textContent = trades.length || 0;

        // Avg profit per trading day
        const days = pnlByDay ? pnlByDay.size : 0;
        const avgPerDay = days ? totalUsd / days : 0;
        $("evalAvgDay").textContent = fmtUSD(avgPerDay);

        // Biggest winner / loser
        let biggestWin = 0,
          biggestLose = 0;
        trades.forEach((t) => {
          if (t.pnlUSD > biggestWin) biggestWin = t.pnlUSD;
          if (t.pnlUSD < biggestLose) biggestLose = t.pnlUSD;
        });
        $("evalBiggestWinner").textContent = fmtUSD(biggestWin);
        $("evalBiggestLoser").textContent = fmtUSD(biggestLose);

        // Total fees – not tracked, so 0 for now
        $("evalFees").textContent = "$0.00";

        // Winrate w/o BE
        const nonBe = trades.filter((t) => t.pnlR !== 0);
        const winNoBE =
          nonBe.length && wins.length
            ? (wins.length / nonBe.length) * 100
            : 0;
        $("evalWinNoBE").textContent = fmtPct(winNoBE);

        // ROI & max drawdown
        const roi = starting ? ((balance - starting) / starting) * 100 : 0;
        $("evalROI").textContent = fmtPct(roi);

        let maxDraw = 0;
        if (equityR.length && starting) {
          let peak = starting;
          let equityUsd = starting;
          equityR.forEach((pt) => {
            equityUsd = starting + pt.y * (state.riskPerTrade || 0);
            if (equityUsd > peak) peak = equityUsd;
            const dd = peak > 0 ? (peak - equityUsd) / peak : 0;
            if (dd > maxDraw) maxDraw = dd;
          });
        }
        $("evalDrawdown").textContent = fmtPct(maxDraw * 100);

        // Winning / losing days
        let winDays = 0,
          loseDays = 0;
        pnlByDay.forEach((v) => {
          if (v > 0) winDays++;
          else if (v < 0) loseDays++;
        });
        $("evalWinLoseDays").textContent = `${winDays} / ${loseDays}`;

        // Trades per day / week
        if (trades.length) {
          const dates = trades
            .map((t) => new Date(t.date))
            .sort((a, b) => a - b);
          const dayMs = 24 * 60 * 60 * 1000;
          const spanDays =
            (dates[dates.length - 1] - dates[0]) / dayMs + 1 || 1;
          const spanWeeks = spanDays / 7;
          const perDay = trades.length / spanDays;
          const perWeek = trades.length / spanWeeks;
          $("evalTradesPer").textContent = `${perDay.toFixed(
            2
          )} / ${perWeek.toFixed(2)}`;
        } else {
          $("evalTradesPer").textContent = "0.00 / 0.00";
        }

        // Current streak (W/L over last trades)
        let streakStr = "";
        const maxStreakTrades = 10;
        trades
          .slice()
          .sort((a, b) => new Date(b.date) - new Date(a.date))
          .slice(0, maxStreakTrades)
          .forEach((t) => {
            const c = t.pnlR > 0 ? "W" : t.pnlR < 0 ? "L" : "B";
            streakStr = c + (streakStr ? " " + streakStr : "");
          });
        $("evalStreak").textContent = streakStr || "–";
      }

      // ========= Charts (vanilla canvas) =========
      function clearCanvas(canvas) {
        const ctx = canvas.getContext("2d");
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "rgba(15,23,42,0.9)";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      }

      function drawEquityChart(points) {
        const canvas = $("equityChart");
        const ctx = canvas.getContext("2d");
        clearCanvas(canvas);
        if (!points.length) return;

        const padding = 20;
        const w = canvas.width;
        const h = canvas.height;
        const xs = points.map((p) => p.x.getTime());
        const ys = points.map((p) => p.y);
        const minX = Math.min(...xs);
        const maxX = Math.max(...xs);
        const minY = Math.min(0, Math.min(...ys));
        const maxY = Math.max(...ys);

        const xScale = (x) =>
          padding +
          ((x - minX) / (maxX - minX || 1)) * (w - padding * 2);
        const yScale = (y) =>
          h - padding - ((y - minY) / (maxY - minY || 1)) * (h - padding * 2);

        ctx.beginPath();
        ctx.strokeStyle = "#4ade80";
        ctx.lineWidth = 2;
        points.forEach((p, i) => {
          const x = xScale(p.x.getTime());
          const y = yScale(p.y);
          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        });
        ctx.stroke();

        // Zero line
        if (minY < 0 && maxY > 0) {
          ctx.beginPath();
          ctx.strokeStyle = "rgba(148,163,184,0.4)";
          const y0 = yScale(0);
          ctx.moveTo(padding, y0);
          ctx.lineTo(w - padding, y0);
          ctx.stroke();
        }
      }

      function drawProbabilityChart(wins, losses) {
        const canvas = $("probChart");
        const ctx = canvas.getContext("2d");
        clearCanvas(canvas);
        const total = wins + losses;
        $("probCaption").textContent = total
          ? `${wins} win(s), ${losses} loss(es).`
          : "No win/loss data yet.";

        if (!total) return;

        const w = canvas.width;
        const h = canvas.height;
        const barWidth = 60;
        const gap = 40;
        const maxHeight = h - 40;

        const winHeight = (wins / total) * maxHeight;
        const lossHeight = (losses / total) * maxHeight;

        const baseY = h - 20;

        // wins
        ctx.fillStyle = "#22c55e";
        ctx.fillRect(
          w / 2 - barWidth - gap / 2,
          baseY - winHeight,
          barWidth,
          winHeight
        );

        // losses
        ctx.fillStyle = "#f97373";
        ctx.fillRect(
          w / 2 + gap / 2,
          baseY - lossHeight,
          barWidth,
          lossHeight
        );
      }

      // ========= Event wiring =========
      function init() {
        loadState();
        // Prefill inputs
        if (state.startingBalance) {
          $("startingBalance").value = state.startingBalance;
        }
        if (state.riskPerTrade) {
          $("riskPerTrade").value = state.riskPerTrade;
        }
        renderCustomRules();
        recalcDashboard();

        $("startingBalance").addEventListener("change", () => {
          state.startingBalance = parseNumber($("startingBalance").value);
          saveState();
          recalcDashboard();
        });
        $("riskPerTrade").addEventListener("change", () => {
          state.riskPerTrade = parseNumber($("riskPerTrade").value);
          saveState();
          recalcDashboard();
        });

        [
          "chkPlannedRespected",
          "chkNoRevenge",
          "chkNoAddRisk",
          "chkScreenshotsSaved",
          "chkAnnotated",
          "chkClearHeadspace",
        ].forEach((id) => {
          $(id).addEventListener("change", updateDisciplinePreview);
        });

        $("addCustomRuleBtn").addEventListener("click", (e) => {
          e.preventDefault();
          const text = $("newCustomRule").value.trim();
          if (!text) return;
          state.customRules.push(text);
          $("newCustomRule").value = "";
          saveState();
          renderCustomRules();
        });

        $("addTradeBtn").addEventListener("click", (e) => {
          e.preventDefault();
          addTradeFromForm();
        });

        $("saveDraftBtn").addEventListener("click", (e) => {
          e.preventDefault();
          addTradeFromForm(true);
        });

        $("clearBtn").addEventListener("click", () => {
          if (
            confirm(
              "This will clear all local trades and settings on this device. Continue?"
            )
          ) {
            localStorage.removeItem(STORAGE_KEY);
            state = {
              startingBalance: 0,
              riskPerTrade: 0,
              trades: [],
              customRules: [],
            };
            resetInputs();
            renderCustomRules();
            recalcDashboard();
            saveState();
          }
        });

        $("exportBtn").addEventListener("click", exportBackup);
        $("importBtn").addEventListener("click", importBackup);

        $("calPrevBtn").addEventListener("click", () => {
          calendarMonthOffset--;
          recalcDashboard();
        });
        $("calNextBtn").addEventListener("click", () => {
          calendarMonthOffset++;
          recalcDashboard();
        });

        $("googleSignInBtn").addEventListener("click", handleSignInClick);
        $("googleSignOutBtn").addEventListener("click", handleSignOutClick);

        window.addEventListener("resize", recalcDashboard);
      }

      function renderCustomRules() {
        const container = $("customRulesList");
        container.innerHTML = "";
        if (!state.customRules.length) {
          container.innerHTML =
            '<em>No custom rules yet. Add your checklist items above.</em>';
          return;
        }
        state.customRules.forEach((rule, idx) => {
          const div = document.createElement("div");
          div.textContent = `${idx + 1}. ${rule}`;
          container.appendChild(div);
        });
      }

      function addTradeFromForm(isDraft = false) {
        const date = $("tradeDate").value;
        if (!date && !isDraft) {
          alert("Please select a trade date.");
          return;
        }
        const pair = $("pair").value.trim();
        const direction = $("direction").value;
        const session = $("session").value.trim();
        const riskR = parseNumber($("riskR").value) || 1;
        const resultR = parseNumber($("resultR").value);
        const setup = $("setup").value.trim();
        const screenshot = $("screenshot").value.trim();
        const notes = $("notes").value.trim();

        const checklistCore = [
          $("chkPlannedRespected").checked,
          $("chkNoRevenge").checked,
          $("chkNoAddRisk").checked,
          $("chkScreenshotsSaved").checked,
          $("chkAnnotated").checked,
          $("chkClearHeadspace").checked,
        ];
        const disciplinePct =
          (checklistCore.filter(Boolean).length / checklistCore.length) * 100;

        const trade = {
          id: Date.now(),
          date: date || new Date().toISOString().slice(0, 10),
          pair,
          direction,
          session,
          riskR,
          resultR,
          setup,
          screenshot,
          notes,
          disciplinePct,
        };

        if (!isDraft) {
          state.trades.push(trade);
          saveState();
          resetInputs();
          recalcDashboard();
        } else {
          alert("Draft saved locally in your browser (not added to log yet).");
        }
      }

      // ========= Backup import / export =========
      function exportBackup() {
        try {
          const data = JSON.stringify(state, null, 2);
          const blob = new Blob([data], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          const stamp = new Date().toISOString().slice(0, 10);
          a.href = url;
          a.download = `tredlog-backup-${stamp}.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          alert(
            "Backup exported. You can store this anywhere (Drive, Dropbox, etc.) as an extra copy."
          );
        } catch (e) {
          console.error(e);
          alert("Could not export backup.");
        }
      }

      function importBackup() {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = "application/json";
        input.addEventListener("change", () => {
          const file = input.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const data = JSON.parse(e.target.result);
              if (!data || typeof data !== "object") {
                alert("File does not look like a TredLog backup.");
                return;
              }
              state = {
                startingBalance: Number(data.startingBalance) || 0,
                riskPerTrade: Number(data.riskPerTrade) || 0,
                trades: Array.isArray(data.trades) ? data.trades : [],
                customRules: Array.isArray(data.customRules)
                  ? data.customRules
                  : [],
              };
              saveState();
              renderCustomRules();
              recalcDashboard();
              alert("Backup imported.");
            } catch (err) {
              console.error(err);
              alert("Failed to import backup.");
            }
          };
          reader.readAsText(file);
        });
        input.click();
      }

      document.addEventListener("DOMContentLoaded", init);
    </script>

    <!-- Google API JS (loads gapi and then calls gapiLoaded) -->
    <script
      src="https://apis.google.com/js/api.js"
      async
      defer
      onload="gapiLoaded()"
    ></script>
  </body>
</html>
