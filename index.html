<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>TredLog – Probability-driven trading journal – Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- =============== SIMPLE PASSWORD GATE (CLIENT-SIDE ONLY) =============== -->
    <script>
      // EDIT THIS to your real password. Keep the quotes.
      const DASHBOARD_PASSWORD =

      (function () {
        if (!DASHBOARD_PASSWORD) return; // leave blank to disable protection

        const KEY = "tredlog_authed_v1";
        if (sessionStorage.getItem(KEY) === "yes") return;

        let ok = false;
        try {
          for (let i = 0; i < 5; i++) {
            const pw = prompt("Enter your TredLog dashboard password:");
            if (pw === null) break; // user cancelled
            if (pw === DASHBOARD_PASSWORD) {
              ok = true;
              break;
            }
            alert("Incorrect password, try again.");
          }
        } catch (e) {
          console.warn("Password gate error", e);
        }

        if (!ok) {
          document.documentElement.innerHTML =
            "<body style='background:#020617;color:#e5e7eb;font-family:system-ui;padding:32px;text-align:center'>" +
            "<h1>Access denied</h1>" +
            "<p>Wrong password. Reload the page to try again.</p>" +
            "</body>";
        } else {
          sessionStorage.setItem(KEY, "yes");
        }
      })();
    </script>
    <!-- ====================================================================== -->

    <style>
      :root {
        --bg: #050816;
        --bg-elevated: #101322;
        --card: #070c1a;
        --border-subtle: rgba(148, 163, 184, 0.35);
        --accent: #ffc24b;
        --accent-strong: #ff9a3c;
        --accent-soft: rgba(255, 194, 75, 0.12);
        --muted: #9ca3af;
        --text: #f9fafb;
        --danger: #f97316;
        --success: #22c55e;
        --radius-lg: 18px;
        --radius-md: 12px;
        --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.85);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
          sans-serif;
        background: radial-gradient(circle at top, #172033 0, #050816 45%);
        color: var(--text);
        display: flex;
        justify-content: center;
      }

      .shell {
        width: 100%;
        max-width: 1200px;
        padding: 28px 16px 40px;
      }

      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 18px;
      }

      .logo-row {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .logo-icon {
        width: 28px;
        height: 28px;
        border-radius: 999px;
        background: radial-gradient(circle at 30% 20%, #ffe29f, #ff9f4a 45%, #ff3c3c);
        box-shadow: 0 0 0 4px rgba(255, 194, 75, 0.18);
      }

      .logo-text {
        font-weight: 600;
        letter-spacing: 0.02em;
      }

      .header-right {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
      }

      .pill {
        padding: 5px 10px;
        border-radius: 999px;
        border: 1px solid var(--border-subtle);
        font-size: 11px;
        color: var(--muted);
        background: rgba(15, 23, 42, 0.9);
      }

      .pill.good {
        border-color: rgba(34, 197, 94, 0.6);
        color: #bbf7d0;
        background: rgba(22, 163, 74, 0.1);
      }

      .pill.danger-outline {
        border-color: rgba(248, 113, 113, 0.7);
        color: #fecaca;
        cursor: pointer;
      }

      .pill.button {
        cursor: pointer;
        background: radial-gradient(circle at top, #111827, #020617);
      }

      .pill.button:hover {
        filter: brightness(1.03);
      }

      main {
        display: grid;
        grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.1fr);
        gap: 18px;
      }

      .card {
        background: radial-gradient(circle at top left, #111827, #020617 60%);
        border-radius: var(--radius-lg);
        border: 1px solid rgba(31, 41, 55, 0.95);
        box-shadow: var(--shadow-soft);
      }

      .card-inner {
        padding: 16px 18px 16px;
      }

      h2.card-title {
        font-size: 13px;
        margin: 0 0 10px;
      }

      .sub {
        font-size: 11px;
        color: var(--muted);
      }

      /* LEFT COLUMN: form + checklist */

      .grid-2 {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 10px;
      }

      .grid-3 {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 8px;
      }

      .field-label {
        font-size: 11px;
        color: var(--muted);
        margin-bottom: 2px;
      }

      .field-row {
        margin-bottom: 8px;
      }

      .input,
      .select {
        width: 100%;
        border-radius: 999px;
        border: 1px solid rgba(55, 65, 81, 0.9);
        background: rgba(15, 23, 42, 0.95);
        color: var(--text);
        padding: 7px 10px;
        font-size: 12px;
      }

      .input::placeholder {
        color: rgba(148, 163, 184, 0.7);
      }

      textarea.input {
        border-radius: 12px;
        resize: vertical;
        min-height: 80px;
      }

      .btn-primary {
        border-radius: 999px;
        border: none;
        background: linear-gradient(90deg, var(--accent), var(--accent-strong));
        color: #111827;
        font-weight: 600;
        padding: 7px 16px;
        font-size: 12px;
        cursor: pointer;
        box-shadow: 0 10px 18px rgba(255, 194, 75, 0.35);
      }

      .btn-ghost {
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.6);
        background: transparent;
        color: var(--muted);
        font-size: 12px;
        padding: 7px 14px;
        cursor: pointer;
      }

      .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        margin-top: 6px;
      }

      .checklist-section-title {
        font-size: 11px;
        font-weight: 600;
        margin-bottom: 4px;
      }

      .checklist-column {
        border-radius: var(--radius-md);
        border: 1px solid rgba(31, 41, 55, 0.9);
        background: rgba(15, 23, 42, 0.9);
        padding: 8px 9px;
      }

      .check-row {
        display: flex;
        align-items: flex-start;
        gap: 6px;
        margin-bottom: 3px;
        font-size: 10px;
        color: var(--muted);
      }

      .check-row label {
        cursor: pointer;
      }

      .checklist-footer {
        margin-top: 4px;
        font-size: 10px;
        color: var(--muted);
        text-align: right;
      }

      /* RIGHT COLUMN: stats + charts + calendar */

      .stats-top {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 8px;
        margin-bottom: 10px;
      }

      .stat-box {
        border-radius: var(--radius-md);
        border: 1px solid rgba(31, 41, 55, 0.9);
        background: rgba(15, 23, 42, 0.9);
        padding: 7px 9px;
        font-size: 11px;
      }

      .stat-label {
        color: var(--muted);
        margin-bottom: 3px;
      }

      .stat-value {
        font-size: 13px;
        font-weight: 600;
      }

      .stat-sub {
        font-size: 10px;
        color: var(--muted);
      }

      .charts-row {
        display: grid;
        grid-template-columns: minmax(0, 1.2fr) minmax(0, 0.9fr);
        gap: 8px;
      }

      .chart-card {
        border-radius: var(--radius-md);
        border: 1px solid rgba(31, 41, 55, 0.9);
        background: rgba(15, 23, 42, 0.9);
        padding: 7px 9px 9px;
      }

      .chart-title {
        font-size: 11px;
        color: var(--muted);
        margin-bottom: 4px;
      }

      canvas {
        width: 100%;
        height: 140px;
        display: block;
      }

      .bottom-row {
        display: grid;
        grid-template-columns: minmax(0, 1.1fr) minmax(0, 1fr);
        gap: 8px;
        margin-top: 10px;
      }

      .recent-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 11px;
      }

      .recent-table th,
      .recent-table td {
        padding: 4px 5px;
        border-bottom: 1px solid rgba(31, 41, 55, 0.9);
        white-space: nowrap;
      }

      .recent-table th {
        color: var(--muted);
        font-weight: 500;
        text-align: left;
      }

      .recent-table td.small {
        font-size: 10px;
      }

      .recent-table a {
        color: var(--accent);
        text-decoration: none;
      }

      .recent-table a:hover {
        text-decoration: underline;
      }

      /* Weekly / monthly + calendar */

      .mini-card {
        border-radius: var(--radius-md);
        border: 1px solid rgba(31, 41, 55, 0.9);
        background: rgba(15, 23, 42, 0.9);
        padding: 7px 9px;
        font-size: 11px;
      }

      .mini-title {
        font-size: 11px;
        color: var(--muted);
        margin-bottom: 4px;
      }

      .mini-line {
        font-size: 10px;
        margin-bottom: 2px;
      }

      .calendar-header {
        display: flex;
        justify-content: space-between;
        font-size: 10px;
        color: var(--muted);
        margin-bottom: 4px;
      }

      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        grid-auto-rows: minmax(18px, auto);
        gap: 2px;
        font-size: 9px;
      }

      .calendar-cell {
        padding: 2px 4px;
        border-radius: 4px;
      }

      .calendar-cell-empty {
        opacity: 0.25;
      }

      .calendar-day-labels {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 2px;
        font-size: 9px;
        color: var(--muted);
        margin-bottom: 2px;
      }

      .calendar-day-labels div {
        text-align: center;
      }

      .calendar-pnl {
        font-size: 9px;
      }

      @media (max-width: 980px) {
        main {
          grid-template-columns: minmax(0, 1fr);
        }
      }

      @media (max-width: 640px) {
        header {
          flex-direction: column;
          align-items: flex-start;
          gap: 8px;
        }
      }
    </style>
  </head>
  <body>
    <div class="shell">
      <header>
        <div class="logo-row">
          <div class="logo-icon"></div>
          <div>
            <div class="logo-text">TredLog</div>
            <div style="font-size:10px;color:var(--muted);margin-top:1px;">
              Probability-driven trading journal – Dashboard
            </div>
          </div>
        </div>
        <div class="header-right">
          <div class="pill">Local session • Browser storage only</div>
          <div class="pill good">Built for serious traders</div>
          <div id="exportBtn" class="pill button">Export backup</div>
          <div id="importBtn" class="pill button">Import backup</div>
          <div id="clearBtn" class="pill danger-outline">Clear local data</div>
          <input id="importFile" type="file" accept="application/json" style="display:none;" />
        </div>
      </header>

      <main>
        <!-- LEFT: Account + new trade + checklist -->
        <section class="card">
          <div class="card-inner">
            <h2 class="card-title">Account &amp; new trade</h2>
            <div class="sub" id="tradeCountLabel">0 trades logged</div>

            <div class="grid-2" style="margin-top:10px;">
              <div>
                <div class="field-row">
                  <div class="field-label">Starting balance (USD)</div>
                  <input
                    id="startingBalance"
                    class="input"
                    type="number"
                    step="0.01"
                    placeholder="e.g. 10,000"
                  />
                </div>
                <div class="field-row">
                  <div class="field-label">Risk per trade (USD)</div>
                  <input
                    id="riskPerTrade"
                    class="input"
                    type="number"
                    step="0.01"
                    placeholder="e.g. 1,000"
                  />
                </div>
                <div class="field-row">
                  <div class="field-label">Date</div>
                  <input id="tradeDate" class="input" type="date" />
                </div>
                <div class="field-row">
                  <div class="field-label">Direction</div>
                  <select id="direction" class="select">
                    <option value="">Select</option>
                    <option value="Buy">Buy</option>
                    <option value="Sell">Sell</option>
                  </select>
                </div>
                <div class="field-row">
                  <div class="field-label">Risk (R)</div>
                  <input
                    id="riskR"
                    class="input"
                    type="number"
                    step="0.1"
                    value="1"
                  />
                </div>
              </div>
              <div>
                <div class="field-row">
                  <div class="field-label">Pair / symbol</div>
                  <input
                    id="pair"
                    class="input"
                    type="text"
                    placeholder="e.g. GBPUSD"
                  />
                </div>
                <div class="field-row">
                  <div class="field-label">Session</div>
                  <input
                    id="session"
                    class="input"
                    type="text"
                    placeholder="London, NY, Asia..."
                  />
                </div>
                <div class="field-row">
                  <div class="field-label">Result (R)</div>
                  <input
                    id="resultR"
                    class="input"
                    type="number"
                    step="0.1"
                    placeholder="e.g. -1, 0.5, 2"
                  />
                </div>
                <div class="field-row">
                  <div class="field-label">Setup</div>
                  <input
                    id="setup"
                    class="input"
                    type="text"
                    placeholder="Momentum, pullback, range break..."
                  />
                </div>
                <div class="field-row">
                  <div class="field-label">Screenshot / chart link</div>
                  <input
                    id="screenshot"
                    class="input"
                    type="url"
                    placeholder="Paste TradingView or chart URL"
                  />
                </div>
              </div>
            </div>

            <div class="field-row">
              <div class="field-label">Journal notes</div>
              <textarea
                id="notes"
                class="input"
                placeholder="What did you see? What rules were met? Where could you improve?"
              ></textarea>
            </div>

            <div class="form-actions">
              <button id="saveDraftBtn" class="btn-ghost">Save draft</button>
              <button id="addTradeBtn" class="btn-primary">Add trade to log</button>
            </div>

            <!-- Weighted checklist -->
            <div style="margin-top:14px;">
              <div class="field-label">Weighted checklist</div>
              <div style="font-size:10px;color:var(--muted);margin-bottom:5px;">
                Tick only what actually happened on this trade.
              </div>
              <div class="grid-3">
                <div class="checklist-column">
                  <div class="checklist-section-title">Momentum setup</div>

                  <div class="check-row">
                    <input
                      id="chk-mom-1"
                      type="checkbox"
                      class="rule-checkbox"
                    />
                    <label for="chk-mom-1">
                      Trend, pullback clean and strong close.
                    </label>
                  </div>
                  <div class="check-row">
                    <input
                      id="chk-mom-2"
                      type="checkbox"
                      class="rule-checkbox"
                    />
                    <label for="chk-mom-2">
                      Clean close at level – no double wick at level.
                    </label>
                  </div>
                  <div class="check-row">
                    <input
                      id="chk-mom-3"
                      type="checkbox"
                      class="rule-checkbox"
                    />
                    <label for="chk-mom-3">
                      No long wick against direction.
                    </label>
                  </div>
                </div>

                <div class="checklist-column">
                  <div class="checklist-section-title">Risk &amp; discipline</div>

                  <div class="check-row">
                    <input
                      id="chk-risk-1"
                      type="checkbox"
                      class="rule-checkbox"
                    />
                    <label for="chk-risk-1">Planned R respected.</label>
                  </div>
                  <div class="check-row">
                    <input
                      id="chk-risk-2"
                      type="checkbox"
                      class="rule-checkbox"
                    />
                    <label for="chk-risk-2">No revenge trades.</label>
                  </div>
                  <div class="check-row">
                    <input
                      id="chk-risk-3"
                      type="checkbox"
                      class="rule-checkbox"
                    />
                    <label for="chk-risk-3">
                      No adding risk mid-trade.
                    </label>
                  </div>
                </div>

                <div class="checklist-column">
                  <div class="checklist-section-title">
                    Screenshots / behaviour
                  </div>

                  <div class="check-row">
                    <input
                      id="chk-beh-1"
                      type="checkbox"
                      class="rule-checkbox"
                    />
                    <label for="chk-beh-1">
                      Screenshots saved for review.
                    </label>
                  </div>
                  <div class="check-row">
                    <input
                      id="chk-beh-2"
                      type="checkbox"
                      class="rule-checkbox"
                    />
                    <label for="chk-beh-2">
                      Annotated before &amp; after.
                    </label>
                  </div>
                  <div class="check-row">
                    <input
                      id="chk-beh-3"
                      type="checkbox"
                      class="rule-checkbox"
                    />
                    <label for="chk-beh-3">
                      Clear headspace / no FOMO late session.
                    </label>
                  </div>
                </div>
              </div>
              <div class="checklist-footer">
                <span id="checklistScoreLabel">0 / 9 rules followed (0% discipline).</span>
                <span style="margin-left:4px;">Higher score → higher discipline.</span>
              </div>
            </div>
          </div>
        </section>

        <!-- RIGHT: stats, charts, calendar, recent trades -->
        <section class="card">
          <div class="card-inner">
            <div
              style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;"
            >
              <div>
                <h2 class="card-title" style="margin-bottom:2px;">
                  Equity &amp; discipline overview
                </h2>
                <div class="sub">
                  High-level view of your performance in R and USD.
                </div>
              </div>
              <div
                class="sub"
                id="topPnlLabel"
                style="font-size:11px;text-align:right;"
              >
                Total PnL: $0.00 • Balance: $0.00
              </div>
            </div>

            <div class="stats-top">
              <div class="stat-box">
                <div class="stat-label">WIN RATE</div>
                <div class="stat-value" id="winRateLabel">0%</div>
                <div class="stat-sub">Based on R &gt; 0 only.</div>
              </div>
              <div class="stat-box">
                <div class="stat-label">AVG R (REALIZED)</div>
                <div class="stat-value" id="avgRLabel">0.0R</div>
                <div class="stat-sub">From all logged trades.</div>
              </div>
              <div class="stat-box">
                <div class="stat-label">DISCIPLINE SCORE</div>
                <div class="stat-value" id="disciplineLabel">0 / 100</div>
                <div class="stat-sub">Average of checklist discipline.</div>
              </div>
            </div>

            <div class="charts-row">
              <div class="chart-card">
                <div class="chart-title">Equity curve (cumulative R)</div>
                <canvas id="equityCanvas" width="400" height="140"></canvas>
                <div
                  id="equitySummary"
                  style="font-size:10px;color:var(--muted);margin-top:2px;"
                >
                  No trades yet. Log your first setup to start drawing your curve.
                </div>
              </div>
              <div class="chart-card">
                <div class="chart-title">Probability view (wins vs losses)</div>
                <canvas id="probCanvas" width="300" height="140"></canvas>
              </div>
            </div>

            <div class="bottom-row">
              <div class="mini-card">
                <div class="mini-title">Weekly &amp; monthly stats</div>
                <div class="mini-line" id="stats7Label">
                  Last 7 days: 0 trades. PnL: 0.0R • $0.00
                </div>
                <div class="mini-line" id="stats30Label">
                  Last 30 days: 0 trades. PnL: 0.0R • $0.00
                </div>
              </div>

              <div class="mini-card">
                <div class="calendar-header">
                  <span>Calendar – this month</span>
                  <span id="calendarMonthLabel"></span>
                </div>
                <div class="calendar-day-labels">
                  <div>Sun</div>
                  <div>Mon</div>
                  <div>Tue</div>
                  <div>Wed</div>
                  <div>Thu</div>
                  <div>Fri</div>
                  <div>Sat</div>
                </div>
                <div id="calendarGrid" class="calendar-grid"></div>
              </div>
            </div>

            <div style="margin-top:10px;">
              <div class="mini-title" style="margin-bottom:4px;">Recent trades</div>
              <table class="recent-table" id="recentTable">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Date</th>
                    <th>Pair</th>
                    <th>Dir</th>
                    <th>R</th>
                    <th>PnL ($)</th>
                    <th>Disc%</th>
                    <th>Screenshot</th>
                    <th>Notes</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>
      </main>
    </div>

    <script>
      /*********************** DATA MODEL & STORAGE ************************/
      const STORAGE_KEY = "tredlog_v2_data";

      let state = {
        startingBalance: 0,
        riskPerTradeUsd: 0,
        trades: [], // newest last
      };

      function loadState() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return;
          const parsed = JSON.parse(raw);
          if (!parsed || typeof parsed !== "object") return;
          state = {
            startingBalance: parsed.startingBalance || 0,
            riskPerTradeUsd: parsed.riskPerTradeUsd || 0,
            trades: Array.isArray(parsed.trades) ? parsed.trades : [],
          };
        } catch (e) {
          console.warn("Failed to parse stored state", e);
        }
      }

      function saveState() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      }

      /************************ HELPER FORMATTING *************************/
      function formatMoney(v) {
        const n = Number(v) || 0;
        return n.toLocaleString("en-US", {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        });
      }

      function formatR(v) {
        const n = Number(v) || 0;
        return n.toFixed(2) + "R";
      }

      function parseDate(str) {
        if (!str) return null;
        const d = new Date(str);
        if (Number.isNaN(d.getTime())) return null;
        return d;
      }

      /************************ CHECKLIST LOGIC ****************************/
      function computeDisciplineScoreFromForm() {
        const boxes = Array.from(document.querySelectorAll(".rule-checkbox"));
        if (!boxes.length) return 0;
        let checked = 0;
        boxes.forEach((b) => {
          if (b.checked) checked++;
        });
        const pct = Math.round((checked / boxes.length) * 100);
        document.getElementById(
          "checklistScoreLabel"
        ).textContent = `${checked} / ${
          boxes.length
        } rules followed (${pct}% discipline).`;
        return pct;
      }

      function clearChecklist() {
        document
          .querySelectorAll(".rule-checkbox")
          .forEach((b) => (b.checked = false));
        computeDisciplineScoreFromForm();
      }

      /***************************** RENDERING *****************************/
      function renderAll() {
        document.getElementById("startingBalance").value =
          state.startingBalance || "";
        document.getElementById("riskPerTrade").value =
          state.riskPerTradeUsd || "";

        document.getElementById(
          "tradeCountLabel"
        ).textContent = `${state.trades.length} trade${
          state.trades.length === 1 ? "" : "s"
        } logged`;

        renderStatsAndCharts();
        renderCalendar(state.trades);
        renderRecentTrades();
      }

      function renderStatsAndCharts() {
        const trades = state.trades.slice();
        if (!trades.length) {
          document.getElementById("winRateLabel").textContent = "0%";
          document.getElementById("avgRLabel").textContent = "0.0R";
          document.getElementById("disciplineLabel").textContent = "0 / 100";
          document.getElementById("topPnlLabel").textContent =
            "Total PnL: $0.00 • Balance: $0.00";
          document.getElementById("equitySummary").textContent =
            "No trades yet. Log your first setup to start drawing your curve.";
          drawEquityCurve([]);
          drawProbabilityChart(0, 0);
          document.getElementById("stats7Label").textContent =
            "Last 7 days: 0 trades. PnL: 0.0R • $0.00";
          document.getElementById("stats30Label").textContent =
            "Last 30 days: 0 trades. PnL: 0.0R • $0.00";
          return;
        }

        let wins = 0,
          losses = 0,
          sumR = 0,
          sumDisc = 0,
          sumUsd = 0;

        trades.forEach((t) => {
          const r = Number(t.resultR) || 0;
          if (r > 0) wins++;
          else if (r < 0) losses++;
          sumR += r;
          sumUsd += Number(t.pnlUsd) || 0;
          sumDisc += Number(t.disciplineScore) || 0;
        });

        const winRate = wins + losses > 0 ? (wins / (wins + losses)) * 100 : 0;
        const avgR = trades.length ? sumR / trades.length : 0;
        const avgDisc = trades.length ? sumDisc / trades.length : 0;

        document.getElementById("winRateLabel").textContent =
          winRate.toFixed(0) + "%";
        document.getElementById("avgRLabel").textContent = formatR(avgR);
        document.getElementById("disciplineLabel").textContent =
          Math.round(avgDisc) + " / 100";

        const totalPnlUsd = sumUsd;
        const balance = (state.startingBalance || 0) + totalPnlUsd;

        document.getElementById("topPnlLabel").textContent =
          "Total PnL: $" +
          formatMoney(totalPnlUsd) +
          " • Balance: $" +
          formatMoney(balance);

        document.getElementById("equitySummary").textContent =
          "Total R: " +
          formatR(sumR) +
          " • PnL: $" +
          formatMoney(totalPnlUsd) +
          " • Starting balance: $" +
          formatMoney(state.startingBalance || 0) +
          " • Current balance: $" +
          formatMoney(balance);

        const equityPoints = [];
        let runningR = 0;
        trades.forEach((t, idx) => {
          runningR += Number(t.resultR) || 0;
          equityPoints.push({ x: idx + 1, y: runningR });
        });
        drawEquityCurve(equityPoints);
        drawProbabilityChart(wins, losses);

        renderRollingStats(trades);
      }

      function renderRollingStats(trades) {
        const now = new Date();
        const dayMs = 24 * 60 * 60 * 1000;
        let count7 = 0,
          sumR7 = 0,
          sumUsd7 = 0;
        let count30 = 0,
          sumR30 = 0,
          sumUsd30 = 0;

        trades.forEach((t) => {
          const d = parseDate(t.date);
          if (!d) return;
          const diffDays = (now - d) / dayMs;
          const r = Number(t.resultR) || 0;
          const usd = Number(t.pnlUsd) || 0;
          if (diffDays <= 7) {
            count7++;
            sumR7 += r;
            sumUsd7 += usd;
          }
          if (diffDays <= 30) {
            count30++;
            sumR30 += r;
            sumUsd30 += usd;
          }
        });

        document.getElementById(
          "stats7Label"
        ).textContent = `Last 7 days: ${count7} trade${
          count7 === 1 ? "" : "s"
        }. PnL: ${formatR(sumR7)} • $${formatMoney(sumUsd7)}.`;

        document.getElementById(
          "stats30Label"
        ).textContent = `Last 30 days: ${count30} trade${
          count30 === 1 ? "" : "s"
        }. PnL: ${formatR(sumR30)} • $${formatMoney(sumUsd30)}.`;
      }

      function renderRecentTrades() {
        const tbody = document.querySelector("#recentTable tbody");
        tbody.innerHTML = "";
        if (!state.trades.length) return;

        const trades = state.trades
          .map((t, i) => ({ ...t, index: i + 1 }))
          .slice(-20)
          .reverse(); // latest first

        trades.forEach((t) => {
          const tr = document.createElement("tr");

          const cells = [
            t.index,
            t.date || "",
            t.pair || "",
            t.direction || "",
            (Number(t.resultR) || 0).toFixed(2),
            formatMoney(t.pnlUsd || 0),
            (Number(t.disciplineScore) || 0).toFixed(0),
          ];

          cells.forEach((val) => {
            const td = document.createElement("td");
            td.textContent = val;
            tr.appendChild(td);
          });

          // screenshot
          const tdShot = document.createElement("td");
          tdShot.className = "small";
          if (t.screenshot) {
            const a = document.createElement("a");
            a.href = t.screenshot;
            a.target = "_blank";
            a.textContent = "View";
            tdShot.appendChild(a);
          } else {
            tdShot.textContent = "—";
          }
          tr.appendChild(tdShot);

          // notes
          const tdNotes = document.createElement("td");
          tdNotes.className = "small";
          tdNotes.textContent = t.notes ? t.notes.slice(0, 40) : "";
          tr.appendChild(tdNotes);

          tbody.appendChild(tr);
        });
      }

      /**************************** CHARTS *******************************/
      function drawEquityCurve(points) {
        const canvas = document.getElementById("equityCanvas");
        const ctx = canvas.getContext("2d");
        const w = canvas.width;
        const h = canvas.height;
        ctx.clearRect(0, 0, w, h);

        ctx.fillStyle = "#020617";
        ctx.fillRect(0, 0, w, h);

        ctx.strokeStyle = "rgba(55,65,81,0.9)";
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(30, 10);
        ctx.lineTo(30, h - 20);
        ctx.lineTo(w - 10, h - 20);
        ctx.stroke();

        if (!points.length) return;

        const ys = points.map((p) => p.y);
        const minY = Math.min(0, ...ys);
        const maxY = Math.max(0, ...ys);
        const spanY = maxY - minY || 1;

        const spanX = points.length - 1 || 1;

        ctx.strokeStyle = "#facc15";
        ctx.lineWidth = 2;
        ctx.beginPath();

        points.forEach((p, idx) => {
          const x = 30 + ((w - 40) * idx) / spanX;
          const y = h - 20 - ((h - 40) * (p.y - minY)) / spanY;
          if (idx === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        });
        ctx.stroke();
      }

      function drawProbabilityChart(wins, losses) {
        const canvas = document.getElementById("probCanvas");
        const ctx = canvas.getContext("2d");
        const w = canvas.width;
        const h = canvas.height;
        ctx.clearRect(0, 0, w, h);
        ctx.fillStyle = "#020617";
        ctx.fillRect(0, 0, w, h);

        const total = wins + losses;
        if (!total) {
          ctx.fillStyle = "rgba(148,163,184,0.7)";
          ctx.font = "10px system-ui";
          ctx.fillText("No trades yet", 14, 20);
          return;
        }

        const winPct = wins / total;
        const lossPct = losses / total;

        const barWidth = 40;
        const maxBarHeight = h - 40;
        const baseY = h - 20;

        function drawBar(x, value, label) {
          const height = maxBarHeight * value;
          ctx.fillStyle = "#22c55e";
          if (label === "Losses") ctx.fillStyle = "#f97316";
          ctx.fillRect(x, baseY - height, barWidth, height);

          ctx.fillStyle = "rgba(148,163,184,0.9)";
          ctx.font = "10px system-ui";
          ctx.fillText(label, x, baseY + 12);
          ctx.fillText((value * 100).toFixed(0) + "%", x, baseY - height - 4);
        }

        drawBar(40, winPct, "Wins");
        drawBar(120, lossPct, "Losses");
      }

      /***************************** CALENDAR *****************************/
      function renderCalendar(trades) {
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth();

        const monthLabel = document.getElementById("calendarMonthLabel");
        monthLabel.textContent = now.toLocaleString(undefined, {
          month: "long",
          year: "numeric",
        });

        const grid = document.getElementById("calendarGrid");
        grid.innerHTML = "";

        const firstOfMonth = new Date(year, month, 1);
        const startDay = firstOfMonth.getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        const pnlByDay = {};
        trades.forEach((t) => {
          const d = parseDate(t.date);
          if (!d) return;
          if (d.getFullYear() !== year || d.getMonth() !== month) return;
          const day = d.getDate();
          pnlByDay[day] = (pnlByDay[day] || 0) + (Number(t.pnlUsd) || 0);
        });

        for (let i = 0; i < startDay; i++) {
          const cell = document.createElement("div");
          cell.className = "calendar-cell calendar-cell-empty";
          grid.appendChild(cell);
        }

        for (let day = 1; day <= daysInMonth; day++) {
          const cell = document.createElement("div");
          cell.className = "calendar-cell";

          const top = document.createElement("div");
          top.textContent = day;

          const bottom = document.createElement("div");
          bottom.className = "calendar-pnl";

          const pnl = pnlByDay[day] || 0;
          if (pnl !== 0) {
            const sign = pnl > 0 ? "+" : "";
            bottom.textContent = sign + "$" + formatMoney(pnl);
            bottom.style.color = pnl >= 0 ? "#22c55e" : "#f97316";
          }

          cell.appendChild(top);
          cell.appendChild(bottom);
          grid.appendChild(cell);
        }

        while (grid.children.length < 42) {
          const cell = document.createElement("div");
          cell.className = "calendar-cell calendar-cell-empty";
          grid.appendChild(cell);
        }
      }

      /*************************** EVENT HANDLERS **************************/
      function handleAddTrade() {
        const startingBal = Number(
          document.getElementById("startingBalance").value || 0
        );
        const riskUsd = Number(
          document.getElementById("riskPerTrade").value || 0
        );
        const dateStr = document.getElementById("tradeDate").value;
        const direction = document.getElementById("direction").value;
        const riskR = Number(document.getElementById("riskR").value || 0);
        const pair = document.getElementById("pair").value.trim();
        const session = document.getElementById("session").value.trim();
        const resultR = Number(document.getElementById("resultR").value || 0);
        const setup = document.getElementById("setup").value.trim();
        const screenshot = document.getElementById("screenshot").value.trim();
        const notes = document.getElementById("notes").value.trim();

        if (!dateStr || !pair || !direction) {
          alert("Please fill in at least date, pair and direction.");
          return;
        }

        state.startingBalance = startingBal || 0;
        state.riskPerTradeUsd = riskUsd || 0;

        const pnlUsd = resultR * (state.riskPerTradeUsd || 0);
        const disciplineScore = computeDisciplineScoreFromForm();

        const trade = {
          id: Date.now(),
          date: dateStr,
          pair,
          direction,
          session,
          setup,
          riskR,
          resultR,
          pnlUsd,
          notes,
          screenshot,
          disciplineScore,
        };

        state.trades.push(trade);
        saveState();

        document.getElementById("notes").value = "";
        clearChecklist();
        document.getElementById("resultR").value = "";
        document.getElementById("screenshot").value = "";

        renderAll();
      }

      function handleSaveDraft() {
        const draft = {
          startingBalance:
            document.getElementById("startingBalance").value || "",
          riskPerTrade: document.getElementById("riskPerTrade").value || "",
          date: document.getElementById("tradeDate").value || "",
          direction: document.getElementById("direction").value || "",
          riskR: document.getElementById("riskR").value || "",
          pair: document.getElementById("pair").value || "",
          session: document.getElementById("session").value || "",
          resultR: document.getElementById("resultR").value || "",
          setup: document.getElementById("setup").value || "",
          screenshot: document.getElementById("screenshot").value || "",
          notes: document.getElementById("notes").value || "",
        };
        localStorage.setItem("tredlog_draft_v1", JSON.stringify(draft));
        alert("Draft saved in this browser.");
      }

      function restoreDraft() {
        try {
          const raw = localStorage.getItem("tredlog_draft_v1");
          if (!raw) return;
          const d = JSON.parse(raw);
          document.getElementById("startingBalance").value =
            d.startingBalance || "";
          document.getElementById("riskPerTrade").value = d.riskPerTrade || "";
          document.getElementById("tradeDate").value = d.date || "";
          document.getElementById("direction").value = d.direction || "";
          document.getElementById("riskR").value = d.riskR || "";
          document.getElementById("pair").value = d.pair || "";
          document.getElementById("session").value = d.session || "";
          document.getElementById("resultR").value = d.resultR || "";
          document.getElementById("setup").value = d.setup || "";
          document.getElementById("screenshot").value = d.screenshot || "";
          document.getElementById("notes").value = d.notes || "";
        } catch (e) {
          console.warn("No draft", e);
        }
      }

      function handleExport() {
        const blob = new Blob([JSON.stringify(state, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        const now = new Date()
          .toISOString()
          .slice(0, 19)
          .replace(/[:T]/g, "-");
        a.download = `tredlog-backup-${now}.json`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      function handleImport(file) {
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const obj = JSON.parse(e.target.result);
            if (!obj || typeof obj !== "object") throw new Error("Bad file");
            state = {
              startingBalance: obj.startingBalance || 0,
              riskPerTradeUsd: obj.riskPerTradeUsd || 0,
              trades: Array.isArray(obj.trades) ? obj.trades : [],
            };
            saveState();
            renderAll();
            alert("Backup imported.");
          } catch (err) {
            alert("Could not import backup: " + err.message);
          }
        };
        reader.readAsText(file);
      }

      function handleClear() {
        if (
          !confirm(
            "This will clear all TredLog data in this browser (trades, settings, draft). Continue?"
          )
        )
          return;
        localStorage.removeItem(STORAGE_KEY);
        localStorage.removeItem("tredlog_draft_v1");
        state = { startingBalance: 0, riskPerTradeUsd: 0, trades: [] };
        clearChecklist();
        renderAll();
      }

      /******************************* INIT ********************************/
      loadState();
      document.addEventListener("DOMContentLoaded", () => {
        restoreDraft();
        computeDisciplineScoreFromForm();
        renderAll();

        document
          .getElementById("addTradeBtn")
          .addEventListener("click", handleAddTrade);
        document
          .getElementById("saveDraftBtn")
          .addEventListener("click", handleSaveDraft);

        document
          .querySelectorAll(".rule-checkbox")
          .forEach((b) =>
            b.addEventListener("change", computeDisciplineScoreFromForm)
          );

        document
          .getElementById("exportBtn")
          .addEventListener("click", handleExport);
        document.getElementById("importBtn").addEventListener("click", () => {
          document.getElementById("importFile").click();
        });
        document
          .getElementById("importFile")
          .addEventListener("change", (e) => {
            if (e.target.files && e.target.files[0]) {
              handleImport(e.target.files[0]);
              e.target.value = "";
            }
          });
        document
          .getElementById("clearBtn")
          .addEventListener("click", handleClear);
      });
    </script>
  </body>
</html>
