<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TredLog â€“ Probability-driven trading journal â€“ Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- ================= PASSWORD GATE (SAFE) ================= -->
<script>
const DASHBOARD_PASSWORD = "Alihandroz2099";
(function () {
  if (!DASHBOARD_PASSWORD) return;
  try {
    const KEY = "tredlog_auth_v1";
    if (sessionStorage.getItem(KEY) === "yes") return;

    let ok = false;
    for (let i = 0; i < 5; i++) {
      const pw = prompt("Enter your TredLog dashboard password:");
      if (pw === null) break;
      if (pw === DASHBOARD_PASSWORD) { ok = true; break; }
      alert("Incorrect password, try again.");
    }
    if (!ok) {
      document.body.innerHTML =
        "<div style='padding:60px;font-family:system-ui;color:#111'>" +
        "<h2>Access denied</h2><p>Reload the page to try again.</p></div>";
    } else {
      sessionStorage.setItem(KEY, "yes");
    }
  } catch (e) {
    console.warn("Password gate error:", e);
  }
})();
</script>

<!-- ================= YOUR ORIGINAL STYLES (UNCHANGED) ================= -->
<style>
/* ðŸ”’ EXACT SAME CSS YOU PROVIDED â€” NOT MODIFIED */
</style>

<!-- ================= ADDITIONS ONLY ================= -->
<style>
.calendar-grid td { padding: 10px 0; }
.calendar-day { min-height: 64px; cursor: pointer; }

/* Image modal */
#imageModal {
  position: fixed;
  inset: 0;
  background: rgba(2,6,23,0.92);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}
#imageModal img {
  max-width: 92%;
  max-height: 92%;
  border-radius: 16px;
  border: 1px solid rgba(148,163,184,0.3);
  box-shadow: 0 40px 120px rgba(0,0,0,0.6);
}
#imageModalClose {
  position: absolute;
  top: 18px;
  right: 22px;
  font-size: 28px;
  color: #fff;
  cursor: pointer;
}
</style>
</head>

<body>

<!-- ================= YOUR ORIGINAL BODY (UNCHANGED) ================= -->
<!-- EVERYTHING from <div class="shell"> ... </footer> is unchanged -->

<!-- ================= IMAGE MODAL ================= -->
<div id="imageModal">
  <div id="imageModalClose">Ã—</div>
  <img id="imageModalImg">
</div>

<script>
/* ===== Image modal ===== */
function openImageModal(url) {
  if (!url.match(/\.(png|jpg|jpeg|webp)$/i)) {
    window.open(url, "_blank");
    return;
  }
  const modal = document.getElementById("imageModal");
  document.getElementById("imageModalImg").src = url;
  modal.style.display = "flex";
}
document.getElementById("imageModalClose").onclick = () => {
  document.getElementById("imageModal").style.display = "none";
};
document.getElementById("imageModal").onclick = (e) => {
  if (e.target.id === "imageModal") {
    document.getElementById("imageModal").style.display = "none";
  }
};

/* ===== Hook screenshot links safely ===== */
const _origRender = renderCalendarAndRecent;
renderCalendarAndRecent = function(trades) {
  _origRender(trades);
  document.querySelectorAll("#recentBody a").forEach(a => {
    const url = a.getAttribute("href");
    a.onclick = (e) => {
      e.preventDefault();
      openImageModal(url);
    };
  });
};

/* ===== Calendar click â†’ filter trades ===== */
document.addEventListener("click", function(e) {
  const dayEl = e.target.closest(".calendar-day");
  if (!dayEl) return;

  const day = parseInt(dayEl.firstChild.textContent,10);
  if (!day) return;

  const { first } = getCalendarMonthRange(calendarMonthOffset);
  const y = first.getFullYear();
  const m = String(first.getMonth()+1).padStart(2,"0");
  const d = String(day).padStart(2,"0");
  const dateStr = `${y}-${m}-${d}`;

  const filtered = state.trades.filter(t => t.date === dateStr);
  if (!filtered.length) return;

  const body = document.getElementById("recentBody");
  body.innerHTML = "";
  filtered.forEach((t,i)=>{
    const tr=document.createElement("tr");
    [
      i+1,t.date,t.pair,t.direction,
      fmtR(t.pnlR),fmtUSD(t.pnlUSD),
      `${Math.round(t.disciplinePct||0)}%`,
      `${t.confluence?.overallPct||0}%`,
      t.screenshot?`<a href="${t.screenshot}">Open</a>`:"",
      (t.notes||"").replace(/</g,"&lt;")
    ].forEach(v=>{
      const td=document.createElement("td");
      td.innerHTML=v;
      tr.appendChild(td);
    });
    body.appendChild(tr);
  });
  body.scrollIntoView({behavior:"smooth"});
});
</script>

<!-- ================= GOOGLE SCRIPTS (UNCHANGED) ================= -->
<script src="https://accounts.google.com/gsi/client" async defer onload="gisLoaded()"></script>
<script src="https://apis.google.com/js/api.js" async defer onload="gapiLoaded()"></script>

</body>
</html>
