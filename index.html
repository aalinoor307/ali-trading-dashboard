<!DOCTYPE html>
<html lang="en">
<head> <link rel="manifest" href="manifest.json" />

  <meta charset="UTF-8" />
  <title>Ali's Trading System - Secure Web Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#020617" />

  <!-- Fonts & Chart.js -->
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
    rel="stylesheet"
  />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --bg: #020617;
      --bg-elevated: #020617;
      --accent: #f97316;
      --accent-soft: rgba(249, 115, 22, 0.16);
      --danger: #ef4444;
      --success: #22c55e;
      --text: #e5e7eb;
      --text-soft: #9ca3af;
      --muted: #64748b;
      --border: #1f2937;
      --card-radius: 18px;
    }

    /* Light mode palette */
    :root[data-theme="light"] {
      --bg: #f4f4f5;
      --bg-elevated: #ffffff;
      --accent: #ea580c;
      --accent-soft: rgba(234, 88, 12, 0.1);
      --danger: #dc2626;
      --success: #16a34a;
      --text: #020617;
      --text-soft: #4b5563;
      --muted: #6b7280;
      --border: #e5e7eb;
      --card-radius: 18px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #111827 45%, #020617 100%);
      color: var(--text);
      min-height: 100vh;
    }

    .app-shell {
      max-width: 1280px;
      margin: 0 auto;
      padding: 18px 16px 32px;
    }

    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 18px;
    }

    .top-left {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .app-title {
      font-size: 1.25rem;
      font-weight: 600;
      letter-spacing: 0.02em;
    }

    .app-subtitle {
      font-size: 0.8rem;
      color: var(--text-soft);
    }

    .top-right {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: flex-end;
    }

    .pill {
      font-size: 0.72rem;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.8);
      color: var(--text-soft);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .pill-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: #22c55e;
    }

    .btn-primary,
    .btn-secondary {
      border-radius: 999px;
      padding: 8px 14px;
      border: none;
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      transition: transform 0.08s ease, box-shadow 0.08s ease,
        background 0.12s;
    }

    .btn-primary {
      background: linear-gradient(135deg, #f97316, #fb923c);
      color: #0b1120;
      box-shadow: 0 12px 25px rgba(248, 113, 22, 0.45);
    }

    .btn-secondary {
      background: rgba(15, 23, 42, 0.85);
      color: var(--text-soft);
      border: 1px solid var(--border);
    }

    button:active,
    .btn-primary:active,
    .btn-secondary:active {
      transform: scale(0.97);
      box-shadow: 0 0 0 rgba(0, 0, 0, 0);
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #fb923c, #f97316);
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.2fr);
      gap: 16px;
    }

    @media (max-width: 960px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: radial-gradient(circle at top left, #020617, #020617 70%);
      border-radius: var(--card-radius);
      padding: 14px 14px 16px;
      border: 1px solid var(--border);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.75);
      position: relative;
      overflow: hidden;
      transition: transform 0.15s ease-out, box-shadow 0.15s ease-out,
        background 0.15s;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 20px 45px rgba(15, 23, 42, 0.85);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }

    .card-title {
      font-size: 0.9rem;
      font-weight: 600;
    }

    .card-subtitle {
      font-size: 0.75rem;
      color: var(--text-soft);
    }

    .field-group {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }

    @media (max-width: 720px) {
      .field-group {
        grid-template-columns: 1fr;
      }
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    label {
      font-size: 0.72rem;
      color: var(--text-soft);
    }

    input,
    select,
    textarea {
      background: rgba(15, 23, 42, 0.85);
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 6px 8px;
      font-size: 0.8rem;
      color: var(--text);
      outline: none;
    }

    input::placeholder,
    textarea::placeholder {
      color: #6b7280;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-soft);
    }

    textarea {
      min-height: 64px;
      resize: vertical;
    }

    .criteria-grid {
      margin-top: 10px;
      border-top: 1px solid var(--border);
      padding-top: 10px;
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }

    @media (max-width: 720px) {
      .criteria-grid {
        grid-template-columns: 1fr;
      }
    }

    .criterion {
      padding: 6px 7px;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(55, 65, 81, 0.9);
      display: flex;
      gap: 6px;
      align-items: flex-start;
      font-size: 0.75rem;
    }

    .criterion input[type="checkbox"] {
      margin-top: 2px;
    }

    .criterion-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .criterion-title {
      font-weight: 500;
    }

    .criterion-meta {
      font-size: 0.7rem;
      color: var(--text-soft);
    }

    .criterion-tag {
      font-size: 0.65rem;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid var(--border);
    }

    .criteria-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .small-muted {
      font-size: 0.7rem;
      color: var(--text-soft);
    }

    .btn-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 0.7rem;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.8);
      color: var(--text-soft);
    }

    .chip-dot-high {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: #22c55e;
    }

    .chip-dot-med {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: #facc15;
    }

    .chip-dot-low {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: #f97316;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
      margin-bottom: 10px;
    }

    @media (max-width: 720px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
    }

    .metric-card {
      padding: 6px 8px;
      border-radius: 14px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid var(--border);
    }

    .metric-label {
      font-size: 0.72rem;
      color: var(--text-soft);
      margin-bottom: 4px;
    }

    .metric-value {
      font-size: 1.05rem;
      font-weight: 600;
    }

    .metric-subtext {
      font-size: 0.7rem;
      color: var(--muted);
    }

    .chart-row {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr);
      gap: 8px;
      margin-bottom: 10px;
    }

    @media (max-width: 960px) {
      .chart-row {
        grid-template-columns: 1fr;
      }
    }

    .chart-container {
      padding: 10px 10px 8px;
      border-radius: 14px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid var(--border);
      animation: fadeInUp 0.35s ease-out;
    }

    .chart-title {
      font-size: 0.75rem;
      color: var(--text-soft);
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }

    .chart-legend {
      display: inline-flex;
      gap: 6px;
      font-size: 0.7rem;
      align-items: center;
    }

    .legend-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
    }

    .table-wrapper {
      margin-top: 8px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.95);
      overflow: auto;
      max-height: 260px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.72rem;
      min-width: 800px;
    }

    thead {
      position: sticky;
      top: 0;
      background: rgba(15, 23, 42, 0.98);
      z-index: 2;
    }

    th,
    td {
      padding: 6px 8px;
      border-bottom: 1px solid rgba(31, 41, 55, 0.9);
      text-align: left;
      white-space: nowrap;
    }

    th {
      font-weight: 500;
      color: var(--text-soft);
      font-size: 0.7rem;
    }

    tbody tr:nth-child(even) {
      background: rgba(15, 23, 42, 0.6);
    }

    .prob-pill {
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 0.7rem;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .prob-high {
      background: rgba(34, 197, 94, 0.12);
      color: #4ade80;
      border: 1px solid rgba(34, 197, 94, 0.5);
    }

    .prob-medium {
      background: rgba(250, 204, 21, 0.12);
      color: #fde68a;
      border: 1px solid rgba(250, 204, 21, 0.6);
    }

    .prob-low {
      background: rgba(248, 113, 22, 0.12);
      color: #fed7aa;
      border: 1px solid rgba(248, 113, 22, 0.6);
    }

    .filters-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
      align-items: center;
    }

    .filters-bar input,
    .filters-bar select {
      font-size: 0.7rem;
      padding: 4px 8px;
      border-radius: 999px;
    }

    .coach-card {
      margin-top: 10px;
      padding: 8px 10px;
      border-radius: 14px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid var(--border);
      font-size: 0.75rem;
      color: var(--text-soft);
    }

    .coach-title {
      font-size: 0.8rem;
      font-weight: 500;
      margin-bottom: 4px;
    }

    .settings-chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .settings-chip {
      font-size: 0.68rem;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px dashed var(--border);
      color: var(--text-soft);
      background: rgba(15, 23, 42, 0.7);
    }

    .footer-bar {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
      font-size: 0.7rem;
      color: var(--muted);
    }

    .export-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }

    .export-row button {
      font-size: 0.72rem;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-soft);
      cursor: pointer;
    }

    .export-row input[type="file"] {
      display: none;
    }

    .lock-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 0.72rem;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid var(--border);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .lock-badge span.dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: #22c55e;
    }

    /* Lock screen */
    .lock-screen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px 16px;
    }

    .lock-panel {
      width: 100%;
      max-width: 380px;
      padding: 20px 18px 18px;
      border-radius: 18px;
      border: 1px solid var(--border);
      background: radial-gradient(circle at top left, #020617, #020617 70%);
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.9);
    }

    .lock-title {
      font-size: 1.05rem;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .lock-text {
      font-size: 0.78rem;
      color: var(--text-soft);
      margin-bottom: 12px;
    }

    .lock-input-row {
      display: flex;
      gap: 8px;
    }

    .lock-input-row input {
      flex: 1;
    }

    .lock-footer {
      margin-top: 10px;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      font-size: 0.7rem;
      color: var(--muted);
      flex-wrap: wrap;
    }

    .link-like {
      color: var(--accent);
      cursor: pointer;
      text-decoration: underline;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(8px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>
<body>
  <!-- LOCK SCREEN (PIN) -->
  <div id="lock-root" class="lock-screen" style="display: none;">
    <div class="lock-panel">
      <div class="lock-title">Ali's Trading System</div>
      <div id="lock-mode-setup">
        <div class="lock-text">
          First-time setup. Create a PIN to protect your dashboard on this
          device.
        </div>
        <div class="lock-input-row">
          <input
            id="pin-setup-input"
            type="password"
            placeholder="4+ digits"
          />
          <button id="pin-setup-btn" class="btn-primary">Set PIN</button>
        </div>
      </div>

      <div id="lock-mode-login" style="display: none;">
        <div class="lock-text">
          Enter PIN to unlock your dashboard on this device.
        </div>
        <div class="lock-input-row">
          <input
            id="pin-login-input"
            type="password"
            placeholder="PIN"
          />
          <button id="pin-login-btn" class="btn-primary">Unlock</button>
        </div>
      </div>

      <div class="lock-footer">
        <span class="small-muted">
          PIN is stored locally only. Clearing browser data resets it.
        </span>
        <span id="lock-reset" class="link-like">Reset / forgot PIN</span>
      </div>
      <div id="lock-error" style="font-size:0.72rem;color:#fca5a5;margin-top:6px;"></div>
    </div>
  </div>

  <!-- MAIN APP -->
  <div id="app-root" style="display: none;">
    <div class="app-shell">
      <div class="top-bar">
        <div class="top-left">
          <div class="app-title">Ali's Trading System</div>
          <div class="app-subtitle">
            Probabilities â€¢ Discipline â€¢ R â€¢ Web-based execution journal
          </div>
        </div>
        <div class="top-right">
          <button id="theme-toggle" class="btn-secondary">ðŸŒ™ Dark</button>
          <button class="btn-secondary" id="lock-btn">Lock</button>
          <span class="pill">
            <span class="pill-dot"></span>
            <span id="autosave-status">Local session â€¢ Auto-backup every 10s</span>
          </span>
        </div>
      </div>

      <div class="layout">
        <!-- LEFT: NEW TRADE -->
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">New trade</div>
              <div class="card-subtitle">
                Fill the form, tick criteria, log trade. Scores &amp; probability
                are calculated automatically.
              </div>
            </div>
            <span class="chip">
              Checklist + Execution
            </span>
          </div>

          <div class="field-group">
            <div class="field">
              <label for="date">Date</label>
              <input id="date" type="date" />
            </div>
            <div class="field">
              <label for="pair">Pair</label>
              <input id="pair" type="text" placeholder="e.g. GBPUSD" />
            </div>
            <div class="field">
              <label for="direction">Direction</label>
              <select id="direction">
                <option value="">Select</option>
                <option>Buy</option>
                <option>Sell</option>
              </select>
            </div>
            <div class="field">
              <label for="setup">Setup</label>
              <select id="setup">
                <option value="">Select</option>
                <option>Breakout with momentum</option>
                <option>Retest continuation</option>
                <option>Range fade / reversal</option>
              </select>
            </div>
            <div class="field">
              <label for="risk">Risk per trade (R)</label>
              <input id="risk" type="number" step="0.01" placeholder="e.g. 1" />
            </div>
            <div class="field">
              <label for="rr-planned">R:R planned</label>
              <input
                id="rr-planned"
                type="number"
                step="0.1"
                placeholder="e.g. 2.5"
              />
            </div>
            <div class="field">
              <label for="rr-realized">R realized</label>
              <input
                id="rr-realized"
                type="number"
                step="0.01"
                placeholder="e.g. 1.8"
              />
            </div>
            <div class="field">
              <label for="session">Session</label>
              <select id="session">
                <option value="">Select</option>
                <option>London</option>
                <option>New York</option>
                <option>Asia</option>
              </select>
            </div>
            <div class="field">
              <label for="emotion">Emotion tag</label>
              <select id="emotion">
                <option value="">Select</option>
                <option>Calm</option>
                <option>Disciplined</option>
                <option>Confident</option>
                <option>Neutral</option>
                <option>FOMO</option>
                <option>Fearful</option>
                <option>Revenge</option>
                <option>Over-confident</option>
              </select>
            </div>
            <div class="field">
              <label for="screenshot">Screenshot / chart link</label>
              <input
                id="screenshot"
                type="url"
                placeholder="Paste TradingView / chart link"
              />
            </div>
            <div class="field">
              <label for="tags">Tags (comma-separated)</label>
              <input
                id="tags"
                type="text"
                placeholder="e.g. London open, news, A+"
              />
            </div>
          </div>

          <div class="field" style="margin-top:8px;">
            <label for="notes">Journal notes</label>
            <textarea
              id="notes"
              placeholder="What did you do well? What can you improve?"
            ></textarea>
          </div>

          <!-- Criteria -->
          <div class="criteria-grid">
            <label style="grid-column:1/-1;font-size:0.75rem;color:var(--text-soft);">
              Breakout / candle criteria (weighted). Tick only what was actually met.
            </label>

            <div class="criterion">
              <input type="checkbox" data-weight="2" class="crit-check" id="crit1" />
              <div class="criterion-main">
                <span class="criterion-title">Clean close at level</span>
                <span class="criterion-meta"
                  >No big wicks both sides â€¢ weight 2</span
                >
              </div>
            </div>

            <div class="criterion">
              <input type="checkbox" data-weight="2" class="crit-check" id="crit2" />
              <div class="criterion-main">
                <span class="criterion-title">No long wick against direction</span>
                <span class="criterion-meta"
                  >Wick profile matches bias â€¢ weight 2</span
                >
              </div>
            </div>

            <div class="criterion">
              <input type="checkbox" data-weight="1" class="crit-check" id="crit3" />
              <div class="criterion-main">
                <span class="criterion-title">Structure matches plan</span>
                <span class="criterion-meta"
                  >Story + higher TF aligned â€¢ weight 1</span
                >
              </div>
            </div>

            <div class="criterion">
              <input type="checkbox" data-weight="1" class="crit-check" id="crit4" />
              <div class="criterion-main">
                <span class="criterion-title">Not after huge candle</span>
                <span class="criterion-meta"
                  >Avoid chasing exhaustion moves â€¢ weight 1</span
                >
              </div>
            </div>

            <div class="criterion">
              <input type="checkbox" data-weight="2" class="crit-check" id="crit5" />
              <div class="criterion-main">
                <span class="criterion-title">No flat / no-wick close</span>
                <span class="criterion-meta"
                  >Entry candle prints wick first then flips â€¢ weight 2</span
                >
              </div>
            </div>

            <div class="criterion">
              <input type="checkbox" data-weight="2" class="crit-check" id="crit6" />
              <div class="criterion-main">
                <span class="criterion-title">Wick first, then flip entry</span>
                <span class="criterion-meta"
                  >Classic flip entry behaviour â€¢ weight 2</span
                >
              </div>
            </div>
          </div>

          <div class="criteria-footer">
            <div class="small-muted" id="criteria-summary">
              0 / 10 weighted points selected.
            </div>
            <div class="btn-row">
              <button id="add-trade-btn" class="btn-primary">
                + Add trade to log
              </button>
              <button id="clear-form-btn" class="btn-secondary">
                Clear form
              </button>
            </div>
          </div>

          <div class="settings-chip-row">
            <span class="settings-chip">Weighted checklist</span>
            <span class="settings-chip">Auto-score</span>
            <span class="settings-chip">JSON / CSV export</span>
            <span class="settings-chip">Local auto-backup</span>
          </div>
        </div>

        <!-- RIGHT: DASHBOARD -->
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Dashboard</div>
              <div class="card-subtitle">
                Live performance breakdown, probability &amp; behaviour tracking.
              </div>
            </div>
            <span class="chip">Auto-updated from left panel</span>
          </div>

          <div class="dashboard-grid">
            <div class="metric-card">
              <div class="metric-label">Win rate</div>
              <div class="metric-value" id="winrate-text">0.0%</div>
              <div class="metric-subtext" id="winrate-subtext">0 trades</div>
            </div>

            <div class="metric-card">
              <div class="metric-label">Avg R (realized)</div>
              <div class="metric-value" id="avgR-text">0.00R</div>
              <div class="metric-subtext" id="avgR-subtext">Equity: 0.00R</div>
            </div>

            <div class="metric-card">
              <div class="metric-label">Discipline score</div>
              <div class="metric-value" id="disc-text">0</div>
              <div class="metric-subtext" id="disc-subtext">No trades yet</div>
            </div>
          </div>

          <div class="chart-row">
            <div class="chart-container">
              <div class="chart-title">
                <span>High vs low probability</span>
                <span class="chart-legend">
                  <span class="legend-dot" style="background:#22c55e;"></span
                  >High
                  <span class="legend-dot" style="background:#facc15;"></span
                  >Medium
                  <span class="legend-dot" style="background:#f97316;"></span
                  >Low
                </span>
              </div>
              <canvas id="prob-chart" height="140"></canvas>
            </div>

            <div class="chart-container">
              <div class="chart-title">
                <span>Equity curve (R)</span>
                <span id="equity-summary" style="font-size:0.7rem;color:var(--text-soft);">
                  0.00R total
                </span>
              </div>
              <canvas id="equity-chart" height="140"></canvas>
            </div>
          </div>

          <div class="chart-row">
            <div class="chart-container">
              <div class="chart-title">
                <span>Probability history</span>
                <span style="font-size:0.7rem;color:var(--text-soft);">
                  1=Low â€¢ 2=Medium â€¢ 3=High
                </span>
              </div>
              <canvas id="prob-history-chart" height="90"></canvas>
            </div>

            <div class="chart-container">
              <div class="chart-title">
                <span>Most common mistakes (last 30 trades)</span>
                <span style="font-size:0.7rem;color:var(--text-soft);" id="mistake-count">
                  None yet
                </span>
              </div>
              <div id="mistake-list" style="font-size:0.74rem;color:var(--text-soft);">
                No mistakes logged yet. Tag emotions &amp; write notes to see patterns.
              </div>
            </div>
          </div>

          <div class="coach-card">
            <div class="coach-title">Coachâ€™s feedback</div>
            <div id="ai-coach-text">
              Log a trade to see feedback based on probability, discipline and emotional tags.
            </div>
          </div>

          <div style="margin-top:10px;">
            <div class="chart-title" style="margin-bottom:4px;">
              <span>Trade log</span>
              <span style="font-size:0.7rem;color:var(--text-soft);">
                Based on filters, tags &amp; date range.
              </span>
            </div>
            <div class="filters-bar">
              <input
                id="filter-text"
                type="text"
                placeholder="Filter by tag, pair, setup or notesâ€¦"
              />
              <select id="filter-prob">
                <option value="">All probabilities</option>
                <option value="High">High only</option>
                <option value="Medium">Medium only</option>
                <option value="Low">Low only</option>
              </select>
              <input id="filter-from" type="date" />
              <input id="filter-to" type="date" />
              <button id="filter-clear" class="btn-secondary" style="padding:4px 10px;">
                Clear filters
              </button>
            </div>

            <div class="table-wrapper">
              <table id="trades-table">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Date</th>
                    <th>Pair</th>
                    <th>Dir</th>
                    <th>Setup</th>
                    <th>Prob</th>
                    <th>Score</th>
                    <th>R planned</th>
                    <th>R realized</th>
                    <th>Run R</th>
                    <th>Session</th>
                    <th>Emotion</th>
                    <th>Discipline</th>
                    <th>Tags</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <div class="footer-bar">
            <div class="export-row">
              <button id="export-json-btn">Export JSON</button>
              <button id="export-csv-btn">Export CSV</button>

              <label class="btn-secondary" style="padding:4px 10px;cursor:pointer;">
                Import JSON
                <input id="import-json-input" type="file" accept=".json" />
              </label>
            </div>

            <div style="max-width:320px;">
              Save this file somewhere easy to open. You can host it on Netlify /
              Vercel / GitHub Pages (like now) to access it from anywhere.
            </div>
          </div>

          <!-- Telegram (optional) -->
          <div class="coach-card" style="margin-top:10px;">
            <div class="coach-title">Notifications (optional)</div>
            <div class="small-muted" style="margin-bottom:6px;">
              Add a Telegram bot token + chat ID to receive a message each time
              you log a new trade. Data goes straight from your browser to Telegram.
            </div>
            <div class="field-group">
              <div class="field" style="flex:1 1 50%;">
                <label>
                  <input type="checkbox" id="notify-telegram" />
                  Enable Telegram alert on new trade
                </label>
              </div>
              <div class="field">
                <label for="tg-token">Telegram bot token</label>
                <input id="tg-token" type="password" placeholder="123456:ABC-DEF..." />
              </div>
              <div class="field">
                <label for="tg-chat">Telegram chat ID</label>
                <input id="tg-chat" type="text" placeholder="Your chat ID" />
              </div>
            </div>
          </div>
        </div>
      </div>

      <div style="margin-top:10px;font-size:0.7rem;color:var(--muted);text-align:center;">
        upgrade v2 â€¢ client-side only â€¢ PIN + local backup â€¢ hosted on GitHub Pages
      </div>
    </div>
  </div>

  <script>
    // ---------- THEME ----------
    (function () {
      const root = document.documentElement;
      const btn = document.getElementById("theme-toggle");
      if (!btn) return;

      const STORAGE_KEY = "aliTheme";

      function applyTheme(theme) {
        if (theme === "light") {
          root.setAttribute("data-theme", "light");
          btn.textContent = "â˜€ï¸ Light";
        } else {
          root.removeAttribute("data-theme");
          btn.textContent = "ðŸŒ™ Dark";
          theme = "dark";
        }
        localStorage.setItem(STORAGE_KEY, theme);
      }

      const saved = localStorage.getItem(STORAGE_KEY);
      applyTheme(saved || "dark");

      btn.addEventListener("click", () => {
        const current = localStorage.getItem(STORAGE_KEY) || "dark";
        applyTheme(current === "dark" ? "light" : "dark");
      });
    })();

    // ---------- PIN LOCK ----------
    (function () {
      const PIN_KEY = "aliPin";
      const lockRoot = document.getElementById("lock-root");
      const appRoot = document.getElementById("app-root");
      const setupMode = document.getElementById("lock-mode-setup");
      const loginMode = document.getElementById("lock-mode-login");
      const setupInput = document.getElementById("pin-setup-input");
      const setupBtn = document.getElementById("pin-setup-btn");
      const loginInput = document.getElementById("pin-login-input");
      const loginBtn = document.getElementById("pin-login-btn");
      const lockError = document.getElementById("lock-error");
      const lockReset = document.getElementById("lock-reset");
      const lockBtn = document.getElementById("lock-btn");

      function showLock() {
        appRoot.style.display = "none";
        lockRoot.style.display = "flex";
        const stored = localStorage.getItem(PIN_KEY);
        if (stored) {
          setupMode.style.display = "none";
          loginMode.style.display = "block";
        } else {
          setupMode.style.display = "block";
          loginMode.style.display = "none";
        }
      }

      function unlock() {
        lockRoot.style.display = "none";
        appRoot.style.display = "block";
      }

      setupBtn.addEventListener("click", () => {
        const v = (setupInput.value || "").trim();
        if (v.length < 4) {
          lockError.textContent = "PIN must be at least 4 digits.";
          return;
        }
        localStorage.setItem(PIN_KEY, v);
        setupInput.value = "";
        lockError.textContent = "";
        unlock();
      });

      loginBtn.addEventListener("click", () => {
        const v = (loginInput.value || "").trim();
        const stored = localStorage.getItem(PIN_KEY);
        if (!stored) {
          lockError.textContent = "No PIN stored. Use reset and set a new one.";
          return;
        }
        if (v !== stored) {
          lockError.textContent = "Incorrect PIN.";
          return;
        }
        loginInput.value = "";
        lockError.textContent = "";
        unlock();
      });

      lockReset.addEventListener("click", () => {
        if (
          confirm(
            "Reset PIN and clear all locally stored trades? This cannot be undone."
          )
        ) {
          localStorage.removeItem(PIN_KEY);
          localStorage.removeItem("aliTrades");
          localStorage.removeItem("aliSettings");
          window.location.reload();
        }
      });

      lockBtn.addEventListener("click", () => {
        showLock();
      });

      // on load
      const stored = localStorage.getItem(PIN_KEY);
      if (stored) {
        showLock();
      } else {
        showLock();
      }
    })();

    // ---------- TRADING LOG + DASHBOARD ----------
    (function () {
      const STORAGE_KEY = "aliTrades";
      const SETTINGS_KEY = "aliSettings";

      let trades = [];
      let filteredTrades = [];

      // Charts
      let probChart, equityChart, probHistoryChart;

      const autosaveStatus = document.getElementById("autosave-status");

      // Inputs
      const dateEl = document.getElementById("date");
      const pairEl = document.getElementById("pair");
      const directionEl = document.getElementById("direction");
      const setupEl = document.getElementById("setup");
      const riskEl = document.getElementById("risk");
      const rrPlannedEl = document.getElementById("rr-planned");
      const rrRealizedEl = document.getElementById("rr-realized");
      const sessionEl = document.getElementById("session");
      const emotionEl = document.getElementById("emotion");
      const screenshotEl = document.getElementById("screenshot");
      const tagsEl = document.getElementById("tags");
      const notesEl = document.getElementById("notes");
      const critChecks = Array.from(document.querySelectorAll(".crit-check"));
      const criteriaSummary = document.getElementById("criteria-summary");

      const addTradeBtn = document.getElementById("add-trade-btn");
      const clearFormBtn = document.getElementById("clear-form-btn");

      const winrateText = document.getElementById("winrate-text");
      const winrateSub = document.getElementById("winrate-subtext");
      const avgRText = document.getElementById("avgR-text");
      const avgRSub = document.getElementById("avgR-subtext");
      const discText = document.getElementById("disc-text");
      const discSub = document.getElementById("disc-subtext");
      const equitySummary = document.getElementById("equity-summary");

      const probChartEl = document.getElementById("prob-chart");
      const equityChartEl = document.getElementById("equity-chart");
      const probHistoryChartEl = document.getElementById("prob-history-chart");

      const tableBody = document.querySelector("#trades-table tbody");

      const filterTextEl = document.getElementById("filter-text");
      const filterProbEl = document.getElementById("filter-prob");
      const filterFromEl = document.getElementById("filter-from");
      const filterToEl = document.getElementById("filter-to");
      const filterClearBtn = document.getElementById("filter-clear");

      const mistakeListEl = document.getElementById("mistake-list");
      const mistakeCountEl = document.getElementById("mistake-count");
      const coachTextEl = document.getElementById("ai-coach-text");

      const exportJsonBtn = document.getElementById("export-json-btn");
      const exportCsvBtn = document.getElementById("export-csv-btn");
      const importJsonInput = document.getElementById("import-json-input");

      const notifyTelegramEl = document.getElementById("notify-telegram");
      const tgTokenEl = document.getElementById("tg-token");
      const tgChatEl = document.getElementById("tg-chat");

      // --- Helpers ---
      function loadTrades() {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        try {
          return JSON.parse(raw);
        } catch (e) {
          console.error("Failed to parse trades", e);
          return [];
        }
      }

      function saveTrades() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(trades));
      }

      function loadSettings() {
        const raw = localStorage.getItem(SETTINGS_KEY);
        if (!raw) return {};
        try {
          return JSON.parse(raw);
        } catch (e) {
          return {};
        }
      }

      function saveSettings() {
        const settings = {
          notifyTelegram: notifyTelegramEl.checked,
          tgToken: tgTokenEl.value,
          tgChat: tgChatEl.value,
        };
        localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
      }

      function updateCriteriaSummary() {
        const max = critChecks.reduce(
          (sum, c) => sum + Number(c.dataset.weight || 0),
          0
        );
        const used = critChecks
          .filter((c) => c.checked)
          .reduce((sum, c) => sum + Number(c.dataset.weight || 0), 0);
        criteriaSummary.textContent = `${used} / ${max} weighted points selected.`;
      }

      critChecks.forEach((c) =>
        c.addEventListener("change", updateCriteriaSummary)
      );
      updateCriteriaSummary();

      // Load initial data
      trades = loadTrades();
      filteredTrades = [...trades];

      // Load settings
      (function initSettings() {
        const s = loadSettings();
        if (s.notifyTelegram) notifyTelegramEl.checked = true;
        if (s.tgToken) tgTokenEl.value = s.tgToken;
        if (s.tgChat) tgChatEl.value = s.tgChat;
      })();

      notifyTelegramEl.addEventListener("change", saveSettings);
      tgTokenEl.addEventListener("input", saveSettings);
      tgChatEl.addEventListener("input", saveSettings);

      // Autosave indicator
      setInterval(() => {
        saveTrades();
        autosaveStatus.textContent = "Local session â€¢ Last autosave: " + new Date().toLocaleTimeString();
      }, 10000);

      // --- Metrics + probability ---
      function getProbabilityLabel(score, maxScore) {
        if (!maxScore) return "Low";
        const pct = score / maxScore;
        if (pct >= 0.8) return "High";
        if (pct >= 0.5) return "Medium";
        return "Low";
      }

      function calcDisciplineScore(trade) {
        // Base is criteria percentage * 70
        const base = (trade.criteriaScore / trade.criteriaMax) * 70;

        let bonus = 0;
        switch (trade.emotion) {
          case "Calm":
          case "Disciplined":
            bonus += 15;
            break;
          case "Confident":
            bonus += 10;
            break;
          case "Neutral":
            bonus += 5;
            break;
          case "FOMO":
            bonus -= 10;
            break;
          case "Fearful":
            bonus -= 5;
            break;
          case "Revenge":
            bonus -= 20;
            break;
        }

        switch (trade.session) {
          case "London":
            bonus += 5;
            break;
          case "New York":
            bonus += 5;
            break;
          case "Asia":
            bonus -= 5;
            break;
        }

        if (trade.tags && trade.tags.some((t) => t.toLowerCase().includes("overlap"))) {
          bonus -= 10;
        }

        let score = base + bonus;
        if (trade.Rrealized < -3) score -= 10;
        if (!Number.isFinite(score)) score = 0;
        return Math.max(0, Math.min(100, Math.round(score)));
      }

      // --- Coach feedback ---
      function generateCoachFeedback(trade) {
        const msgs = [];

        if (trade.probabilityLabel === "Low" && trade.Rrealized > 0) {
          msgs.push(
            "You made money on a low-probability setup. Good outcome, but don't let this trick your brain into always taking lower quality trades."
          );
        }

        if (trade.probabilityLabel === "Low" && trade.Rrealized <= 0) {
          msgs.push(
            "Loss on low-probability setup. That's expected. Tighten your selection and focus on A/B quality trades only."
          );
        }

        if (trade.probabilityLabel === "High" && trade.Rrealized < 0) {
          msgs.push(
            "You took a high-quality setup that lost. This is normal. The edge plays out over many trades as long as the execution stays consistent."
          );
        }

        if (trade.disciplineScore >= 80 && trade.Rrealized <= 0) {
          msgs.push(
            "High discipline on a losing trade. This is exactly the behavior that builds long-term growth. Reward yourself for following process, not outcome."
          );
        }

        if (trade.disciplineScore < 50) {
          msgs.push(
            "Discipline score is low. Review which rules you skipped and why. Consider journaling the trigger that pulled you into this trade."
          );
        }

        if (trade.emotion === "FOMO") {
          msgs.push(
            "You tagged this as FOMO. Ask: 'If I see this exact setup tomorrow, under my rules, would I still take it?' If not, it's outside your plan."
          );
        }

        if (!msgs.length) {
          msgs.push(
            "Solid execution. Keep repeating this playbook and let the numbers compound. Your only job is to show up and follow the rules."
          );
        }

        return msgs.join(" ");
      }

      // --- Telegram alert ---
      async function sendTelegramAlert(trade) {
        const enabled = notifyTelegramEl.checked;
        if (!enabled) return;

        const token = tgTokenEl.value.trim();
        const chat = tgChatEl.value.trim();
        if (!token || !chat) return;

        const text =
          `New trade logged:\n` +
          `${trade.date} ${trade.pair} ${trade.direction}\n` +
          `Setup: ${trade.setup}\n` +
          `Planned R:R: ${trade.Rplanned}, Realized: ${trade.Rrealized}R\n` +
          `Prob: ${trade.probabilityLabel}, Disc: ${trade.disciplineScore}`;

        const url = `https://api.telegram.org/bot${token}/sendMessage`;
        try {
          await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ chat_id: chat, text }),
          });
        } catch (e) {
          console.error("Telegram error", e);
        }
      }

      // --- Rendering ---
      function computeRunningR(tradesArr) {
        let sum = 0;
        return tradesArr.map((t) => {
          sum += t.Rrealized;
          return sum;
        });
      }

      function renderTable(data) {
        tableBody.innerHTML = "";
        const running = computeRunningR(data);

        data.forEach((t, idx) => {
          const tr = document.createElement("tr");

          const cells = [
            idx + 1,
            t.date || "",
            t.pair || "",
            t.direction || "",
            t.setup || "",
          ];

          cells.forEach((v) => {
            const td = document.createElement("td");
            td.textContent = v;
            tr.appendChild(td);
          });

          // Prob pill
          const probTd = document.createElement("td");
          const span = document.createElement("span");
          span.classList.add("prob-pill");
          span.textContent = t.probabilityLabel || "Low";
          if (t.probabilityLabel === "High") span.classList.add("prob-high");
          else if (t.probabilityLabel === "Medium")
            span.classList.add("prob-medium");
          else span.classList.add("prob-low");
          probTd.appendChild(span);
          tr.appendChild(probTd);

          const scoreTd = document.createElement("td");
          const pct = t.criteriaMax
            ? Math.round((t.criteriaScore / t.criteriaMax) * 100)
            : 0;
          scoreTd.textContent = `${pct}%`;
          tr.appendChild(scoreTd);

          const plannedTd = document.createElement("td");
          plannedTd.textContent = t.Rplanned != null ? t.Rplanned.toFixed(1) : "";
          tr.appendChild(plannedTd);

          const realizedTd = document.createElement("td");
          realizedTd.textContent =
            t.Rrealized != null ? t.Rrealized.toFixed(2) : "";
          tr.appendChild(realizedTd);

          const runTd = document.createElement("td");
          runTd.textContent = running[idx].toFixed(2);
          tr.appendChild(runTd);

          const sessionTd = document.createElement("td");
          sessionTd.textContent = t.session || "";
          tr.appendChild(sessionTd);

          const emoTd = document.createElement("td");
          emoTd.textContent = t.emotion || "";
          tr.appendChild(emoTd);

          const discTd = document.createElement("td");
          discTd.textContent =
            t.disciplineScore != null ? t.disciplineScore.toString() : "";
          tr.appendChild(discTd);

          const tagsTd = document.createElement("td");
          tagsTd.textContent = (t.tags || []).join(", ");
          tr.appendChild(tagsTd);

          tableBody.appendChild(tr);
        });
      }

      function updateSummaryCards(data) {
        const total = data.length;
        if (!total) {
          winrateText.textContent = "0.0%";
          winrateSub.textContent = "0 trades";
          avgRText.textContent = "0.00R";
          avgRSub.textContent = "Equity: 0.00R";
          discText.textContent = "0";
          discSub.textContent = "No trades yet";
          equitySummary.textContent = "0.00R total";
          return;
        }

        const wins = data.filter((t) => t.Rrealized > 0).length;
        const winrate = (wins / total) * 100;
        const avgR =
          data.reduce((sum, t) => sum + (t.Rrealized || 0), 0) / total;
        const equity = data.reduce((sum, t) => sum + (t.Rrealized || 0), 0);
        const avgDisc =
          data.reduce((sum, t) => sum + (t.disciplineScore || 0), 0) / total;

        winrateText.textContent = winrate.toFixed(1) + "%";
        winrateSub.textContent = `${total} trade${total === 1 ? "" : "s"}`;
        avgRText.textContent = avgR.toFixed(2) + "R";
        avgRSub.textContent = "Equity: " + equity.toFixed(2) + "R";
        discText.textContent = Math.round(avgDisc).toString();
        discSub.textContent = "Avg. discipline score";
        equitySummary.textContent = equity.toFixed(2) + "R total";
      }

      function updateProbChart(data) {
        const counts = { High: 0, Medium: 0, Low: 0 };
        data.forEach((t) => {
          counts[t.probabilityLabel || "Low"]++;
        });

        const values = [counts.High, counts.Medium, counts.Low];

        if (probChart) probChart.destroy();
        probChart = new Chart(probChartEl, {
          type: "doughnut",
          data: {
            labels: ["High", "Medium", "Low"],
            datasets: [
              {
                data: values,
                backgroundColor: ["#22c55e", "#facc15", "#f97316"],
                borderWidth: 0,
              },
            ],
          },
          options: {
            cutout: "65%",
            plugins: {
              legend: {
                display: false,
              },
            },
          },
        });
      }

      function updateEquityChart(data) {
        const labels = data.map((t, i) => "#" + (i + 1));
        const equity = computeRunningR(data);

        if (equityChart) equityChart.destroy();
        equityChart = new Chart(equityChartEl, {
          type: "line",
          data: {
            labels,
            datasets: [
              {
                label: "Equity (R)",
                data: equity,
                tension: 0.25,
                pointRadius: 3,
              },
            ],
          },
          options: {
            plugins: {
              legend: { display: false },
            },
            scales: {
              x: {
                display: true,
                ticks: { maxRotation: 0 },
              },
              y: {
                display: true,
              },
            },
          },
        });
      }

      function updateProbHistoryChart(data) {
        const sorted = [...data].sort((a, b) =>
          (a.date || "").localeCompare(b.date || "")
        );
        const labels = sorted.map((t, i) => "#" + (i + 1));
        const values = sorted.map((t) => {
          if (t.probabilityLabel === "High") return 3;
          if (t.probabilityLabel === "Medium") return 2;
          return 1;
        });

        if (probHistoryChart) probHistoryChart.destroy();
        probHistoryChart = new Chart(probHistoryChartEl, {
          type: "line",
          data: {
            labels,
            datasets: [
              {
                label: "Probability level",
                data: values,
                tension: 0.3,
                pointRadius: 4,
              },
            ],
          },
          options: {
            plugins: { legend: { display: false } },
            scales: {
              y: {
                min: 1,
                max: 3,
                ticks: {
                  stepSize: 1,
                  callback: (v) =>
                    ({ 1: "Low", 2: "Med", 3: "High" }[v] || v),
                },
              },
            },
          },
        });
      }

      function updateMistakes(data) {
        if (!data.length) {
          mistakeListEl.textContent =
            "No mistakes logged yet. Tag emotions & write notes to see patterns.";
          mistakeCountEl.textContent = "None yet";
          return;
        }

        const map = {};
        data.forEach((t) => {
          const emo = (t.emotion || "").toLowerCase();
          if (!emo) return;
          map[emo] = (map[emo] || 0) + 1;
        });

        const entries = Object.entries(map)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 5);

        if (!entries.length) {
          mistakeListEl.textContent =
            "No emotion tags yet. Start tagging to see behaviour patterns.";
          mistakeCountEl.textContent = "0";
          return;
        }

        mistakeCountEl.textContent = `${entries.length} emotions`;
        mistakeListEl.innerHTML = entries
          .map(
            ([emo, count]) =>
              `<div>${emo} <span style="color:var(--text-soft);">â€¢ ${count} trade(s)</span></div>`
          )
          .join("");
      }

      function applyFilters() {
        const text = filterTextEl.value.trim().toLowerCase();
        const prob = filterProbEl.value;
        const from = filterFromEl.value;
        const to = filterToEl.value;

        filteredTrades = trades.filter((t) => {
          const haystack = [
            t.pair,
            t.setup,
            t.emotion,
            t.session,
            t.notes,
            (t.tags || []).join(" "),
          ]
            .join(" ")
            .toLowerCase();

          if (text && !haystack.includes(text)) return false;

          if (prob && t.probabilityLabel !== prob) return false;

          if (from && (!t.date || t.date < from)) return false;
          if (to && (!t.date || t.date > to)) return false;

          return true;
        });

        renderAll();
      }

      function renderAll() {
        renderTable(filteredTrades);
        updateSummaryCards(filteredTrades);
        updateProbChart(filteredTrades);
        updateEquityChart(filteredTrades);
        updateProbHistoryChart(filteredTrades);
        updateMistakes(filteredTrades);
      }

      filterTextEl.addEventListener("input", applyFilters);
      filterProbEl.addEventListener("change", applyFilters);
      filterFromEl.addEventListener("change", applyFilters);
      filterToEl.addEventListener("change", applyFilters);
      filterClearBtn.addEventListener("click", () => {
        filterTextEl.value = "";
        filterProbEl.value = "";
        filterFromEl.value = "";
        filterToEl.value = "";
        filteredTrades = [...trades];
        renderAll();
      });

      // Initial render
      filteredTrades = [...trades];
      renderAll();

      // Date default today
      if (!dateEl.value) {
        const today = new Date().toISOString().slice(0, 10);
        dateEl.value = today;
      }

      function clearForm() {
        pairEl.value = "";
        directionEl.value = "";
        setupEl.value = "";
        riskEl.value = "";
        rrPlannedEl.value = "";
        rrRealizedEl.value = "";
        sessionEl.value = "";
        emotionEl.value = "";
        screenshotEl.value = "";
        tagsEl.value = "";
        notesEl.value = "";
        critChecks.forEach((c) => (c.checked = false));
        updateCriteriaSummary();
      }

      clearFormBtn.addEventListener("click", clearForm);

      addTradeBtn.addEventListener("click", () => {
        const date = dateEl.value || new Date().toISOString().slice(0, 10);
        const pair = pairEl.value.trim();
        const direction = directionEl.value;
        const setup = setupEl.value;
        const risk = Number(riskEl.value) || 0;
        const Rplanned = Number(rrPlannedEl.value) || 0;
        const Rrealized = Number(rrRealizedEl.value) || 0;
        const session = sessionEl.value;
        const emotion = emotionEl.value;
        const screenshot = screenshotEl.value.trim();
        const tags = tagsEl.value
          .split(",")
          .map((t) => t.trim())
          .filter(Boolean);
        const notes = notesEl.value.trim();

        const criteriaMax = critChecks.reduce(
          (sum, c) => sum + Number(c.dataset.weight || 0),
          0
        );
        const criteriaScore = critChecks
          .filter((c) => c.checked)
          .reduce((sum, c) => sum + Number(c.dataset.weight || 0), 0);

        const probabilityLabel = getProbabilityLabel(criteriaScore, criteriaMax);

        const trade = {
          id: Date.now(),
          date,
          pair,
          direction,
          setup,
          risk,
          Rplanned,
          Rrealized,
          session,
          emotion,
          screenshot,
          tags,
          notes,
          criteriaScore,
          criteriaMax,
          probabilityLabel,
        };

        trade.disciplineScore = calcDisciplineScore(trade);

        trades.push(trade);
        saveTrades();

        filteredTrades = [...trades];
        renderAll();

        if (coachTextEl) {
          coachTextEl.textContent = generateCoachFeedback(trade);
        }

        sendTelegramAlert(trade);

        clearForm();
      });

      // --- Export / Import ---
      exportJsonBtn.addEventListener("click", () => {
        const blob = new Blob([JSON.stringify(trades, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "ali_trading_journal.json";
        a.click();
        URL.revokeObjectURL(url);
      });

      exportCsvBtn.addEventListener("click", () => {
        const headers = [
          "date",
          "pair",
          "direction",
          "setup",
          "probabilityLabel",
          "criteriaScore",
          "criteriaMax",
          "Rplanned",
          "Rrealized",
          "session",
          "emotion",
          "disciplineScore",
          "tags",
          "notes",
        ];

        const rows = trades.map((t) =>
          headers
            .map((h) => {
              let v = t[h];
              if (h === "tags") v = (t.tags || []).join(";");
              if (v == null) v = "";
              const s = String(v).replace(/"/g, '""');
              return `"${s}"`;
            })
            .join(",")
        );

        const csv = [headers.join(","), ...rows].join("\n");
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "ali_trading_journal.csv";
        a.click();
        URL.revokeObjectURL(url);
      });

      importJsonInput.addEventListener("change", (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (evt) => {
          try {
            const data = JSON.parse(evt.target.result);
            if (!Array.isArray(data)) throw new Error("Invalid JSON");
            trades = data;
            saveTrades();
            filteredTrades = [...trades];
            renderAll();
            alert("Trades imported successfully.");
          } catch (err) {
            alert("Failed to import JSON: " + err.message);
          }
        };
        reader.readAsText(file);
        importJsonInput.value = "";
      });
    })();
  </script>
</body>
</html>
{
  "name": "Ali's Trading System",
  "short_name": "Ali Trading",
  "start_url": "/ali-trading-dashboard/",
  "display": "standalone",
  "background_color": "#020617",
  "theme_color": "#020617",
  "icons": [
    {
      "src": "icon-192.png",
      "sizes": "192x192",
      "type": "image/png"
    },
    {
      "src": "icon-512.png",
      "sizes": "512x512",
      "type": "image/png"
    }
  ]
}
const CACHE_NAME = "ali-trading-cache-v1";
const OFFLINE_URLS = ["/ali-trading-dashboard/"];

self.addEventListener("install", (event) => {
  event.waitUntil(
    caches.open(CACHE_NAME).then((cache) => cache.addAll(OFFLINE_URLS))
  );
});

self.addEventListener("fetch", (event) => {
  event.respondWith(
    caches.match(event.request).then((res) => res || fetch(event.request))
  );
});
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js").catch(console.error);
}
