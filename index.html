<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ali's Trading System - PnL & Weekly / Monthly Stats</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Fonts & Chart.js -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --bg: #020617;
      --bg-elevated: #020617;
      --accent: #f97316;
      --accent-soft: rgba(249, 115, 22, 0.12);
      --danger: #ef4444;
      --success: #22c55e;
      --text: #e5e7eb;
      --text-soft: #9ca3af;
      --muted: #64748b;
      --border: #1f2937;
      --card-radius: 18px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #111827 40%, #020617 100%);
      color: var(--text);
    }

    .app {
      min-height: 100vh;
      padding: 20px 16px 40px;
      max-width: 1280px;
      margin: 0 auto;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 18px;
    }

    .title-block h1 {
      font-size: 1.5rem;
      margin: 0 0 4px;
    }

    .subtitle {
      font-size: 0.8rem;
      color: var(--text-soft);
    }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .pill {
      font-size: 0.72rem;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-soft);
    }

    .top-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .chip {
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 0.75rem;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.95);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: var(--text-soft);
    }

    .chip-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--success);
    }

    .btn-icon {
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 0.75rem;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-soft);
      cursor: pointer;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 0.9fr) minmax(0, 1.1fr);
      gap: 16px;
    }

    .card {
      background: rgba(15, 23, 42, 0.98);
      border-radius: var(--card-radius);
      border: 1px solid rgba(15, 23, 42, 0.9);
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.65);
      padding: 14px 16px 16px;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
    }

    .card-title {
      font-size: 0.85rem;
      font-weight: 600;
    }

    .section-label {
      font-size: 0.7rem;
      color: var(--text-soft);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 8px;
    }

    .field-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      margin-bottom: 10px;
    }

    label {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.75rem;
      color: var(--text-soft);
    }

    input[type="text"],
    input[type="number"],
    input[type="date"],
    select,
    textarea {
      background: #020617;
      border-radius: 10px;
      border: 1px solid #111827;
      padding: 7px 9px;
      font-size: 0.78rem;
      color: var(--text);
      outline: none;
      width: 100%;
    }

    input::placeholder,
    textarea::placeholder {
      color: #4b5563;
    }

    textarea {
      resize: vertical;
      min-height: 56px;
      max-height: 120px;
    }

    .criteria-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 6px;
      margin-bottom: 9px;
    }

    .criterion {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid #111827;
      background: rgba(15, 23, 42, 0.95);
    }

    .criterion-left {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.75rem;
    }

    .criterion input[type="checkbox"] {
      accent-color: var(--accent);
      width: 13px;
      height: 13px;
    }

    .badge {
      font-size: 0.7rem;
      padding: 2px 7px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: #fed7aa;
      border: 1px solid rgba(251, 146, 60, 0.5);
      white-space: nowrap;
    }

    .btn-primary {
      width: 100%;
      padding: 8px 12px;
      margin-top: 4px;
      border-radius: 999px;
      border: none;
      font-size: 0.8rem;
      background: linear-gradient(135deg, #fb923c, #f97316);
      color: #111827;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .btn-secondary {
      width: 100%;
      padding: 7px 12px;
      margin-top: 4px;
      border-radius: 999px;
      border: 1px solid #111827;
      font-size: 0.76rem;
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-soft);
      cursor: pointer;
    }

    .two-btn-row {
      display: grid;
      grid-template-columns: 1.4fr 1fr;
      gap: 6px;
      margin-top: 4px;
    }

    /* Dashboard */
    .dashboard-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }

    .kpi-row {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 8px;
    }

    .kpi-card {
      background: #020617;
      border-radius: 14px;
      border: 1px solid #111827;
      padding: 8px 10px;
    }

    .kpi-label {
      font-size: 0.7rem;
      color: var(--text-soft);
      margin-bottom: 4px;
    }

    .kpi-main {
      font-size: 1rem;
      font-weight: 600;
    }

    .kpi-sub {
      font-size: 0.72rem;
      color: var(--muted);
      margin-top: 2px;
    }

    .kpi-main.good {
      color: var(--success);
    }

    .kpi-main.bad {
      color: var(--danger);
    }

    .charts-row {
      display: grid;
      grid-template-columns: 1.1fr 1.1fr 0.8fr;
      gap: 8px;
    }

    .chart-card {
      background: #020617;
      border-radius: 14px;
      border: 1px solid #111827;
      padding: 8px 10px;
    }

    .chart-title {
      font-size: 0.72rem;
      color: var(--text-soft);
      margin-bottom: 4px;
    }

    .wm-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }

    .wm-card {
      background: #020617;
      border-radius: 14px;
      border: 1px solid #111827;
      padding: 8px 10px;
    }

    .wm-title {
      font-size: 0.72rem;
      color: var(--text-soft);
      margin-bottom: 2px;
    }

    .wm-main {
      font-size: 0.95rem;
      font-weight: 600;
    }

    .wm-sub {
      font-size: 0.7rem;
      color: var(--muted);
    }

    /* Trade table */
    .table-card {
      background: #020617;
      border-radius: 14px;
      border: 1px solid #111827;
      padding: 8px 10px 10px;
    }

    .table-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }

    .filters-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
    }

    .filters-row select,
    .filters-row input[type="date"] {
      max-width: 130px;
      font-size: 0.7rem;
      padding: 4px 6px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.7rem;
    }

    th, td {
      padding: 4px 4px;
      text-align: left;
      border-bottom: 1px solid #020617;
      white-space: nowrap;
    }

    th {
      color: var(--text-soft);
      font-weight: 500;
      font-size: 0.68rem;
    }

    tr:nth-child(even) td {
      background: #020617;
    }

    .badge-prob-low {
      color: #f97316;
    }

    .badge-prob-med {
      color: #22c55e;
    }

    .badge-prob-high {
      color: #22c55e;
      font-weight: 600;
    }

    .bottom-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      justify-content: flex-end;
      margin-top: 6px;
    }

    .btn-small {
      padding: 5px 9px;
      border-radius: 999px;
      border: 1px solid #111827;
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-soft);
      font-size: 0.7rem;
      cursor: pointer;
    }

    .btn-small.primary {
      background: var(--accent);
      color: #111827;
      border-color: var(--accent);
    }

    .file-input {
      display: none;
    }

    .coach-card {
      background: #020617;
      border-radius: 14px;
      border: 1px solid #111827;
      padding: 8px 10px;
      margin-top: 6px;
      font-size: 0.72rem;
      color: var(--muted);
    }

    .coach-title {
      font-weight: 600;
      margin-bottom: 3px;
      color: var(--text-soft);
    }

    .autosave-label {
      font-size: 0.7rem;
      color: var(--text-soft);
      margin-top: 2px;
    }

    @media (max-width: 980px) {
      .layout {
        grid-template-columns: 1fr;
      }
      .charts-row {
        grid-template-columns: 1fr;
      }
      .kpi-row {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 640px) {
      body {
        padding: 0;
      }
      .app {
        padding-inline: 10px;
      }
      header {
        flex-direction: column;
        align-items: flex-start;
      }
      .top-controls {
        width: 100%;
        justify-content: space-between;
      }
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <div class="title-block">
      <h1>Ali's Trading System</h1>
      <div class="subtitle">Probabilities â€¢ Discipline â€¢ R â€¢ Web-based execution journal</div>
      <div class="pill-row">
        <div class="pill">Weighted checklist</div>
        <div class="pill">PnL & account balance</div>
        <div class="pill">Weekly & monthly stats</div>
        <div class="pill">JSON / CSV export</div>
      </div>
    </div>
    <div class="top-controls">
      <div class="chip">
        <span class="chip-dot"></span>
        <span id="session-status">Local session</span>
      </div>
      <button class="btn-icon" id="lock-btn">ðŸ”’ Lock</button>
    </div>
  </header>

  <main class="layout">
    <!-- LEFT: New trade form -->
    <section class="card">
      <div class="card-header">
        <div>
          <div class="card-title">New trade</div>
          <div class="autosave-label" id="autosave-status">Last autosave: â€“</div>
        </div>
        <div class="badge">Checklist + Execution</div>
      </div>

      <div class="section-label">Account</div>
      <div class="field-grid">
        <label>
          Starting balance
          <input id="starting-balance" type="number" step="0.01" placeholder="e.g. 2000" />
        </label>
        <label>
          Current balance
          <input id="current-balance" type="number" step="0.01" disabled />
        </label>
      </div>

      <div class="section-label">New trade</div>
      <div class="field-grid">
        <label>
          Date
          <input id="trade-date" type="date" />
        </label>
        <label>
          Pair
          <input id="trade-pair" type="text" placeholder="e.g. GBPUSD" />
        </label>
        <label>
          Direction
          <select id="trade-direction">
            <option value="">Select</option>
            <option>Buy</option>
            <option>Sell</option>
          </select>
        </label>
        <label>
          Setup
          <select id="trade-setup">
            <option value="">Select</option>
            <option>Breakout with momentum</option>
            <option>Candle close above/below level</option>
          </select>
        </label>
        <label>
          Risk per trade (money)
          <input id="risk-amount" type="number" step="0.01" placeholder="e.g. 50" />
        </label>
        <label>
          R:R planned
          <input id="rr-planned" type="number" step="0.1" placeholder="e.g. 2.5" />
        </label>
        <label>
          R realized
          <input id="rr-realized" type="number" step="0.1" placeholder="e.g. 1.8 or -1" />
        </label>
        <label>
          Session
          <select id="trade-session">
            <option value="">Select</option>
            <option>London</option>
            <option>New York</option>
            <option>Asia</option>
            <option>Overlap</option>
          </select>
        </label>
        <label>
          Emotion tag
          <select id="trade-emotion">
            <option value="">Select</option>
            <option>Calm</option>
            <option>Disciplined</option>
            <option>Confident</option>
            <option>Neutral</option>
            <option>FOMO</option>
            <option>Fearful</option>
            <option>Revenge</option>
            <option>Greedy</option>
          </select>
        </label>
        <label>
          Screenshot / chart link
          <input id="screenshot-link" type="text" placeholder="Paste TradingView / chart link" />
        </label>
      </div>

      <label>
        Tags (comma-separated)
        <input id="trade-tags" type="text" placeholder="e.g. London open, news, A+" />
      </label>

      <label style="margin-top:6px;">
        Journal notes
        <textarea id="trade-notes" placeholder="What did you do well? What can you improve?"></textarea>
      </label>

      <div class="section-label" style="margin-top:10px;">Breakout / candle criteria (weighted)</div>
      <div class="criteria-grid" id="criteria-list">
        <!-- JS will inject criteria here -->
      </div>

      <div class="two-btn-row">
        <button class="btn-primary" id="add-trade-btn">
          + Add trade to log
        </button>
        <button class="btn-secondary" id="clear-form-btn">
          Clear form
        </button>
      </div>
    </section>

    <!-- RIGHT: Dashboard & table -->
    <section class="dashboard-grid">
      <section class="card">
        <div class="card-header">
          <div class="card-title">Dashboard</div>
          <div class="badge">Auto-updated from left panel</div>
        </div>

        <div class="kpi-row">
          <div class="kpi-card">
            <div class="kpi-label">Win rate</div>
            <div class="kpi-main" id="kpi-winrate">0.0%</div>
            <div class="kpi-sub" id="kpi-trade-count">0 trades</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Avg R (realized)</div>
            <div class="kpi-main" id="kpi-avg-r">0.00R</div>
            <div class="kpi-sub" id="kpi-equity-r">Equity: 0.00R</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Discipline score</div>
            <div class="kpi-main" id="kpi-discipline">0</div>
            <div class="kpi-sub">Checklist score (0â€“100)</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Total PnL & balance</div>
            <div class="kpi-main" id="kpi-total-pnl">0.00</div>
            <div class="kpi-sub" id="kpi-balance">Balance: 0.00</div>
          </div>
        </div>

        <div class="charts-row" style="margin-top:8px;">
          <div class="chart-card">
            <div class="chart-title">High vs medium vs low probability</div>
            <canvas id="probabilityChart" height="150"></canvas>
          </div>
          <div class="chart-card">
            <div class="chart-title">Equity curve (R)</div>
            <canvas id="equityChart" height="150"></canvas>
          </div>
          <div class="chart-card">
            <div class="chart-title">Probability history</div>
            <canvas id="probHistoryChart" height="150"></canvas>
          </div>
        </div>

        <div class="section-label" style="margin-top:10px;">Weekly & monthly stats</div>
        <div class="wm-grid">
          <div class="wm-card">
            <div class="wm-title">Last 7 days</div>
            <div class="wm-main" id="wm-week-winrate">0.0% win</div>
            <div class="wm-sub" id="wm-week-pnl">0.00R â€¢ 0.00 money</div>
          </div>
          <div class="wm-card">
            <div class="wm-title">Last 30 days</div>
            <div class="wm-main" id="wm-month-winrate">0.0% win</div>
            <div class="wm-sub" id="wm-month-pnl">0.00R â€¢ 0.00 money</div>
          </div>
        </div>

        <div class="coach-card">
          <div class="coach-title">Coach's feedback</div>
          <div id="coach-feedback">
            Log trades, tag emotions and maintain high checklist scores. Iâ€™ll highlight patterns as data builds up.
          </div>
        </div>
      </section>

      <section class="card table-card">
        <div class="table-header-row">
          <div class="card-title">Trade log</div>
          <span class="section-label" style="margin:0;">Based on filters, tags & date range.</span>
        </div>

        <div class="filters-row">
          <select id="filter-prob">
            <option value="">All probabilities</option>
            <option value="High">High</option>
            <option value="Medium">Medium</option>
            <option value="Low">Low</option>
          </select>
          <input id="filter-from" type="date" />
          <input id="filter-to" type="date" />
          <button class="btn-small" id="clear-filters-btn">Clear filters</button>
        </div>

        <div style="overflow-x:auto; max-height:230px;">
          <table>
            <thead>
            <tr>
              <th>#</th>
              <th>Date</th>
              <th>Pair</th>
              <th>Dir</th>
              <th>Setup</th>
              <th>Prob</th>
              <th>Score</th>
              <th>R planned</th>
              <th>R realized</th>
              <th>PnL (R)</th>
              <th>PnL</th>
              <th>Balance</th>
              <th>Session</th>
              <th>Emotion</th>
            </tr>
            </thead>
            <tbody id="trades-tbody">
            <!-- JS will inject rows -->
            </tbody>
          </table>
        </div>

        <div class="bottom-bar">
          <button class="btn-small primary" id="export-json-btn">Export JSON</button>
          <button class="btn-small primary" id="export-csv-btn">Export CSV</button>
          <label class="btn-small" style="cursor:pointer;">
            Import JSON
            <input id="import-json-input" class="file-input" type="file" accept="application/json" />
          </label>
          <button class="btn-small" id="clear-log-btn">Clear log (local)</button>
        </div>
      </section>
    </section>
  </main>
</div>

<script>
  // --------- STATE ---------
  const STORAGE_KEY = "ali_trading_trades_v3";
  const BALANCE_KEY = "ali_trading_balance_v3";
  const START_BAL_KEY = "ali_trading_start_balance_v3";

  let trades = [];
  let startingBalance = parseFloat(localStorage.getItem(START_BAL_KEY) || "0");
  let accountBalance = parseFloat(localStorage.getItem(BALANCE_KEY) || startingBalance);

  let probabilityChart, equityChart, probHistoryChart;
  let autosaveTimer = null;

  const criteriaConfig = [
    { id: "clean", label: "Clean close at level", desc: "No big wicks both sides", weight: 2 },
    { id: "no-wick-against", label: "No long wick against direction", desc: "Favourable wick profile", weight: 2 },
    { id: "structure", label: "Structure matches plan", desc: "Story + higher TF aligned", weight: 1 },
    { id: "no-huge-candle", label: "Not after huge candle", desc: "Avoid chasing exhaustion moves", weight: 1 },
    { id: "no-flat", label: "No flat / no-wick close", desc: "Entry candle prints wick first then flips", weight: 2 },
    { id: "flip-entry", label: "Wick first, then flip entry", desc: "Classic flip entry behaviour", weight: 2 }
  ];

  // --------- HELPERS ---------
  function formatPercent(x) {
    if (!isFinite(x)) return "0.0%";
    return (x * 100).toFixed(1) + "%";
  }

  function formatMoney(x) {
    if (!isFinite(x)) return "0.00";
    return x.toFixed(2);
  }

  function nowIsoDate() {
    return new Date().toISOString().slice(0, 10);
  }

  function parseDateSafe(str) {
    if (!str) return null;
    const d = new Date(str);
    return isNaN(d.getTime()) ? null : d;
  }

  function inLastNDays(dateStr, n) {
    const d = parseDateSafe(dateStr);
    if (!d) return false;
    const today = new Date();
    const diff = (today - d) / (1000 * 60 * 60 * 24);
    return diff >= 0 && diff < n;
  }

  function calcSummary(subset) {
    let total = subset.length;
    let wins = 0;
    let sumR = 0;
    let sumMoney = 0;
    let sumScore = 0;

    subset.forEach(t => {
      const pnlR = parseFloat(t.pnlR || 0);
      const pnlMoney = parseFloat(t.pnlMoney || 0);
      const score = parseFloat(t.checklistScore || 0);
      sumR += pnlR;
      sumMoney += pnlMoney;
      sumScore += score;
      if (pnlR > 0) wins++;
    });

    const winRate = total ? wins / total : 0;
    const avgR = total ? sumR / total : 0;
    const avgScore = total ? sumScore / total : 0;

    return {
      total,
      wins,
      winRate,
      sumR,
      sumMoney,
      avgR,
      avgScore
    };
  }

  function saveState() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(trades));
    localStorage.setItem(BALANCE_KEY, accountBalance.toString());
    localStorage.setItem(START_BAL_KEY, startingBalance.toString());
    const autosaveLabel = document.getElementById("autosave-status");
    if (autosaveLabel) {
      const t = new Date();
      autosaveLabel.textContent = "Last autosave: " + t.toLocaleTimeString();
    }
  }

  function scheduleAutosave() {
    if (autosaveTimer) clearTimeout(autosaveTimer);
    autosaveTimer = setTimeout(saveState, 1000);
  }

  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        trades = JSON.parse(raw) || [];
      }
    } catch (e) {
      trades = [];
    }
  }

  function recomputeBalanceFromTrades() {
    // recompute total pnl from scratch from startingBalance
    let totalMoney = 0;
    trades.forEach(t => {
      const pnlMoney = parseFloat(t.pnlMoney || 0);
      totalMoney += pnlMoney;
    });
    accountBalance = startingBalance + totalMoney;
  }

  // --------- UI RENDER ---------
  function renderCriteria() {
    const container = document.getElementById("criteria-list");
    if (!container) return;
    container.innerHTML = "";
    criteriaConfig.forEach(c => {
      const div = document.createElement("div");
      div.className = "criterion";
      div.innerHTML = `
        <div class="criterion-left">
          <input type="checkbox" id="crit-${c.id}" data-weight="${c.weight}" />
          <div>
            <div>${c.label}</div>
            <div style="font-size:0.68rem; color:var(--text-soft);">${c.desc} â€¢ weight ${c.weight}</div>
          </div>
        </div>
        <span class="badge">+${c.weight} pts</span>
      `;
      container.appendChild(div);
    });
  }

  function computeChecklistScore() {
    let used = 0;
    let max = 0;
    criteriaConfig.forEach(c => {
      const cb = document.getElementById("crit-" + c.id);
      if (!cb) return;
      max += c.weight;
      if (cb.checked) used += c.weight;
    });
    const pct = max > 0 ? used / max : 0;
    return { used, max, pct };
  }

  function classifyProbability(scorePct) {
    if (scorePct >= 0.8) return "High";
    if (scorePct >= 0.5) return "Medium";
    return "Low";
  }

  function renderDashboard() {
    const overall = calcSummary(trades);
    const week = calcSummary(trades.filter(t => inLastNDays(t.date, 7)));
    const month = calcSummary(trades.filter(t => inLastNDays(t.date, 30)));

    // overall KPIs
    document.getElementById("kpi-winrate").textContent = formatPercent(overall.winRate);
    document.getElementById("kpi-trade-count").textContent = `${overall.total} trade${overall.total === 1 ? "" : "s"}`;
    document.getElementById("kpi-avg-r").textContent = overall.avgR.toFixed(2) + "R";
    document.getElementById("kpi-equity-r").textContent = "Equity: " + overall.sumR.toFixed(2) + "R";
    document.getElementById("kpi-discipline").textContent = overall.avgScore.toFixed(0);
    document.getElementById("kpi-total-pnl").textContent = `${overall.sumR.toFixed(2)}R â€¢ ${formatMoney(overall.sumMoney)}`;
    document.getElementById("kpi-balance").textContent = "Balance: " + formatMoney(accountBalance);

    // weekly / monthly
    document.getElementById("wm-week-winrate").textContent = formatPercent(week.winRate) + " win";
    document.getElementById("wm-week-pnl").textContent = `${week.sumR.toFixed(2)}R â€¢ ${formatMoney(week.sumMoney)} money`;

    document.getElementById("wm-month-winrate").textContent = formatPercent(month.winRate) + " win";
    document.getElementById("wm-month-pnl").textContent = `${month.sumR.toFixed(2)}R â€¢ ${formatMoney(month.sumMoney)} money`;

    // balance fields
    const startInput = document.getElementById("starting-balance");
    const currentInput = document.getElementById("current-balance");
    if (startInput) startInput.value = startingBalance || "";
    if (currentInput) currentInput.value = formatMoney(accountBalance);

    // coach feedback
    const coach = document.getElementById("coach-feedback");
    if (trades.length === 0) {
      coach.textContent = "No trades logged yet. Focus on following your checklist and tagging emotions consistently.";
    } else {
      const recent = trades.slice(-10);
      const recentSummary = calcSummary(recent);
      if (recentSummary.winRate < 0.4 && recentSummary.avgScore < 60) {
        coach.textContent = "Recent discipline and win rate are low. Consider reducing size, only taking A+ setups and reviewing your pre-trade checklist.";
      } else if (recentSummary.winRate > 0.6 && recentSummary.avgScore >= 70) {
        coach.textContent = "Good job. You're trading in sync with your plan. Keep journaling and avoid overconfidence after strong streaks.";
      } else if (recentSummary.avgScore < 60) {
        coach.textContent = "Your checklist score is slipping. Before each trade, pause and verify the key criteria instead of forcing entries.";
      } else {
        coach.textContent = "Mixed performance. Review losing trades, especially those with low checklist scores or emotional tags like FOMO or Revenge.";
      }
    }

    renderCharts();
  }

  function renderTradesTable() {
    const tbody = document.getElementById("trades-tbody");
    if (!tbody) return;

    const probFilter = document.getElementById("filter-prob").value || "";
    const from = document.getElementById("filter-from").value || "";
    const to = document.getElementById("filter-to").value || "";

    const fromDate = parseDateSafe(from);
    const toDate = parseDateSafe(to);

    tbody.innerHTML = "";

    let filtered = trades.slice();
    filtered = filtered.filter(t => {
      if (probFilter && t.probLabel !== probFilter) return false;
      const d = parseDateSafe(t.date);
      if (fromDate && (!d || d < fromDate)) return false;
      if (toDate && (!d || d > toDate)) return false;
      return true;
    });

    filtered.forEach((t, idx) => {
      const tr = document.createElement("tr");
      const probClass =
        t.probLabel === "High"
          ? "badge-prob-high"
          : t.probLabel === "Medium"
          ? "badge-prob-med"
          : "badge-prob-low";

      tr.innerHTML = `
        <td>${idx + 1}</td>
        <td>${t.date || ""}</td>
        <td>${t.pair || ""}</td>
        <td>${t.direction || ""}</td>
        <td>${t.setup || ""}</td>
        <td class="${probClass}">${t.probLabel || ""}</td>
        <td>${(t.checklistScore || 0).toFixed(0)}</td>
        <td>${(t.rrPlanned || 0).toFixed(2)}</td>
        <td>${(t.rrRealized || 0).toFixed(2)}</td>
        <td>${(t.pnlR || 0).toFixed(2)}</td>
        <td>${formatMoney(t.pnlMoney || 0)}</td>
        <td>${formatMoney(t.balanceAfter || 0)}</td>
        <td>${t.session || ""}</td>
        <td>${t.emotion || ""}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function renderCharts() {
    const probCounts = { High: 0, Medium: 0, Low: 0 };
    trades.forEach(t => {
      if (t.probLabel && probCounts[t.probLabel] !== undefined) {
        probCounts[t.probLabel]++;
      }
    });

    const probData = [probCounts.High, probCounts.Medium, probCounts.Low];

    if (!probabilityChart) {
      const ctx = document.getElementById("probabilityChart").getContext("2d");
      probabilityChart = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels: ["High", "Medium", "Low"],
          datasets: [
            {
              data: probData,
              backgroundColor: ["#22c55e", "#fb923c", "#4b5563"]
            }
          ]
        },
        options: {
          plugins: {
            legend: {
              labels: {
                color: "#9ca3af",
                font: { size: 10 }
              }
            }
          },
          cutout: "60%"
        }
      });
    } else {
      probabilityChart.data.datasets[0].data = probData;
      probabilityChart.update();
    }

    // Equity curve (R)
    const labels = trades.map((t, i) => i + 1);
    let runningR = 0;
    const equityData = trades.map(t => {
      runningR += parseFloat(t.pnlR || 0);
      return runningR;
    });

    if (!equityChart) {
      const ctx2 = document.getElementById("equityChart").getContext("2d");
      equityChart = new Chart(ctx2, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: "Equity (R)",
              data: equityData,
              borderColor: "#22c55e",
              backgroundColor: "rgba(34,197,94,0.15)",
              tension: 0.25,
              fill: true,
              pointRadius: 2
            }
          ]
        },
        options: {
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: {
              ticks: { color: "#6b7280", font: { size: 9 } },
              grid: { display: false }
            },
            y: {
              ticks: { color: "#6b7280", font: { size: 9 } },
              grid: { color: "#111827" }
            }
          }
        }
      });
    } else {
      equityChart.data.labels = labels;
      equityChart.data.datasets[0].data = equityData;
      equityChart.update();
    }

    // Probability history (checklist score)
    const probLabels = trades.map((_, i) => i + 1);
    const probScores = trades.map(t => t.checklistScore || 0);

    if (!probHistoryChart) {
      const ctx3 = document.getElementById("probHistoryChart").getContext("2d");
      probHistoryChart = new Chart(ctx3, {
        type: "line",
        data: {
          labels: probLabels,
          datasets: [
            {
              label: "Checklist score",
              data: probScores,
              borderColor: "#fb923c",
              backgroundColor: "rgba(248,154,72,0.18)",
              tension: 0.25,
              fill: true,
              pointRadius: 2
            }
          ]
        },
        options: {
          plugins: { legend: { display: false } },
          scales: {
            x: {
              ticks: { color: "#6b7280", font: { size: 9 } },
              grid: { display: false }
            },
            y: {
              ticks: { color: "#6b7280", font: { size: 9 } },
              grid: { color: "#111827" },
              suggestedMin: 0,
              suggestedMax: 100
            }
          }
        }
      });
    } else {
      probHistoryChart.data.labels = probLabels;
      probHistoryChart.data.datasets[0].data = probScores;
      probHistoryChart.update();
    }
  }

  // --------- FORM HANDLERS ---------
  function addTradeFromForm() {
    const date = document.getElementById("trade-date").value || nowIsoDate();
    const pair = document.getElementById("trade-pair").value.trim();
    const direction = document.getElementById("trade-direction").value;
    const setup = document.getElementById("trade-setup").value;
    const riskAmount = parseFloat(document.getElementById("risk-amount").value || "0");
    const rrPlanned = parseFloat(document.getElementById("rr-planned").value || "0");
    const rrRealized = parseFloat(document.getElementById("rr-realized").value || "0");
    const session = document.getElementById("trade-session").value;
    const emotion = document.getElementById("trade-emotion").value;
    const screenshot = document.getElementById("screenshot-link").value.trim();
    const tags = document.getElementById("trade-tags").value.trim();
    const notes = document.getElementById("trade-notes").value.trim();

    const { used, max, pct } = computeChecklistScore();
    const probLabel = classifyProbability(pct);

    const pnlR = rrRealized; // realized R
    const pnlMoney = riskAmount * rrRealized;

    accountBalance += pnlMoney;

    const trade = {
      id: Date.now(),
      date,
      pair,
      direction,
      setup,
      riskAmount,
      rrPlanned,
      rrRealized,
      pnlR,
      pnlMoney,
      balanceAfter: accountBalance,
      session,
      emotion,
      screenshot,
      tags,
      notes,
      checklistUsed: used,
      checklistMax: max,
      checklistScore: pct * 100,
      probLabel
    };

    trades.push(trade);
    scheduleAutosave();
    renderDashboard();
    renderTradesTable();
  }

  function clearForm() {
    document.getElementById("trade-pair").value = "";
    document.getElementById("trade-direction").value = "";
    document.getElementById("trade-setup").value = "";
    document.getElementById("risk-amount").value = "";
    document.getElementById("rr-planned").value = "";
    document.getElementById("rr-realized").value = "";
    document.getElementById("trade-session").value = "";
    document.getElementById("trade-emotion").value = "";
    document.getElementById("screenshot-link").value = "";
    document.getElementById("trade-tags").value = "";
    document.getElementById("trade-notes").value = "";
    criteriaConfig.forEach(c => {
      const cb = document.getElementById("crit-" + c.id);
      if (cb) cb.checked = false;
    });
  }

  // --------- EXPORT / IMPORT ---------
  function exportJSON() {
    const payload = {
      version: 3,
      startingBalance,
      accountBalance,
      trades
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "ali_trading_session.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function exportCSV() {
    const header = [
      "date",
      "pair",
      "direction",
      "setup",
      "probability",
      "checklistScore",
      "riskAmount",
      "rrPlanned",
      "rrRealized",
      "pnlR",
      "pnlMoney",
      "balanceAfter",
      "session",
      "emotion",
      "tags",
      "notes"
    ];
    const rows = trades.map(t => [
      t.date,
      t.pair,
      t.direction,
      t.setup,
      t.probLabel,
      (t.checklistScore || 0).toFixed(0),
      t.riskAmount,
      t.rrPlanned,
      t.rrRealized,
      t.pnlR,
      t.pnlMoney,
      t.balanceAfter,
      t.session,
      t.emotion,
      (t.tags || "").replace(/,/g, ";"),
      '"' + (t.notes || "").replace(/"/g, '""') + '"'
    ]);

    const csv = [header.join(","), ...rows.map(r => r.join(","))].join("\n");
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "ali_trading_session.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function importJSON(file) {
    const reader = new FileReader();
    reader.onload = e => {
      try {
        const data = JSON.parse(e.target.result);
        if (Array.isArray(data)) {
          trades = data;
          // older format
        } else if (data && Array.isArray(data.trades)) {
          trades = data.trades;
          if (typeof data.startingBalance === "number") {
            startingBalance = data.startingBalance;
          }
          if (typeof data.accountBalance === "number") {
            accountBalance = data.accountBalance;
          } else {
            recomputeBalanceFromTrades();
          }
        }
        scheduleAutosave();
        renderDashboard();
        renderTradesTable();
      } catch (err) {
        alert("Could not import JSON file.");
      }
    };
    reader.readAsText(file);
  }

  // --------- INIT ---------
  document.addEventListener("DOMContentLoaded", () => {
    renderCriteria();
    loadState();
    recomputeBalanceFromTrades();

    const dateInput = document.getElementById("trade-date");
    if (dateInput && !dateInput.value) {
      dateInput.value = nowIsoDate();
    }

    // apply starting / current balance
    const startInput = document.getElementById("starting-balance");
    const currentInput = document.getElementById("current-balance");
    if (startInput) startInput.value = startingBalance || "";
    if (currentInput) currentInput.value = formatMoney(accountBalance);

    // events
    document.getElementById("add-trade-btn").addEventListener("click", () => {
      addTradeFromForm();
    });

    document.getElementById("clear-form-btn").addEventListener("click", () => {
      clearForm();
    });

    document.getElementById("starting-balance").addEventListener("change", e => {
      const val = parseFloat(e.target.value || "0");
      startingBalance = isNaN(val) ? 0 : val;
      recomputeBalanceFromTrades();
      scheduleAutosave();
      renderDashboard();
    });

    document.getElementById("export-json-btn").addEventListener("click", exportJSON);
    document.getElementById("export-csv-btn").addEventListener("click", exportCSV);

    document.getElementById("import-json-input").addEventListener("change", e => {
      const file = e.target.files[0];
      if (file) importJSON(file);
      e.target.value = "";
    });

    document.getElementById("clear-log-btn").addEventListener("click", () => {
      if (confirm("Clear all local trades and reset balance?")) {
        trades = [];
        accountBalance = startingBalance;
        scheduleAutosave();
        renderDashboard();
        renderTradesTable();
      }
    });

    document.getElementById("clear-filters-btn").addEventListener("click", () => {
      document.getElementById("filter-prob").value = "";
      document.getElementById("filter-from").value = "";
      document.getElementById("filter-to").value = "";
      renderTradesTable();
    });

    ["filter-prob", "filter-from", "filter-to"].forEach(id => {
      const el = document.getElementById(id);
      el.addEventListener("change", renderTradesTable);
    });

    const lockBtn = document.getElementById("lock-btn");
    lockBtn.addEventListener("click", () => {
      const locked = lockBtn.dataset.locked === "true";
      if (!locked) {
        lockBtn.textContent = "ðŸ”“ Unlock";
        lockBtn.dataset.locked = "true";
      } else {
        lockBtn.textContent = "ðŸ”’ Lock";
        lockBtn.dataset.locked = "false";
      }
    });

    renderDashboard();
    renderTradesTable();
  });
</script>
</body>
</html>
