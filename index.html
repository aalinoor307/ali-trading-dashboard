<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>TredLog – Probability-driven trading journal – Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <style>
      :root {
        --bg: #020617;
        --bg-elevated: #050b18;
        --bg-card: #050b18;
        --border-soft: #1f2937;
        --accent: #facc15;
        --accent-soft: rgba(250, 204, 21, 0.1);
        --accent-strong: #fbbf24;
        --muted: #9ca3af;
        --muted-soft: #4b5563;
        --text: #f9fafb;
        --danger: #f97373;
        --positive: #4ade80;
        --radius-lg: 18px;
        --radius-md: 12px;
        --radius-sm: 8px;
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        margin: 0;
        padding: 0;
      }

      body {
        min-height: 100vh;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
          -apple-system, system-ui, sans-serif;
        background: radial-gradient(circle at top, #111827 0, #020617 55%);
        color: var(--text);
        display: flex;
        justify-content: center;
      }

      .shell {
        width: 100%;
        max-width: 1220px;
        padding: 24px 16px 32px;
      }

      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        margin-bottom: 20px;
      }

      .logo-row {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .logo-icon {
        width: 28px;
        height: 28px;
        border-radius: 999px;
        background: radial-gradient(circle at 30% 20%, #ffe29f, #ff9f4a 45%, #ff3c3c 100%);
        box-shadow: 0 0 0 4px rgba(250, 204, 21, 0.15);
      }

      .logo-text-main {
        font-weight: 600;
        letter-spacing: 0.02em;
      }

      .logo-sub {
        font-size: 11px;
        color: var(--muted);
      }

      .header-right {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 6px;
      }

      .pill-row {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        justify-content: flex-end;
      }

      .pill {
        padding: 5px 11px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.5);
        font-size: 11px;
        color: var(--muted);
        background: rgba(15, 23, 42, 0.8);
      }

      .pill.positive {
        border-color: rgba(34, 197, 94, 0.7);
        color: #bbf7d0;
        background: rgba(22, 163, 74, 0.1);
      }

      .pill.danger {
        border-color: rgba(248, 113, 113, 0.8);
        color: #fecaca;
        background: rgba(248, 113, 113, 0.1);
      }

      .top-buttons {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        justify-content: flex-end;
      }

      .btn-top {
        padding: 6px 12px;
        border-radius: 999px;
        border: 1px solid rgba(55, 65, 81, 0.9);
        background: rgba(15, 23, 42, 0.9);
        color: var(--muted);
        font-size: 11px;
        cursor: pointer;
      }

      .btn-top:hover {
        border-color: rgba(156, 163, 175, 0.9);
      }

      .btn-top.primary {
        border-color: rgba(250, 204, 21, 0.7);
        color: #1f2937;
        background: linear-gradient(90deg, #facc15, #f97316);
        font-weight: 600;
      }

      main {
        display: grid;
        grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr);
        gap: 20px;
      }

      .card {
        background: radial-gradient(circle at top left, #0b1220, #020617 65%);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border-soft);
        padding: 14px 16px 14px;
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        margin-bottom: 8px;
      }

      .card-title {
        font-size: 13px;
        font-weight: 600;
      }

      .card-sub {
        font-size: 11px;
        color: var(--muted);
      }

      .section-grid-left {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .section-grid-right {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .form-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 10px 12px;
      }

      .field {
        display: flex;
        flex-direction: column;
        gap: 3px;
        font-size: 11px;
      }

      .field label {
        color: var(--muted);
      }

      .input,
      .select {
        border-radius: 999px;
        border: 1px solid #111827;
        background: #020617;
        color: var(--text);
        padding: 7px 11px;
        font-size: 12px;
      }

      .input::placeholder {
        color: rgba(148, 163, 184, 0.7);
      }

      .select {
        appearance: none;
      }

      .notes-area {
        border-radius: 12px;
        border: 1px solid #111827;
        background: #020617;
        color: var(--text);
        padding: 8px 11px;
        font-size: 12px;
        min-height: 80px;
        resize: vertical;
      }

      .notes-area::placeholder {
        color: rgba(148, 163, 184, 0.7);
      }

      .button-row {
        display: flex;
        justify-content: space-between;
        gap: 8px;
        margin-top: 8px;
      }

      .btn-secondary,
      .btn-primary-main {
        border-radius: 999px;
        padding: 7px 14px;
        font-size: 12px;
        cursor: pointer;
        border: 1px solid transparent;
      }

      .btn-secondary {
        background: transparent;
        color: var(--muted);
        border-color: rgba(55, 65, 81, 0.9);
      }

      .btn-secondary:hover {
        border-color: rgba(148, 163, 184, 0.9);
      }

      .btn-primary-main {
        background: linear-gradient(90deg, #facc15, #f97316);
        color: #1f2937;
        font-weight: 600;
        box-shadow: 0 10px 22px rgba(250, 204, 21, 0.35);
        min-width: 120px;
      }

      .meta-topline {
        font-size: 11px;
        color: var(--muted);
        margin-top: 6px;
      }

      .meta-topline span {
        margin-right: 8px;
      }

      .metrics-row {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 10px;
        margin-top: 6px;
      }

      .metric-pill {
        border-radius: var(--radius-md);
        border: 1px solid var(--border-soft);
        background: rgba(15, 23, 42, 0.9);
        padding: 8px 10px;
        font-size: 11px;
      }

      .metric-label {
        color: var(--muted);
      }

      .metric-value {
        font-size: 14px;
        font-weight: 600;
        margin-top: 2px;
      }

      .metric-foot {
        margin-top: 2px;
        color: var(--muted);
      }

      .charts-row {
        display: grid;
        grid-template-columns: 1.3fr 0.9fr;
        gap: 10px;
        margin-top: 10px;
      }

      .mini-card {
        border-radius: var(--radius-md);
        border: 1px solid var(--border-soft);
        background: rgba(15, 23, 42, 0.9);
        padding: 8px 9px;
        font-size: 11px;
      }

      .mini-title {
        font-size: 11px;
        font-weight: 600;
        margin-bottom: 4px;
      }

      canvas {
        width: 100%;
        height: 160px;
        border-radius: 10px;
        background: #020617;
      }

      .bottom-row-right {
        display: grid;
        grid-template-columns: 1.05fr 0.95fr;
        gap: 10px;
        margin-top: 10px;
      }

      .bottom-right-inner {
        display: grid;
        grid-template-columns: 1.1fr 0.9fr;
        gap: 10px;
      }

      .stats-block p {
        margin: 1px 0;
      }

      .stats-label {
        color: var(--muted);
      }

      .stats-value {
        font-weight: 500;
      }

      .calendar-grid {
        margin-top: 4px;
      }

      .calendar-header {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        font-size: 10px;
        color: var(--muted);
        text-align: center;
        margin-bottom: 4px;
      }

      .calendar-days {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 2px;
        font-size: 10px;
      }

      .day-cell {
        padding: 3px 0;
        border-radius: 5px;
        text-align: center;
        color: var(--muted);
        min-height: 20px;
      }

      .day-cell.has-trade {
        background: rgba(34, 197, 94, 0.1);
        color: #bbf7d0;
      }

      .day-cell.loss-day {
        background: rgba(248, 113, 113, 0.12);
        color: #fecaca;
      }

      .day-cell.today {
        border: 1px solid rgba(250, 204, 21, 0.8);
      }

      .day-pnl {
        display: block;
        font-size: 9px;
      }

      .checklist-grid {
        display: grid;
        grid-template-columns: 1.1fr 0.9fr 0.9fr;
        gap: 10px;
        margin-top: 8px;
      }

      .checklist-column-title {
        font-size: 11px;
        font-weight: 600;
        margin-bottom: 3px;
      }

      .checklist-sub {
        font-size: 10px;
        color: var(--muted);
        margin-bottom: 4px;
      }

      .checklist-list {
        font-size: 10px;
        color: var(--muted);
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .check-item {
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .check-item input {
        width: 11px;
        height: 11px;
      }

      .custom-rule-row {
        display: flex;
        gap: 4px;
        margin-top: 4px;
      }

      .custom-input {
        flex: 1;
        border-radius: 999px;
        border: 1px solid #111827;
        background: #020617;
        color: var(--text);
        padding: 5px 9px;
        font-size: 10px;
      }

      .btn-add-small {
        padding: 4px 8px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.9);
        background: transparent;
        color: var(--muted);
        font-size: 10px;
        cursor: pointer;
      }

      .checklist-footer {
        font-size: 10px;
        color: var(--muted);
        margin-top: 4px;
        display: flex;
        justify-content: space-between;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 10px;
      }

      thead {
        background: #020617;
      }

      th,
      td {
        padding: 5px 6px;
        border-bottom: 1px solid #0f172a;
        text-align: left;
        white-space: nowrap;
      }

      th {
        color: var(--muted);
        font-weight: 500;
      }

      tbody tr:hover {
        background: rgba(15, 23, 42, 0.9);
      }

      tfoot td {
        border-top: 1px solid #0f172a;
        font-weight: 500;
      }

      .text-right {
        text-align: right;
      }

      .text-center {
        text-align: center;
      }

      .link {
        color: var(--accent);
        text-decoration: none;
      }

      .link:hover {
        text-decoration: underline;
      }

      footer {
        margin-top: 18px;
        font-size: 10px;
        color: var(--muted);
        display: flex;
        justify-content: space-between;
        gap: 8px;
        flex-wrap: wrap;
      }

      footer a {
        color: var(--accent);
        text-decoration: none;
      }

      footer a:hover {
        text-decoration: underline;
      }

      /* Calendar month navigation */
      .calendar-title-bar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 6px;
      }

      .cal-nav-btn {
        border: none;
        background: transparent;
        color: var(--muted);
        font-size: 11px;
        padding: 2px 6px;
        border-radius: 999px;
        cursor: pointer;
      }

      .cal-nav-btn:hover {
        background: #020617;
      }

      @media (max-width: 1100px) {
        main {
          grid-template-columns: minmax(0, 1fr);
        }
      }

      @media (max-width: 780px) {
        header {
          flex-direction: column;
          align-items: flex-start;
        }

        .header-right {
          align-items: flex-start;
        }

        .charts-row,
        .bottom-row-right,
        .bottom-right-inner {
          grid-template-columns: minmax(0, 1fr);
        }

        .checklist-grid {
          grid-template-columns: minmax(0, 1fr);
        }
      }
    </style>
  </head>
  <body>
    <div class="shell">
      <header>
        <div class="logo-row">
          <div class="logo-icon"></div>
          <div>
            <div class="logo-text-main">TredLog</div>
            <div class="logo-sub">Probability-driven trading journal – Dashboard</div>
          </div>
        </div>

        <div class="header-right">
          <div class="pill-row">
            <div class="pill">Local session • Browser storage only</div>
            <div class="pill positive">Built for serious traders</div>
          </div>
          <div class="top-buttons">
            <button id="btnExport" class="btn-top">Export backup</button>
            <button id="btnImport" class="btn-top">Import backup</button>
            <button id="btnClear" class="btn-top danger">Clear local data</button>
          </div>
        </div>
      </header>

      <main>
        <!-- LEFT SIDE: new trade + checklist -->
        <section class="section-grid-left">
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">Account &amp; new trade</div>
                <div class="card-sub">
                  Set your starting balance once, then log trades and track PnL in R and USD.
                </div>
              </div>
              <div class="card-sub"><span id="tradesCountLabel">0 trades logged</span></div>
            </div>

            <div class="form-grid">
              <div class="field">
                <label for="startingBalance">Starting balance (USD)</label>
                <input
                  id="startingBalance"
                  class="input"
                  type="text"
                  placeholder="e.g. 10,000"
                />
              </div>
              <div class="field">
                <label for="riskPerTrade">Risk per trade (USD)</label>
                <input
                  id="riskPerTrade"
                  class="input"
                  type="text"
                  placeholder="e.g. 1,000"
                />
              </div>
              <div class="field">
                <label for="tradeDate">Date</label>
                <input id="tradeDate" class="input" type="date" />
              </div>
              <div class="field">
                <label for="pair">Pair / symbol</label>
                <input
                  id="pair"
                  class="input"
                  type="text"
                  placeholder="e.g. GBPUSD"
                />
              </div>
              <div class="field">
                <label for="direction">Direction</label>
                <select id="direction" class="select">
                  <option value="">Select</option>
                  <option value="Buy">Buy</option>
                  <option value="Sell">Sell</option>
                </select>
              </div>
              <div class="field">
                <label for="session">Session</label>
                <input
                  id="session"
                  class="input"
                  type="text"
                  placeholder="London, NY, Asia..."
                />
              </div>
              <div class="field">
                <label for="riskR">Risk (R)</label>
                <input
                  id="riskR"
                  class="input"
                  type="number"
                  step="0.01"
                  placeholder="1"
                />
              </div>
              <div class="field">
                <label for="resultR">Result (R)</label>
                <input
                  id="resultR"
                  class="input"
                  type="number"
                  step="0.01"
                  placeholder="e.g. -1, 0.5, 2"
                />
              </div>
              <div class="field">
                <label for="setup">Setup</label>
                <input
                  id="setup"
                  class="input"
                  type="text"
                  placeholder="Momentum, pullback, range break..."
                />
              </div>
              <div class="field">
                <label for="screenshot">Screenshot / chart link</label>
                <input
                  id="screenshot"
                  class="input"
                  type="text"
                  placeholder="Paste TradingView or chart URL"
                />
              </div>
            </div>

            <div class="field" style="margin-top: 8px">
              <label for="notes">Journal notes</label>
              <textarea
                id="notes"
                class="notes-area"
                placeholder="What did you see? Which rules were met? Where could you improve?"
              ></textarea>
            </div>

            <div class="button-row">
              <button id="btnSaveDraft" class="btn-secondary">Save draft</button>
              <button id="btnAddTrade" class="btn-primary-main">Add trade to log</button>
            </div>
          </div>

          <!-- Weighted checklist -->
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">Weighted checklist</div>
                <div class="card-sub">
                  Tick only what actually happened on this trade. Custom setup rules are for you
                  only – discipline % is based on the core rules.
                </div>
              </div>
            </div>

            <div class="checklist-grid">
              <!-- Custom setup column -->
              <div>
                <div class="checklist-column-title">Custom setup checklist</div>
                <div class="checklist-sub">
                  Add your own rules (e.g. “Clean close at level”). These don’t affect discipline
                  %, they’re just for you.
                </div>
                <div id="customRulesList" class="checklist-list">
                  <!-- Custom rules injected here -->
                </div>
                <div class="custom-rule-row">
                  <input
                    id="customRuleInput"
                    class="custom-input"
                    type="text"
                    placeholder="e.g. Clean close at level"
                  />
                  <button id="btnAddRule" class="btn-add-small">Add</button>
                </div>
              </div>

              <!-- Risk & discipline -->
              <div>
                <div class="checklist-column-title">Risk &amp; discipline</div>
                <div class="checklist-list">
                  <label class="check-item">
                    <input id="chkPlannedR" type="checkbox" />
                    <span>Planned R respected.</span>
                  </label>
                  <label class="check-item">
                    <input id="chkNoRevenge" type="checkbox" />
                    <span>No revenge trades.</span>
                  </label>
                  <label class="check-item">
                    <input id="chkNoAddRisk" type="checkbox" />
                    <span>No adding risk mid-trade.</span>
                  </label>
                </div>
              </div>

              <!-- Screenshots / behaviour -->
              <div>
                <div class="checklist-column-title">Screenshots / behaviour</div>
                <div class="checklist-list">
                  <label class="check-item">
                    <input id="chkScreenshotsSaved" type="checkbox" />
                    <span>Screenshots saved for review.</span>
                  </label>
                  <label class="check-item">
                    <input id="chkAnnotated" type="checkbox" />
                    <span>Annotated before &amp; after.</span>
                  </label>
                  <label class="check-item">
                    <input id="chkClearHead" type="checkbox" />
                    <span>Clear headspace / no FOMO late session.</span>
                  </label>
                </div>
              </div>
            </div>

            <div class="checklist-footer">
              <div>
                <span id="rulesHitLabel">0 / 6 rules followed</span>
                <span>(0% discipline).</span>
              </div>
              <div>Higher score → higher discipline per trade.</div>
            </div>
          </div>
        </section>

        <!-- RIGHT SIDE: overview, stats, calendar, recent trades -->
        <section class="section-grid-right">
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">Equity &amp; discipline overview</div>
                <div class="card-sub">
                  High-level view of your performance in R and USD.
                </div>
              </div>
              <div class="card-sub" id="toplineMeta">
                Total PnL: <span id="toplinePnL">$0.00</span> • Balance:
                <span id="toplineBalance">$0.00</span> • Starting:
                <span id="toplineStarting">$0.00</span>
              </div>
            </div>

            <div class="metrics-row">
              <div class="metric-pill">
                <div class="metric-label">WIN RATE</div>
                <div class="metric-value" id="winRateLabel">0%</div>
                <div class="metric-foot" id="winRateFoot">Based on R &gt; 0.</div>
              </div>
              <div class="metric-pill">
                <div class="metric-label">AVG R (REALIZED)</div>
                <div class="metric-value" id="avgRLabel">0.0R</div>
                <div class="metric-foot">From all logged trades.</div>
              </div>
              <div class="metric-pill">
                <div class="metric-label">DISCIPLINE SCORE</div>
                <div class="metric-value" id="discScoreLabel">0 / 100</div>
                <div class="metric-foot">
                  Average of checklist discipline per trade.
                </div>
              </div>
            </div>

            <div class="charts-row">
              <div class="mini-card">
                <div class="mini-title">Equity curve (cumulative R)</div>
                <canvas id="equityChart"></canvas>
                <div class="meta-topline" id="equityMeta">
                  No trades yet. Log your first setup to start drawing your curve.
                </div>
              </div>
              <div class="mini-card">
                <div class="mini-title">Probability view (wins vs losses)</div>
                <canvas id="probChart"></canvas>
              </div>
            </div>

            <div class="bottom-row-right">
              <div class="mini-card">
                <div class="mini-title">Weekly &amp; monthly stats</div>
                <div class="stats-block">
                  <p>
                    <span class="stats-label">Last 7 days:</span>
                    <span class="stats-value" id="last7Label">PnL: 0.0R • $0.00</span>
                  </p>
                  <p>
                    <span class="stats-label">Last 30 days:</span>
                    <span class="stats-value" id="last30Label">PnL: 0.0R • $0.00</span>
                  </p>
                  <p>
                    <span class="stats-label">Total trades:</span>
                    <span class="stats-value" id="totalTradesLabel">0 trades.</span>
                  </p>
                  <p>
                    <span class="stats-label">Best day (USD):</span>
                    <span class="stats-value" id="bestDayLabel">$0.00</span>
                  </p>
                  <p>
                    <span class="stats-label">Worst day (USD):</span>
                    <span class="stats-value" id="worstDayLabel">$0.00</span>
                  </p>
                </div>
              </div>

              <div class="mini-card">
                <div class="mini-title calendar-title-bar">
                  <button id="calPrev" class="cal-nav-btn">◀</button>
                  <span id="calendarTitle">Calendar – this month</span>
                  <button id="calNext" class="cal-nav-btn">▶</button>
                </div>
                <div class="calendar-grid">
                  <div class="calendar-header">
                    <div>Sun</div>
                    <div>Mon</div>
                    <div>Tue</div>
                    <div>Wed</div>
                    <div>Thu</div>
                    <div>Fri</div>
                    <div>Sat</div>
                  </div>
                  <div id="calendarDays" class="calendar-days"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Recent trades -->
          <div class="card">
            <div class="card-header">
              <div class="card-title">Recent trades</div>
            </div>
            <div style="overflow-x: auto">
              <table>
                <thead>
                  <tr>
                    <th class="text-center">#</th>
                    <th>Date</th>
                    <th>Pair</th>
                    <th>Dir</th>
                    <th class="text-right">R</th>
                    <th class="text-right">PnL ($)</th>
                    <th class="text-right">Disc%</th>
                    <th>Screenshot</th>
                    <th>Notes</th>
                  </tr>
                </thead>
                <tbody id="tradesTableBody"></tbody>
                <tfoot>
                  <tr>
                    <td colspan="5" class="text-right">Totals:</td>
                    <td id="tfootPnL" class="text-right">$0.00</td>
                    <td id="tfootDisc" class="text-right">0%</td>
                    <td colspan="2"></td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </section>
      </main>

      <footer>
        <div>© 2025 TredLog. All rights reserved.</div>
        <div>
          Contact:
          <a href="mailto:support@tredlog.com">support@tredlog.com</a>
        </div>
      </footer>
    </div>

    <script>
      /*************** UTILITIES ***************/
      function parseNumber(str) {
        if (!str) return 0;
        const cleaned = String(str).replace(/,/g, "").trim();
        const num = Number(cleaned);
        return isNaN(num) ? 0 : num;
      }

      function formatUSD(value) {
        return (
          "$" +
          (value || 0).toLocaleString("en-US", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          })
        );
      }

      function formatR(value) {
        const v = Number(value || 0);
        return v.toFixed(2).replace(/\.00$/, "");
      }

      function todayISO() {
        const d = new Date();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const day = String(d.getDate()).padStart(2, "0");
        return d.getFullYear() + "-" + m + "-" + day;
      }

      function shortDate(dateStr) {
        const d = new Date(dateStr);
        if (isNaN(d)) return dateStr || "";
        const dd = String(d.getDate()).padStart(2, "0");
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const yy = String(d.getFullYear()).slice(-2);
        return dd + "/" + mm + "/" + yy;
      }

      /*************** STORAGE KEYS ***************/
      const STORAGE_KEY_TRADES = "tredlog_trades_v1";
      const STORAGE_KEY_SETTINGS = "tredlog_settings_v1";
      const STORAGE_KEY_RULES = "tredlog_custom_rules_v1";

      /*************** ELEMENTS ***************/
      const startingBalanceInput = document.getElementById("startingBalance");
      const riskPerTradeInput = document.getElementById("riskPerTrade");
      const tradeDateInput = document.getElementById("tradeDate");
      const pairInput = document.getElementById("pair");
      const directionSelect = document.getElementById("direction");
      const sessionInput = document.getElementById("session");
      const riskRInput = document.getElementById("riskR");
      const resultRInput = document.getElementById("resultR");
      const setupInput = document.getElementById("setup");
      const screenshotInput = document.getElementById("screenshot");
      const notesInput = document.getElementById("notes");

      const tradesCountLabel = document.getElementById("tradesCountLabel");
      const equityMeta = document.getElementById("equityMeta");

      const toplinePnL = document.getElementById("toplinePnL");
      const toplineBalance = document.getElementById("toplineBalance");
      const toplineStarting = document.getElementById("toplineStarting");

      const winRateLabel = document.getElementById("winRateLabel");
      const winRateFoot = document.getElementById("winRateFoot");
      const avgRLabel = document.getElementById("avgRLabel");
      const discScoreLabel = document.getElementById("discScoreLabel");

      const last7Label = document.getElementById("last7Label");
      const last30Label = document.getElementById("last30Label");
      const totalTradesLabel = document.getElementById("totalTradesLabel");
      const bestDayLabel = document.getElementById("bestDayLabel");
      const worstDayLabel = document.getElementById("worstDayLabel");

      const calendarTitle = document.getElementById("calendarTitle");
      const calendarDaysEl = document.getElementById("calendarDays");
      const calPrevBtn = document.getElementById("calPrev");
      const calNextBtn = document.getElementById("calNext");

      const tradesTableBody = document.getElementById("tradesTableBody");
      const tfootPnL = document.getElementById("tfootPnL");
      const tfootDisc = document.getElementById("tfootDisc");

      const customRulesList = document.getElementById("customRulesList");
      const customRuleInput = document.getElementById("customRuleInput");
      const btnAddRule = document.getElementById("btnAddRule");

      const chkPlannedR = document.getElementById("chkPlannedR");
      const chkNoRevenge = document.getElementById("chkNoRevenge");
      const chkNoAddRisk = document.getElementById("chkNoAddRisk");
      const chkScreenshotsSaved = document.getElementById("chkScreenshotsSaved");
      const chkAnnotated = document.getElementById("chkAnnotated");
      const chkClearHead = document.getElementById("chkClearHead");
      const rulesHitLabel = document.getElementById("rulesHitLabel");

      const btnSaveDraft = document.getElementById("btnSaveDraft");
      const btnAddTrade = document.getElementById("btnAddTrade");

      const btnExport = document.getElementById("btnExport");
      const btnImport = document.getElementById("btnImport");
      const btnClear = document.getElementById("btnClear");

      const equityCanvas = document.getElementById("equityChart");
      const probCanvas = document.getElementById("probChart");

      let trades = [];
      let customRules = [];
      let startingBalance = 0;
      let riskPerTrade = 0;

      // calendar view state (for navigation)
      let calendarYear = null;
      let calendarMonth = null; // 0-based

      /*************** LOAD INITIAL ***************/
      function loadSettings() {
        tradeDateInput.value = todayISO();

        const rawSettings = localStorage.getItem(STORAGE_KEY_SETTINGS);
        if (rawSettings) {
          try {
            const s = JSON.parse(rawSettings);
            startingBalance = Number(s.startingBalance || 0);
            riskPerTrade = Number(s.riskPerTrade || 0);
          } catch (e) {
            console.warn("Settings parse error", e);
          }
        }
        if (startingBalance > 0) {
          startingBalanceInput.value = startingBalance.toLocaleString("en-US");
        }
        if (riskPerTrade > 0) {
          riskPerTradeInput.value = riskPerTrade.toLocaleString("en-US");
        }
      }

      function saveSettings() {
        startingBalance = parseNumber(startingBalanceInput.value);
        riskPerTrade = parseNumber(riskPerTradeInput.value);
        localStorage.setItem(
          STORAGE_KEY_SETTINGS,
          JSON.stringify({
            startingBalance,
            riskPerTrade,
          })
        );
      }

      function loadTrades() {
        const raw = localStorage.getItem(STORAGE_KEY_TRADES);
        if (raw) {
          try {
            trades = JSON.parse(raw) || [];
          } catch (e) {
            console.warn("Trades parse error", e);
            trades = [];
          }
        }
      }

      function saveTrades() {
        localStorage.setItem(STORAGE_KEY_TRADES, JSON.stringify(trades));
      }

      function loadRules() {
        const raw = localStorage.getItem(STORAGE_KEY_RULES);
        if (raw) {
          try {
            customRules = JSON.parse(raw) || [];
          } catch (e) {
            customRules = [];
          }
        }
        renderCustomRules();
      }

      function saveRules() {
        localStorage.setItem(STORAGE_KEY_RULES, JSON.stringify(customRules));
      }

      /*************** CUSTOM RULES ***************/
      function renderCustomRules() {
        customRulesList.innerHTML = "";
        if (!customRules.length) {
          const p = document.createElement("div");
          p.className = "checklist-sub";
          p.textContent = "No custom rules yet. Add your checklist items above.";
          customRulesList.appendChild(p);
          return;
        }
        customRules.forEach((text, idx) => {
          const div = document.createElement("div");
          div.className = "check-item";
          const input = document.createElement("input");
          input.type = "checkbox";
          input.dataset.customIndex = idx;
          const span = document.createElement("span");
          span.textContent = text;
          div.appendChild(input);
          div.appendChild(span);
          customRulesList.appendChild(div);
        });
      }

      btnAddRule.addEventListener("click", () => {
        const val = customRuleInput.value.trim();
        if (!val) return;
        customRules.push(val);
        customRuleInput.value = "";
        saveRules();
        renderCustomRules();
      });

      /*************** CHECKLIST DISCIPLINE ***************/
      function computeDisciplineScoreForCurrent() {
        const coreChecks = [
          chkPlannedR.checked,
          chkNoRevenge.checked,
          chkNoAddRisk.checked,
          chkScreenshotsSaved.checked,
          chkAnnotated.checked,
          chkClearHead.checked,
        ];
        const hits = coreChecks.filter(Boolean).length;
        const total = coreChecks.length;
        const pct = total ? Math.round((hits / total) * 100) : 0;
        rulesHitLabel.textContent = `${hits} / ${total} rules followed (${pct}% discipline).`;
        return { hits, total, pct };
      }

      [
        chkPlannedR,
        chkNoRevenge,
        chkNoAddRisk,
        chkScreenshotsSaved,
        chkAnnotated,
        chkClearHead,
      ].forEach((el) =>
        el.addEventListener("change", () => {
          computeDisciplineScoreForCurrent();
        })
      );

      /*************** ADD TRADE ***************/
      btnSaveDraft.addEventListener("click", () => {
        saveSettings();
        alert("Draft saved (starting balance and risk per trade).");
      });

      btnAddTrade.addEventListener("click", () => {
        saveSettings();
        const trade = collectTradeFromForm();
        if (!trade) return;
        trades.push(trade);
        saveTrades();
        clearFormAfterSave();
        refreshAll();
      });

      function collectTradeFromForm() {
        const dateStr = tradeDateInput.value || todayISO();
        const pair = pairInput.value.trim();
        const dir = directionSelect.value;
        const ses = sessionInput.value.trim();
        const riskR = parseNumber(riskRInput.value) || 1;
        const resultR = Number(resultRInput.value || 0);
        const setup = setupInput.value.trim();
        const screenshotUrl = screenshotInput.value.trim();
        const notes = notesInput.value.trim();

        const { hits, total, pct } = computeDisciplineScoreForCurrent();

        if (!pair || !dir || !resultR) {
          if (!pair) alert("Please enter pair/symbol.");
          if (!dir) alert("Please select direction.");
          if (!resultR) alert("Please enter result in R (can be negative).");
          return null;
        }

        return {
          date: dateStr,
          pair,
          dir,
          session: ses,
          riskR,
          resultR,
          setup,
          screenshot: screenshotUrl,
          notes,
          discHits: hits,
          discTotal: total,
          discPct: pct,
        };
      }

      function clearFormAfterSave() {
        tradeDateInput.value = todayISO();
        pairInput.value = "";
        directionSelect.value = "";
        sessionInput.value = "";
        riskRInput.value = "";
        resultRInput.value = "";
        setupInput.value = "";
        screenshotInput.value = "";
        notesInput.value = "";
        [
          chkPlannedR,
          chkNoRevenge,
          chkNoAddRisk,
          chkScreenshotsSaved,
          chkAnnotated,
          chkClearHead,
        ].forEach((el) => (el.checked = false));
        computeDisciplineScoreForCurrent();
      }

      /*************** EXPORT / IMPORT / CLEAR ***************/
      btnExport.addEventListener("click", () => {
        const payload = {
          version: 1,
          exportedAt: new Date().toISOString(),
          trades,
          settings: {
            startingBalance,
            riskPerTrade,
          },
          customRules,
        };
        const blob = new Blob([JSON.stringify(payload, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "tredlog-backup.json";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        alert(
          "Backup exported. Save this file somewhere safe (e.g. OneDrive). You can re-import it later."
        );
      });

      btnImport.addEventListener("click", () => {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = "application/json";
        input.addEventListener("change", (e) => {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (evt) => {
            try {
              const data = JSON.parse(evt.target.result);
              if (Array.isArray(data.trades)) {
                trades = data.trades;
                saveTrades();
              }
              if (data.settings) {
                startingBalance = Number(data.settings.startingBalance || 0);
                riskPerTrade = Number(data.settings.riskPerTrade || 0);
                startingBalanceInput.value =
                  startingBalance > 0
                    ? startingBalance.toLocaleString("en-US")
                    : "";
                riskPerTradeInput.value =
                  riskPerTrade > 0 ? riskPerTrade.toLocaleString("en-US") : "";
                saveSettings();
              }
              if (Array.isArray(data.customRules)) {
                customRules = data.customRules;
                saveRules();
                renderCustomRules();
              }
              refreshAll();
              alert("Backup imported successfully.");
            } catch (err) {
              console.error(err);
              alert("Import failed – not a valid TredLog backup.");
            }
          };
          reader.readAsText(file);
        });
        input.click();
      });

      btnClear.addEventListener("click", () => {
        if (!confirm("Really clear all local data for this dashboard?")) return;
        localStorage.removeItem(STORAGE_KEY_TRADES);
        localStorage.removeItem(STORAGE_KEY_SETTINGS);
        localStorage.removeItem(STORAGE_KEY_RULES);
        trades = [];
        startingBalance = 0;
        riskPerTrade = 0;
        startingBalanceInput.value = "";
        riskPerTradeInput.value = "";
        refreshAll();
      });

      /*************** VIEW HELPERS ***************/
      function ensureCalendarState() {
        if (calendarYear === null || calendarMonth === null) {
          const now = new Date();
          calendarYear = now.getFullYear();
          calendarMonth = now.getMonth();
        }
      }

      function getTradesForCalendarMonth() {
        ensureCalendarState();
        return trades.filter((t) => {
          const d = new Date(t.date);
          if (isNaN(d)) return false;
          return (
            d.getFullYear() === calendarYear && d.getMonth() === calendarMonth
          );
        });
      }

      /*************** RENDERING ***************/
      function refreshAll() {
        saveSettings();
        renderCountsAndTopline();
        renderStatsAndCharts();
        renderCalendar();
        renderTrades();
      }

      function renderCountsAndTopline() {
        tradesCountLabel.textContent =
          trades.length === 1
            ? "1 trade logged"
            : `${trades.length} trades logged`;

        let totalR = 0;
        let totalUsd = 0;
        trades.forEach((t) => {
          const r = Number(t.resultR || 0);
          totalR += r;
          totalUsd += r * (riskPerTrade || 0);
        });

        const balance = startingBalance + totalUsd;

        toplinePnL.textContent = formatUSD(totalUsd);
        toplineBalance.textContent = formatUSD(balance);
        toplineStarting.textContent = formatUSD(startingBalance);
      }

      function renderStatsAndCharts() {
        if (!trades.length) {
          equityMeta.textContent =
            "No trades yet. Log your first setup to start drawing your curve.";
        }

        // Win rate & avg R
        let wins = 0;
        let totalR = 0;
        let discSum = 0;
        let discCount = 0;
        trades.forEach((t) => {
          const r = Number(t.resultR || 0);
          totalR += r;
          if (r > 0) wins++;
          if (t.discPct != null) {
            discSum += Number(t.discPct || 0);
            discCount++;
          }
        });

        const winRate = trades.length ? Math.round((wins / trades.length) * 100) : 0;
        const avgR = trades.length ? totalR / trades.length : 0;
        const discAvg = discCount ? Math.round(discSum / discCount) : 0;

        winRateLabel.textContent = `${winRate}%`;
        winRateFoot.textContent =
          trades.length === 0
            ? "No trades yet."
            : `Based on ${wins} trade${
                wins === 1 ? "" : "s"
              } with R > 0 out of ${trades.length}.`;
        avgRLabel.textContent = `${formatR(avgR)}R`;
        discScoreLabel.textContent = `${discAvg} / 100`;

        // Weekly/monthly stats (rolling windows)
        const now = new Date();
        const last7Cutoff = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        const last30Cutoff = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);

        let last7R = 0,
          last7Usd = 0;
        let last30R = 0,
          last30Usd = 0;

        const dayMap = {}; // yyyy-mm-dd -> usd
        trades.forEach((t) => {
          const d = new Date(t.date);
          const r = Number(t.resultR || 0);
          const usd = r * (riskPerTrade || 0);
          const dayKey = t.date;

          if (d >= last7Cutoff) {
            last7R += r;
            last7Usd += usd;
          }
          if (d >= last30Cutoff) {
            last30R += r;
            last30Usd += usd;
          }
          dayMap[dayKey] = (dayMap[dayKey] || 0) + usd;
        });

        let bestDayVal = 0;
        let worstDayVal = 0;
        Object.values(dayMap).forEach((usd) => {
          if (usd > bestDayVal) bestDayVal = usd;
          if (usd < worstDayVal) worstDayVal = usd;
        });

        last7Label.textContent = `PnL: ${formatR(last7R)}R • ${formatUSD(last7Usd)}`;
        last30Label.textContent = `PnL: ${formatR(last30R)}R • ${formatUSD(last30Usd)}`;
        totalTradesLabel.textContent = `${trades.length} trade${
          trades.length === 1 ? "" : "s"
        }.`;
        bestDayLabel.textContent = formatUSD(bestDayVal);
        worstDayLabel.textContent = formatUSD(worstDayVal);

        drawEquityChart();
        drawProbabilityChart();
      }

      function drawEquityChart() {
        const ctx = equityCanvas.getContext("2d");
        const w = equityCanvas.width;
        const h = equityCanvas.height;
        ctx.clearRect(0, 0, w, h);

        ctx.fillStyle = "#020617";
        ctx.fillRect(0, 0, w, h);

        if (!trades.length) {
          ctx.fillStyle = "#4b5563";
          ctx.font = "11px system-ui";
          ctx.fillText("No trades yet", 10, h / 2);
          return;
        }

        // cumulative R
        const cumR = [];
        let running = 0;
        trades.forEach((t) => {
          running += Number(t.resultR || 0);
          cumR.push(running);
        });

        const minR = Math.min(0, ...cumR);
        const maxR = Math.max(0, ...cumR);
        const padding = 18;
        const innerW = w - padding * 2;
        const innerH = h - padding * 2;

        ctx.strokeStyle = "#111827";
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(padding, padding);
        ctx.lineTo(padding, h - padding);
        ctx.lineTo(w - padding, h - padding);
        ctx.stroke();

        ctx.beginPath();
        ctx.strokeStyle = "#facc15";
        ctx.lineWidth = 2;

        cumR.forEach((val, idx) => {
          const x = padding + (innerW * idx) / Math.max(1, cumR.length - 1);
          const t =
            maxR === minR ? 0.5 : (val - minR) / (maxR - minR); // 0..1
          const y = h - padding - t * innerH;
          if (idx === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        });
        ctx.stroke();
      }

      function drawProbabilityChart() {
        const ctx = probCanvas.getContext("2d");
        const w = probCanvas.width;
        const h = probCanvas.height;
        ctx.clearRect(0, 0, w, h);
        ctx.fillStyle = "#020617";
        ctx.fillRect(0, 0, w, h);

        if (!trades.length) {
          ctx.fillStyle = "#4b5563";
          ctx.font = "11px system-ui";
          ctx.fillText("No trades yet", 10, h / 2);
          return;
        }

        let wins = 0;
        let losses = 0;
        trades.forEach((t) => {
          const r = Number(t.resultR || 0);
          if (r > 0) wins++;
          else if (r < 0) losses++;
        });

        const total = wins + losses || 1;
        const winPct = wins / total;
        const lossPct = losses / total;

        const padding = 20;
        const barW = (w - padding * 2) / 3;

        function drawBar(x, pct, color) {
          const maxH = h - padding * 2;
          const barH = maxH * pct;
          ctx.fillStyle = color;
          ctx.fillRect(
            x,
            h - padding - barH,
            barW,
            barH < 2 ? 2 : barH // ensure visible
          );
        }

        drawBar(padding, winPct, "#22c55e");
        drawBar(padding + barW * 2, lossPct, "#f87171");

        ctx.fillStyle = "#9ca3af";
        ctx.font = "10px system-ui";
        ctx.textAlign = "center";
        ctx.fillText("Wins", padding + barW / 2, h - 6);
        ctx.fillText("Losses", padding + barW * 2 + barW / 2, h - 6);
      }

      /*************** CALENDAR ***************/
      function renderCalendar() {
        ensureCalendarState();

        const now = new Date();
        const year = calendarYear;
        const month = calendarMonth; // 0-based
        const first = new Date(year, month, 1);
        const firstWeekday = first.getDay(); // 0=Sun
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        const monthName = first.toLocaleString("default", { month: "long" });
        calendarTitle.textContent = `Calendar – ${monthName} ${year}`;

        // map date -> pnl for this month
        const dayPnLMap = {};
        trades.forEach((t) => {
          const d = new Date(t.date);
          if (d.getFullYear() === year && d.getMonth() === month) {
            const r = Number(t.resultR || 0);
            const usd = r * (riskPerTrade || 0);
            const day = d.getDate();
            dayPnLMap[day] = (dayPnLMap[day] || 0) + usd;
          }
        });

        calendarDaysEl.innerHTML = "";
        // blanks before first day
        for (let i = 0; i < firstWeekday; i++) {
          const cell = document.createElement("div");
          cell.className = "day-cell";
          calendarDaysEl.appendChild(cell);
        }

        const today = new Date();
        const todayYear = today.getFullYear();
        const todayMonth = today.getMonth();
        const todayDay = today.getDate();

        for (let d = 1; d <= daysInMonth; d++) {
          const cell = document.createElement("div");
          cell.className = "day-cell";
          cell.textContent = d;

          const pnl = dayPnLMap[d] || 0;
          if (pnl !== 0) {
            const span = document.createElement("span");
            span.className = "day-pnl";
            span.textContent = (pnl > 0 ? "+" : "") + pnl.toFixed(0);
            cell.appendChild(span);
            if (pnl > 0) cell.classList.add("has-trade");
            if (pnl < 0) cell.classList.add("loss-day");
          }

          if (year === todayYear && month === todayMonth && d === todayDay) {
            cell.classList.add("today");
          }

          calendarDaysEl.appendChild(cell);
        }
      }

      // calendar navigation
      calPrevBtn.addEventListener("click", () => {
        ensureCalendarState();
        calendarMonth--;
        if (calendarMonth < 0) {
          calendarMonth = 11;
          calendarYear--;
        }
        renderCalendar();
        renderTrades(); // sync table
      });

      calNextBtn.addEventListener("click", () => {
        ensureCalendarState();
        calendarMonth++;
        if (calendarMonth > 11) {
          calendarMonth = 0;
          calendarYear++;
        }
        renderCalendar();
        renderTrades(); // sync table
      });

      /*************** TRADES TABLE (month-synced, screenshot links) ***************/
      function renderTrades() {
        tradesTableBody.innerHTML = "";

        const viewTrades = getTradesForCalendarMonth()
          .slice()
          .sort((a, b) => new Date(a.date) - new Date(b.date));

        if (!viewTrades.length) {
          tfootPnL.textContent = "$0.00";
          tfootDisc.textContent = "0%";
          return;
        }

        let totalUsd = 0;
        let discSum = 0;
        let discCount = 0;

        viewTrades.forEach((t, idx) => {
          const row = document.createElement("tr");
          const r = Number(t.resultR || 0);
          const usd = r * (riskPerTrade || 0);
          totalUsd += usd;

          const disc = Number(t.discPct || 0);
          if (!isNaN(disc)) {
            discSum += disc;
            discCount++;
          }

          const cells = [];
          for (let i = 0; i < 9; i++) {
            const td = document.createElement("td");
            cells.push(td);
            row.appendChild(td);
          }

          cells[0].className = "text-center";
          cells[0].textContent = idx + 1;

          cells[1].textContent = shortDate(t.date);
          cells[2].textContent = t.pair || "";
          cells[3].textContent = t.dir || "";

          cells[4].className = "text-right";
          cells[4].textContent = formatR(t.resultR);

          cells[5].className = "text-right";
          cells[5].textContent = formatUSD(usd);

          cells[6].className = "text-right";
          cells[6].textContent = `${disc}%`;

          // Screenshot link
          const screenshotCell = cells[7];
          const url = (t.screenshot || "").trim();
          if (url) {
            const a = document.createElement("a");
            a.href = url;
            a.target = "_blank";
            a.rel = "noopener";
            a.textContent = "View";
            a.className = "link";
            screenshotCell.appendChild(a);
          } else {
            screenshotCell.textContent = "—";
          }

          cells[8].textContent = t.notes || "";

          tradesTableBody.appendChild(row);
        });

        tfootPnL.textContent = formatUSD(totalUsd);
        const discAvg = discCount ? Math.round(discSum / discCount) : 0;
        tfootDisc.textContent = `${discAvg}%`;
      }

      /*************** INIT ***************/
      function init() {
        loadSettings();
        loadTrades();
        loadRules();
        computeDisciplineScoreForCurrent();

        // default calendar to current month
        const now = new Date();
        calendarYear = now.getFullYear();
        calendarMonth = now.getMonth();

        refreshAll();
      }

      init();
    </script>
  </body>
</html>
