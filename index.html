<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>TredLog – Probability-driven trading journal – Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- ===== SIMPLE PASSWORD GATE (CLIENT-SIDE ONLY) ===== -->
    <script>
      // Edit this if you ever want to change your password
      const DASHBOARD_PASSWORD = "Alihandroz2099";

      (function () {
        if (!DASHBOARD_PASSWORD) return; // disable gate if empty

        const KEY = "tredlog_auth_v2";
        if (sessionStorage.getItem(KEY) === "yes") return;

        let ok = false;
        try {
          for (let i = 0; i < 5; i++) {
            const pw = prompt("Enter your TredLog dashboard password:");
            if (pw === null) break;
            if (pw === DASHBOARD_PASSWORD) {
              ok = true;
              break;
            }
            alert("Incorrect password, try again.");
          }
        } catch (e) {
          console.warn("Password gate error:", e);
        }

        if (!ok) {
          document.write(
            "<h2 style='font-family:system-ui,sans-serif;color:#f97373;text-align:center;margin-top:3rem;'>Access denied.</h2>"
          );
          throw new Error("Access denied");
        }
        sessionStorage.setItem(KEY, "yes");
      })();
    </script>

    <!-- Charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      :root {
        --bg: #050816;
        --bg-elevated: #0b1020;
        --bg-elevated-soft: #111827;
        --accent: #ffc24b;
        --accent-soft: rgba(255, 194, 75, 0.12);
        --accent-green: #22c55e;
        --accent-red: #ef4444;
        --muted: #9ca3af;
        --text: #f9fafb;
        --border-soft: rgba(148, 163, 184, 0.35);
        --radius: 18px;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
          -apple-system, system-ui, sans-serif;
        background: radial-gradient(circle at top, #172033 0, #050816 45%);
        color: var(--text);
        display: flex;
        justify-content: center;
      }

      .shell {
        width: 100%;
        max-width: 1400px;
        padding: 24px 16px 40px;
      }

      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
      }

      .logo-row {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .logo-icon {
        width: 28px;
        height: 28px;
        border-radius: 999px;
        background: radial-gradient(
          circle at 30% 20%,
          #ffe29f,
          #ff9f4a 45%,
          #ff3c3c 100%
        );
        box-shadow: 0 0 0 4px rgba(255, 194, 75, 0.15);
      }

      .logo-text-main {
        font-weight: 600;
        letter-spacing: 0.02em;
      }

      .logo-sub {
        font-size: 11px;
        color: var(--muted);
      }

      .header-badges {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: flex-end;
      }

      .header-pill {
        padding: 6px 12px;
        border-radius: 999px;
        font-size: 11px;
        border: 1px solid var(--border-soft);
        color: var(--muted);
        background: rgba(15, 23, 42, 0.7);
      }

      .header-pill.positive {
        border-color: rgba(22, 163, 74, 0.7);
        color: #bbf7d0;
        background: rgba(22, 163, 74, 0.12);
      }

      .top-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 12px;
        justify-content: flex-end;
      }

      .top-btn {
        border-radius: 999px;
        padding: 6px 12px;
        font-size: 11px;
        border: 1px solid var(--border-soft);
        background: rgba(15, 23, 42, 0.9);
        color: var(--muted);
        cursor: pointer;
      }

      .top-btn.primary {
        border-color: rgba(34, 197, 94, 0.7);
        color: #bbf7d0;
        background: rgba(22, 163, 74, 0.12);
      }

      .top-btn.danger {
        border-color: rgba(239, 68, 68, 0.7);
        color: #fecaca;
        background: rgba(239, 68, 68, 0.16);
      }

      .top-btn:hover {
        filter: brightness(1.05);
      }

      main {
        display: grid;
        grid-template-columns: minmax(0, 1.08fr) minmax(0, 1.05fr);
        gap: 16px;
      }

      .card {
        border-radius: var(--radius);
        background: radial-gradient(circle at top left, #151a2b, #050816 60%);
        border: 1px solid rgba(148, 163, 184, 0.32);
      }

      .card-inner {
        padding: 18px 18px 16px;
      }

      .card-title-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .card-title {
        font-size: 13px;
        font-weight: 600;
      }

      .card-subtitle {
        font-size: 11px;
        color: var(--muted);
      }

      .muted {
        color: var(--muted);
      }

      .field-row {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 8px;
        margin-bottom: 8px;
      }

      .field-row-3 {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 8px;
        margin-bottom: 8px;
      }

      .field {
        display: flex;
        flex-direction: column;
        gap: 3px;
      }

      label {
        font-size: 11px;
        color: var(--muted);
      }

      input[type="text"],
      input[type="number"],
      select,
      textarea {
        border-radius: 999px;
        border: 1px solid rgba(55, 65, 81, 0.9);
        background: rgba(15, 23, 42, 0.95);
        color: var(--text);
        padding: 7px 11px;
        font-size: 12px;
        outline: none;
        width: 100%;
      }

      textarea {
        border-radius: 12px;
        min-height: 80px;
        resize: vertical;
      }

      input::placeholder,
      textarea::placeholder {
        color: rgba(148, 163, 184, 0.7);
      }

      .field-inline {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .btn {
        border-radius: 999px;
        padding: 7px 14px;
        font-size: 12px;
        border: none;
        cursor: pointer;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
      }

      .btn-primary {
        background: linear-gradient(90deg, #ffc24b, #ff9a3c);
        color: #111827;
        box-shadow: 0 10px 22px rgba(255, 194, 75, 0.28);
      }

      .btn-ghost {
        background: transparent;
        color: var(--muted);
        border: 1px solid rgba(148, 163, 184, 0.6);
      }

      .btn-small {
        padding: 5px 10px;
        font-size: 11px;
      }

      .btn-primary:hover,
      .btn-ghost:hover {
        filter: brightness(1.05);
      }

      .trade-footer-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 8px;
      }

      /* Weighted checklist */

      .checklist-row {
        display: grid;
        grid-template-columns: 2fr 1.5fr 1.5fr;
        gap: 8px;
      }

      .checklist-section-title {
        font-size: 11px;
        font-weight: 600;
        margin-bottom: 4px;
      }

      .rule-row {
        display: flex;
        align-items: center;
        gap: 5px;
        margin-bottom: 2px;
        font-size: 11px;
      }

      .rule-row input[type="checkbox"] {
        width: 11px;
        height: 11px;
      }

      .custom-rule-add-row {
        display: flex;
        gap: 6px;
        margin-top: 6px;
      }

      .custom-rule-input {
        flex: 1;
        border-radius: 999px;
        padding: 5px 9px;
        font-size: 11px;
      }

      .discipline-summary {
        text-align: right;
        margin-top: 4px;
        font-size: 10px;
        color: var(--muted);
      }

      .discipline-summary span {
        color: #e5e7eb;
      }

      /* Right column: stats, charts, calendar */

      .stats-header {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 8px;
        margin-top: 6px;
      }

      .stat-box {
        border-radius: 12px;
        background: rgba(15, 23, 42, 0.96);
        border: 1px solid rgba(31, 41, 55, 0.9);
        padding: 7px 9px;
        font-size: 11px;
      }

      .stat-label {
        color: var(--muted);
        margin-bottom: 3px;
      }

      .stat-value {
        font-size: 13px;
        font-weight: 600;
      }

      .stat-caption {
        margin-top: 2px;
        font-size: 10px;
        color: var(--muted);
      }

      .equity-grid {
        display: grid;
        grid-template-columns: minmax(0, 1.1fr) minmax(0, 0.9fr);
        gap: 8px;
        margin-top: 10px;
      }

      .chart-card {
        border-radius: 14px;
        background: rgba(15, 23, 42, 0.96);
        border: 1px solid rgba(31, 41, 55, 0.9);
        padding: 8px 9px;
        font-size: 10px;
      }

      .chart-title-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 4px;
      }

      .chart-title {
        font-size: 11px;
        font-weight: 600;
      }

      .chart-meta {
        font-size: 9px;
        color: var(--muted);
      }

      .chart-wrapper {
        height: 160px;
      }

      .lower-right-row {
        display: grid;
        grid-template-columns: minmax(0, 1.1fr) minmax(0, 0.9fr);
        gap: 8px;
        margin-top: 10px;
      }

      .mini-card {
        border-radius: 14px;
        background: rgba(15, 23, 42, 0.96);
        border: 1px solid rgba(31, 41, 55, 0.9);
        padding: 8px 9px;
        font-size: 10px;
      }

      .mini-title {
        font-size: 11px;
        font-weight: 600;
        margin-bottom: 4px;
      }

      .mini-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 2px;
      }

      .mini-label {
        color: var(--muted);
      }

      .mini-value {
        font-weight: 500;
      }

      /* Calendar */

      .calendar-card {
        border-radius: 14px;
        background: rgba(15, 23, 42, 0.96);
        border: 1px solid rgba(31, 41, 55, 0.9);
        padding: 8px 9px;
        font-size: 10px;
      }

      .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 4px;
      }

      .calendar-title {
        font-size: 11px;
        font-weight: 600;
      }

      .calendar-grid-header,
      .calendar-grid-body {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 2px;
      }

      .calendar-grid-header div {
        text-align: center;
        font-size: 9px;
        color: var(--muted);
        padding-bottom: 2px;
      }

      .calendar-cell {
        height: 26px;
        border-radius: 6px;
        border: 1px solid rgba(31, 41, 55, 0.9);
        background: rgba(15, 23, 42, 0.96);
        font-size: 9px;
        padding: 2px 3px;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
      }

      .calendar-cell.empty {
        border-color: transparent;
        background: transparent;
      }

      .cal-date {
        font-size: 9px;
        color: var(--muted);
      }

      .cal-pnl {
        font-size: 8px;
      }

      .cal-pnl.win {
        color: var(--accent-green);
      }

      .cal-pnl.loss {
        color: var(--accent-red);
      }

      /* Recent trades table */

      .recent-card {
        border-radius: 14px;
        background: rgba(15, 23, 42, 0.96);
        border: 1px solid rgba(31, 41, 55, 0.9);
        padding: 8px 9px 10px;
        margin-top: 10px;
        font-size: 10px;
      }

      .recent-title {
        font-size: 11px;
        font-weight: 600;
        margin-bottom: 4px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 10px;
      }

      th,
      td {
        text-align: left;
        padding: 4px 4px;
        border-bottom: 1px solid rgba(31, 41, 55, 0.9);
      }

      th {
        font-weight: 500;
        color: var(--muted);
      }

      td.amount-win {
        color: var(--accent-green);
      }

      td.amount-loss {
        color: var(--accent-red);
      }

      footer {
        margin-top: 18px;
        font-size: 10px;
        color: var(--muted);
        display: flex;
        justify-content: space-between;
        gap: 8px;
        flex-wrap: wrap;
      }

      footer a {
        color: var(--accent);
        text-decoration: none;
      }

      footer a:hover {
        text-decoration: underline;
      }

      @media (max-width: 1080px) {
        main {
          grid-template-columns: minmax(0, 1fr);
        }
      }

      @media (max-width: 720px) {
        header {
          flex-direction: column;
          align-items: flex-start;
          gap: 8px;
        }

        .top-buttons {
          justify-content: flex-start;
        }
      }
    </style>
  </head>
  <body>
    <div class="shell">
      <header>
        <div class="logo-row">
          <div class="logo-icon"></div>
          <div>
            <div class="logo-text-main">TredLog</div>
            <div class="logo-sub">Probability-driven trading journal – Dashboard</div>
          </div>
        </div>
        <div class="header-badges">
          <div class="header-pill">Local session • Browser storage only</div>
          <div class="header-pill positive">Built for serious traders</div>
        </div>
      </header>

      <div class="top-buttons">
        <button class="top-btn primary" type="button">Local session • Browser storage only</button>
        <button id="exportBtn" class="top-btn" type="button">Export backup</button>
        <button id="importBtn" class="top-btn" type="button">Import backup</button>
        <input id="importFile" type="file" accept="application/json" style="display:none" />
        <button id="clearBtn" class="top-btn danger" type="button">Clear local data</button>
      </div>

      <main>
        <!-- LEFT: New trade + checklist -->
        <section class="card">
          <div class="card-inner">
            <div class="card-title-row">
              <div>
                <div class="card-title">Account & new trade</div>
                <div class="card-subtitle">
                  Set your starting balance once, then log trades and track PnL in R and USD.
                </div>
              </div>
              <div class="card-subtitle">
                <span id="tradeCount">0</span> trades logged
              </div>
            </div>

            <!-- Starting balance / risk -->
            <div class="field-row">
              <div class="field">
                <label for="startingBalance">Starting balance (USD)</label>
                <input
                  id="startingBalance"
                  type="text"
                  placeholder="e.g. 10,000"
                  autocomplete="off"
                />
              </div>
              <div class="field">
                <label for="riskPerTrade">Risk per trade (USD)</label>
                <input
                  id="riskPerTrade"
                  type="text"
                  placeholder="e.g. 1,000"
                  autocomplete="off"
                />
              </div>
            </div>

            <!-- Date / pair -->
            <div class="field-row">
              <div class="field">
                <label for="tradeDate">Date</label>
                <input id="tradeDate" type="text" placeholder="dd/mm/yyyy" autocomplete="off" />
              </div>
              <div class="field">
                <label for="pair">Pair / symbol</label>
                <input id="pair" type="text" placeholder="e.g. GBPUSD" autocomplete="off" />
              </div>
            </div>

            <!-- Direction / session -->
            <div class="field-row">
              <div class="field">
                <label for="direction">Direction</label>
                <select id="direction">
                  <option value="">Select</option>
                  <option value="Buy">Buy</option>
                  <option value="Sell">Sell</option>
                </select>
              </div>
              <div class="field">
                <label for="session">Session</label>
                <input
                  id="session"
                  type="text"
                  placeholder="London, NY, Asia..."
                  autocomplete="off"
                />
              </div>
            </div>

            <!-- Risk (R) / Result (R) -->
            <div class="field-row">
              <div class="field">
                <label for="riskR">Risk (R)</label>
                <input id="riskR" type="text" placeholder="1" autocomplete="off" />
              </div>
              <div class="field">
                <label for="resultR">Result (R)</label>
                <input id="resultR" type="text" placeholder="e.g. -1, 0.5, 2" autocomplete="off" />
              </div>
            </div>

            <!-- Setup / screenshot -->
            <div class="field-row">
              <div class="field">
                <label for="setup">Setup</label>
                <input
                  id="setup"
                  type="text"
                  placeholder="Momentum, pullback, range break..."
                  autocomplete="off"
                />
              </div>
              <div class="field">
                <label for="screenshot">Screenshot / chart link</label>
                <input
                  id="screenshot"
                  type="text"
                  placeholder="Paste TradingView or chart URL"
                  autocomplete="off"
                />
              </div>
            </div>

            <!-- Journal notes -->
            <div class="field">
              <label for="notes">Journal notes</label>
              <textarea
                id="notes"
                placeholder="What did you see? Which rules were met? Where could you improve?"
              ></textarea>
            </div>

            <!-- Weighted checklist -->
            <div style="margin-top: 10px">
              <div class="card-title">Weighted checklist</div>
              <div class="card-subtitle">
                Tick only what actually happened on this trade. Custom setup rules are for you only –
                discipline % is based on the core rules.
              </div>
            </div>

            <div class="checklist-row" style="margin-top: 8px">
              <!-- Custom setup checklist (user-defined, not counted in discipline) -->
              <div>
                <div class="checklist-section-title">Custom setup checklist</div>
                <div id="customRulesContainer" class="muted" style="font-size: 11px">
                  <div class="muted" style="font-size: 10px; margin-bottom: 4px">
                    Add your own rules (e.g. “Clean close at level”, “No double wick”).
                  </div>
                  <!-- Custom rules will render here -->
                </div>
                <div class="custom-rule-add-row">
                  <input
                    id="newCustomRule"
                    class="custom-rule-input"
                    type="text"
                    placeholder="e.g. Clean close at level"
                  />
                  <button id="addCustomRuleBtn" class="btn btn-small btn-ghost" type="button">
                    Add
                  </button>
                </div>
              </div>

              <!-- Risk & discipline (CORE) -->
              <div>
                <div class="checklist-section-title">Risk & discipline</div>
                <div class="rule-row">
                  <input id="riskRule1" type="checkbox" />
                  <span>Planned R respected.</span>
                </div>
                <div class="rule-row">
                  <input id="riskRule2" type="checkbox" />
                  <span>No revenge trades.</span>
                </div>
                <div class="rule-row">
                  <input id="riskRule3" type="checkbox" />
                  <span>No adding risk mid-trade.</span>
                </div>
              </div>

              <!-- Screenshots / behaviour (CORE) -->
              <div>
                <div class="checklist-section-title">Screenshots / behaviour</div>
                <div class="rule-row">
                  <input id="behRule1" type="checkbox" />
                  <span>Screenshots saved for review.</span>
                </div>
                <div class="rule-row">
                  <input id="behRule2" type="checkbox" />
                  <span>Annotated before & after.</span>
                </div>
                <div class="rule-row">
                  <input id="behRule3" type="checkbox" />
                  <span>Clear headspace / no FOMO late session.</span>
                </div>
              </div>
            </div>

            <div class="discipline-summary">
              <span id="disciplineSummaryText">0 / 6 rules followed (0% discipline).</span>
              <span> Higher score → higher discipline per trade.</span>
            </div>

            <div class="trade-footer-row">
              <button id="saveDraftBtn" class="btn btn-small btn-ghost" type="button">
                Save draft
              </button>
              <button id="addTradeBtn" class="btn btn-primary" type="button">
                Add trade to log
              </button>
            </div>
          </div>
        </section>

        <!-- RIGHT: Stats, charts, calendar, recent trades -->
        <section class="card">
          <div class="card-inner">
            <div class="card-title-row">
              <div>
                <div class="card-title">Equity & discipline overview</div>
                <div class="card-subtitle">High-level view of your performance in R and USD.</div>
              </div>
              <div class="card-subtitle" id="totalsLine">
                Total PnL: $0.00 • Balance: $0.00 • Starting: $0.00
              </div>
            </div>

            <!-- Win rate / Avg R / Discipline -->
            <div class="stats-header">
              <div class="stat-box">
                <div class="stat-label">WIN RATE</div>
                <div class="stat-value" id="winRateText">0%</div>
                <div class="stat-caption" id="winRateCaption">Based on R ≠ 0 trades.</div>
              </div>
              <div class="stat-box">
                <div class="stat-label">AVG R (REALIZED)</div>
                <div class="stat-value" id="avgRText">0.0R</div>
                <div class="stat-caption">From all logged trades.</div>
              </div>
              <div class="stat-box">
                <div class="stat-label">DISCIPLINE SCORE</div>
                <div class="stat-value" id="discScoreText">0 / 100</div>
                <div class="stat-caption">Average of checklist discipline per trade.</div>
              </div>
            </div>

            <!-- Equity curve + Probability chart -->
            <div class="equity-grid">
              <div class="chart-card">
                <div class="chart-title-row">
                  <div class="chart-title">Equity curve (cumulative R)</div>
                  <div class="chart-meta" id="equityMeta">
                    Log trades to start drawing your curve in R.
                  </div>
                </div>
                <div class="chart-wrapper">
                  <canvas id="equityChart"></canvas>
                </div>
              </div>
              <div class="chart-card">
                <div class="chart-title-row">
                  <div class="chart-title">Probability view (wins vs losses)</div>
                  <div class="chart-meta">Quick glance at how many trades closed green vs red.</div>
                </div>
                <div class="chart-wrapper">
                  <canvas id="probChart"></canvas>
                </div>
              </div>
            </div>

            <!-- Weekly & monthly + calendar -->
            <div class="lower-right-row">
              <div class="mini-card">
                <div class="mini-title">Weekly & monthly stats</div>
                <div class="mini-row">
                  <div class="mini-label">Last 7 days:</div>
                  <div class="mini-value" id="last7Text">PnL: 0.0R • $0.00</div>
                </div>
                <div class="mini-row">
                  <div class="mini-label">Last 30 days:</div>
                  <div class="mini-value" id="last30Text">PnL: 0.0R • $0.00</div>
                </div>
                <div style="margin-top: 6px; border-top: 1px solid rgba(31,41,55,0.9); padding-top: 4px">
                  <div class="mini-row">
                    <div class="mini-label">Total trades:</div>
                    <div class="mini-value" id="totalTradesMini">0 trades.</div>
                  </div>
                  <div class="mini-row">
                    <div class="mini-label">Best day (USD):</div>
                    <div class="mini-value" id="bestDayText">$0.00</div>
                  </div>
                  <div class="mini-row">
                    <div class="mini-label">Worst day (USD):</div>
                    <div class="mini-value" id="worstDayText">$0.00</div>
                  </div>
                </div>
              </div>

              <div class="calendar-card">
                <div class="calendar-header">
                  <div class="calendar-title" id="calendarTitle">Calendar</div>
                </div>
                <div class="calendar-grid-header">
                  <div>Sun</div>
                  <div>Mon</div>
                  <div>Tue</div>
                  <div>Wed</div>
                  <div>Thu</div>
                  <div>Fri</div>
                  <div>Sat</div>
                </div>
                <div id="calendarBody" class="calendar-grid-body"></div>
              </div>
            </div>

            <!-- Recent trades -->
            <div class="recent-card">
              <div class="recent-title">Recent trades</div>
              <div style="overflow-x: auto">
                <table>
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>Date</th>
                      <th>Pair</th>
                      <th>Dir</th>
                      <th>R</th>
                      <th>PnL ($)</th>
                      <th>Disc%</th>
                      <th>Screenshot</th>
                      <th>Notes</th>
                    </tr>
                  </thead>
                  <tbody id="recentTableBody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </section>
      </main>

      <footer>
        <div>© 2025 TredLog. All rights reserved.</div>
        <div>
          Contact:
          <a href="mailto:support@tredlog.com">support@tredlog.com</a>
        </div>
      </footer>
    </div>

    <script>
      // ===== Helpers =====
      const STORAGE_KEY = "tredlog_dashboard_v3";

      function parseNumber(value) {
        if (value === undefined || value === null) return 0;
        const num = parseFloat(String(value).replace(/,/g, ""));
        return isNaN(num) ? 0 : num;
      }

      function formatUSD(n) {
        return n.toLocaleString("en-US", {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        });
      }

      function formatR(n) {
        return (
          (Math.round(n * 10) / 10)
            .toLocaleString("en-US", {
              minimumFractionDigits: 1,
              maximumFractionDigits: 1,
            }) + "R"
        );
      }

      function todayISO() {
        const d = new Date();
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, "0");
        const day = String(d.getDate()).padStart(2, "0");
        return `${year}-${month}-${day}`;
      }

      function ddmmyyyyFromISO(iso) {
        const [y, m, d] = iso.split("-");
        return `${d}/${m}/${y}`;
      }

      function isoFromDdMmYyyy(str) {
        const parts = str.split(/[./-]/);
        if (parts.length !== 3) return null;
        const [dd, mm, yyyy] = parts;
        if (!dd || !mm || !yyyy) return null;
        return `${yyyy.padStart(4, "0")}-${mm.padStart(2, "0")}-${dd.padStart(2, "0")}`;
      }

      function daysDiff(aISO, bISO) {
        const a = new Date(aISO + "T00:00:00");
        const b = new Date(bISO + "T00:00:00");
        return Math.round((b - a) / (1000 * 60 * 60 * 24));
      }

      // ===== State =====
      let state = {
        startingBalance: 0,
        defaultRiskPerTrade: 0,
        customRules: [], // {id, label}
        trades: [], // see addTrade for shape
      };

      function loadState() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return;
          const parsed = JSON.parse(raw);
          if (parsed && typeof parsed === "object") {
            state = Object.assign(state, parsed);
          }
        } catch (e) {
          console.warn("Failed to load state:", e);
        }
      }

      function saveState() {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        } catch (e) {
          console.warn("Failed to save state:", e);
        }
      }

      // ===== DOM refs =====
      const startingBalanceInput = document.getElementById("startingBalance");
      const riskPerTradeInput = document.getElementById("riskPerTrade");
      const tradeDateInput = document.getElementById("tradeDate");
      const pairInput = document.getElementById("pair");
      const directionSelect = document.getElementById("direction");
      const sessionInput = document.getElementById("session");
      const riskRInput = document.getElementById("riskR");
      const resultRInput = document.getElementById("resultR");
      const setupInput = document.getElementById("setup");
      const screenshotInput = document.getElementById("screenshot");
      const notesInput = document.getElementById("notes");

      const riskRule1 = document.getElementById("riskRule1");
      const riskRule2 = document.getElementById("riskRule2");
      const riskRule3 = document.getElementById("riskRule3");
      const behRule1 = document.getElementById("behRule1");
      const behRule2 = document.getElementById("behRule2");
      const behRule3 = document.getElementById("behRule3");
      const disciplineSummaryText = document.getElementById("disciplineSummaryText");

      const customRulesContainer = document.getElementById("customRulesContainer");
      const newCustomRuleInput = document.getElementById("newCustomRule");
      const addCustomRuleBtn = document.getElementById("addCustomRuleBtn");

      const tradeCountEl = document.getElementById("tradeCount");
      const totalsLineEl = document.getElementById("totalsLine");
      const winRateText = document.getElementById("winRateText");
      const winRateCaption = document.getElementById("winRateCaption");
      const avgRText = document.getElementById("avgRText");
      const discScoreText = document.getElementById("discScoreText");
      const equityMeta = document.getElementById("equityMeta");

      const last7Text = document.getElementById("last7Text");
      const last30Text = document.getElementById("last30Text");
      const totalTradesMini = document.getElementById("totalTradesMini");
      const bestDayText = document.getElementById("bestDayText");
      const worstDayText = document.getElementById("worstDayText");

      const calendarTitle = document.getElementById("calendarTitle");
      const calendarBody = document.getElementById("calendarBody");

      const recentTableBody = document.getElementById("recentTableBody");

      const addTradeBtn = document.getElementById("addTradeBtn");
      const saveDraftBtn = document.getElementById("saveDraftBtn");
      const exportBtn = document.getElementById("exportBtn");
      const importBtn = document.getElementById("importBtn");
      const importFileInput = document.getElementById("importFile");
      const clearBtn = document.getElementById("clearBtn");

      // ===== Charts =====
      let equityChart;
      let probChart;

      function initCharts() {
        const equityCtx = document.getElementById("equityChart").getContext("2d");
        const probCtx = document.getElementById("probChart").getContext("2d");

        equityChart = new Chart(equityCtx, {
          type: "line",
          data: {
            labels: [],
            datasets: [
              {
                label: "Equity (R)",
                data: [],
                borderColor: "#facc15",
                backgroundColor: "rgba(250, 204, 21, 0.15)",
                tension: 0.25,
                borderWidth: 2,
                pointRadius: 2,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
            },
            scales: {
              x: {
                grid: { color: "rgba(55,65,81,0.4)" },
                ticks: { font: { size: 9 } },
              },
              y: {
                grid: { color: "rgba(55,65,81,0.4)" },
                ticks: { font: { size: 9 } },
              },
            },
          },
        });

        probChart = new Chart(probCtx, {
          type: "bar",
          data: {
            labels: ["Wins", "Losses"],
            datasets: [
              {
                label: "Percentage",
                data: [0, 0],
                backgroundColor: ["#22c55e", "#ef4444"],
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
            },
            scales: {
              x: {
                ticks: { font: { size: 9 } },
                grid: { display: false },
              },
              y: {
                min: 0,
                max: 100,
                ticks: {
                  stepSize: 25,
                  font: { size: 9 },
                  callback: (v) => v + "%",
                },
                grid: { color: "rgba(55,65,81,0.4)" },
              },
            },
          },
        });
      }

      // ===== Custom rules rendering =====

      function renderCustomRules() {
        customRulesContainer.innerHTML = `
          <div class="muted" style="font-size:10px;margin-bottom:4px;">
            Add your own rules (e.g. “Clean close at level”, “No double wick”). These are just for you – they don’t change discipline %.
          </div>
        `;

        state.customRules.forEach((rule) => {
          const row = document.createElement("div");
          row.className = "rule-row";
          row.innerHTML = `
            <input type="checkbox" data-custom-rule-id="${rule.id}" />
            <span>${rule.label}</span>
          `;
          customRulesContainer.appendChild(row);
        });

        if (state.customRules.length === 0) {
          const empty = document.createElement("div");
          empty.className = "muted";
          empty.style.fontSize = "10px";
          empty.textContent = "No custom rules yet. Add your checklist items above.";
          customRulesContainer.appendChild(empty);
        }
      }

      function addCustomRule(label) {
        const trimmed = label.trim();
        if (!trimmed) return;
        const id =
          "rule_" +
          Math.random().toString(36).slice(2) +
          "_" +
          Date.now().toString(36);
        state.customRules.push({ id, label: trimmed });
        saveState();
        renderCustomRules();
        newCustomRuleInput.value = "";
      }

      // ===== Discipline preview =====

      function updateDisciplinePreview() {
        const coreTotal = 6;
        const hits =
          (riskRule1.checked ? 1 : 0) +
          (riskRule2.checked ? 1 : 0) +
          (riskRule3.checked ? 1 : 0) +
          (behRule1.checked ? 1 : 0) +
          (behRule2.checked ? 1 : 0) +
          (behRule3.checked ? 1 : 0);
        const pct = coreTotal ? Math.round((hits / coreTotal) * 100) : 0;
        disciplineSummaryText.textContent = `${hits} / ${coreTotal} rules followed (${pct}% discipline).`;
      }

      [riskRule1, riskRule2, riskRule3, behRule1, behRule2, behRule3].forEach(
        (el) => {
          el.addEventListener("change", updateDisciplinePreview);
        }
      );

      // ===== Calculations =====

      function recalcAndRender() {
        // Format starting balance + risk inputs
        startingBalanceInput.value =
          state.startingBalance > 0 ? formatUSD(state.startingBalance) : "";
        riskPerTradeInput.value =
          state.defaultRiskPerTrade > 0
            ? state.defaultRiskPerTrade.toLocaleString("en-US", {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0,
              })
            : "";

        // Trade count
        tradeCountEl.textContent = state.trades.length.toString();
        totalTradesMini.textContent = `${state.trades.length} trade${
          state.trades.length === 1 ? "" : "s"
        }.`;

        // PnL + balance
        let totalPnLR = 0;
        let totalPnLUSD = 0;
        state.trades.forEach((t) => {
          totalPnLR += t.resultR;
          totalPnLUSD += t.pnlUsd;
        });

        const currentBalance = state.startingBalance + totalPnLUSD;

        totalsLineEl.textContent = `Total PnL: $${formatUSD(
          totalPnLUSD
        )} • Balance: $${formatUSD(
          currentBalance
        )} • Starting: $${formatUSD(state.startingBalance)}`;

        // Win rate / avg R / discipline
        const tradesWithR = state.trades.filter((t) => t.resultR !== 0);
        const wins = tradesWithR.filter((t) => t.resultR > 0).length;
        const losses = tradesWithR.filter((t) => t.resultR < 0).length;
        const totalNonZero = wins + losses;

        const winRate = totalNonZero
          ? Math.round((wins / totalNonZero) * 100)
          : 0;
        const avgR =
          state.trades.length > 0 ? totalPnLR / state.trades.length : 0;
        const avgDisc =
          state.trades.length > 0
            ? Math.round(
                state.trades.reduce((sum, t) => sum + t.disciplinePct, 0) /
                  state.trades.length
              )
            : 0;

        winRateText.textContent = `${winRate}%`;
        winRateCaption.textContent =
          totalNonZero === 0
            ? "No R ≠ 0 trades yet."
            : `Based on ${totalNonZero} trade${
                totalNonZero === 1 ? "" : "s"
              } with R ≠ 0.`;
        avgRText.textContent = formatR(avgR);
        discScoreText.textContent = `${avgDisc} / 100`;

        // Equity chart
        const labels = state.trades.map((t, idx) => idx + 1);
        const equityData = [];
        let runningR = 0;
        state.trades.forEach((t) => {
          runningR += t.resultR;
          equityData.push(runningR);
        });
        equityChart.data.labels = labels;
        equityChart.data.datasets[0].data = equityData;
        equityChart.update();

        equityMeta.textContent =
          state.trades.length === 0
            ? "No trades yet. Log your first setup to start drawing your curve."
            : `Total R: ${formatR(
                totalPnLR
              )} • PnL: $${formatUSD(totalPnLUSD)} • Starting balance: $${formatUSD(
                state.startingBalance
              )} • Current balance: $${formatUSD(currentBalance)}.`;

        // Probability chart (percent)
        const lossCount = losses;
        const winCount = wins;
        const probWin = totalNonZero ? Math.round((winCount / totalNonZero) * 100) : 0;
        const probLoss = totalNonZero ? Math.round((lossCount / totalNonZero) * 100) : 0;
        probChart.data.datasets[0].data = [probWin, probLoss];
        probChart.update();

        // Weekly & monthly stats (7 & 30 days from today)
        const today = todayISO();
        let last7R = 0,
          last7USD = 0,
          last30R = 0,
          last30USD = 0;
        const perDay = {}; // iso -> pnlUSD

        state.trades.forEach((t) => {
          const diff = daysDiff(t.dateISO, today);
          if (diff >= 0 && diff <= 6) {
            last7R += t.resultR;
            last7USD += t.pnlUsd;
          }
          if (diff >= 0 && diff <= 29) {
            last30R += t.resultR;
            last30USD += t.pnlUsd;
          }
          perDay[t.dateISO] = (perDay[t.dateISO] || 0) + t.pnlUsd;
        });

        last7Text.textContent = `PnL: ${formatR(last7R)} • $${formatUSD(
          last7USD
        )}`;
        last30Text.textContent = `PnL: ${formatR(last30R)} • $${formatUSD(
          last30USD
        )}`;

        // Best/worst day
        let best = 0;
        let worst = 0;
        Object.values(perDay).forEach((val) => {
          if (val > best) best = val;
          if (val < worst) worst = val;
        });
        bestDayText.textContent = `$${formatUSD(best)}`;
        worstDayText.textContent = `$${formatUSD(worst)}`;

        // Calendar (current month)
        renderCalendar(perDay);

        // Recent trades table (most recent first)
        renderRecentTrades();
      }

      function renderCalendar(perDayMap) {
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth(); // 0-based
        const monthName = now.toLocaleString("en-US", {
          month: "long",
          year: "numeric",
        });
        calendarTitle.textContent = `Calendar – ${monthName}`;

        calendarBody.innerHTML = "";

        const first = new Date(year, month, 1);
        const firstDayOfWeek = first.getDay(); // 0 Sun
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        const cells = [];
        for (let i = 0; i < firstDayOfWeek; i++) {
          cells.push(null);
        }
        for (let d = 1; d <= daysInMonth; d++) {
          cells.push(d);
        }
        while (cells.length % 7 !== 0) {
          cells.push(null);
        }

        cells.forEach((day) => {
          const cell = document.createElement("div");
          cell.className = "calendar-cell";
          if (day === null) {
            cell.classList.add("empty");
          } else {
            const iso = `${year}-${String(month + 1).padStart(2, "0")}-${String(
              day
            ).padStart(2, "0")}`;
            const pnl = perDayMap[iso] || 0;

            const dateSpan = document.createElement("div");
            dateSpan.className = "cal-date";
            dateSpan.textContent = day;
            cell.appendChild(dateSpan);

            if (pnl !== 0) {
              const pnlSpan = document.createElement("div");
              pnlSpan.className = "cal-pnl " + (pnl > 0 ? "win" : "loss");
              pnlSpan.textContent =
                (pnl > 0 ? "+" : "") + "$" + formatUSD(Math.abs(pnl));
              cell.appendChild(pnlSpan);
            }
          }
          calendarBody.appendChild(cell);
        });
      }

      function renderRecentTrades() {
        recentTableBody.innerHTML = "";
        const trades = [...state.trades].reverse();
        trades.forEach((t, idx) => {
          const tr = document.createElement("tr");
          const isWin = t.resultR > 0;
          const isLoss = t.resultR < 0;

          tr.innerHTML = `
            <td>${trades.length - idx}</td>
            <td>${ddmmyyyyFromISO(t.dateISO)}</td>
            <td>${t.pair || ""}</td>
            <td>${t.direction || ""}</td>
            <td class="${
              isWin ? "amount-win" : isLoss ? "amount-loss" : ""
            }">${t.resultR.toFixed(2)}</td>
            <td class="${
              isWin ? "amount-win" : isLoss ? "amount-loss" : ""
            }">$${formatUSD(t.pnlUsd)}</td>
            <td>${t.disciplinePct}%</td>
            <td>${t.screenshot ? "Yes" : ""}</td>
            <td>${t.notes ? t.notes.slice(0, 40) : ""}${
            t.notes && t.notes.length > 40 ? "…" : ""
          }</td>
          `;
          recentTableBody.appendChild(tr);
        });
      }

      // ===== Add trade =====

      function handleAddTrade() {
        const startBal = parseNumber(startingBalanceInput.value);
        const riskPerTradeUSD = parseNumber(riskPerTradeInput.value);
        const riskR = parseNumber(riskRInput.value || "1");
        const resultR = parseNumber(resultRInput.value || "0");

        if (!startBal || startBal <= 0) {
          alert("Set your starting balance (USD) first.");
          startingBalanceInput.focus();
          return;
        }

        if (!riskPerTradeUSD || riskPerTradeUSD <= 0) {
          alert("Set a valid risk per trade (USD).");
          riskPerTradeInput.focus();
          return;
        }

        const rawDate = tradeDateInput.value.trim();
        const isoDate = rawDate ? isoFromDdMmYyyy(rawDate) : todayISO();
        if (!isoDate) {
          alert("Please enter date as dd/mm/yyyy.");
          tradeDateInput.focus();
          return;
        }

        const coreTotal = 6;
        const coreHits =
          (riskRule1.checked ? 1 : 0) +
          (riskRule2.checked ? 1 : 0) +
          (riskRule3.checked ? 1 : 0) +
          (behRule1.checked ? 1 : 0) +
          (behRule2.checked ? 1 : 0) +
          (behRule3.checked ? 1 : 0);
        const disciplinePct = coreTotal
          ? Math.round((coreHits / coreTotal) * 100)
          : 0;

        // PnL in USD = risk per trade * R result
        const pnlUsd = riskPerTradeUSD * resultR;

        // Save base state (starting balance, default risk)
        state.startingBalance = startBal;
        state.defaultRiskPerTrade = riskPerTradeUSD;

        const trade = {
          id:
            "trade_" +
            Math.random().toString(36).slice(2) +
            "_" +
            Date.now().toString(36),
          dateISO: isoDate,
          pair: pairInput.value.trim(),
          direction: directionSelect.value || "",
          session: sessionInput.value.trim(),
          riskR: riskR,
          resultR: resultR,
          setup: setupInput.value.trim(),
          screenshot: screenshotInput.value.trim(),
          notes: notesInput.value.trim(),
          riskPerTradeUSD: riskPerTradeUSD,
          pnlUsd: pnlUsd,
          coreHits,
          coreTotal,
          disciplinePct,
        };

        state.trades.push(trade);
        saveState();

        // Clear trade-specific inputs, keep starting balance & risk per trade
        tradeDateInput.value = "";
        pairInput.value = "";
        directionSelect.value = "";
        sessionInput.value = "";
        riskRInput.value = "1";
        resultRInput.value = "";
        setupInput.value = "";
        screenshotInput.value = "";
        notesInput.value = "";
        [riskRule1, riskRule2, riskRule3, behRule1, behRule2, behRule3].forEach(
          (c) => (c.checked = false)
        );
        updateDisciplinePreview();

        recalcAndRender();
      }

      // Save draft = just persist starting balance & default risk
      function handleSaveDraft() {
        const startBal = parseNumber(startingBalanceInput.value);
        const riskPerTradeUSD = parseNumber(riskPerTradeInput.value);
        state.startingBalance = startBal;
        state.defaultRiskPerTrade = riskPerTradeUSD;
        saveState();
        alert("Draft saved: starting balance and default risk per trade.");
        recalcAndRender();
      }

      // ===== Backup / Import / Clear =====

      function handleExport() {
        const dataStr = JSON.stringify(state, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        const stamp = new Date().toISOString().slice(0, 10);
        a.href = url;
        a.download = `tredlog-backup-${stamp}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      function handleImportFileChange(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (evt) => {
          try {
            const parsed = JSON.parse(evt.target.result);
            if (!parsed || typeof parsed !== "object") {
              alert("Invalid backup file.");
              return;
            }
            state = Object.assign(
              { startingBalance: 0, defaultRiskPerTrade: 0, customRules: [], trades: [] },
              parsed
            );
            saveState();
            renderCustomRules();
            recalcAndRender();
            alert("Backup imported successfully.");
          } catch (err) {
            console.error(err);
            alert("Could not read backup file.");
          }
        };
        reader.readAsText(file);
      }

      function handleClear() {
        if (
          !confirm(
            "This will clear all local trades and settings from this browser. Continue?"
          )
        ) {
          return;
        }
        localStorage.removeItem(STORAGE_KEY);
        state = {
          startingBalance: 0,
          defaultRiskPerTrade: 0,
          customRules: [],
          trades: [],
        };
        saveState();
        renderCustomRules();
        recalcAndRender();
      }

      // ===== Init =====
      (function init() {
        loadState();
        initCharts();
        renderCustomRules();

        // Prefill date as today
        tradeDateInput.placeholder = ddmmyyyyFromISO(todayISO());

        // Wire events
        addCustomRuleBtn.addEventListener("click", () =>
          addCustomRule(newCustomRuleInput.value)
        );
        newCustomRuleInput.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            addCustomRule(newCustomRuleInput.value);
          }
        });

        startingBalanceInput.addEventListener("blur", () => {
          const val = parseNumber(startingBalanceInput.value);
          if (val > 0) startingBalanceInput.value = formatUSD(val);
        });

        riskPerTradeInput.addEventListener("blur", () => {
          const val = parseNumber(riskPerTradeInput.value);
          if (val > 0) {
            riskPerTradeInput.value = val.toLocaleString("en-US", {
              minimumFractionDigits: 0,
              maximumFractionDigits: 0,
            });
          }
        });

        addTradeBtn.addEventListener("click", handleAddTrade);
        saveDraftBtn.addEventListener("click", handleSaveDraft);
        exportBtn.addEventListener("click", handleExport);
        importBtn.addEventListener("click", () => importFileInput.click());
        importFileInput.addEventListener("change", handleImportFileChange);
        clearBtn.addEventListener("click", handleClear);

        updateDisciplinePreview();
        recalcAndRender();
      })();
    </script>
  </body>
</html>
