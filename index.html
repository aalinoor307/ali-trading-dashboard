<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>TredLog â€“ Probability-driven trading journal â€¢ Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Chart.js for equity & probability charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      :root {
        --bg: #050816;
        --bg-elevated: #101322;
        --card: #0b1220;
        --card-soft: #111827;
        --accent: #ffc24b;
        --accent-soft: rgba(255, 194, 75, 0.12);
        --accent-strong: #f97316;
        --border-subtle: rgba(148, 163, 184, 0.28);
        --border-strong: rgba(31, 41, 55, 0.9);
        --muted: #9ca3af;
        --text: #f9fafb;
        --danger: #f97373;
        --success: #4ade80;
        --radius-card: 18px;
        --radius-pill: 999px;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
          -apple-system, sans-serif;
        background: radial-gradient(circle at top, #172033 0, #050816 45%);
        color: var(--text);
        display: flex;
        justify-content: center;
      }

      .shell {
        max-width: 1280px;
        width: 100%;
        padding: 24px 16px 40px;
      }

      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 18px;
        gap: 12px;
      }

      .logo-row {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .logo-icon {
        width: 28px;
        height: 28px;
        border-radius: 999px;
        background: radial-gradient(circle at 30% 20%, #ffe29f, #ff9f4a 45%, #ff3c3c 100%);
        box-shadow: 0 0 0 4px rgba(255, 194, 75, 0.15);
      }

      .logo-text {
        font-weight: 600;
        letter-spacing: 0.02em;
      }

      .logo-sub {
        font-size: 11px;
        color: var(--muted);
      }

      .header-right {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
      }

      .pill {
        border-radius: var(--radius-pill);
        padding: 4px 10px;
        font-size: 11px;
        border: 1px solid rgba(148, 163, 184, 0.35);
        color: var(--muted);
        background: rgba(15, 23, 42, 0.7);
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .pill.positive {
        border-color: rgba(22, 163, 74, 0.6);
        color: #bbf7d0;
        background: rgba(22, 163, 74, 0.12);
      }

      .btn-small {
        border-radius: var(--radius-pill);
        padding: 5px 11px;
        font-size: 11px;
        border: 1px solid rgba(148, 163, 184, 0.4);
        background: rgba(15, 23, 42, 0.9);
        color: var(--muted);
        cursor: pointer;
      }

      .btn-small.warning {
        border-color: rgba(248, 113, 113, 0.8);
        color: #fecaca;
      }

      .btn-small:hover {
        filter: brightness(1.07);
      }

      main {
        display: grid;
        grid-template-columns: minmax(0, 1.3fr) minmax(0, 1.2fr);
        gap: 18px;
      }

      .card {
        border-radius: var(--radius-card);
        background: radial-gradient(circle at top left, #111827, #020617 60%);
        border: 1px solid var(--border-subtle);
      }

      .card-inner {
        padding: 16px 18px 14px;
      }

      .card-title-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        gap: 8px;
      }

      .card-title {
        font-size: 13px;
        font-weight: 600;
      }

      .card-sub {
        font-size: 11px;
        color: var(--muted);
      }

      /* Form / left column */

      .form-grid {
        display: grid;
        grid-template-columns: 1.1fr 1.1fr;
        gap: 10px;
        margin-bottom: 10px;
      }

      .field-group {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      label {
        font-size: 11px;
        color: var(--muted);
      }

      input,
      select,
      textarea {
        border-radius: 999px;
        border: 1px solid rgba(55, 65, 81, 0.9);
        background: rgba(15, 23, 42, 0.9);
        color: var(--text);
        padding: 7px 11px;
        font-size: 12px;
      }

      textarea {
        border-radius: 12px;
        min-height: 80px;
        resize: vertical;
      }

      input::placeholder,
      textarea::placeholder {
        color: rgba(148, 163, 184, 0.7);
      }

      .two-col-row {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 10px;
      }

      .form-footer {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        margin-top: 8px;
      }

      .btn-primary {
        border-radius: var(--radius-pill);
        padding: 8px 16px;
        font-size: 13px;
        border: none;
        cursor: pointer;
        font-weight: 500;
        background: linear-gradient(90deg, #ffc24b, #ff9a3c);
        color: #111827;
        box-shadow: 0 10px 22px rgba(255, 194, 75, 0.24);
      }

      .btn-secondary {
        border-radius: var(--radius-pill);
        padding: 8px 14px;
        font-size: 12px;
        border: 1px solid var(--border-subtle);
        background: rgba(15, 23, 42, 0.9);
        color: var(--muted);
        cursor: pointer;
      }

      .section-label-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 10px;
        margin-bottom: 6px;
      }

      .section-label {
        font-size: 12px;
        font-weight: 500;
      }

      .section-sub {
        font-size: 10px;
        color: var(--muted);
      }

      .checklist-grid {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 10px;
        font-size: 11px;
      }

      .checklist-card {
        border-radius: 12px;
        background: rgba(15, 23, 42, 0.95);
        border: 1px solid var(--border-strong);
        padding: 8px 9px;
      }

      .checklist-title {
        font-weight: 600;
        margin-bottom: 4px;
      }

      .checklist-items {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .checklist-items label {
        display: flex;
        align-items: center;
        gap: 4px;
        cursor: pointer;
      }

      .checklist-items input[type="checkbox"] {
        width: 12px;
        height: 12px;
        accent-color: var(--accent-strong);
      }

      .checklist-footer {
        margin-top: 6px;
        font-size: 10px;
        color: var(--muted);
        display: flex;
        justify-content: space-between;
      }

      /* Right column â€“ stats & charts */

      .stat-grid {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 8px;
        margin-top: 4px;
      }

      .stat-card {
        border-radius: 12px;
        background: rgba(15, 23, 42, 0.95);
        border: 1px solid var(--border-strong);
        padding: 7px 9px;
        font-size: 11px;
      }

      .stat-label {
        font-size: 10px;
        color: var(--muted);
        margin-bottom: 2px;
      }

      .stat-value {
        font-size: 14px;
        font-weight: 600;
      }

      .stat-sub {
        font-size: 10px;
        color: var(--muted);
        margin-top: 2px;
      }

      canvas {
        width: 100% !important;
        height: 200px !important;
      }

      .charts-grid {
        display: grid;
        grid-template-columns: minmax(0, 1.4fr) minmax(0, 1fr);
        gap: 10px;
        margin-top: 10px;
      }

      .chart-card {
        border-radius: 12px;
        background: rgba(15, 23, 42, 0.95);
        border: 1px solid var(--border-strong);
        padding: 8px 9px 10px;
        font-size: 11px;
      }

      .chart-title {
        margin-bottom: 4px;
      }

      .summary-row {
        margin-top: 8px;
        font-size: 11px;
        color: var(--muted);
      }

      .summary-row strong {
        color: var(--text);
      }

      /* Weekly / monthly and calendar */

      .bottom-right-grid {
        display: grid;
        grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.2fr);
        gap: 10px;
        margin-top: 10px;
      }

      .small-card {
        border-radius: 12px;
        background: rgba(15, 23, 42, 0.95);
        border: 1px solid var(--border-strong);
        padding: 8px 9px;
        font-size: 11px;
      }

      .small-card h4 {
        margin: 0 0 4px;
        font-size: 11px;
      }

      .small-stat {
        margin-top: 4px;
      }

      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, minmax(0, 1fr));
        gap: 4px;
        margin-top: 6px;
        font-size: 10px;
      }

      .calendar-head {
        font-size: 10px;
        color: var(--muted);
        text-align: center;
      }

      .calendar-cell {
        min-height: 40px;
        border-radius: 8px;
        border: 1px solid rgba(31, 41, 55, 0.9);
        background: rgba(15, 23, 42, 0.95);
        padding: 2px 3px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
      }

      .calendar-day {
        font-size: 10px;
        color: var(--muted);
      }

      .calendar-pnl {
        font-size: 10px;
      }

      .calendar-pnl.positive {
        color: var(--success);
      }

      .calendar-pnl.negative {
        color: var(--danger);
      }

      /* Trades table */

      .table-card {
        margin-top: 12px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 11px;
      }

      th,
      td {
        padding: 6px 6px;
        border-bottom: 1px solid rgba(30, 41, 59, 0.9);
        text-align: left;
        white-space: nowrap;
      }

      th {
        font-size: 10px;
        color: var(--muted);
      }

      tbody tr:hover {
        background: rgba(15, 23, 42, 0.85);
      }

      .pnl-positive {
        color: var(--success);
      }

      .pnl-negative {
        color: var(--danger);
      }

      .link-icon {
        cursor: pointer;
        font-size: 12px;
      }

      /* Responsive */

      @media (max-width: 1024px) {
        main {
          grid-template-columns: minmax(0, 1fr);
        }

        .charts-grid {
          grid-template-columns: minmax(0, 1fr);
        }

        .bottom-right-grid {
          grid-template-columns: minmax(0, 1fr);
        }
      }

      @media (max-width: 640px) {
        header {
          flex-direction: column;
          align-items: flex-start;
        }

        .form-grid {
          grid-template-columns: minmax(0, 1fr);
        }

        .two-col-row {
          grid-template-columns: minmax(0, 1fr);
        }

        .checklist-grid {
          grid-template-columns: minmax(0, 1fr);
        }

        .stat-grid {
          grid-template-columns: minmax(0, 1fr);
        }
      }
    </style>
  </head>
  <body>
    <div class="shell">
      <header>
        <div class="logo-row">
          <div class="logo-icon"></div>
          <div>
            <div class="logo-text">TredLog</div>
            <div class="logo-sub">Probability-driven trading journal â€“ Dashboard</div>
          </div>
        </div>
        <div class="header-right">
          <div class="pill">Local session â€¢ Browser storage only</div>
          <div class="pill positive">Built for serious traders</div>
          <button class="btn-small" onclick="exportBackup()">Export backup</button>
          <button class="btn-small" onclick="triggerImport()">Import backup</button>
          <button class="btn-small warning" onclick="clearAllData()">
            Clear local data
          </button>
        </div>
      </header>

      <main>
        <!-- LEFT: account + new trade + checklist -->
        <section class="card">
          <div class="card-inner">
            <div class="card-title-row">
              <div>
                <div class="card-title">Account & new trade</div>
                <div class="card-sub">
                  Set your starting balance once, then log trades and track PnL in R and USD.
                </div>
              </div>
              <div class="card-sub" id="tradeCountLabel">0 trades logged</div>
            </div>

            <!-- Account row -->
            <div class="form-grid">
              <div class="field-group">
                <label for="startingBalance">Starting balance (USD)</label>
                <input
                  id="startingBalance"
                  type="number"
                  min="0"
                  step="100"
                  placeholder="e.g. 10,000"
                />
              </div>
              <div class="field-group">
                <label for="riskPerTrade">Risk per trade (USD)</label>
                <input
                  id="riskPerTrade"
                  type="number"
                  min="0"
                  step="10"
                  placeholder="e.g. 1,000"
                />
              </div>
            </div>

            <!-- Trade form -->
            <div class="two-col-row" style="margin-top: 8px;">
              <div class="field-group">
                <label for="tradeDate">Date</label>
                <input id="tradeDate" type="date" />
              </div>
              <div class="field-group">
                <label for="pair">Pair / symbol</label>
                <input id="pair" type="text" placeholder="e.g. GBPUSD" />
              </div>
            </div>

            <div class="two-col-row">
              <div class="field-group">
                <label for="direction">Direction</label>
                <select id="direction">
                  <option value="">Select</option>
                  <option>Buy</option>
                  <option>Sell</option>
                </select>
              </div>
              <div class="field-group">
                <label for="session">Session</label>
                <input id="session" type="text" placeholder="London, NY, Asia..." />
              </div>
            </div>

            <div class="two-col-row">
              <div class="field-group">
                <label for="riskR">Risk (R)</label>
                <input id="riskR" type="number" step="0.1" value="1" />
              </div>
              <div class="field-group">
                <label for="resultR">Result (R)</label>
                <input
                  id="resultR"
                  type="number"
                  step="0.1"
                  placeholder="e.g. -1, 0.5, 2"
                />
              </div>
            </div>

            <div class="two-col-row">
              <div class="field-group">
                <label for="setup">Setup</label>
                <input
                  id="setup"
                  type="text"
                  placeholder="Momentum, pullback, range break..."
                />
              </div>
              <div class="field-group">
                <label for="screenshot">Screenshot / chart link</label>
                <input
                  id="screenshot"
                  type="url"
                  placeholder="Paste TradingView or chart URL"
                />
              </div>
            </div>

            <div class="field-group" style="margin-top: 6px;">
              <label for="notes">Journal notes</label>
              <textarea
                id="notes"
                placeholder="What did you see? What rules were met? Where could you improve?"
              ></textarea>
            </div>

            <div class="form-footer">
              <button class="btn-secondary" onclick="saveDraft()">Save draft</button>
              <button class="btn-primary" onclick="addTrade()">Add trade to log</button>
            </div>

            <!-- Checklist -->
            <div class="section-label-row">
              <div class="section-label">Weighted checklist</div>
              <div class="section-sub">Tick only what actually happened on this trade.</div>
            </div>

            <div class="checklist-grid" id="checklistArea">
              <div class="checklist-card">
                <div class="checklist-title">Momentum setup</div>
                <div class="checklist-items">
                  <label
                    ><input type="checkbox" data-weight="1" /> Trend, pullback clean and
                    strong close.</label
                  >
                  <label
                    ><input type="checkbox" data-weight="1" /> Clean close at level â€“ no
                    double wick at level.</label
                  >
                  <label
                    ><input type="checkbox" data-weight="1" /> No long wick against
                    direction.</label
                  >
                </div>
              </div>

              <div class="checklist-card">
                <div class="checklist-title">Risk & discipline</div>
                <div class="checklist-items">
                  <label
                    ><input type="checkbox" data-weight="1" /> Planned R respected.</label
                  >
                  <label
                    ><input type="checkbox" data-weight="1" /> No revenge trades.</label
                  >
                  <label
                    ><input type="checkbox" data-weight="1" /> No adding risk mid-trade.</label
                  >
                </div>
              </div>

              <div class="checklist-card">
                <div class="checklist-title">Screenshots / behaviour</div>
                <div class="checklist-items">
                  <label
                    ><input type="checkbox" data-weight="1" /> Screenshots saved for
                    review.</label
                  >
                  <label
                    ><input type="checkbox" data-weight="1" /> Annotated before & after.</label
                  >
                  <label
                    ><input type="checkbox" data-weight="1" /> Clear headspace / no FOMO
                    late session.</label
                  >
                </div>
              </div>
            </div>

            <div class="checklist-footer">
              <div id="checklistSummary">0 / 9 rules followed (0% discipline).</div>
              <div>Higher score â†’ higher discipline.</div>
            </div>
          </div>
        </section>

        <!-- RIGHT: overview / charts / calendar -->
        <section class="card">
          <div class="card-inner">
            <div class="card-title-row">
              <div>
                <div class="card-title">Equity & discipline overview</div>
                <div class="card-sub">
                  High-level view of your performance in R and USD.
                </div>
              </div>
              <div class="card-sub" id="moneySummary">Total PnL: $0.00 â€¢ Balance: $0.00</div>
            </div>

            <!-- Top stats -->
            <div class="stat-grid">
              <div class="stat-card">
                <div class="stat-label">WIN RATE</div>
                <div class="stat-value" id="winRate">0%</div>
                <div class="stat-sub" id="winRateSub">Based on R > 0.</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">AVG R (REALIZED)</div>
                <div class="stat-value" id="avgR">0.0R</div>
                <div class="stat-sub" id="avgRSub">From all logged trades.</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">DISCIPLINE SCORE</div>
                <div class="stat-value" id="disciplineScore">0 / 100</div>
                <div class="stat-sub" id="disciplineSub">Average of checklist hits.</div>
              </div>
            </div>

            <!-- Charts -->
            <div class="charts-grid">
              <div class="chart-card">
                <div class="chart-title">Equity curve (cumulative R)</div>
                <canvas id="equityChart"></canvas>
              </div>
              <div class="chart-card">
                <div class="chart-title">Probability view (wins vs losses)</div>
                <canvas id="probChart"></canvas>
              </div>
            </div>

            <div class="summary-row" id="tradeSummaryText">
              No trades yet. Log your first setup to start drawing your curve.
            </div>

            <!-- Weekly / monthly & calendar -->
            <div class="bottom-right-grid">
              <div class="small-card">
                <h4>Weekly & monthly stats</h4>
                <div class="small-stat" id="weeklyStats">Last 7 days: 0 trades.</div>
                <div class="small-stat" id="weeklyPnl">PnL: 0.00R â€¢ $0.00</div>
                <div class="small-stat" id="monthlyStats">Last 30 days: 0 trades.</div>
                <div class="small-stat" id="monthlyPnl">PnL: 0.00R â€¢ $0.00</div>
              </div>
              <div class="small-card">
                <h4 id="calendarTitle">Calendar â€“ this month</h4>
                <div class="calendar-grid" id="calendarHead"></div>
                <div class="calendar-grid" id="calendarBody"></div>
              </div>
            </div>

            <!-- Trades table -->
            <div class="small-card table-card">
              <h4>Recent trades</h4>
              <div style="overflow-x:auto;">
                <table>
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>Date</th>
                      <th>Pair</th>
                      <th>Dir</th>
                      <th>R</th>
                      <th>PnL ($)</th>
                      <th>Disc%</th>
                      <th>Screenshot</th>
                      <th>Notes</th>
                    </tr>
                  </thead>
                  <tbody id="tradesTableBody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>

    <!-- hidden file input for import -->
    <input
      type="file"
      id="importFile"
      accept="application/json"
      style="display: none;"
    />

    <script>
      /*************** REAL PASSWORD (simple, client-side) ***************/
      // ðŸ‘‰ EDIT THIS to your own secret.
      // Example: "AliNoor!2025"
      const DASHBOARD_PASSWORD = Alihandroz@2099;

      (function passwordGate() {
        if (!DASHBOARD_PASSWORD) return; // leave blank to disable protection
        try {
          let ok = false;
          for (let i = 0; i < 5; i++) {
            const pw = prompt("Enter your TredLog dashboard password:");
            if (pw === null) continue;
            if (pw === DASHBOARD_PASSWORD) {
              ok = true;
              break;
            }
            alert("Incorrect password. Try again.");
          }
          if (!ok) {
            alert("Access denied.");
            window.location.href = "about:blank";
          }
        } catch (e) {
          console.warn("Password gate error:", e);
        }
      })();

      /******************* STORAGE & HELPERS *******************/

      const TRADES_KEY = "tredlogTradesV2";
      const SETTINGS_KEY = "tredlogSettingsV2";
      const DRAFT_KEY = "tredlogDraftV2";

      let trades = [];
      let settings = {
        startingBalance: 10000,
        riskPerTrade: 1000,
      };

      let equityChartInstance = null;
      let probChartInstance = null;

      function formatMoney(num) {
        const n = Number(num || 0);
        return n.toLocaleString("en-US", {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        });
      }

      function formatR(num) {
        const n = Number(num || 0);
        return n.toFixed(2);
      }

      function loadState() {
        try {
          const t = JSON.parse(localStorage.getItem(TRADES_KEY) || "[]");
          const s = JSON.parse(localStorage.getItem(SETTINGS_KEY) || "{}");
          trades = Array.isArray(t) ? t : [];
          settings = Object.assign(settings, s);
        } catch (e) {
          console.error("loadState error", e);
        }
      }

      function saveState() {
        localStorage.setItem(TRADES_KEY, JSON.stringify(trades));
        localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
      }

      /******************* FORM / DRAFT *******************/

      function restoreForm() {
        document.getElementById("startingBalance").value =
          settings.startingBalance || "";
        document.getElementById("riskPerTrade").value = settings.riskPerTrade || "";

        // default date = today
        const today = new Date();
        const iso = today.toISOString().slice(0, 10);
        document.getElementById("tradeDate").value = iso;

        try {
          const draft = JSON.parse(localStorage.getItem(DRAFT_KEY) || "null");
          if (draft) {
            for (const [id, val] of Object.entries(draft)) {
              const el = document.getElementById(id);
              if (el) el.value = val;
            }
          }
        } catch (e) {
          console.warn("Draft restore error", e);
        }
      }

      function saveDraft() {
        const draft = {
          tradeDate: document.getElementById("tradeDate").value,
          pair: document.getElementById("pair").value,
          direction: document.getElementById("direction").value,
          session: document.getElementById("session").value,
          riskR: document.getElementById("riskR").value,
          resultR: document.getElementById("resultR").value,
          setup: document.getElementById("setup").value,
          screenshot: document.getElementById("screenshot").value,
          notes: document.getElementById("notes").value,
        };
        localStorage.setItem(DRAFT_KEY, JSON.stringify(draft));
        alert("Draft saved locally.");
      }

      /******************* CHECKLIST *******************/

      function getChecklistScore() {
        const boxes = document.querySelectorAll(
          "#checklistArea input[type='checkbox']"
        );
        let total = 0;
        let hits = 0;
        boxes.forEach((b) => {
          const w = Number(b.dataset.weight || 1);
          total += w;
          if (b.checked) hits += w;
        });
        const pct = total > 0 ? (hits / total) * 100 : 0;
        return { hits, total, pct };
      }

      function updateChecklistSummary() {
        const { hits, total, pct } = getChecklistScore();
        document.getElementById(
          "checklistSummary"
        ).textContent = `${hits} / ${total} rules followed (${pct.toFixed(
          0
        )}% discipline).`;
      }

      /******************* ADD TRADE *******************/

      function addTrade() {
        const startingBalance = Number(
          document.getElementById("startingBalance").value || settings.startingBalance
        );
        const riskPerTrade = Number(
          document.getElementById("riskPerTrade").value || settings.riskPerTrade
        );
        if (!startingBalance || startingBalance <= 0) {
          alert("Set a positive starting balance.");
          return;
        }
        if (!riskPerTrade || riskPerTrade <= 0) {
          alert("Set a positive risk per trade (USD).");
          return;
        }

        settings.startingBalance = startingBalance;
        settings.riskPerTrade = riskPerTrade;

        const date = document.getElementById("tradeDate").value;
        const pair = document.getElementById("pair").value.trim();
        const direction = document.getElementById("direction").value;
        const session = document.getElementById("session").value.trim();
        const riskR = Number(document.getElementById("riskR").value || 1);
        const resultR = Number(document.getElementById("resultR").value);
        const setup = document.getElementById("setup").value.trim();
        const screenshot = document.getElementById("screenshot").value.trim();
        const notes = document.getElementById("notes").value.trim();

        if (!date || !pair || !direction || isNaN(resultR)) {
          alert("Date, pair, direction and Result (R) are required.");
          return;
        }

        const { hits, total, pct } = getChecklistScore();

        const trade = {
          id: Date.now(),
          date,
          pair,
          direction,
          session,
          riskR,
          resultR,
          setup,
          screenshot,
          notes,
          checklistHits: hits,
          checklistTotal: total,
          checklistPct: pct,
        };
        trades.push(trade);
        saveState();
        localStorage.removeItem(DRAFT_KEY);
        // reset notes / checklist, keep other fields
        document.getElementById("notes").value = "";
        document
          .querySelectorAll("#checklistArea input[type='checkbox']")
          .forEach((b) => (b.checked = false));
        updateChecklistSummary();
        renderAll();
      }

      /******************* CLEAR DATA *******************/

      function clearAllData() {
        if (!confirm("This will clear all saved trades & settings on this device. Continue?"))
          return;
        trades = [];
        settings = { startingBalance: 10000, riskPerTrade: 1000 };
        localStorage.removeItem(TRADES_KEY);
        localStorage.removeItem(SETTINGS_KEY);
        localStorage.removeItem(DRAFT_KEY);
        restoreForm();
        renderAll();
      }

      /******************* BACKUP EXPORT / IMPORT *******************/

      function exportBackup() {
        const payload = {
          settings,
          trades,
          exportedAt: new Date().toISOString(),
        };
        const blob = new Blob([JSON.stringify(payload, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download =
          "tredlog-backup-" + new Date().toISOString().slice(0, 10) + ".json";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      function triggerImport() {
        document.getElementById("importFile").click();
      }

      /******************* STATS & CHARTS *******************/

      function computeStats() {
        let totalTrades = trades.length;
        let wins = 0;
        let totalR = 0;
        let totalDiscipline = 0;
        let disciplineCount = 0;

        trades.forEach((t) => {
          totalR += Number(t.resultR || 0);
          if (t.resultR > 0) wins++;

          // include every trade in discipline average;
          // trades with no checklist simply contribute 0%
          if (t.checklistTotal > 0) {
            totalDiscipline += (t.checklistHits / t.checklistTotal) * 100;
          } else {
            totalDiscipline += 0;
          }
          disciplineCount++;
        });

        const winRate = totalTrades ? (wins / totalTrades) * 100 : 0;
        const avgR = totalTrades ? totalR / totalTrades : 0;
        const avgDisc = disciplineCount ? totalDiscipline / disciplineCount : 0;

        const starting = Number(settings.startingBalance || 0);
        const totalPnLMoney = totalR * Number(settings.riskPerTrade || 0);
        const balance = starting + totalPnLMoney;

        return {
          totalTrades,
          wins,
          totalR,
          winRate,
          avgR,
          avgDisc,
          starting,
          totalPnLMoney,
          balance,
        };
      }

      function renderStats() {
        const s = computeStats();

        document.getElementById("tradeCountLabel").textContent =
          s.totalTrades === 1 ? "1 trade logged" : `${s.totalTrades} trades logged`;

        document.getElementById("winRate").textContent =
          s.winRate.toFixed(1).replace(/\.0$/, "") + "%";
        document.getElementById(
          "winRateSub"
        ).textContent = `Based on ${s.totalTrades} trade${
          s.totalTrades === 1 ? "" : "s"
        } with R â‰  0.`;

        document.getElementById("avgR").textContent = formatR(s.avgR) + "R";
        document.getElementById("avgRSub").textContent =
          s.totalTrades > 0 ? "From all logged trades." : "Log trades to see average R.";

        document.getElementById("disciplineScore").textContent =
          s.avgDisc.toFixed(0) + " / 100";
        document.getElementById("disciplineSub").textContent =
          "Average of checklist discipline per trade.";

        document.getElementById("moneySummary").textContent =
          "Total PnL: $" +
          formatMoney(s.totalPnLMoney) +
          " â€¢ Balance: $" +
          formatMoney(s.balance);

        if (s.totalTrades === 0) {
          document.getElementById("tradeSummaryText").textContent =
            "No trades yet. Log your first setup to start drawing your curve.";
        } else {
          document.getElementById(
            "tradeSummaryText"
          ).textContent = `Total R: ${formatR(s.totalR)}R â€¢ PnL: $${formatMoney(
            s.totalPnLMoney
          )} â€¢ Starting balance: $${formatMoney(
            s.starting
          )} â€¢ Current balance: $${formatMoney(s.balance)}.`;
        }
      }

      function renderEquityChart() {
        const ctx = document.getElementById("equityChart").getContext("2d");
        const labels = [];
        const data = [];
        let cumR = 0;
        trades.forEach((t, idx) => {
          cumR += Number(t.resultR || 0);
          labels.push(idx + 1);
          data.push(cumR);
        });

        if (equityChartInstance) equityChartInstance.destroy();
        equityChartInstance = new Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets: [
              {
                label: "Equity (R)",
                data,
                borderColor: "#facc15",
                backgroundColor: "rgba(250, 204, 21, 0.15)",
                borderWidth: 2,
                pointRadius: 2,
                tension: 0.25,
              },
            ],
          },
          options: {
            plugins: {
              legend: { display: false },
            },
            scales: {
              x: {
                grid: { color: "rgba(31,41,55,0.5)" },
                ticks: { color: "#9ca3af", font: { size: 10 } },
              },
              y: {
                grid: { color: "rgba(31,41,55,0.5)" },
                ticks: { color: "#9ca3af", font: { size: 10 } },
              },
            },
          },
        });
      }

      function renderProbChart() {
        const ctx = document.getElementById("probChart").getContext("2d");
        let wins = 0;
        let losses = 0;
        trades.forEach((t) => {
          if (t.resultR > 0) wins++;
          else if (t.resultR < 0) losses++;
        });

        if (probChartInstance) probChartInstance.destroy();
        probChartInstance = new Chart(ctx, {
          type: "bar",
          data: {
            labels: ["Wins", "Losses"],
            datasets: [
              {
                data: [wins, losses],
                backgroundColor: ["rgba(34,197,94,0.7)", "rgba(248,113,113,0.7)"],
              },
            ],
          },
          options: {
            plugins: { legend: { display: false } },
            scales: {
              x: {
                grid: { display: false },
                ticks: { color: "#9ca3af", font: { size: 10 } },
              },
              y: {
                grid: { color: "rgba(31,41,55,0.5)" },
                ticks: { color: "#9ca3af", font: { size: 10 } },
                beginAtZero: true,
                precision: 0,
              },
            },
          },
        });
      }

      /******************* WEEKLY / MONTHLY *******************/

      function renderWeeklyMonthly() {
        const now = new Date();
        const dayMs = 24 * 60 * 60 * 1000;
        const last7 = now.getTime() - 7 * dayMs;
        const last30 = now.getTime() - 30 * dayMs;

        let wCount = 0,
          wR = 0;
        let mCount = 0,
          mR = 0;
        trades.forEach((t) => {
          const d = new Date(t.date);
          const ms = d.getTime();
          if (!isNaN(ms)) {
            if (ms >= last7) {
              wCount++;
              wR += Number(t.resultR || 0);
            }
            if (ms >= last30) {
              mCount++;
              mR += Number(t.resultR || 0);
            }
          }
        });

        const risk = Number(settings.riskPerTrade || 0);
        const wMoney = wR * risk;
        const mMoney = mR * risk;

        document.getElementById(
          "weeklyStats"
        ).textContent = `Last 7 days: ${wCount} trade${wCount === 1 ? "" : "s"}.`;
        document.getElementById(
          "weeklyPnl"
        ).textContent = `PnL: ${formatR(wR)}R â€¢ $${formatMoney(wMoney)}`;

        document.getElementById(
          "monthlyStats"
        ).textContent = `Last 30 days: ${mCount} trade${mCount === 1 ? "" : "s"}.`;
        document.getElementById(
          "monthlyPnl"
        ).textContent = `PnL: ${formatR(mR)}R â€¢ $${formatMoney(mMoney)}`;
      }

      /******************* CALENDAR *******************/

      function renderCalendar() {
        const head = document.getElementById("calendarHead");
        const body = document.getElementById("calendarBody");
        head.innerHTML = "";
        body.innerHTML = "";

        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth();
        const monthStart = new Date(year, month, 1);
        const monthEnd = new Date(year, month + 1, 0);
        const firstDayIdx = monthStart.getDay(); // 0=Sun
        const daysInMonth = monthEnd.getDate();

        const monthName = monthStart.toLocaleString("en-US", { month: "long" });
        document.getElementById(
          "calendarTitle"
        ).textContent = `Calendar â€“ ${monthName} ${year}`;

        const weekdays = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
        weekdays.forEach((w) => {
          const div = document.createElement("div");
          div.className = "calendar-head";
          div.textContent = w;
          head.appendChild(div);
        });

        // Map date -> total PnL
        const dailyR = {};
        trades.forEach((t) => {
          const d = new Date(t.date);
          if (
            d.getFullYear() === year &&
            d.getMonth() === month &&
            !isNaN(d.getTime())
          ) {
            const day = d.getDate();
            dailyR[day] = (dailyR[day] || 0) + Number(t.resultR || 0);
          }
        });

        const risk = Number(settings.riskPerTrade || 0);

        // leading blanks
        for (let i = 0; i < firstDayIdx; i++) {
          const cell = document.createElement("div");
          body.appendChild(cell);
        }

        for (let day = 1; day <= daysInMonth; day++) {
          const cell = document.createElement("div");
          cell.className = "calendar-cell";

          const top = document.createElement("div");
          top.className = "calendar-day";
          top.textContent = day;
          cell.appendChild(top);

          const pnlDiv = document.createElement("div");
          pnlDiv.className = "calendar-pnl";
          const r = dailyR[day] || 0;
          if (r !== 0) {
            const money = r * risk;
            pnlDiv.textContent = (r > 0 ? "+" : "") + formatR(r) + "R / $" + formatMoney(money);
            pnlDiv.classList.add(r > 0 ? "positive" : "negative");
          } else {
            pnlDiv.textContent = "-";
          }
          cell.appendChild(pnlDiv);

          body.appendChild(cell);
        }
      }

      /******************* TRADES TABLE *******************/

      function openScreenshot(url) {
        if (!url) return;
        window.open(url, "_blank", "noopener");
      }

      function renderTable() {
        const tbody = document.getElementById("tradesTableBody");
        tbody.innerHTML = "";
        const risk = Number(settings.riskPerTrade || 0);

        trades
          .slice()
          .sort((a, b) => new Date(a.date) - new Date(b.date))
          .forEach((t, idx) => {
            const tr = document.createElement("tr");

            function addCell(text, cls) {
              const td = document.createElement("td");
              if (cls) td.className = cls;
              td.textContent = text;
              tr.appendChild(td);
            }

            addCell(idx + 1, "");
            addCell(t.date, "");
            addCell(t.pair, "");
            addCell(t.direction, "");
            addCell(formatR(t.resultR), "");
            const money = (t.resultR || 0) * risk;
            addCell(
              (money > 0 ? "+" : money < 0 ? "-" : "") +
                "$" +
                formatMoney(Math.abs(money)),
              money > 0 ? "pnl-positive" : money < 0 ? "pnl-negative" : ""
            );

            const discPct =
              t.checklistTotal > 0
                ? ((t.checklistHits / t.checklistTotal) * 100).toFixed(0)
                : "0";
            addCell(discPct + "%", "");

            // screenshot cell
            const tdLink = document.createElement("td");
            if (t.screenshot) {
              const span = document.createElement("span");
              span.textContent = "ðŸ”—";
              span.className = "link-icon";
              span.title = t.screenshot;
              span.onclick = () => openScreenshot(t.screenshot);
              tdLink.appendChild(span);
            } else {
              tdLink.textContent = "â€”";
            }
            tr.appendChild(tdLink);

            const tdNotes = document.createElement("td");
            tdNotes.textContent = t.notes || "";
            tr.appendChild(tdNotes);

            tbody.appendChild(tr);
          });
      }

      /******************* RENDER ALL *******************/

      function renderAll() {
        renderStats();
        renderEquityChart();
        renderProbChart();
        renderWeeklyMonthly();
        renderCalendar();
        renderTable();
      }

      /******************* INIT *******************/

      document.addEventListener("DOMContentLoaded", () => {
        loadState();
        restoreForm();
        updateChecklistSummary();
        renderAll();

        // update starting balance / risk on change
        document.getElementById("startingBalance").addEventListener("change", () => {
          settings.startingBalance = Number(
            document.getElementById("startingBalance").value || 0
          );
          saveState();
          renderAll();
        });
        document.getElementById("riskPerTrade").addEventListener("change", () => {
          settings.riskPerTrade = Number(
            document.getElementById("riskPerTrade").value || 0
          );
          saveState();
          renderAll();
        });

        document
          .querySelectorAll("#checklistArea input[type='checkbox']")
          .forEach((b) => b.addEventListener("change", updateChecklistSummary));

        // handle import
        const importInput = document.getElementById("importFile");
        importInput.addEventListener("change", (e) => {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = () => {
            try {
              const data = JSON.parse(reader.result);
              if (!data || !Array.isArray(data.trades)) {
                throw new Error("Invalid backup format");
              }
              trades = data.trades;
              settings = Object.assign(settings, data.settings || {});
              saveState();
              restoreForm();
              renderAll();
              alert("Backup imported successfully.");
            } catch (err) {
              console.error(err);
              alert("Could not import this file. Make sure it is a TredLog backup JSON.");
            } finally {
              importInput.value = "";
            }
          };
          reader.readAsText(file);
        });
      });
    </script>
  </body>
</html>
