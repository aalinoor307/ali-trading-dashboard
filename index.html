<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ali's Trading System • Secure Web Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Fonts & Chart.js -->
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
    rel="stylesheet"
  />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --bg: #020617;
      --bg-elevated: #020617;
      --accent: #f97316;
      --accent-soft: rgba(249, 115, 22, 0.16);
      --danger: #ef4444;
      --success: #22c55e;
      --muted: #64748b;
      --muted-soft: rgba(148, 163, 184, 0.12);
      --border: #1e293b;
      --text: #e2e8f0;
      --text-soft: #9ca3af;
      --radius-lg: 18px;
      --radius-sm: 10px;
      --shadow-soft: 0 24px 60px rgba(15, 23, 42, 0.85);
      --shadow-subtle: 0 14px 40px rgba(15, 23, 42, 0.6);
      --danger-soft: rgba(248, 113, 113, 0.14);
      --success-soft: rgba(34, 197, 94, 0.12);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at 0 0, #111827 0, #020617 52%, #000 100%);
      color: var(--text);
      display: flex;
      justify-content: center;
      align-items: stretch;
      padding: 20px;
    }

    /* Pin lock overlay */

    .pin-overlay {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at 0 0, #111827 0, #020617 50%, #000);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    .pin-overlay.hidden {
      display: none;
    }

    .pin-card {
      width: 100%;
      max-width: 420px;
      background: linear-gradient(145deg, #020617, #020617, #0b1120);
      border-radius: 26px;
      padding: 26px 26px 22px;
      border: 1px solid rgba(148, 163, 184, 0.22);
      box-shadow: var(--shadow-soft);
    }

    .pin-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin: 0 0 4px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .pin-badge {
      font-size: 0.55rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding: 3px 7px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      color: var(--text-soft);
    }

    .pin-subtitle {
      margin: 0 0 18px;
      font-size: 0.82rem;
      color: var(--text-soft);
    }

    .pin-label {
      font-size: 0.78rem;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .pin-input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text);
      font-size: 1rem;
      letter-spacing: 0.18em;
      text-align: center;
    }

    .pin-input:focus {
      outline: 1px solid var(--accent);
      box-shadow: 0 0 0 1px rgba(248, 113, 22, 0.65);
    }

    .pin-row {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 16px;
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 9px 16px;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.1s ease,
        background 0.12s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #f97316, #fb923c);
      color: #020617;
      box-shadow: 0 12px 35px rgba(249, 115, 22, 0.45);
      width: 100%;
      margin-bottom: 8px;
    }

    .btn-primary:active {
      transform: translateY(1px) scale(0.99);
      box-shadow: 0 8px 22px rgba(249, 115, 22, 0.4);
    }

    .btn-ghost {
      background: transparent;
      color: var(--text-soft);
      border-radius: 999px;
      padding-inline: 6px;
    }

    .btn-ghost:hover {
      color: var(--accent);
    }

    .pin-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 6px;
      font-size: 0.74rem;
      color: var(--muted);
    }

    .pin-msg {
      min-height: 16px;
      font-size: 0.76rem;
      margin: 4px 0 0;
    }

    .pin-msg.error {
      color: var(--danger);
    }

    .pin-msg.ok {
      color: var(--success);
    }

    .pin-meta {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.7rem;
      color: var(--muted);
      margin-bottom: 6px;
    }

    /* App shell */

    .app {
      width: 100%;
      max-width: 1280px;
      background: radial-gradient(circle at top left, #0b1120 0, #020617 46%, #000 100%);
      border-radius: 28px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      box-shadow: var(--shadow-soft);
      padding: 18px 18px 16px;
      display: flex;
      flex-direction: column;
      gap: 14px;
      overflow: hidden;
    }

    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      padding-inline: 4px;
    }

    .app-title {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .app-title-main {
      font-size: 1.02rem;
      font-weight: 600;
      letter-spacing: 0.04em;
    }

    .app-title-sub {
      font-size: 0.78rem;
      color: var(--muted);
    }

    .app-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 0.68rem;
    }

    .chip {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.32);
      background: rgba(15, 23, 42, 0.7);
    }

    .chip-accent {
      border-color: rgba(249, 115, 22, 0.55);
      background: rgba(248, 113, 22, 0.08);
      color: #fed7aa;
    }

    .chip-soft {
      border-style: dashed;
    }

    .app-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.75rem;
      color: var(--muted);
    }

    .pill {
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.75);
      border: 1px solid rgba(148, 163, 184, 0.28);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .pill-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.18);
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.05fr) minmax(0, 1.3fr);
      gap: 14px;
      align-items: flex-start;
    }

    .card {
      background: radial-gradient(circle at top left, #020617 0, #020617 40%, #020617 100%);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(148, 163, 184, 0.22);
      padding: 14px 14px 12px;
      box-shadow: var(--shadow-subtle);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .card-title {
      font-size: 0.88rem;
      font-weight: 600;
    }

    .card-subtitle {
      font-size: 0.75rem;
      color: var(--muted);
    }

    .tag {
      font-size: 0.7rem;
      padding: 3px 7px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.28);
      color: var(--text-soft);
    }

    .tag-accent {
      color: #fed7aa;
      border-color: rgba(248, 113, 22, 0.6);
      background: rgba(248, 113, 22, 0.08);
    }

    .tag-good {
      color: #bbf7d0;
      border-color: rgba(34, 197, 94, 0.5);
      background: var(--success-soft);
    }

    .grid-2 {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      margin-bottom: 10px;
    }

    .form-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 6px;
    }

    label {
      font-size: 0.75rem;
      color: var(--muted);
    }

    input,
    select,
    textarea {
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      padding: 7px 10px;
      background: rgba(15, 23, 42, 0.96);
      color: var(--text);
      font-size: 0.8rem;
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: 1px solid var(--accent);
      box-shadow: 0 0 0 1px rgba(248, 113, 22, 0.45);
    }

    textarea {
      min-height: 50px;
      resize: vertical;
    }

    .criteria-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 6px;
      margin-top: 4px;
    }

    .crit-item {
      display: flex;
      align-items: flex-start;
      gap: 6px;
      font-size: 0.75rem;
      padding: 6px 7px;
      background: rgba(15, 23, 42, 0.95);
      border-radius: var(--radius-sm);
      border: 1px solid rgba(30, 64, 175, 0.6);
    }

    .crit-item input {
      margin-top: 2px;
    }

    .crit-label-main {
      font-weight: 500;
      font-size: 0.75rem;
    }

    .crit-weight {
      font-size: 0.7rem;
      color: var(--muted);
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-top: 6px;
    }

    .btn-small {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-soft);
      font-size: 0.72rem;
      cursor: pointer;
    }

    .btn-small:hover {
      border-color: var(--accent);
      color: #fed7aa;
    }

    .btn-main {
      background: linear-gradient(135deg, #f97316, #fb923c);
      color: #020617;
      border: none;
      padding: 7px 16px;
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 14px 38px rgba(249, 115, 22, 0.4);
      cursor: pointer;
    }

    .btn-main:active {
      transform: translateY(1px) scale(0.99);
      box-shadow: 0 10px 26px rgba(249, 115, 22, 0.35);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
      margin-bottom: 10px;
    }

    .stat {
      padding: 8px 9px;
      border-radius: 14px;
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(148, 163, 184, 0.28);
    }

    .stat-label {
      font-size: 0.72rem;
      color: var(--muted);
      margin-bottom: 2px;
    }

    .stat-value {
      font-size: 1.05rem;
      font-weight: 600;
    }

    .stat-pill {
      font-size: 0.7rem;
      margin-top: 2px;
      color: var(--muted);
    }

    .stat-positive {
      color: var(--success);
    }

    .stat-negative {
      color: var(--danger);
    }

    .charts-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.05fr) minmax(0, 1.1fr);
      gap: 8px;
    }

    .chart-container {
      border-radius: 16px;
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(148, 163, 184, 0.24);
      padding: 8px 8px 6px;
    }

    .chart-title {
      font-size: 0.76rem;
      color: var(--muted);
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 4px;
    }

    .chart-title span {
      font-weight: 500;
      color: var(--text-soft);
    }

    .table-card {
      margin-top: 6px;
      background: rgba(15, 23, 42, 0.96);
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.26);
      padding: 8px;
      max-height: 240px;
      overflow: auto;
      font-size: 0.75rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 650px;
    }

    th,
    td {
      padding: 5px 6px;
      border-bottom: 1px solid rgba(30, 64, 175, 0.3);
      text-align: left;
    }

    th {
      font-size: 0.7rem;
      color: var(--muted);
      position: sticky;
      top: 0;
      background: rgba(15, 23, 42, 0.98);
      backdrop-filter: blur(10px);
    }

    tr:last-child td {
      border-bottom: none;
    }

    .pill-high {
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--success-soft);
      color: #bbf7d0;
      font-size: 0.7rem;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .pill-low {
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--danger-soft);
      color: #fecaca;
      font-size: 0.7rem;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .footer {
      margin-top: 2px;
      font-size: 0.7rem;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      gap: 6px;
      align-items: center;
    }

    .footer-links {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .footer-links button {
      border-radius: 999px;
      border: 1px dashed rgba(148, 163, 184, 0.45);
      background: transparent;
      color: var(--text-soft);
      padding: 2px 8px;
      font-size: 0.68rem;
      cursor: pointer;
    }

    .footer-links button:hover {
      border-color: var(--accent);
      color: #fed7aa;
    }

    .badge-dot {
      width: 6px;
      height: 6px;
      border-radius: 99px;
      background: var(--accent);
    }

    .mistakes-list {
      padding: 2px 0 0;
      list-style: none;
      margin: 0;
      font-size: 0.72rem;
      color: var(--muted);
    }

    .mistakes-list li {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      padding-block: 2px;
    }

    .mistakes-count {
      color: var(--text-soft);
    }

    /* Mobile */

    @media (max-width: 1024px) {
      body {
        padding: 10px;
      }

      .app {
        border-radius: 20px;
        padding: 12px 10px 10px;
      }

      .layout {
        grid-template-columns: minmax(0, 1fr);
      }

      .charts-grid {
        grid-template-columns: minmax(0, 1fr);
      }

      .stats-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }

      .card {
        padding-inline: 10px;
      }
    }

    @media (max-width: 640px) {
      .stats-grid {
        grid-template-columns: minmax(0, 1fr);
      }

      .criteria-grid {
        grid-template-columns: minmax(0, 1fr);
      }

      .app-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .app-actions {
        width: 100%;
        justify-content: space-between;
      }

      table {
        min-width: 560px;
      }
    }
  </style>
</head>
<body>
  <!-- PIN / Password Lock -->
  <div class="pin-overlay" id="pinOverlay">
    <div class="pin-card">
      <div class="pin-meta">
        <span class="badge-dot"></span>
        <span>Ali's Trading System • Secure Mode</span>
      </div>
      <h1 class="pin-title">
        Unlock dashboard
        <span class="pin-badge" id="pinModeTag">First-time setup</span>
      </h1>
      <p class="pin-subtitle" id="pinSubtitle">
        Set a 4-digit PIN to protect your trading journal. This only lives in this
        browser.
      </p>

      <div class="pin-row">
        <div class="pin-label" id="pinLabel">New PIN (4 digits)</div>
        <input
          id="pinInput"
          class="pin-input"
          type="password"
          inputmode="numeric"
          maxlength="12"
          autocomplete="off"
        />
        <div class="pin-msg" id="pinMessage"></div>
      </div>

      <button class="btn btn-primary" id="pinSubmitBtn">
        Continue
      </button>

      <div class="pin-footer">
        <button class="btn btn-ghost" id="pinResetBtn">
          Reset / Forgot PIN
        </button>
        <span>Encrypted-ish • Client-side only</span>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div class="app" id="app" style="display:none;">
    <header class="app-header">
      <div class="app-title">
        <div class="app-title-main">Ali's Trading System</div>
        <div class="app-title-sub">
          Probabilities • Discipline • R • Web-based execution journal
        </div>
        <div class="app-chips">
          <div class="chip chip-accent">Weighted checklist • Auto-score</div>
          <div class="chip chip-soft">JSON / CSV export • Import</div>
          <div class="chip chip-soft">Local auto-backup</div>
        </div>
      </div>
      <div class="app-actions">
        <div class="pill">
          <span class="pill-dot"></span>
          <span id="sessionInfo">Local session • Unsynced</span>
        </div>
        <button class="btn-small" id="lockBtn">Lock</button>
      </div>
    </header>

    <main class="layout">
      <!-- LEFT: Trade form + criteria -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">New trade</div>
            <div class="card-subtitle">
              Fill the form, tick criteria, log the trade. Scores &amp; probability
              are calculated automatically.
            </div>
          </div>
          <span class="tag tag-accent">Checklist + Execution</span>
        </div>

        <div class="grid-2">
          <div class="form-row">
            <label for="dateInput">Date</label>
            <input id="dateInput" type="date" />
          </div>
          <div class="form-row">
            <label for="pairInput">Pair</label>
            <input id="pairInput" placeholder="e.g. GBPUSD" />
          </div>
        </div>

        <div class="grid-2">
          <div class="form-row">
            <label for="directionInput">Direction</label>
            <select id="directionInput">
              <option value="">Select</option>
              <option value="Buy">Buy</option>
              <option value="Sell">Sell</option>
            </select>
          </div>
          <div class="form-row">
            <label for="setupInput">Setup</label>
            <select id="setupInput">
              <option value="">Select</option>
              <option value="Breakout with momentum">
                Breakout with momentum
              </option>
              <option value="Close above/below level">
                Candle close above/below level
              </option>
              <option value="Other">Other</option>
            </select>
          </div>
        </div>

        <div class="grid-2">
          <div class="form-row">
            <label for="riskInput">Risk per trade (R)</label>
            <input
              id="riskInput"
              type="number"
              step="0.01"
              placeholder="e.g. 1"
            />
          </div>
          <div class="form-row">
            <label for="rrPlannedInput">R:R planned</label>
            <input
              id="rrPlannedInput"
              type="number"
              step="0.1"
              placeholder="e.g. 2.5"
            />
          </div>
        </div>

        <div class="grid-2">
          <div class="form-row">
            <label for="rrRealizedInput">R realized</label>
            <input
              id="rrRealizedInput"
              type="number"
              step="0.1"
              placeholder="e.g. 1.5"
            />
          </div>
          <div class="form-row">
            <label for="sessionInput">Session</label>
            <select id="sessionInput">
              <option value="">Select</option>
              <option value="London">London</option>
              <option value="New York">New York</option>
              <option value="Asia">Asia</option>
            </select>
          </div>
        </div>

        <div class="grid-2">
          <div class="form-row">
            <label for="emotionInput">Emotion tag</label>
            <select id="emotionInput">
              <option value="">Select</option>
              <option value="Calm">Calm</option>
              <option value="Disciplined">Disciplined</option>
              <option value="Confident">Confident</option>
              <option value="Neutral">Neutral</option>
              <option value="FOMO">FOMO</option>
              <option value="Fearful">Fearful</option>
              <option value="Revenge">Revenge</option>
              <option value="Overtrading">Overtrading</option>
            </select>
          </div>
          <div class="form-row">
            <label for="screenshotInput">Screenshot link</label>
            <input
              id="screenshotInput"
              placeholder="Paste TradingView / chart link"
            />
          </div>
        </div>

        <div class="form-row">
          <label for="notesInput">Journal notes</label>
          <textarea
            id="notesInput"
            placeholder="What did you do well? What can you improve?"
          ></textarea>
        </div>

        <div class="card-subtitle" style="margin-top: 8px;">
          Breakout / candle criteria (weighted). Tick only what was actually met.
        </div>
        <div class="criteria-grid">
          <label class="crit-item">
            <input type="checkbox" class="crit-checkbox" data-weight="2" />
            <div>
              <div class="crit-label-main">
                Clean close at level
              </div>
              <div class="crit-weight">
                No big wicks both sides &bull; weight 2
              </div>
            </div>
          </label>
          <label class="crit-item">
            <input type="checkbox" class="crit-checkbox" data-weight="2" />
            <div>
              <div class="crit-label-main">
                No long wick against direction
              </div>
              <div class="crit-weight">
                Wick profile matches bias &bull; weight 2
              </div>
            </div>
          </label>
          <label class="crit-item">
            <input type="checkbox" class="crit-checkbox" data-weight="1" />
            <div>
              <div class="crit-label-main">
                Structure matches plan
              </div>
              <div class="crit-weight">
                Story + higher TF aligned &bull; weight 1
              </div>
            </div>
          </label>
          <label class="crit-item">
            <input type="checkbox" class="crit-checkbox" data-weight="1" />
            <div>
              <div class="crit-label-main">
                Not after huge candle
              </div>
              <div class="crit-weight">
                Avoid exhaustion move &bull; weight 1
              </div>
            </div>
          </label>
          <label class="crit-item">
            <input type="checkbox" class="crit-checkbox" data-weight="2" />
            <div>
              <div class="crit-label-main">
                No flat / no-wick close
              </div>
              <div class="crit-weight">
                Entry candle prints wick first then flips &bull; weight 2
              </div>
            </div>
          </label>
          <label class="crit-item">
            <input type="checkbox" class="crit-checkbox" data-weight="2" />
            <div>
              <div class="crit-label-main">
                Wick first, then flip entry
              </div>
              <div class="crit-weight">
                Classic flip entry behaviour &bull; weight 2
              </div>
            </div>
          </label>
        </div>

        <div class="btn-row">
          <button class="btn-main" id="addTradeBtn">
            + Add trade to log
          </button>
          <button class="btn-small" id="clearFormBtn" type="button">
            Clear form
          </button>
          <span class="card-subtitle" id="formInfo">
            Checklist score and probability will be calculated automatically.
          </span>
        </div>
      </section>

      <!-- RIGHT: Dashboard -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Dashboard</div>
            <div class="card-subtitle">
              Live performance breakdown, probability &amp; behaviour tracking.
            </div>
          </div>
          <span class="tag tag-good">Auto-updated from left panel</span>
        </div>

        <div class="stats-grid">
          <div class="stat">
            <div class="stat-label">Win rate</div>
            <div class="stat-value" id="winRateStat">0%</div>
            <div class="stat-pill">
              <span id="totalTradesStat">0</span> trades
            </div>
          </div>
          <div class="stat">
            <div class="stat-label">Avg R (realized)</div>
            <div class="stat-value" id="avgRStat">0.0R</div>
            <div class="stat-pill">
              Equity: <span id="equityStat">0.0R</span>
            </div>
          </div>
          <div class="stat">
            <div class="stat-label">Discipline score</div>
            <div class="stat-value" id="disciplineStat">0</div>
            <div class="stat-pill" id="disciplineLabel">No trades yet</div>
          </div>
        </div>

        <div class="charts-grid">
          <div class="chart-container">
            <div class="chart-title">
              <span>High vs low probability</span>
              <span id="probabilitySummary">0 high • 0 low</span>
            </div>
            <canvas id="probChart" height="130"></canvas>
          </div>
          <div class="chart-container">
            <div class="chart-title">
              <span>Equity curve (R)</span>
              <span id="equitySummary">0R start</span>
            </div>
            <canvas id="equityChart" height="130"></canvas>
          </div>
        </div>

        <div class="chart-container" style="margin-top: 8px;">
          <div class="chart-title">
            <span>Most common mistakes (last 30 trades)</span>
            <span style="font-size:0.7rem;color:var(--muted);">
              based on emotion &amp; notes tags
            </span>
          </div>
          <ul class="mistakes-list" id="mistakesList">
            <li><span>None yet</span><span class="mistakes-count">0</span></li>
          </ul>
        </div>

        <div class="table-card">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Date</th>
                <th>Pair</th>
                <th>Dir</th>
                <th>Setup</th>
                <th>Prob</th>
                <th>Score</th>
                <th>R planned</th>
                <th>R realized</th>
                <th>Run R</th>
                <th>Session</th>
                <th>Emotion</th>
                <th>Discipline</th>
              </tr>
            </thead>
            <tbody id="tradesTableBody"></tbody>
          </table>
        </div>
      </section>
    </main>

    <footer class="footer">
      <div>Data is stored locally &amp; never leaves your browser.</div>
      <div class="footer-links">
        <button id="exportJsonBtn">Export JSON</button>
        <button id="exportCsvBtn">Export CSV</button>
        <button id="importJsonBtn">Import JSON</button>
        <input
          id="importFileInput"
          type="file"
          accept="application/json"
          style="display:none"
        />
      </div>
    </footer>
  </div>

  <script>
    // ------- Core State & Constants -------

    const STORAGE_KEY = "ali_trading_dashboard_v2";
    const PIN_KEY = "ali_trading_pin_v1";

    let state = {
      trades: [],
      runningEquity: 0,
      createdAt: new Date().toISOString(),
    };

    let probChart = null;
    let equityChart = null;

    // ------- Helpers -------

    function saveState() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (e) {
        console.warn("Could not save state", e);
      }
    }

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) {
          const parsed = JSON.parse(raw);
          if (Array.isArray(parsed.trades)) {
            state = parsed;
          }
        }
      } catch (e) {
        console.warn("Could not load state", e);
      }
    }

    function formatPercent(v) {
      return isFinite(v) ? v.toFixed(1) + "%" : "0%";
    }

    function formatR(v) {
      return (isFinite(v) ? v.toFixed(2) : 0).toString() + "R";
    }

    function computeDisciplineScore(trade) {
      // Base on emotion, session & whether R:R was followed
      let score = 50;

      const goodEmotions = ["Calm", "Disciplined", "Confident", "Neutral"];
      const badEmotions = ["FOMO", "Fearful", "Revenge", "Overtrading"];

      if (goodEmotions.includes(trade.emotion)) score += 15;
      if (badEmotions.includes(trade.emotion)) score -= 15;

      if (trade.session === "London") score += 5;
      if (trade.session === "New York") score += 5;
      if (trade.session === "Asia") score -= 5;

      if (typeof trade.rrPlanned === "number" &&
          typeof trade.rrRealized === "number") {
        if (trade.rrRealized < -1.2 * trade.rrPlanned) score -= 10;
        if (trade.rrRealized > 0.8 * trade.rrPlanned) score += 5;
      }

      if (trade.scorePercent >= 0.8) score += 10;
      if (trade.scorePercent < 0.5) score -= 10;

      return Math.max(0, Math.min(100, score));
    }

    function probabilityLabel(pctScore) {
      if (pctScore >= 0.8) return "High";
      if (pctScore >= 0.6) return "Medium";
      return "Low";
    }

    function aggregateMistakes(lastTrades) {
      const buckets = {};
      lastTrades.forEach((t) => {
        const emo = t.emotion || "None";
        if (!buckets[emo]) buckets[emo] = 0;
        if (["FOMO", "Fearful", "Revenge", "Overtrading"].includes(emo)) {
          buckets[emo] += 1;
        }
      });
      return buckets;
    }

    // ------- Charts -------

    function initCharts() {
      const probCtx = document.getElementById("probChart").getContext("2d");
      const eqCtx = document.getElementById("equityChart").getContext("2d");

      probChart = new Chart(probCtx, {
        type: "doughnut",
        data: {
          labels: ["High", "Medium", "Low"],
          datasets: [
            {
              data: [0, 0, 1],
            },
          ],
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: "bottom",
              labels: {
                color: "#cbd5f5",
                font: { size: 11 },
              },
            },
          },
          cutout: "65%",
        },
      });

      equityChart = new Chart(eqCtx, {
        type: "line",
        data: {
          labels: [],
          datasets: [
            {
              label: "Equity (R)",
              data: [],
              tension: 0.25,
              borderWidth: 2,
              pointRadius: 2.5,
            },
          ],
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
          },
          scales: {
            x: {
              ticks: { color: "#94a3b8", font: { size: 10 } },
              grid: { color: "rgba(30,64,175,0.4)" },
            },
            y: {
              ticks: { color: "#94a3b8", font: { size: 10 } },
              grid: { color: "rgba(30,64,175,0.4)" },
            },
          },
        },
      });
    }

    function updateCharts() {
      if (!probChart || !equityChart) return;
      const trades = state.trades || [];

      // Probability distribution
      let high = 0,
        med = 0,
        low = 0;
      trades.forEach((t) => {
        if (t.probLabel === "High") high++;
        else if (t.probLabel === "Medium") med++;
        else low++;
      });

      probChart.data.datasets[0].data = [high, med, low || 1];
      probChart.update("none");

      // Equity curve
      const labels = [];
      const data = [];
      let running = 0;
      trades.forEach((t, idx) => {
        running += t.rrRealized || 0;
        labels.push(idx + 1);
        data.push(running);
      });
      equityChart.data.labels = labels;
      equityChart.data.datasets[0].data = data;
      equityChart.update("none");
    }

    // ------- Rendering -------

    function renderStats() {
      const trades = state.trades || [];

      const total = trades.length;
      const wins = trades.filter((t) => (t.rrRealized || 0) > 0).length;
      const losses = trades.filter((t) => (t.rrRealized || 0) < 0).length;
      const sumR = trades.reduce((acc, t) => acc + (t.rrRealized || 0), 0);
      const winRate = total ? (wins / total) * 100 : 0;
      const avgR = total ? sumR / total : 0;

      state.runningEquity = sumR;

      document.getElementById("winRateStat").textContent =
        formatPercent(winRate);
      document.getElementById("avgRStat").textContent = formatR(avgR);
      document.getElementById("equityStat").textContent = formatR(sumR);
      document.getElementById("totalTradesStat").textContent = total;

      // Discipline aggregate
      const avgDisc =
        total > 0
          ? trades.reduce((acc, t) => acc + (t.disciplineScore || 0), 0) /
            total
          : 0;
      document.getElementById("disciplineStat").textContent = Math.round(
        avgDisc
      ).toString();
      const labelEl = document.getElementById("disciplineLabel");
      if (total === 0) {
        labelEl.textContent = "No trades yet";
      } else if (avgDisc >= 80) {
        labelEl.textContent = "Elite discipline";
      } else if (avgDisc >= 65) {
        labelEl.textContent = "Solid execution";
      } else if (avgDisc >= 50) {
        labelEl.textContent = "Inconsistent – review rules";
      } else {
        labelEl.textContent = "Danger zone – slow down";
      }

      // Probability summary
      const high = trades.filter((t) => t.probLabel === "High").length;
      const low = trades.filter((t) => t.probLabel === "Low").length;
      document.getElementById(
        "probabilitySummary"
      ).textContent = `${high} high • ${low} low`;

      // Equity summary
      document.getElementById(
        "equitySummary"
      ).textContent = `${formatR(sumR)} total`;
    }

    function renderTradesTable() {
      const body = document.getElementById("tradesTableBody");
      body.innerHTML = "";
      const trades = state.trades || [];
      let running = 0;

      trades.forEach((t, idx) => {
        running += t.rrRealized || 0;
        const row = document.createElement("tr");

        const probBadge =
          t.probLabel === "High"
            ? `<span class="pill-high">High</span>`
            : t.probLabel === "Medium"
            ? `<span class="pill-high" style="background:rgba(56,189,248,0.12);color:#bae6fd;">Medium</span>`
            : `<span class="pill-low">Low</span>`;

        row.innerHTML = `
          <td>${idx + 1}</td>
          <td>${t.date || ""}</td>
          <td>${t.pair || ""}</td>
          <td>${t.direction || ""}</td>
          <td>${t.setup || ""}</td>
          <td>${probBadge}</td>
          <td>${Math.round((t.scorePercent || 0) * 100)}%</td>
          <td>${t.rrPlanned ?? ""}</td>
          <td>${t.rrRealized ?? ""}</td>
          <td>${running.toFixed(2)}</td>
          <td>${t.session || ""}</td>
          <td>${t.emotion || ""}</td>
          <td>${Math.round(t.disciplineScore || 0)}</td>
        `;
        body.appendChild(row);
      });
    }

    function renderMistakes() {
      const list = document.getElementById("mistakesList");
      list.innerHTML = "";
      const trades = state.trades || [];
      const last = trades.slice(-30);
      const buckets = aggregateMistakes(last);
      const entries = Object.entries(buckets).sort((a, b) => b[1] - a[1]);
      if (entries.length === 0) {
        const li = document.createElement("li");
        li.innerHTML = `<span>None yet</span><span class="mistakes-count">0</span>`;
        list.appendChild(li);
        return;
      }
      entries.forEach(([name, count]) => {
        const li = document.createElement("li");
        li.innerHTML = `<span>${name}</span><span class="mistakes-count">${count}</span>`;
        list.appendChild(li);
      });
    }

    function renderAll() {
      renderStats();
      renderTradesTable();
      renderMistakes();
      updateCharts();
    }

    // ------- Form handling -------

    function getCheckedCriteria() {
      const boxes = Array.from(
        document.querySelectorAll(".crit-checkbox")
      );
      const weights = boxes.map((b) => Number(b.dataset.weight || "0"));
      const usedWeights = boxes
        .filter((b) => b.checked)
        .map((b) => Number(b.dataset.weight || "0"));
      const total = weights.reduce((a, b) => a + b, 0) || 1;
      const met = usedWeights.reduce((a, b) => a + b, 0);
      const percent = met / total;
      return { totalWeight: total, metWeight: met, percent };
    }

    function clearForm() {
      document.getElementById("dateInput").value = "";
      document.getElementById("pairInput").value = "";
      document.getElementById("directionInput").value = "";
      document.getElementById("setupInput").value = "";
      document.getElementById("riskInput").value = "";
      document.getElementById("rrPlannedInput").value = "";
      document.getElementById("rrRealizedInput").value = "";
      document.getElementById("sessionInput").value = "";
      document.getElementById("emotionInput").value = "";
      document.getElementById("screenshotInput").value = "";
      document.getElementById("notesInput").value = "";
      document
        .querySelectorAll(".crit-checkbox")
        .forEach((cb) => (cb.checked = false));
      document.getElementById("formInfo").textContent =
        "Checklist score and probability will be calculated automatically.";
    }

    function addTradeFromForm() {
      const date = document.getElementById("dateInput").value;
      const pair = document.getElementById("pairInput").value.trim();
      const direction = document.getElementById("directionInput").value;
      const setup = document.getElementById("setupInput").value;
      const risk = Number(document.getElementById("riskInput").value) || 0;
      const rrPlanned =
        Number(document.getElementById("rrPlannedInput").value) || 0;
      const rrRealized =
        Number(document.getElementById("rrRealizedInput").value) || 0;
      const session = document.getElementById("sessionInput").value;
      const emotion = document.getElementById("emotionInput").value;
      const screenshot = document.getElementById("screenshotInput").value;
      const notes = document.getElementById("notesInput").value;

      if (!date || !pair || !direction || !setup) {
        document.getElementById("formInfo").textContent =
          "Please fill at least date, pair, direction & setup.";
        return;
      }

      const crit = getCheckedCriteria();
      const probLbl = probabilityLabel(crit.percent);
      const disciplineScore = computeDisciplineScore({
        rrPlanned,
        rrRealized,
        session,
        emotion,
        scorePercent: crit.percent,
      });

      const trade = {
        id: Date.now(),
        date,
        pair,
        direction,
        setup,
        risk,
        rrPlanned,
        rrRealized,
        session,
        emotion,
        screenshot,
        notes,
        scorePercent: crit.percent,
        totalCriteriaWeight: crit.totalWeight,
        metCriteriaWeight: crit.metWeight,
        probLabel: probLbl,
        disciplineScore,
      };

      state.trades.push(trade);
      saveState();
      renderAll();

      document.getElementById("formInfo").textContent =
        `Trade added • Score: ${Math.round(
          crit.percent * 100
        )}% • Probability: ${probLbl}`;
    }

    // ------- Export / Import -------

    function exportJson() {
      const blob = new Blob([JSON.stringify(state, null, 2)], {
        type: "application/json",
      });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const date = new Date().toISOString().slice(0, 10);
      a.href = url;
      a.download = `ali_trading_backup_${date}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function exportCsv() {
      const trades = state.trades || [];
      const header = [
        "id",
        "date",
        "pair",
        "direction",
        "setup",
        "probability",
        "scorePercent",
        "rrPlanned",
        "rrRealized",
        "session",
        "emotion",
        "disciplineScore",
        "screenshot",
        "notes",
      ];
      const rows = trades.map((t) =>
        header
          .map((key) => {
            const v =
              key === "probability" ? t.probLabel : t[key] ?? "";
            const escaped =
              typeof v === "string" && v.includes(",")
                ? `"${v.replace(/"/g, '""')}"`
                : v;
            return escaped;
          })
          .join(",")
      );
      const csv = [header.join(","), ...rows].join("\n");
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const date = new Date().toISOString().slice(0, 10);
      a.href = url;
      a.download = `ali_trading_log_${date}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function importJsonFromFile(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const parsed = JSON.parse(e.target.result);
          if (parsed && Array.isArray(parsed.trades)) {
            state = parsed;
            saveState();
            renderAll();
            alert("Session imported successfully.");
          } else {
            alert("Invalid file format – no trades array found.");
          }
        } catch (err) {
          console.error(err);
          alert("Could not parse JSON file.");
        }
      };
      reader.readAsText(file);
    }

    // ------- PIN / Lock -------

    function getPinHash() {
      return localStorage.getItem(PIN_KEY);
    }

    function setPinHash(pin) {
      // Not true crypto, but better than plain text; for offline use it's fine
      const hash = btoa("ali_salt__" + pin);
      localStorage.setItem(PIN_KEY, hash);
    }

    function checkPin(pin) {
      const stored = getPinHash();
      if (!stored) return false;
      const hash = btoa("ali_salt__" + pin);
      return stored === hash;
    }

    function resetPin() {
      if (
        confirm(
          "Reset PIN and clear all stored data? This cannot be undone."
        )
      ) {
        localStorage.removeItem(PIN_KEY);
        localStorage.removeItem(STORAGE_KEY);
        state = { trades: [], runningEquity: 0 };
        location.reload();
      }
    }

    function initPinOverlay() {
      const overlay = document.getElementById("pinOverlay");
      const app = document.getElementById("app");
      const modeTag = document.getElementById("pinModeTag");
      const subtitle = document.getElementById("pinSubtitle");
      const label = document.getElementById("pinLabel");
      const input = document.getElementById("pinInput");
      const msg = document.getElementById("pinMessage");
      const submitBtn = document.getElementById("pinSubmitBtn");
      const resetBtn = document.getElementById("pinResetBtn");
      const lockBtn = document.getElementById("lockBtn");

      const hasPin = !!getPinHash();
      let mode = hasPin ? "unlock" : "set";

      if (mode === "unlock") {
        modeTag.textContent = "Locked";
        subtitle.textContent =
          "Enter your PIN to unlock Ali's trading dashboard in this browser.";
        label.textContent = "PIN";
      } else {
        modeTag.textContent = "First-time setup";
        subtitle.textContent =
          "Set a 4-digit PIN to protect your trading journal. This stays only on this device.";
        label.textContent = "New PIN (4 digits)";
      }

      function unlock() {
        overlay.classList.add("hidden");
        app.style.display = "flex";
      }

      submitBtn.addEventListener("click", () => {
        const pin = input.value.trim();
        msg.classList.remove("error", "ok");
        if (!pin || pin.length < 4) {
          msg.textContent = "PIN should be at least 4 digits.";
          msg.classList.add("error");
          return;
        }

        if (mode === "set") {
          setPinHash(pin);
          msg.textContent = "PIN saved. Unlocking…";
          msg.classList.add("ok");
          setTimeout(unlock, 400);
        } else {
          if (checkPin(pin)) {
            msg.textContent = "Unlocked.";
            msg.classList.add("ok");
            setTimeout(unlock, 200);
          } else {
            msg.textContent = "Incorrect PIN.";
            msg.classList.add("error");
          }
        }
      });

      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") submitBtn.click();
      });

      resetBtn.addEventListener("click", resetPin);

      lockBtn.addEventListener("click", () => {
        app.style.display = "none";
        overlay.classList.remove("hidden");
        modeTag.textContent = "Locked";
        subtitle.textContent =
          "Enter your PIN to unlock Ali's trading dashboard in this browser.";
        label.textContent = "PIN";
        mode = "unlock";
        input.value = "";
        msg.textContent = "";
      });
    }

    // ------- Init -------

    document.addEventListener("DOMContentLoaded", () => {
      loadState();
      initCharts();
      renderAll();
      initPinOverlay();

      // Auto-backup indicator
      const sessionInfo = document.getElementById("sessionInfo");
      sessionInfo.textContent = "Local session • Auto-backup every 10s";

      // Auto backup every 10 seconds
      setInterval(saveState, 10000);

      // Buttons
      document
        .getElementById("addTradeBtn")
        .addEventListener("click", addTradeFromForm);
      document
        .getElementById("clearFormBtn")
        .addEventListener("click", clearForm);
      document
        .getElementById("exportJsonBtn")
        .addEventListener("click", exportJson);
      document
        .getElementById("exportCsvBtn")
        .addEventListener("click", exportCsv);
      document
        .getElementById("importJsonBtn")
        .addEventListener("click", () =>
          document.getElementById("importFileInput").click()
        );
      document
        .getElementById("importFileInput")
        .addEventListener("change", (e) => {
          const file = e.target.files[0];
          if (file) importJsonFromFile(file);
          e.target.value = "";
        });

      // Pre-fill today's date
      const today = new Date().toISOString().slice(0, 10);
      document.getElementById("dateInput").value = today;
    });
  </script>
</body>
</html>
upgrade v2
