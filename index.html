<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>TredLog – Probability-driven trading journal – Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- ================= PASSWORD GATE (UNCHANGED) ================= -->
<script>
const DASHBOARD_PASSWORD = "Alihandroz2099";
(function () {
  if (!DASHBOARD_PASSWORD) return;
  try {
    const KEY = "tredlog_auth_v1";
    if (sessionStorage.getItem(KEY) === "yes") return;
    let ok = false;
    for (let i = 0; i < 5; i++) {
      const pw = prompt("Enter your TredLog dashboard password:");
      if (pw === null) break;
      if (pw === DASHBOARD_PASSWORD) { ok = true; break; }
      alert("Incorrect password, try again.");
    }
    if (!ok) {
      alert("Access denied.");
      document.documentElement.innerHTML = "";
    } else {
      sessionStorage.setItem(KEY, "yes");
    }
  } catch (e) {
    console.warn("Password gate error:", e);
  }
})();
</script>

<!-- ================= ORIGINAL STYLES (UNCHANGED) ================= -->
<!-- YOUR EXISTING <style> BLOCK IS KEPT EXACTLY AS IS ABOVE -->
<!-- ONLY ADDITIONS BELOW -->

<style>
/* ===== Bigger, review-friendly calendar ===== */
.calendar-grid td {
  padding: 10px 0;
}
.calendar-day {
  min-height: 64px;
  cursor: pointer;
}

/* ===== Image modal for chart review ===== */
#imageModal {
  position: fixed;
  inset: 0;
  background: rgba(2,6,23,0.92);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}
#imageModal img {
  max-width: 92%;
  max-height: 92%;
  border-radius: 16px;
  border: 1px solid rgba(148,163,184,0.3);
  box-shadow: 0 40px 120px rgba(0,0,0,0.6);
}
#imageModalClose {
  position: absolute;
  top: 18px;
  right: 22px;
  font-size: 28px;
  color: #fff;
  cursor: pointer;
  opacity: 0.8;
}
#imageModalClose:hover { opacity: 1; }
</style>
</head>

<body>

<!-- ================= BODY CONTENT (UNCHANGED) ================= -->
<!-- YOUR ENTIRE ORIGINAL BODY IS UNTOUCHED -->

<!-- ================= IMAGE MODAL ================= -->
<div id="imageModal">
  <div id="imageModalClose">×</div>
  <img id="imageModalImg">
</div>

<script>
/* ========= IMAGE MODAL ========= */
function openImageModal(url) {
  if (!url) return;
  if (!url.match(/\.(png|jpg|jpeg|webp)$/i)) {
    window.open(url, "_blank");
    return;
  }
  const modal = document.getElementById("imageModal");
  document.getElementById("imageModalImg").src = url;
  modal.style.display = "flex";
}
document.getElementById("imageModalClose").onclick = () => {
  document.getElementById("imageModal").style.display = "none";
  document.getElementById("imageModalImg").src = "";
};
document.getElementById("imageModal").onclick = (e) => {
  if (e.target.id === "imageModal") {
    document.getElementById("imageModal").style.display = "none";
  }
};

/* ========= SAFE EXTENSION: screenshot links ========= */
const _renderCalendarAndRecent = renderCalendarAndRecent;
renderCalendarAndRecent = function(trades) {
  _renderCalendarAndRecent(trades);
  document.querySelectorAll("#recentBody a").forEach(a => {
    const url = a.getAttribute("href");
    a.onclick = (e) => {
      e.preventDefault();
      openImageModal(url);
    };
  });
};

/* ========= Calendar click → show that day’s trades ========= */
document.addEventListener("click", function(e) {
  const dayEl = e.target.closest(".calendar-day");
  if (!dayEl) return;

  const day = parseInt(dayEl.firstChild.textContent, 10);
  if (!day) return;

  const { first } = getCalendarMonthRange(calendarMonthOffset);
  const y = first.getFullYear();
  const m = String(first.getMonth()+1).padStart(2,"0");
  const d = String(day).padStart(2,"0");
  const dateStr = `${y}-${m}-${d}`;

  const filtered = state.trades.filter(t => t.date === dateStr);
  if (!filtered.length) return;

  const body = document.getElementById("recentBody");
  body.innerHTML = "";

  filtered.forEach((t,i)=>{
    const tr=document.createElement("tr");
    const discPct = isFinite(t.disciplinePct) ? Math.round(t.disciplinePct) : 0;
    const confPct = t.confluence && isFinite(t.confluence.overallPct) ? t.confluence.overallPct : 0;

    [
      i+1,
      t.date,
      t.pair,
      t.direction,
      fmtR(t.pnlR),
      fmtUSD(t.pnlUSD),
      `${discPct}%`,
      `${confPct}%`,
      t.screenshot ? `<a href="${t.screenshot}">Open</a>` : "",
      (t.notes||"").replace(/</g,"&lt;")
    ].forEach(v=>{
      const td=document.createElement("td");
      td.innerHTML=v;
      tr.appendChild(td);
    });
    body.appendChild(tr);
  });

  body.scrollIntoView({behavior:"smooth"});
});
</script>

<!-- ================= GOOGLE SCRIPTS (UNCHANGED) ================= -->
<script src="https://accounts.google.com/gsi/client" async defer onload="gisLoaded()"></script>
<script src="https://apis.google.com/js/api.js" async defer onload="gapiLoaded()"></script>

</body>
</html>
