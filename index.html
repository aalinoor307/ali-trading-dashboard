<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ali's Trading System • Black & Gold Edition</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Fonts & Charts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --bg: #050508;
      --bg-elevated: #11111a;
      --bg-soft: #171722;
      --border-soft: #26263a;
      --accent: #f7b733;
      --accent-soft: rgba(247, 183, 51, 0.16);
      --accent-strong: #ffcf40;
      --danger: #ff5555;
      --success: #2ecc71;
      --muted: #8588a0;
      --text: #f5f5ff;
      --text-soft: #b5b7d4;
      --radius-lg: 18px;
      --radius-md: 12px;
      --shadow-soft: 0 24px 60px rgba(0, 0, 0, 0.75);
      --shadow-card: 0 18px 40px rgba(0, 0, 0, 0.55);
      --transition-fast: 0.18s ease-out;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #19192e 0, #050508 55%);
      color: var(--text);
      min-height: 100vh;
    }

    .app-shell {
      max-width: 1320px;
      margin: 16px auto 32px;
      padding: 0 16px;
    }

    header.app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      gap: 16px;
    }

    .brand {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .brand-title {
      font-size: 22px;
      font-weight: 600;
      letter-spacing: 0.03em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .brand-chip {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(247, 183, 51, 0.7);
      background: radial-gradient(circle at top, rgba(247, 183, 51, 0.15), transparent 60%);
      color: var(--accent-strong);
    }

    .brand-subtitle {
      font-size: 12px;
      color: var(--muted);
    }

    .top-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .pill {
      padding: 6px 10px;
      font-size: 11px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: rgba(8, 8, 16, 0.8);
      color: var(--text-soft);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .pill-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--success);
      box-shadow: 0 0 12px rgba(46, 204, 113, 0.8);
    }

    .pill-lock {
      border-color: rgba(247, 183, 51, 0.5);
      cursor: pointer;
    }

    .pill-lock.active {
      background: linear-gradient(135deg, rgba(247, 183, 51, 0.15), rgba(247, 183, 51, 0.03));
      color: var(--accent-strong);
    }

    .pill-button {
      cursor: pointer;
      transition: background var(--transition-fast), transform var(--transition-fast), box-shadow var(--transition-fast);
    }

    .pill-button:hover {
      background: rgba(30, 30, 42, 0.9);
      box-shadow: 0 0 0 1px rgba(247, 183, 51, 0.2);
      transform: translateY(-1px);
    }

    /* Main layout */
    .layout {
      display: grid;
      grid-template-columns: minmax(0, 380px) minmax(0, 1fr);
      gap: 16px;
    }

    .card {
      background: radial-gradient(circle at top left, rgba(247, 183, 51, 0.08), transparent 60%),
                  radial-gradient(circle at bottom right, rgba(88, 80, 180, 0.18), transparent 65%),
                  var(--bg-elevated);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(255, 255, 255, 0.03);
      box-shadow: var(--shadow-card);
      padding: 16px 16px 14px;
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(16px);
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      border-radius: inherit;
      border: 1px solid rgba(255, 255, 255, 0.02);
      opacity: 0;
      transition: opacity var(--transition-fast);
    }

    .card:hover::before {
      opacity: 1;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      gap: 8px;
    }

    .card-title {
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--text-soft);
    }

    .card-meta {
      font-size: 11px;
      color: var(--muted);
    }

    .chip {
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: rgba(14, 14, 24, 0.9);
      border: 1px solid var(--border-soft);
      color: var(--text-soft);
    }

    .chip-gold {
      border-color: rgba(247, 183, 51, 0.7);
      color: var(--accent-strong);
      background: radial-gradient(circle at top, rgba(247, 183, 51, 0.14), rgba(8, 8, 16, 0.98));
    }

    .card-body {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .field-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }

    .field-row-3 {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .field label {
      font-size: 11px;
      color: var(--muted);
    }

    .field input,
    .field select,
    .field textarea {
      background: rgba(10, 10, 20, 0.96);
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      color: var(--text);
      padding: 7px 9px;
      font-size: 12px;
      font-family: inherit;
      outline: none;
      transition: border var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast), transform var(--transition-fast);
    }

    .field input::placeholder,
    .field textarea::placeholder {
      color: rgba(173, 175, 204, 0.7);
    }

    .field input:focus,
    .field select:focus,
    .field textarea:focus {
      border-color: rgba(247, 183, 51, 0.75);
      box-shadow: 0 0 0 1px rgba(247, 183, 51, 0.3);
      transform: translateY(-0.5px);
    }

    .field textarea {
      resize: vertical;
      min-height: 54px;
      max-height: 120px;
    }

    .criteria-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
      margin-top: 4px;
    }

    .criteria-item {
      display: flex;
      align-items: flex-start;
      gap: 6px;
      padding: 7px 8px;
      border-radius: 10px;
      border: 1px solid rgba(45, 46, 70, 0.9);
      background: radial-gradient(circle at top left, rgba(247, 183, 51, 0.06), rgba(12, 12, 24, 0.96));
      font-size: 11px;
      color: var(--text-soft);
      cursor: pointer;
      transition: border var(--transition-fast), background var(--transition-fast), transform var(--transition-fast), box-shadow var(--transition-fast);
    }

    .criteria-item:hover {
      border-color: rgba(247, 183, 51, 0.55);
      transform: translateY(-1px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
    }

    .criteria-item input {
      margin-top: 2px;
    }

    .criteria-label-main {
      font-size: 11px;
      font-weight: 500;
      color: var(--text);
    }

    .criteria-label-sub {
      font-size: 10px;
      color: var(--muted);
      margin-top: 1px;
    }

    .criteria-weight {
      margin-left: auto;
      font-size: 10px;
      white-space: nowrap;
      color: var(--accent-strong);
      background: rgba(247, 183, 51, 0.09);
      border-radius: 999px;
      padding: 2px 5px;
    }

    .btn-primary {
      border: none;
      outline: none;
      cursor: pointer;
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      color: #20130a;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      padding: 7px 14px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 12px 26px rgba(247, 183, 51, 0.45);
      transition: transform var(--transition-fast), box-shadow var(--transition-fast), filter var(--transition-fast);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 36px rgba(247, 183, 51, 0.5);
      filter: brightness(1.03);
    }

    .btn-secondary {
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: rgba(10, 10, 18, 0.96);
      color: var(--text-soft);
      font-size: 11px;
      padding: 6px 10px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: background var(--transition-fast), transform var(--transition-fast), box-shadow var(--transition-fast), border var(--transition-fast);
    }

    .btn-secondary:hover {
      background: rgba(30, 30, 46, 0.95);
      border-color: rgba(247, 183, 51, 0.25);
      transform: translateY(-0.5px);
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.5);
    }

    .left-footer-buttons {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      margin-top: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .left-footer-buttons > div {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    /* Right panel */
    .right-grid {
      display: grid;
      grid-template-rows: auto auto auto;
      gap: 12px;
    }

    .dash-top {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 8px;
    }

    .metric-card {
      background: linear-gradient(135deg, rgba(11, 11, 20, 0.96), rgba(17, 17, 29, 0.96));
      border-radius: var(--radius-md);
      border: 1px solid rgba(255, 255, 255, 0.03);
      padding: 10px 11px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .metric-label {
      font-size: 11px;
      color: var(--muted);
    }

    .metric-main {
      font-size: 16px;
      font-weight: 600;
      color: var(--text);
    }

    .metric-sub {
      font-size: 11px;
      color: var(--muted);
    }

    .metric-highlight {
      color: var(--accent-strong);
    }

    .dash-middle {
      display: grid;
      grid-template-columns: minmax(0, 0.9fr) minmax(0, 0.9fr) minmax(0, 0.9fr);
      gap: 10px;
    }

    .chart-container {
      position: relative;
      height: 220px;
    }

    .dash-bottom {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
      gap: 10px;
    }

    .coach-text {
      font-size: 12px;
      line-height: 1.4;
      color: var(--text-soft);
      white-space: pre-line;
    }

    /* Weekly monthly stats bar */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      margin-top: 6px;
    }

    .stats-box {
      background: rgba(14, 14, 24, 0.96);
      border-radius: 12px;
      padding: 8px 10px;
      border: 1px solid rgba(255, 255, 255, 0.03);
      font-size: 11px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .stats-label {
      color: var(--muted);
    }

    .stats-main {
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
    }

    .stats-sub {
      color: var(--muted);
    }

    /* Trade log */
    .log-card {
      margin-top: 12px;
    }

    .log-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      gap: 8px;
      flex-wrap: wrap;
    }

    .log-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .filter-pill {
      background: rgba(10, 10, 18, 0.96);
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      padding: 4px 7px;
      font-size: 11px;
      display: flex;
      align-items: center;
      gap: 4px;
      color: var(--text-soft);
    }

    .filter-pill select,
    .filter-pill input {
      background: transparent;
      border: none;
      outline: none;
      color: var(--text-soft);
      font-size: 11px;
      min-width: 60px;
    }

    .filter-pill input[type="date"] {
      color-scheme: dark;
    }

    .log-table-wrapper {
      max-height: 260px;
      overflow: auto;
      border-radius: 10px;
      border: 1px solid rgba(32, 32, 52, 0.9);
      background: rgba(4, 4, 10, 0.94);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
      min-width: 720px;
    }

    thead {
      position: sticky;
      top: 0;
      z-index: 2;
      background: rgba(8, 8, 16, 0.96);
    }

    th,
    td {
      padding: 6px 7px;
      text-align: left;
      border-bottom: 1px solid rgba(24, 24, 36, 0.9);
      white-space: nowrap;
    }

    th {
      font-weight: 500;
      color: var(--muted);
    }

    tbody tr:nth-child(even) {
      background: rgba(12, 12, 22, 0.65);
    }

    .tag {
      border-radius: 999px;
      padding: 2px 6px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 10px;
      border: 1px solid transparent;
    }

    .tag-low {
      color: #ff7676;
      border-color: rgba(255, 118, 118, 0.4);
      background: rgba(255, 118, 118, 0.08);
    }

    .tag-medium {
      color: #ffd66b;
      border-color: rgba(255, 214, 107, 0.4);
      background: rgba(255, 214, 107, 0.08);
    }

    .tag-high {
      color: #7df7a0;
      border-color: rgba(125, 247, 160, 0.4);
      background: rgba(125, 247, 160, 0.08);
    }

    .tag-session {
      color: var(--accent-strong);
      border-color: rgba(247, 183, 51, 0.5);
      background: rgba(247, 183, 51, 0.05);
    }

    .pnl-positive {
      color: var(--success);
    }

    .pnl-negative {
      color: var(--danger);
    }

    .score-pill {
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      font-size: 10px;
      background: rgba(16, 16, 28, 0.98);
    }

    /* Calendar */
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 4px;
      font-size: 10px;
      margin-top: 6px;
    }

    .calendar-header-row {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      font-size: 10px;
      color: var(--muted);
      margin-bottom: 3px;
    }

    .calendar-header-cell {
      text-align: center;
    }

    .calendar-day {
      min-height: 54px;
      border-radius: 8px;
      padding: 3px 4px;
      background: rgba(12, 12, 22, 0.96);
      border: 1px solid rgba(32, 32, 48, 0.9);
      display: flex;
      flex-direction: column;
      gap: 1px;
    }

    .calendar-day-muted {
      opacity: 0.35;
    }

    .calendar-day-date {
      font-size: 10px;
      color: var(--muted);
    }

    .calendar-day-pnl {
      font-size: 11px;
      font-weight: 600;
    }

    .calendar-day-count {
      font-size: 10px;
      color: var(--muted);
    }

    .calendar-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      margin-top: 4px;
    }

    .calendar-controls span {
      font-size: 11px;
      color: var(--muted);
    }

    .calendar-controls button {
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: rgba(6, 6, 14, 0.98);
      color: var(--text-soft);
      font-size: 10px;
      padding: 2px 8px;
      cursor: pointer;
    }

    /* Broker sync */
    .broker-card-body {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1fr);
      gap: 10px;
      font-size: 11px;
    }

    .broker-section-title {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-soft);
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .broker-note {
      color: var(--muted);
      font-size: 11px;
      line-height: 1.5;
    }

    .broker-code {
      margin-top: 4px;
      background: rgba(10, 10, 18, 0.96);
      border-radius: 8px;
      border: 1px solid var(--border-soft);
      padding: 6px 8px;
      font-family: "JetBrains Mono", monospace;
      font-size: 10px;
      color: var(--text-soft);
      max-height: 120px;
      overflow: auto;
      white-space: pre;
    }

    /* Export buttons */
    .export-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .export-btn {
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: rgba(10, 10, 18, 0.96);
      color: var(--text-soft);
      font-size: 10px;
      padding: 4px 8px;
      cursor: pointer;
      transition: background var(--transition-fast), transform var(--transition-fast), border var(--transition-fast);
    }

    .export-btn:hover {
      background: rgba(30, 30, 46, 0.96);
      border-color: rgba(247, 183, 51, 0.25);
      transform: translateY(-0.5px);
    }

    /* Responsive */
    @media (max-width: 1020px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
      .right-grid {
        order: -1;
      }
    }

    @media (max-width: 720px) {
      header.app-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .dash-top {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      .dash-middle {
        grid-template-columns: minmax(0, 1fr);
      }
      .dash-bottom {
        grid-template-columns: minmax(0, 1fr);
      }
      .broker-card-body {
        grid-template-columns: minmax(0, 1fr);
      }
      .log-table-wrapper {
        max-height: 220px;
      }
    }
  </style>
</head>

<body>
  <div class="app-shell">
    <header class="app-header">
      <div class="brand">
        <div class="brand-title">
          Ali's Trading System
          <span class="brand-chip">Black &amp; Gold Edge</span>
        </div>
        <div class="brand-subtitle">
          Probabilities • Discipline • R &amp; PnL • Web-based execution journal
        </div>
      </div>
      <div class="top-actions">
        <span class="pill">
          <span class="pill-dot"></span>
          Local session
        </span>
        <span class="pill pill-button" id="installAppBtn">Install app</span>
        <button class="pill pill-button pill-lock" id="lockBtn">
          <span>Lock</span>
        </button>
      </div>
    </header>

    <main class="layout">
      <!-- LEFT PANEL -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">New trade</div>
            <div class="card-meta" id="autosaveStatus">Last autosave: –</div>
          </div>
          <button class="chip chip-gold" id="brokerSyncShortcut">Broker sync / import</button>
        </div>

        <div class="card-body">
          <!-- ACCOUNT -->
          <div class="field-row">
            <div class="field">
              <label>Account • Starting balance</label>
              <input type="number" id="startingBalanceInput" placeholder="e.g. 2000" />
            </div>
            <div class="field">
              <label>Current balance</label>
              <input type="text" id="currentBalanceDisplay" disabled />
            </div>
          </div>

          <!-- NEW TRADE -->
          <div class="field-row">
            <div class="field">
              <label>Date</label>
              <input type="date" id="dateInput" />
            </div>
            <div class="field">
              <label>Pair</label>
              <input type="text" id="pairInput" placeholder="e.g. GBPUSD" />
            </div>
          </div>

          <div class="field-row">
            <div class="field">
              <label>Direction</label>
              <select id="directionInput">
                <option value="">Select</option>
                <option>Buy</option>
                <option>Sell</option>
              </select>
            </div>
            <div class="field">
              <label>Setup / Strategy</label>
              <select id="setupInput">
                <option value="">Select</option>
                <option>Breakout with momentum</option>
                <option>Flip entry</option>
                <option>Pullback continuation</option>
                <option>Range breakout</option>
                <option>Liquidity sweep &amp; reclaim</option>
                <option>News breakout</option>
              </select>
            </div>
          </div>

          <div class="field-row">
            <div class="field">
              <label>Risk per trade (money)</label>
              <input type="number" id="riskMoneyInput" placeholder="e.g. 50" />
            </div>
            <div class="field">
              <label>R:R planned</label>
              <input type="number" step="0.1" id="rrPlannedInput" placeholder="e.g. 2.5" />
            </div>
          </div>

          <div class="field-row">
            <div class="field">
              <label>R realized</label>
              <input type="number" step="0.1" id="rRealizedInput" placeholder="e.g. 1.8 or -1" />
            </div>
            <div class="field">
              <label>Session</label>
              <select id="sessionInput">
                <option value="">Select</option>
                <option>London</option>
                <option>New York</option>
                <option>Asia</option>
                <option>London + NY overlap</option>
              </select>
            </div>
          </div>

          <div class="field-row">
            <div class="field">
              <label>Emotion tag</label>
              <select id="emotionInput">
                <option value="">Select</option>
                <option>Calm</option>
                <option>Disciplined</option>
                <option>Confident</option>
                <option>Neutral</option>
                <option>FOMO</option>
                <option>Fearful</option>
                <option>Revenge</option>
                <option>Overtrade</option>
              </select>
            </div>
            <div class="field">
              <label>Screenshot / chart link</label>
              <input type="text" id="screenshotInput" placeholder="Paste TradingView / chart link" />
            </div>
          </div>

          <div class="field-row">
            <div class="field">
              <label>Tags (comma-separated)</label>
              <input type="text" id="tagsInput" placeholder="e.g. London open, A+, news fade" />
            </div>
            <div class="field">
              <label>Timeframe</label>
              <input type="text" id="timeframeInput" placeholder="e.g. 4H/M15" />
            </div>
          </div>

          <div class="field">
            <label>Journal notes</label>
            <textarea id="journalInput" placeholder="What did you do well? What can you improve?"></textarea>
          </div>

          <!-- CHECKLIST -->
          <div class="field">
            <label>Breakout / candle criteria (weighted). Tick only what was actually met.</label>
            <div class="criteria-grid" id="criteriaGrid">
              <!-- One item per rule -->
              <label class="criteria-item">
                <input type="checkbox" data-weight="2" />
                <div>
                  <div class="criteria-label-main">Clean close at level</div>
                  <div class="criteria-label-sub">No big wicks both sides • weight 2</div>
                </div>
                <span class="criteria-weight">+2 pts</span>
              </label>

              <label class="criteria-item">
                <input type="checkbox" data-weight="2" />
                <div>
                  <div class="criteria-label-main">No long wick against direction</div>
                  <div class="criteria-label-sub">Wick profile matches bias • weight 2</div>
                </div>
                <span class="criteria-weight">+2 pts</span>
              </label>

              <label class="criteria-item">
                <input type="checkbox" data-weight="1" />
                <div>
                  <div class="criteria-label-main">Structure matches plan</div>
                  <div class="criteria-label-sub">Story + higher TF aligned • weight 1</div>
                </div>
                <span class="criteria-weight">+1 pt</span>
              </label>

              <label class="criteria-item">
                <input type="checkbox" data-weight="1" />
                <div>
                  <div class="criteria-label-main">Not after huge candle</div>
                  <div class="criteria-label-sub">Avoid chasing exhaustion move • weight 1</div>
                </div>
                <span class="criteria-weight">+1 pt</span>
              </label>

              <label class="criteria-item">
                <input type="checkbox" data-weight="2" />
                <div>
                  <div class="criteria-label-main">No flat / no-wick close</div>
                  <div class="criteria-label-sub">Entry candle prints wick first then flips • weight 2</div>
                </div>
                <span class="criteria-weight">+2 pts</span>
              </label>

              <label class="criteria-item">
                <input type="checkbox" data-weight="2" />
                <div>
                  <div class="criteria-label-main">Wick first, then flip entry</div>
                  <div class="criteria-label-sub">Classic flip behaviour • weight 2</div>
                </div>
                <span class="criteria-weight">+2 pts</span>
              </label>

              <label class="criteria-item">
                <input type="checkbox" data-weight="1" />
                <div>
                  <div class="criteria-label-main">Session aligned with edge</div>
                  <div class="criteria-label-sub">London open, NY reversal, etc. • weight 1</div>
                </div>
                <span class="criteria-weight">+1 pt</span>
              </label>

              <label class="criteria-item">
                <input type="checkbox" data-weight="1" />
                <div>
                  <div class="criteria-label-main">RR realistic for setup</div>
                  <div class="criteria-label-sub">Not forcing 1:10 randomly • weight 1</div>
                </div>
                <span class="criteria-weight">+1 pt</span>
              </label>
            </div>
          </div>

          <!-- Buttons -->
          <div class="left-footer-buttons">
            <div>
              <button class="btn-primary" id="addTradeBtn">
                <span>+ Add trade to log</span>
              </button>
              <button class="btn-secondary" id="clearFormBtn">Clear form</button>
            </div>
            <div>
              <button class="btn-secondary export-btn" id="exportJsonBtn">Export JSON</button>
              <button class="btn-secondary export-btn" id="exportCsvBtn">Export CSV</button>
              <button class="btn-secondary export-btn" id="importJsonBtn">Import JSON</button>
            </div>
          </div>
        </div>
      </section>

      <!-- RIGHT PANEL -->
      <section class="right-grid">
        <!-- DASHBOARD TOP -->
        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Dashboard</div>
              <div class="card-meta">Live performance breakdown: probability, PnL, behaviour tracking.</div>
            </div>
            <span class="chip">Auto-updated from left panel</span>
          </div>
          <div class="card-body">
            <div class="dash-top">
              <div class="metric-card">
                <div class="metric-label">Win rate</div>
                <div class="metric-main" id="winRateDisplay">0.0%</div>
                <div class="metric-sub"><span id="tradeCountDisplay">0</span> trades</div>
              </div>
              <div class="metric-card">
                <div class="metric-label">Avg R (realized)</div>
                <div class="metric-main" id="avgRDisplay">0.00R</div>
                <div class="metric-sub">
                  Equity: <span class="metric-highlight" id="equityDisplay">0.00R</span>
                </div>
              </div>
              <div class="metric-card">
                <div class="metric-label">Discipline score</div>
                <div class="metric-main" id="disciplineScoreDisplay">0</div>
                <div class="metric-sub">Checklist &amp; behaviour (0-100)</div>
              </div>
              <div class="metric-card">
                <div class="metric-label">Total PnL &amp; balance</div>
                <div class="metric-main">
                  <span id="totalRDisplay">0.00R</span>
                  •
                  <span id="totalMoneyDisplay">0.00</span>
                </div>
                <div class="metric-sub">
                  Balance: <span class="metric-highlight" id="balanceDisplay">0.00</span>
                </div>
              </div>
            </div>

            <div class="dash-middle">
              <div class="card chart-card">
                <div class="card-header">
                  <div class="card-title">High vs medium vs low probability</div>
                  <div class="card-meta"><span id="probabilitySummaryLabel">0 high • 0 medium • 0 low</span></div>
                </div>
                <div class="chart-container">
                  <canvas id="probabilityPie"></canvas>
                </div>
              </div>

              <div class="card chart-card">
                <div class="card-header">
                  <div class="card-title">Equity curve (R)</div>
                  <div class="card-meta"><span id="equityTotalLabel">0.00R total</span></div>
                </div>
                <div class="chart-container">
                  <canvas id="equityChart"></canvas>
                </div>
              </div>

              <div class="card chart-card">
                <div class="card-header">
                  <div class="card-title">Probability history</div>
                  <div class="card-meta">1 = Low • 2 = Medium • 3 = High</div>
                </div>
                <div class="chart-container">
                  <canvas id="probHistoryChart"></canvas>
                </div>
              </div>
            </div>

            <div class="dash-bottom">
              <div>
                <div class="stats-row">
                  <div class="stats-box">
                    <div class="stats-label">Last 7 days</div>
                    <div class="stats-main" id="stats7dWinRate">0.0% win</div>
                    <div class="stats-sub" id="stats7dR">0.00R • 0.00 money</div>
                  </div>
                  <div class="stats-box">
                    <div class="stats-label">Last 30 days</div>
                    <div class="stats-main" id="stats30dWinRate">0.0% win</div>
                    <div class="stats-sub" id="stats30dR">0.00R • 0.00 money</div>
                  </div>
                </div>

                <div class="card coach-card" style="margin-top:8px;">
                  <div class="card-header">
                    <div class="card-title">Coach's feedback</div>
                    <div class="card-meta">AI-style summary of probability, discipline and emotional tags.</div>
                  </div>
                  <div class="coach-text" id="coachFeedback">
                    No trades logged yet. Use the checklist and emotion tags every time to build consistent data. The more structured the journal, the sharper your edge.
                  </div>
                </div>
              </div>

              <div class="card">
                <div class="card-header">
                  <div>
                    <div class="card-title">Calendar view</div>
                    <div class="card-meta">PnL and trade count by day.</div>
                  </div>
                </div>
                <div class="calendar-controls">
                  <button id="prevMonthBtn">&laquo; Prev</button>
                  <span id="calendarMonthLabel">Month</span>
                  <button id="nextMonthBtn">Next &raquo;</button>
                </div>
                <div class="calendar-header-row">
                  <div class="calendar-header-cell">Mon</div>
                  <div class="calendar-header-cell">Tue</div>
                  <div class="calendar-header-cell">Wed</div>
                  <div class="calendar-header-cell">Thu</div>
                  <div class="calendar-header-cell">Fri</div>
                  <div class="calendar-header-cell">Sat</div>
                  <div class="calendar-header-cell">Sun</div>
                </div>
                <div class="calendar-grid" id="calendarGrid"></div>
              </div>
            </div>
          </div>
        </section>

        <!-- BROKER SYNC / EXPORTS / LOG -->
        <section class="card log-card">
          <div class="card-header log-header-row">
            <div>
              <div class="card-title">Trade log &amp; broker sync</div>
              <div class="card-meta">Filter by setup, session, probability, emotion, pair, date range.</div>
            </div>
            <div class="export-row">
              <button class="export-btn" id="exportExcelBtn">Export Excel (styled)</button>
              <button class="export-btn" id="clearAllBtn">Clear all data</button>
            </div>
          </div>

          <div class="card-body">
            <div class="log-filters">
              <div class="filter-pill">
                Setup
                <select id="filterSetup">
                  <option value="">All</option>
                  <option>Breakout with momentum</option>
                  <option>Flip entry</option>
                  <option>Pullback continuation</option>
                  <option>Range breakout</option>
                  <option>Liquidity sweep &amp; reclaim</option>
                  <option>News breakout</option>
                </select>
              </div>
              <div class="filter-pill">
                Session
                <select id="filterSession">
                  <option value="">All</option>
                  <option>London</option>
                  <option>New York</option>
                  <option>Asia</option>
                  <option>London + NY overlap</option>
                </select>
              </div>
              <div class="filter-pill">
                Probability
                <select id="filterProb">
                  <option value="">All</option>
                  <option>High</option>
                  <option>Medium</option>
                  <option>Low</option>
                </select>
              </div>
              <div class="filter-pill">
                Emotion
                <select id="filterEmotion">
                  <option value="">All</option>
                  <option>Calm</option>
                  <option>Disciplined</option>
                  <option>Confident</option>
                  <option>Neutral</option>
                  <option>FOMO</option>
                  <option>Fearful</option>
                  <option>Revenge</option>
                  <option>Overtrade</option>
                </select>
              </div>
              <div class="filter-pill">
                Pair
                <input type="text" id="filterPair" placeholder="e.g. GU" />
              </div>
              <div class="filter-pill">
                From
                <input type="date" id="filterFrom" />
              </div>
              <div class="filter-pill">
                To
                <input type="date" id="filterTo" />
              </div>
              <button class="export-btn" id="clearFiltersBtn">Clear filters</button>
            </div>

            <div class="log-table-wrapper" id="logTableWrapper">
              <table>
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Date</th>
                    <th>Pair</th>
                    <th>Dir</th>
                    <th>Setup</th>
                    <th>Prob</th>
                    <th>Score</th>
                    <th>R planned</th>
                    <th>R realized</th>
                    <th>PnL (R)</th>
                    <th>PnL</th>
                    <th>Balance</th>
                    <th>Session</th>
                    <th>Emotion</th>
                    <th>Tags</th>
                  </tr>
                </thead>
                <tbody id="logTableBody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- BROKER SYNC CARD -->
        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Broker sync</div>
              <div class="card-meta">Import from FTMO / MT5 / cTrader / TradeLocker. API-ready.</div>
            </div>
            <span class="chip chip-gold">Client-side • No credentials stored</span>
          </div>

          <div class="card-body broker-card-body">
            <div>
              <div class="broker-section-title">CSV import (recommended)</div>
              <p class="broker-note">
                Export your trades as CSV from your broker / FTMO dashboard, then import here.
                <br /><br />
                Expected columns (header row required):
                <strong>Date, Pair, Direction, RRealized, RiskMoney, Session</strong><br />
                Dates will be parsed as YYYY-MM-DD. RRealized can be 1.8, -1, etc.
              </p>
              <div style="margin-top:6px; display:flex; align-items:center; gap:6px;">
                <input type="file" id="brokerCsvInput" accept=".csv" />
                <button class="btn-secondary" id="brokerCsvExampleBtn">Sample mapping</button>
              </div>
            </div>

            <div>
              <div class="broker-section-title">API sync (advanced)</div>
              <p class="broker-note">
                To sync MT4/5, cTrader or your prop firm's REST API, you can build a tiny serverless
                function (e.g. Cloudflare Workers, Vercel, Netlify) that talks to the broker, then this
                dashboard calls <strong>your</strong> endpoint.
              </p>
              <div class="field" style="margin-top:4px;">
                <label>API endpoint (serverless function URL)</label>
                <input type="text" id="apiUrlInput" placeholder="https://your-worker.yourdomain.com/sync" />
              </div>
              <div class="field-row">
                <div class="field">
                  <label>API key (optional)</label>
                  <input type="password" id="apiKeyInput" placeholder="Sent as Authorization header" />
                </div>
                <div class="field">
                  <label>&nbsp;</label>
                  <button class="btn-secondary" id="apiSyncBtn">Sync now (demo)</button>
                </div>
              </div>
              <div class="broker-code" id="brokerCodeSnippet">
fetch("https://your-worker.yourdomain.com/sync", {
  method: "POST",
  headers: {
    "Content-Type": "application/json",
    "Authorization": "Bearer YOUR_API_KEY"
  },
  body: JSON.stringify({ accountId: "YOUR_ACCOUNT_ID" })
});</div>
            </div>
          </div>
        </section>
      </section>
    </main>
  </div>

  <script>
    // ------- STATE -------
    const STORAGE_KEY = "ali_trading_dashboard_v3";

    const state = {
      startingBalance: 0,
      trades: [],
      locked: false,
      calendarMonth: (() => {
        const d = new Date();
        return new Date(d.getFullYear(), d.getMonth(), 1);
      })(),
    };

    // ------- DOM HELPERS -------
    const $ = (id) => document.getElementById(id);

    // Inputs
    const startingBalanceInput = $("startingBalanceInput");
    const currentBalanceDisplay = $("currentBalanceDisplay");
    const dateInput = $("dateInput");
    const pairInput = $("pairInput");
    const directionInput = $("directionInput");
    const setupInput = $("setupInput");
    const riskMoneyInput = $("riskMoneyInput");
    const rrPlannedInput = $("rrPlannedInput");
    const rRealizedInput = $("rRealizedInput");
    const sessionInput = $("sessionInput");
    const emotionInput = $("emotionInput");
    const screenshotInput = $("screenshotInput");
    const tagsInput = $("tagsInput");
    const timeframeInput = $("timeframeInput");
    const journalInput = $("journalInput");
    const criteriaGrid = $("criteriaGrid");
    const autosaveStatus = $("autosaveStatus");

    // Dashboard metrics
    const winRateDisplay = $("winRateDisplay");
    const tradeCountDisplay = $("tradeCountDisplay");
    const avgRDisplay = $("avgRDisplay");
    const equityDisplay = $("equityDisplay");
    const disciplineScoreDisplay = $("disciplineScoreDisplay");
    const totalRDisplay = $("totalRDisplay");
    const totalMoneyDisplay = $("totalMoneyDisplay");
    const balanceDisplay = $("balanceDisplay");
    const stats7dWinRate = $("stats7dWinRate");
    const stats7dR = $("stats7dR");
    const stats30dWinRate = $("stats30dWinRate");
    const stats30dR = $("stats30dR");
    const coachFeedback = $("coachFeedback");
    const probabilitySummaryLabel = $("probabilitySummaryLabel");
    const equityTotalLabel = $("equityTotalLabel");
    const calendarMonthLabel = $("calendarMonthLabel");
    const calendarGrid = $("calendarGrid");

    // Filters
    const filterSetup = $("filterSetup");
    const filterSession = $("filterSession");
    const filterProb = $("filterProb");
    const filterEmotion = $("filterEmotion");
    const filterPair = $("filterPair");
    const filterFrom = $("filterFrom");
    const filterTo = $("filterTo");
    const logTableBody = $("logTableBody");

    // Buttons
    const addTradeBtn = $("addTradeBtn");
    const clearFormBtn = $("clearFormBtn");
    const exportJsonBtn = $("exportJsonBtn");
    const exportCsvBtn = $("exportCsvBtn");
    const importJsonBtn = $("importJsonBtn");
    const exportExcelBtn = $("exportExcelBtn");
    const clearAllBtn = $("clearAllBtn");
    const clearFiltersBtn = $("clearFiltersBtn");
    const prevMonthBtn = $("prevMonthBtn");
    const nextMonthBtn = $("nextMonthBtn");
    const brokerCsvInput = $("brokerCsvInput");
    const brokerCsvExampleBtn = $("brokerCsvExampleBtn");
    const apiSyncBtn = $("apiSyncBtn");
    const lockBtn = $("lockBtn");
    const brokerSyncShortcut = $("brokerSyncShortcut");
    const installAppBtn = $("installAppBtn");

    // Charts
    let probabilityPie, equityChart, probHistoryChart;

    // ------- LOCAL STORAGE -------
    function saveState() {
      try {
        localStorage.setItem(
          STORAGE_KEY,
          JSON.stringify({
            startingBalance: state.startingBalance,
            trades: state.trades,
            locked: state.locked,
            calendarMonth: state.calendarMonth.toISOString(),
          })
        );
        autosaveStatus.textContent =
          "Last autosave: " + new Date().toLocaleTimeString();
      } catch (e) {
        console.error("Failed to save", e);
      }
    }

    function loadState() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      try {
        const data = JSON.parse(raw);
        state.startingBalance = data.startingBalance || 0;
        state.trades = Array.isArray(data.trades) ? data.trades : [];
        state.locked = !!data.locked;
        if (data.calendarMonth) {
          state.calendarMonth = new Date(data.calendarMonth);
        }
      } catch (e) {
        console.error("Failed to load", e);
      }
    }

    // ------- HELPERS -------
    function parseNumber(val) {
      const n = parseFloat(val);
      return isNaN(n) ? 0 : n;
    }

    function formatMoney(n) {
      return (n >= 0 ? "" : "-") + Math.abs(n).toFixed(2);
    }

    function formatR(n) {
      const sign = n >= 0 ? "" : "-";
      return sign + Math.abs(n).toFixed(2) + "R";
    }

    function probabilityFromScore(score) {
      if (score >= 80) return "High";
      if (score >= 60) return "Medium";
      return "Low";
    }

    function probabilityNumeric(label) {
      if (label === "High") return 3;
      if (label === "Medium") return 2;
      return 1;
    }

    function computeChecklistScore(criteriaFlags) {
      const weights = criteriaFlags.map((c) => c.weight);
      const max = weights.reduce((a, b) => a + b, 0);
      const checked = criteriaFlags
        .filter((c) => c.checked)
        .map((c) => c.weight)
        .reduce((a, b) => a + b, 0);
      const pct = max ? (checked / max) * 100 : 0;
      return { raw: checked, max, pct };
    }

    function computeDisciplineScore(probLabel, emotion, checklistPct) {
      let base = checklistPct; // 0-100
      // Emotion modifiers
      if (emotion === "Calm" || emotion === "Disciplined") base += 10;
      if (emotion === "Confident") base += 5;
      if (emotion === "Neutral") base += 0;
      if (emotion === "FOMO" || emotion === "Fearful") base -= 10;
      if (emotion === "Revenge" || emotion === "Overtrade") base -= 20;

      // Probability influence
      if (probLabel === "High") base += 5;
      if (probLabel === "Low") base -= 5;

      return Math.max(0, Math.min(100, Math.round(base)));
    }

    function getFilteredTrades() {
      const setup = filterSetup.value || "";
      const session = filterSession.value || "";
      const prob = filterProb.value || "";
      const emotion = filterEmotion.value || "";
      const pairFilter = (filterPair.value || "").trim().toUpperCase();
      const fromDate = filterFrom.value ? new Date(filterFrom.value) : null;
      const toDate = filterTo.value ? new Date(filterTo.value) : null;

      return state.trades.filter((t) => {
        if (setup && t.setup !== setup) return false;
        if (session && t.session !== session) return false;
        if (prob && t.probability !== prob) return false;
        if (emotion && t.emotion !== emotion) return false;
        if (pairFilter && !t.pair.toUpperCase().includes(pairFilter)) return false;

        if (fromDate || toDate) {
          const d = new Date(t.date);
          if (fromDate && d < fromDate) return false;
          if (toDate && d > toDate) return false;
        }
        return true;
      });
    }

    // ------- RENDERING -------
    function recalcBalancesAndMetrics() {
      // Starting balance
      startingBalanceInput.value =
        state.startingBalance > 0 ? state.startingBalance : "";
      let balance = state.startingBalance || 0;
      let wins = 0;
      let totalR = 0;
      let totalMoney = 0;

      state.trades.forEach((t) => {
        totalR += t.pnlR;
        totalMoney += t.pnlMoney;
        balance += t.pnlMoney;
        t.balanceAfter = balance;
        if (t.pnlR > 0) wins++;
      });

      currentBalanceDisplay.value = formatMoney(balance);
      balanceDisplay.textContent = formatMoney(balance);
      totalRDisplay.textContent = formatR(totalR);
      totalMoneyDisplay.textContent = formatMoney(totalMoney);
      tradeCountDisplay.textContent = state.trades.length;
      winRateDisplay.textContent =
        state.trades.length > 0
          ? ((wins / state.trades.length) * 100).toFixed(1) + "%"
          : "0.0%";
      avgRDisplay.textContent =
        state.trades.length > 0
          ? formatR(totalR / state.trades.length)
          : "0.00R";
      equityDisplay.textContent = formatR(totalR);

      equityTotalLabel.textContent = formatR(totalR) + " total";

      // Global discipline: average
      const avgDiscipline =
        state.trades.length > 0
          ? Math.round(
              state.trades.reduce((sum, t) => sum + (t.disciplineScore || 0), 0) /
                state.trades.length
            )
          : 0;
      disciplineScoreDisplay.textContent = avgDiscipline;

      // Weekly / monthly stats
      const now = new Date();
      const days7 = new Date(now);
      days7.setDate(now.getDate() - 7);
      const days30 = new Date(now);
      days30.setDate(now.getDate() - 30);

      function computePeriodStats(fromDate) {
        const trades = state.trades.filter(
          (t) => new Date(t.date) >= fromDate && new Date(t.date) <= now
        );
        if (!trades.length)
          return { winRate: 0, r: 0, money: 0, trades: 0, wins: 0 };
        let r = 0,
          money = 0,
          wins = 0;
        trades.forEach((t) => {
          r += t.pnlR;
          money += t.pnlMoney;
          if (t.pnlR > 0) wins++;
        });
        const winRate = (wins / trades.length) * 100;
        return { winRate, r, money, trades: trades.length, wins };
      }

      const s7 = computePeriodStats(days7);
      const s30 = computePeriodStats(days30);

      stats7dWinRate.textContent = s7.trades
        ? s7.winRate.toFixed(1) + "% win"
        : "0.0% win";
      stats7dR.textContent =
        formatR(s7.r) + " • " + formatMoney(s7.money) + " money";

      stats30dWinRate.textContent = s30.trades
        ? s30.winRate.toFixed(1) + "% win"
        : "0.0% win";
      stats30dR.textContent =
        formatR(s30.r) + " • " + formatMoney(s30.money) + " money";

      // Probability distribution
      let high = 0,
        med = 0,
        low = 0;
      state.trades.forEach((t) => {
        if (t.probability === "High") high++;
        else if (t.probability === "Medium") med++;
        else low++;
      });
      probabilitySummaryLabel.textContent =
        high + " high • " + med + " medium • " + low + " low";

      // Charts
      updateCharts();

      // Calendar
      renderCalendar();

      // Coach feedback
      renderCoachFeedback();

      // Trade log
      renderTradeLog();

      saveState();
    }

    function renderTradeLog() {
      const trades = getFilteredTrades();
      logTableBody.innerHTML = "";
      trades.forEach((t, idx) => {
        const tr = document.createElement("tr");

        function td(text, className) {
          const cell = document.createElement("td");
          cell.textContent = text;
          if (className) cell.className = className;
          tr.appendChild(cell);
        }

        td(String(idx + 1));
        td(t.date);
        td(t.pair);
        td(t.direction);
        td(t.setup);

        const probTd = document.createElement("td");
        const span = document.createElement("span");
        span.className =
          "tag " +
          (t.probability === "High"
            ? "tag-high"
            : t.probability === "Medium"
            ? "tag-medium"
            : "tag-low");
        span.textContent = t.probability;
        probTd.appendChild(span);
        tr.appendChild(probTd);

        const scoreTd = document.createElement("td");
        const scoreSpan = document.createElement("span");
        scoreSpan.className = "score-pill";
        scoreSpan.textContent = t.score + "/100";
        scoreTd.appendChild(scoreSpan);
        tr.appendChild(scoreTd);

        td(t.rrPlanned.toFixed(2));
        td(t.rRealized.toFixed(2));

        const pnlRTd = document.createElement("td");
        pnlRTd.textContent = t.pnlR.toFixed(2);
        pnlRTd.className = t.pnlR >= 0 ? "pnl-positive" : "pnl-negative";
        tr.appendChild(pnlRTd);

        const pnlMoneyTd = document.createElement("td");
        pnlMoneyTd.textContent = formatMoney(t.pnlMoney);
        pnlMoneyTd.className = t.pnlMoney >= 0 ? "pnl-positive" : "pnl-negative";
        tr.appendChild(pnlMoneyTd);

        td(formatMoney(t.balanceAfter));

        const sessionTd = document.createElement("td");
        const sessionSpan = document.createElement("span");
        sessionSpan.className = "tag tag-session";
        sessionSpan.textContent = t.session || "-";
        sessionTd.appendChild(sessionSpan);
        tr.appendChild(sessionTd);

        td(t.emotion || "-");
        td(t.tags || "-");

        logTableBody.appendChild(tr);
      });
    }

    function updateCharts() {
      const labels = state.trades.map((t, i) => "#" + (i + 1));

      // Probability pie
      let high = 0,
        med = 0,
        low = 0;
      state.trades.forEach((t) => {
        if (t.probability === "High") high++;
        else if (t.probability === "Medium") med++;
        else low++;
      });

      const pieData = [high, med, low];
      if (!probabilityPie) {
        probabilityPie = new Chart($("probabilityPie"), {
          type: "doughnut",
          data: {
            labels: ["High", "Medium", "Low"],
            datasets: [
              {
                data: pieData,
                backgroundColor: ["#7df7a0", "#ffd66b", "#ff7676"],
                borderWidth: 0,
              },
            ],
          },
          options: {
            plugins: { legend: { display: true, labels: { color: "#c7c9f0", boxWidth: 10 } } },
            cutout: "60%",
          },
        });
      } else {
        probabilityPie.data.datasets[0].data = pieData;
        probabilityPie.update();
      }

      // Equity curve
      let cumulative = 0;
      const equityData = state.trades.map((t) => {
        cumulative += t.pnlR;
        return cumulative;
      });

      if (!equityChart) {
        equityChart = new Chart($("equityChart"), {
          type: "line",
          data: {
            labels,
            datasets: [
              {
                label: "Equity (R)",
                data: equityData,
                tension: 0.25,
                borderColor: "#f7b733",
                backgroundColor: "rgba(247, 183, 51, 0.1)",
                fill: true,
                pointRadius: 2,
              },
            ],
          },
          options: {
            plugins: { legend: { display: false } },
            scales: {
              x: {
                ticks: { color: "#8f92be", maxRotation: 0 },
                grid: { display: false },
              },
              y: {
                ticks: { color: "#8f92be" },
                grid: { color: "rgba(90,90,120,0.3)" },
              },
            },
          },
        });
      } else {
        equityChart.data.labels = labels;
        equityChart.data.datasets[0].data = equityData;
        equityChart.update();
      }

      // Probability history (1-3)
      const probData = state.trades.map((t) =>
        probabilityNumeric(t.probability)
      );

      if (!probHistoryChart) {
        probHistoryChart = new Chart($("probHistoryChart"), {
          type: "line",
          data: {
            labels,
            datasets: [
              {
                label: "Probability level",
                data: probData,
                borderColor: "#7df7a0",
                backgroundColor: "rgba(125,247,160,0.12)",
                pointRadius: 2,
                tension: 0,
              },
            ],
          },
          options: {
            plugins: { legend: { display: false } },
            scales: {
              x: {
                ticks: { color: "#8f92be", maxRotation: 0 },
                grid: { display: false },
              },
              y: {
                ticks: {
                  color: "#8f92be",
                  stepSize: 1,
                  callback: (val) =>
                    val === 1 ? "Low" : val === 2 ? "Medium" : val === 3 ? "High" : "",
                },
                min: 1,
                max: 3,
                grid: { color: "rgba(90,90,120,0.3)" },
              },
            },
          },
        });
      } else {
        probHistoryChart.data.labels = labels;
        probHistoryChart.data.datasets[0].data = probData;
        probHistoryChart.update();
      }
    }

    function renderCalendar() {
      const month = state.calendarMonth;
      const year = month.getFullYear();
      const monthIndex = month.getMonth();

      // Label
      const monthName = month.toLocaleString(undefined, {
        month: "long",
        year: "numeric",
      });
      calendarMonthLabel.textContent = monthName;

      // Build daily stats
      const dailyMap = {};
      state.trades.forEach((t) => {
        const d = new Date(t.date);
        if (
          d.getFullYear() === year &&
          d.getMonth() === monthIndex
        ) {
          const key = d.getDate();
          if (!dailyMap[key]) dailyMap[key] = { pnl: 0, count: 0 };
          dailyMap[key].pnl += t.pnlMoney;
          dailyMap[key].count++;
        }
      });

      // Calendar generation
      const firstDay = new Date(year, monthIndex, 1);
      const startDay = (firstDay.getDay() + 6) % 7; // make Monday=0
      const daysInMonth = new Date(year, monthIndex + 1, 0).getDate();
      const daysInPrev = new Date(year, monthIndex, 0).getDate();

      calendarGrid.innerHTML = "";
      const totalCells = 42; // 6 weeks
      for (let i = 0; i < totalCells; i++) {
        const cell = document.createElement("div");
        cell.className = "calendar-day";

        const dayNum = i - startDay + 1;
        let dateNum, muted;
        if (dayNum <= 0) {
          // previous month
          dateNum = daysInPrev + dayNum;
          muted = true;
        } else if (dayNum > daysInMonth) {
          dateNum = dayNum - daysInMonth;
          muted = true;
        } else {
          dateNum = dayNum;
          muted = false;
        }

        if (muted) cell.classList.add("calendar-day-muted");

        const dateSpan = document.createElement("div");
        dateSpan.className = "calendar-day-date";
        dateSpan.textContent = dateNum;
        cell.appendChild(dateSpan);

        if (!muted && dailyMap[dateNum]) {
          const { pnl, count } = dailyMap[dateNum];
          const pnlSpan = document.createElement("div");
          pnlSpan.className =
            "calendar-day-pnl " + (pnl >= 0 ? "pnl-positive" : "pnl-negative");
          pnlSpan.textContent = formatMoney(pnl);
          cell.appendChild(pnlSpan);

          const countSpan = document.createElement("div");
          countSpan.className = "calendar-day-count";
          countSpan.textContent = count + " trade" + (count !== 1 ? "s" : "");
          cell.appendChild(countSpan);
        }

        calendarGrid.appendChild(cell);
      }
    }

    function renderCoachFeedback() {
      if (!state.trades.length) {
        coachFeedback.textContent =
          "No trades logged yet. Use the checklist and emotion tags every time to build consistent data. The more structured the journal, the sharper your edge.";
        return;
      }

      const last = state.trades[state.trades.length - 1];
      const totalTrades = state.trades.length;
      const wins = state.trades.filter((t) => t.pnlR > 0).length;
      const winRate = totalTrades ? (wins / totalTrades) * 100 : 0;
      const avgDiscipline =
        state.trades.reduce((s, t) => s + (t.disciplineScore || 0), 0) /
        totalTrades;

      let lines = [];

      lines.push(
        `Last trade: ${last.probability.toUpperCase()} probability ${last.direction} on ${last.pair} with ${formatR(
          last.pnlR
        )} (${formatMoney(last.pnlMoney)}).`
      );

      // Checklist commentary
      if (last.score >= 80) {
        lines.push(
          "Checklist: Very solid. You're stacking multiple aligned conditions. Keep repeating this exact behaviour."
        );
      } else if (last.score >= 60) {
        lines.push(
          "Checklist: Decent, but room for improvement. See if one more condition (wick behaviour, structure, session alignment) could have upgraded this to HIGH probability."
        );
      } else {
        lines.push(
          "Checklist: Low conviction. Only a few criteria were met. Ask yourself if this trade truly matched your A+ playbook."
        );
      }

      // Emotion commentary
      if (last.emotion === "Calm" || last.emotion === "Disciplined") {
        lines.push(
          "Emotion: Great state. Calm / disciplined execution tends to keep your risk curve smooth."
        );
      } else if (last.emotion === "FOMO" || last.emotion === "Overtrade") {
        lines.push(
          "Emotion: Warning. Tags like FOMO / Overtrade usually signal impulsive entries. Consider pausing and re-running the checklist before the next trade."
        );
      } else if (last.emotion === "Revenge") {
        lines.push(
          "Emotion: High risk of revenge trading. Reduce size or take a break when you notice this tag showing up."
        );
      }

      // Session commentary
      if (last.session === "London") {
        lines.push("Session: London. Good for breakouts and clean volatility.");
      } else if (last.session === "New York") {
        lines.push("Session: New York. Watch for reversals and over-extensions.");
      }

      // Global performance commentary
      if (winRate >= 55) {
        lines.push(
          `Overall: ${winRate.toFixed(
            1
          )}% win rate over ${totalTrades} trades with an average discipline score around ${avgDiscipline.toFixed(
            0
          )}. Solid. Focus now is on repeating your best setups and avoiding emotional entries.`
        );
      } else {
        lines.push(
          `Overall: ${winRate.toFixed(
            1
          )}% win rate over ${totalTrades} trades. Focus on cutting low probability setups and tightening risk. Discipline score averages around ${avgDiscipline.toFixed(
            0
          )}.`
        );
      }

      lines.push(
        "Next steps: Before placing your next trade, quickly review your last 3 losing trades and make sure you're not repeating the same mistake."
      );

      coachFeedback.textContent = lines.join("\n\n");
    }

    // ------- EVENT HANDLERS -------
    function handleAddTrade() {
      if (state.locked) {
        alert(
          "Dashboard is locked. Unlock it first if you want to add / edit trades."
        );
        return;
      }

      const date = dateInput.value || new Date().toISOString().slice(0, 10);
      const pair = (pairInput.value || "").trim();
      const direction = directionInput.value || "";
      const setup = setupInput.value || "";
      const riskMoney = parseNumber(riskMoneyInput.value);
      const rrPlanned = parseNumber(rrPlannedInput.value);
      const rRealized = parseNumber(rRealizedInput.value);
      const session = sessionInput.value || "";
      const emotion = emotionInput.value || "";
      const screenshot = screenshotInput.value || "";
      const tags = tagsInput.value || "";
      const timeframe = timeframeInput.value || "";
      const journal = journalInput.value || "";

      if (!pair || !direction || !setup || !riskMoney) {
        alert(
          "Please fill at least Pair, Direction, Setup and Risk per trade before logging."
        );
        return;
      }

      const criteriaInputs = criteriaGrid.querySelectorAll("input[type=checkbox]");
      const criteriaFlags = Array.from(criteriaInputs).map((input) => ({
        checked: input.checked,
        weight: parseNumber(input.dataset.weight),
      }));
      const checklist = computeChecklistScore(criteriaFlags);
      const probability = probabilityFromScore(checklist.pct);
      const pnlR = rRealized;
      const pnlMoney = riskMoney * rRealized;
      const score = Math.round(checklist.pct);
      const disciplineScore = computeDisciplineScore(
        probability,
        emotion,
        checklist.pct
      );

      const trade = {
        id: Date.now(),
        date,
        pair,
        direction,
        setup,
        riskMoney,
        rrPlanned,
        rRealized,
        session,
        emotion,
        screenshot,
        tags,
        timeframe,
        journal,
        checklistRaw: checklist.raw,
        checklistMax: checklist.max,
        score,
        probability,
        pnlR,
        pnlMoney,
        balanceAfter: 0,
        disciplineScore,
      };

      state.trades.push(trade);

      // Clear criteria for next trade
      criteriaInputs.forEach((i) => (i.checked = false));

      recalcBalancesAndMetrics();
    }

    function handleClearForm() {
      dateInput.value = "";
      pairInput.value = "";
      directionInput.value = "";
      setupInput.value = "";
      riskMoneyInput.value = "";
      rrPlannedInput.value = "";
      rRealizedInput.value = "";
      sessionInput.value = "";
      emotionInput.value = "";
      screenshotInput.value = "";
      tagsInput.value = "";
      timeframeInput.value = "";
      journalInput.value = "";
      criteriaGrid
        .querySelectorAll("input[type=checkbox]")
        .forEach((i) => (i.checked = false));
    }

    // Export JSON
    function handleExportJson() {
      const dataStr =
        "data:text/json;charset=utf-8," +
        encodeURIComponent(JSON.stringify(state, null, 2));
      const a = document.createElement("a");
      a.href = dataStr;
      a.download = "ali_trading_session.json";
      a.click();
    }

    // Import JSON
    function handleImportJson() {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = ".json";
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
          try {
            const data = JSON.parse(ev.target.result);
            if (data.startingBalance != null) {
              state.startingBalance = data.startingBalance;
            }
            if (Array.isArray(data.trades)) {
              state.trades = data.trades;
            }
            recalcBalancesAndMetrics();
            alert("Session imported successfully.");
          } catch (err) {
            alert("Could not import JSON file.");
          }
        };
        reader.readAsText(file);
      };
      input.click();
    }

    // Export CSV
    function handleExportCsv() {
      const header = [
        "Date",
        "Pair",
        "Direction",
        "Setup",
        "Probability",
        "Score",
        "RiskMoney",
        "RPlanned",
        "RRealized",
        "PnLR",
        "PnLMoney",
        "BalanceAfter",
        "Session",
        "Emotion",
        "Tags",
        "Timeframe",
        "JournalNotes",
      ];
      const rows = state.trades.map((t) => [
        t.date,
        t.pair,
        t.direction,
        t.setup,
        t.probability,
        t.score,
        t.riskMoney,
        t.rrPlanned,
        t.rRealized,
        t.pnlR,
        t.pnlMoney,
        t.balanceAfter,
        t.session,
        t.emotion,
        t.tags,
        t.timeframe,
        (t.journal || "").replace(/\n/g, " "),
      ]);

      const csv = [header, ...rows]
        .map((row) => row.map((v) => `"${String(v).replace(/"/g, '""')}"`).join(","))
        .join("\n");

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "ali_trading_log.csv";
      a.click();
      URL.revokeObjectURL(url);
    }

    // "Export Excel" – generate an .xlsx-like CSV but with styling info text
    function handleExportExcel() {
      // Simpler: reuse CSV but named .xlsx so Excel opens it, plus user already has full Excel log.
      handleExportCsv();
      alert(
        "Excel export: the CSV you just downloaded can be opened directly in Excel. You can then apply your own conditional formatting / heatmaps on top of it."
      );
    }

    // Clear all
    function handleClearAll() {
      if (
        !confirm(
          "This will remove all trades and reset your session. Are you sure?"
        )
      )
        return;
      state.trades = [];
      recalcBalancesAndMetrics();
    }

    // Filters change handler
    function handleFiltersChange() {
      renderTradeLog();
    }

    // Calendar navigation
    function handlePrevMonth() {
      const d = state.calendarMonth;
      state.calendarMonth = new Date(d.getFullYear(), d.getMonth() - 1, 1);
      renderCalendar();
      saveState();
    }

    function handleNextMonth() {
      const d = state.calendarMonth;
      state.calendarMonth = new Date(d.getFullYear(), d.getMonth() + 1, 1);
      renderCalendar();
      saveState();
    }

    // Broker CSV import
    function handleBrokerCsvExample() {
      alert(
        "Example CSV header:\nDate,Pair,Direction,RRealized,RiskMoney,Session\n\nExample row:\n2025-11-16,GBPUSD,Buy,1.8,4000,London"
      );
    }

    function handleBrokerCsvImport(evt) {
      const file = evt.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        const text = e.target.result;
        const lines = text.split(/\r?\n/).filter((l) => l.trim().length > 0);
        if (lines.length <= 1) {
          alert("CSV seems empty or missing header.");
          return;
        }
        const header = lines[0].split(",");
        function idx(name) {
          return header.findIndex(
            (h) => h.trim().toLowerCase() === name.toLowerCase()
          );
        }

        const idxDate = idx("Date");
        const idxPair = idx("Pair");
        const idxDir = idx("Direction");
        const idxR = idx("RRealized");
        const idxRisk = idx("RiskMoney");
        const idxSession = idx("Session");

        if (idxDate < 0 || idxPair < 0 || idxDir < 0 || idxR < 0 || idxRisk < 0) {
          alert(
            "CSV must contain at least: Date, Pair, Direction, RRealized, RiskMoney columns."
          );
          return;
        }

        let imported = 0;
        for (let i = 1; i < lines.length; i++) {
          const row = lines[i].split(",");
          if (row.length < header.length) continue;
          const date = row[idxDate].trim();
          const pair = row[idxPair].trim();
          const direction = row[idxDir].trim();
          const rRealized = parseNumber(row[idxR]);
          const riskMoney = parseNumber(row[idxRisk]);
          const session =
            idxSession >= 0 ? row[idxSession].trim() : "";

          if (!pair || !direction) continue;

          const trade = {
            id: Date.now() + i,
            date: date || new Date().toISOString().slice(0, 10),
            pair,
            direction,
            setup: "Imported",
            riskMoney,
            rrPlanned: 0,
            rRealized,
            session,
            emotion: "",
            screenshot: "",
            tags: "imported",
            timeframe: "",
            journal: "",
            checklistRaw: 0,
            checklistMax: 0,
            score: 50,
            probability: rRealized >= 1 ? "High" : rRealized > 0 ? "Medium" : "Low",
            pnlR: rRealized,
            pnlMoney: riskMoney * rRealized,
            balanceAfter: 0,
            disciplineScore: 60,
          };
          state.trades.push(trade);
          imported++;
        }

        recalcBalancesAndMetrics();
        alert("Imported " + imported + " trades from CSV.");
        brokerCsvInput.value = "";
      };
      reader.readAsText(file);
    }

    // API sync demo
    function handleApiSync() {
      const url = $("apiUrlInput").value.trim();
      if (!url) {
        alert(
          "Add your serverless function URL first. This dashboard does not talk directly to brokers for security reasons."
        );
        return;
      }
      alert(
        "This button is wired as a demo. In your real implementation, your serverless function would:\n\n1) Call MT4/5, cTrader or FTMO APIs.\n2) Return a JSON list of trades.\n3) This dashboard would merge them into your log."
      );
    }

    // Lock toggle
    function handleToggleLock() {
      state.locked = !state.locked;
      lockBtn.classList.toggle("active", state.locked);
      lockBtn.textContent = state.locked ? "Locked" : "Lock";
      saveState();
    }

    // Broker sync shortcut (scroll to card)
    function handleBrokerShortcut() {
      document
        .querySelectorAll(".card")
        [3].scrollIntoView({ behavior: "smooth", block: "start" });
    }

    // Simple PWA prompt (browser default)
    function handleInstallApp() {
      alert(
        "To install as an app on desktop: use your browser's menu → 'Install Ali's Trading System' or 'Add to Home Screen' on mobile."
      );
    }

    // ------- INIT -------
    function init() {
      loadState();

      // Apply lock state
      lockBtn.classList.toggle("active", state.locked);
      lockBtn.textContent = state.locked ? "Locked" : "Lock";

      // Starting balance
      if (state.startingBalance) {
        startingBalanceInput.value = state.startingBalance;
      }

      // Default date
      dateInput.value = new Date().toISOString().slice(0, 10);

      recalcBalancesAndMetrics();

      // Events
      addTradeBtn.addEventListener("click", handleAddTrade);
      clearFormBtn.addEventListener("click", handleClearForm);
      exportJsonBtn.addEventListener("click", handleExportJson);
      exportCsvBtn.addEventListener("click", handleExportCsv);
      importJsonBtn.addEventListener("click", handleImportJson);
      exportExcelBtn.addEventListener("click", handleExportExcel);
      clearAllBtn.addEventListener("click", handleClearAll);

      [filterSetup, filterSession, filterProb, filterEmotion, filterPair, filterFrom, filterTo].forEach(
        (el) => el.addEventListener("input", handleFiltersChange)
      );

      clearFiltersBtn.addEventListener("click", () => {
        filterSetup.value = "";
        filterSession.value = "";
        filterProb.value = "";
        filterEmotion.value = "";
        filterPair.value = "";
        filterFrom.value = "";
        filterTo.value = "";
        handleFiltersChange();
      });

      prevMonthBtn.addEventListener("click", handlePrevMonth);
      nextMonthBtn.addEventListener("click", handleNextMonth);

      startingBalanceInput.addEventListener("input", () => {
        state.startingBalance = parseNumber(startingBalanceInput.value);
        recalcBalancesAndMetrics();
      });

      brokerCsvExampleBtn.addEventListener(
        "click",
        handleBrokerCsvExample
      );
      brokerCsvInput.addEventListener("change", handleBrokerCsvImport);
      apiSyncBtn.addEventListener("click", handleApiSync);
      lockBtn.addEventListener("click", handleToggleLock);
      brokerSyncShortcut.addEventListener("click", handleBrokerShortcut);
      installAppBtn.addEventListener("click", handleInstallApp);

      autosaveStatus.textContent = "Last autosave: –";
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
<script>
// ======================================================
//  USD balance formatting + PnL recompute (FULL BLOCK)
//  - Formats starting/current balance as $ with commas
//  - Keeps numeric values for calculations
//  - Updates "Total PnL & balance" card
// ======================================================
(function () {
  // ---------- Helpers ----------
  function parseMoney(raw) {
    if (!raw) return 0;
    return Number(String(raw).replace(/[^0-9.-]/g, "")) || 0;
  }

  function formatMoneyUSD(value) {
    if (value === null || value === undefined || value === "") return "";
    const num = typeof value === "number" ? value : parseMoney(value);
    return num.toLocaleString("en-US", {
      style: "currency",
      currency: "USD",
      maximumFractionDigits: 2
    });
  }

  // ---------- DOM refs ----------
  const startingBalanceInput = document.getElementById("starting-balance");
  const currentBalanceInput  = document.getElementById("current-balance");
  const balanceDisplayEl     = document.getElementById("balance-display");
  const pnlTotalDisplayEl    = document.getElementById("pnl-total-display");

  if (!startingBalanceInput || !currentBalanceInput) {
    console.warn("[Ali dashboard] Balance inputs not found. " +
      "Make sure you used ids 'starting-balance' and 'current-balance'.");
    return;
  }

  // ---------- Get numeric balances ----------
  function getBalances() {
    const s = parseMoney(
      startingBalanceInput.dataset.value || startingBalanceInput.value
    );
    const c = parseMoney(
      currentBalanceInput.dataset.value || currentBalanceInput.value
    );
    return { starting: s, current: c };
  }

  // ---------- Recompute PnL & balance card ----------
  function recomputeFromBalances() {
    const { starting, current } = getBalances();
    const totalPnLMoney = current - starting;
    const totalR = starting !== 0 ? totalPnLMoney / starting : 0;

    if (balanceDisplayEl) {
      balanceDisplayEl.textContent = formatMoneyUSD(current);
    }
    if (pnlTotalDisplayEl) {
      const rText = `${totalR.toFixed(2)}R`;
      const moneyText = formatMoneyUSD(totalPnLMoney);
      pnlTotalDisplayEl.textContent = `${rText} • ${moneyText}`;
    }
  }

  // ---------- Attach formatting behaviour ----------
  [startingBalanceInput, currentBalanceInput].forEach((input) => {
    if (!input) return;

    // When user focuses, show plain number for easier editing
    input.addEventListener("focus", () => {
      const stored = input.dataset.value;
      if (stored !== undefined) {
        input.value = stored;
      } else {
        input.value = parseMoney(input.value) || "";
      }
    });

    // When user leaves, format as USD with commas and recalc PnL
    input.addEventListener("blur", () => {
      const num = parseMoney(input.value);
      input.dataset.value = num;              // raw numeric value
      input.value = formatMoneyUSD(num);      // pretty view
      recomputeFromBalances();
    });
  });

  // ---------- Initial default values (optional) ----------
  // You can change these or remove them if you prefer manual input.
  if (!startingBalanceInput.dataset.value && !startingBalanceInput.value) {
    startingBalanceInput.dataset.value = 0;
    startingBalanceInput.value = "";
  }
  if (!currentBalanceInput.dataset.value && !currentBalanceInput.value) {
    currentBalanceInput.dataset.value = 0;
    currentBalanceInput.value = "";
  }

  // Run once on load so cards don't show "undefined"
  recomputeFromBalances();

  // Expose for other scripts if needed
  window.AliDashboardBalances = {
    getBalances,
    recomputeFromBalances,
    parseMoney,
    formatMoneyUSD
  };
})();
</script>
<script>
/* ============================================================
   ⭐ AUTO-DETECT BALANCE INPUTS + FORMAT MONEY + PNL CALCULATION
   No replacement needed. No ID changes. It works with your 
   existing fields automatically.
   ============================================================ */

(function () {
  // Try to detect the starting & current balance fields automatically
  const startingInput =
    document.querySelector("input[placeholder*='Starting'], input[id*='starting'], input[name*='starting']");
  const currentInput =
    document.querySelector("input[placeholder*='Current'], input[id*='current'], input[name*='current']");

  if (!startingInput || !currentInput) {
    console.warn("Balance fields not found — adjust selectors if needed.");
    return;
  }

  // Dashboard elements
  const pnlCard = document.querySelector("[data-pnl-total]"); 
  const balanceCard = document.querySelector("[data-balance-total]");

  /* ---------------- Helper functions ---------------- */
  const parseMoney = (val) => {
    if (!val) return 0;
    return parseFloat(String(val).replace(/[^0-9.-]/g, "")) || 0;
  };

  const formatUSD = (num) =>
    Number(num).toLocaleString("en-US", {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2,
    });

  function saveLocal(starting, current) {
    localStorage.setItem("ali_balances", JSON.stringify({ starting, current }));
  }

  function loadLocal() {
    try {
      return JSON.parse(localStorage.getItem("ali_balances")) || null;
    } catch {
      return null;
    }
  }

  function updateDashboard() {
    const starting = parseMoney(startingInput.dataset.value);
    const current = parseMoney(currentInput.dataset.value);
    const pnl = current - starting;
    const r = starting !== 0 ? pnl / starting : 0;

    if (pnlCard) pnlCard.textContent = `${r.toFixed(2)}R • ${formatUSD(pnl)}`;
    if (balanceCard) balanceCard.textContent = formatUSD(current);
  }

  /* ---------------- Input behaviour ---------------- */
  function attachMoneyInput(input) {
    input.addEventListener("focus", () => {
      const raw = input.dataset.value;
      input.value = raw !== undefined ? raw : "";
    });

    input.addEventListener("blur", () => {
      const raw = parseMoney(input.value);
      input.dataset.value = raw;
      input.value = formatUSD(raw);

      const starting = parseMoney(startingInput.dataset.value);
      const current = parseMoney(currentInput.dataset.value);
      saveLocal(starting, current);
      updateDashboard();
    });
  }

  attachMoneyInput(startingInput);
  attachMoneyInput(currentInput);

  // Load saved balances on startup
  const saved = loadLocal();
  if (saved) {
    startingInput.dataset.value = saved.starting;
    currentInput.dataset.value = saved.current;
    startingInput.value = formatUSD(saved.starting);
    currentInput.value = formatUSD(saved.current);
    updateDashboard();
  }

  updateDashboard();
})();
</script>


